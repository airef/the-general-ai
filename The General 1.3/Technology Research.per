;Technology Research.per

;=========================<>=========================
;				      ECO TECHS
;=========================<>=========================
			
	;--------------------------------------------
	;	Double-Bit Axe - Secondary Feudal Tech
	;--------------------------------------------

		(defrule
		(up-compare-goal g-difficulty != EASIEST)
		(or
			(goal g-strategy-type DRUSH)
			(or
				(goal g-strategy-type FLUSH)
				(and
					(up-compare-goal g-current-strategy >= BOOMC-STRATS-START)	;Boom Strats
					(up-compare-goal g-current-strategy <= BOOMI-STRATS-END))))
		(can-research-with-escrow ri-double-bit-axe)
		(unit-type-count villager >= 10)
		(unit-type-count-total villager >= 11)
		(or
			(up-pending-objects c: villager > 1)
			(up-compare-goal g-age-status >= TO-FEUDAL))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-double-bit-axe c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow wood g:- g-wood-cost)
		(research ri-double-bit-axe)
		)

		(defrule
		(up-compare-goal g-difficulty != EASIEST)
		(or
			(goal g-strategy-type DRUSH)
			(or
				(goal g-strategy-type FLUSH)
				(and
					(up-compare-goal g-current-strategy >= BOOMC-STRATS-START)	;Boom Strats
					(up-compare-goal g-current-strategy <= BOOMI-STRATS-END))))
		(can-research ri-double-bit-axe)
		(unit-type-count villager >= 10)
		(unit-type-count-total villager >= 11)
		=>
		(up-get-fact escrow-amount food g-temp)
		(research ri-double-bit-axe)
		)

		(defrule
		(up-compare-goal g-difficulty != EASIEST)
		(or
			(goal g-strategy-type FAST-CASTLE)
			(goal g-strategy-type FAST-IMPERIAL))
		(or
			(up-compare-goal g-current-strategy != FC-STRONGBOW)
			(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(can-research-with-escrow ri-double-bit-axe)
		(up-compare-goal g-age-status >= TO-CASTLE)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-double-bit-axe c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow wood g:- g-wood-cost)
		(research ri-double-bit-axe)
		)

    ;------------------------------------
    ;   Bow Saw - Priority Castle Tech
    ;------------------------------------

		(defrule
		(up-compare-goal g-difficulty > STANDARD)
		(can-research-with-escrow ri-bow-saw)
		(or
			(up-compare-goal g-age-status >= TO-CASTLE)
			(up-compare-goal g-strategy-type != FAST-CASTLE))
		(or
			(up-compare-goal g-current-strategy != FC-STRONGBOW)
			(up-compare-goal g-age-status >= MID-CASTLE))
		(or
			(goal g-game-focus BOOM)
			(up-compare-goal g-primary-unit-tech-progress >= REQUIRED-CASTLE-COMPLETE))
		(up-compare-flag g-flag != TRUSH-DEFENSE)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-bow-saw c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow wood g:- g-wood-cost)
		(research ri-bow-saw)
		)

    ;-------------------------------------------
    ;   Two-Man Saw - Secondary Imperial Tech
    ;-------------------------------------------

		(defrule
		(can-research ri-two-man-saw)
		(up-compare-goal g-game-focus != DEFENSIVE)
		(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-IMPERIAL-COMPLETE)
		(population >= NINETY-PERCENT-POP)
		=>
		(research ri-two-man-saw)
		)

	#load-if-not-defined KHITANS-CIV

		;-----------------------------------------
		;	Horse Collar - Priority Castle Tech
		;-----------------------------------------

			(defrule
			(up-compare-goal g-difficulty > EASIEST)
			(or
				(goal g-strategy-type FAST-CASTLE)
				(goal g-strategy-type FAST-IMPERIAL))
			(or
				(up-compare-goal g-current-strategy != FC-STRONGBOW)
				(or
					(goal g-game-focus BOOM)
					(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-CASTLE-COMPLETE)))
			(up-research-status c: ri-double-bit-axe >= research-pending)
			(can-research-with-escrow ri-horse-collar)
			(up-compare-goal g-age-status >= TO-CASTLE)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-horse-collar c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow wood g:- g-wood-cost)
			(research ri-horse-collar)
			)

		;----------------
		;   Heavy Plow
		;----------------

			(defrule
			(up-compare-goal g-difficulty > STANDARD)
			(or
				(up-compare-goal g-usable-farm-count < 20)
				(or
					(and
						(up-object-type-count c: town-center g:< g-desired-num-town-center)
						(and
							(building-type-count-total town-center < 2)
							(up-compare-goal g-usable-farm-count < 25)))
					(and
						(goal g-game-focus DEFENSIVE)
						(up-compare-goal g-human-military-count g:< g-min-military-pop))))
			=>
			(up-jump-rule 1)
			)

				(defrule
				(up-compare-goal g-difficulty > STANDARD)
				(can-research-with-escrow ri-heavy-plow)
				(up-research-status c: ri-bow-saw >= research-pending)
				(or
					(up-compare-goal g-age-status >= MID-CASTLE)
					(and
						(goal g-position POCKET)
						(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-CASTLE-COMPLETE)))
				(up-compare-flag g-flag != TRUSH-DEFENSE)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-heavy-plow c: 1)
				(up-modify-escrow food g:- g-food-cost)
				(up-modify-escrow wood g:- g-wood-cost)
				(research ri-heavy-plow)
				)

		;-------------------
		;   Crop Rotation
		;-------------------

			(defrule
			(can-research ri-crop-rotation)
			(up-compare-goal g-game-focus != DEFENSIVE)
			(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-IMPERIAL-COMPLETE)
			(population >= NINETY-FIVE-PERCENT-POP)
			=>
			(research ri-crop-rotation)
			)

	#else

		;------------------------------------------
		;	Domestication - Priority Castle Tech
		;------------------------------------------

			(defrule
			(up-compare-goal g-difficulty > EASIEST)
			(or
				(goal g-strategy-type FAST-CASTLE)
				(goal g-strategy-type FAST-IMPERIAL))
			(or
				(up-compare-goal g-current-strategy != FC-STRONGBOW)
				(or
					(goal g-game-focus BOOM)
					(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-CASTLE-COMPLETE)))
			(up-research-status c: ri-double-bit-axe >= research-pending)
			(can-research-with-escrow ri-domestication)
			(up-compare-goal g-age-status >= TO-CASTLE)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-domestication c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow wood g:- g-wood-cost)
			(research ri-domestication)
			)

		;-----------------
		;   Pastoralism
		;-----------------

			(defrule
			(up-compare-goal g-difficulty > STANDARD)
			(or
				(up-compare-goal g-usable-farm-count < 20)
				(or
					(and
						(up-object-type-count c: town-center g:< g-desired-num-town-center)
						(and
							(building-type-count-total town-center < 2)
							(up-compare-goal g-usable-farm-count < 25)))
					(and
						(goal g-game-focus DEFENSIVE)
						(up-compare-goal g-human-military-count g:< g-min-military-pop))))
			=>
			(up-jump-rule 1)
			)

				(defrule
				(up-compare-goal g-difficulty > STANDARD)
				(can-research-with-escrow ri-pastoralism)
				(up-research-status c: ri-bow-saw >= research-pending)
				(or
					(up-compare-goal g-age-status >= MID-CASTLE)
					(and
						(goal g-position POCKET)
						(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-CASTLE-COMPLETE)))
				(up-compare-flag g-flag != TRUSH-DEFENSE)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-pastoralism c: 1)
				(up-modify-escrow food g:- g-food-cost)
				(up-modify-escrow wood g:- g-wood-cost)
				(research ri-pastoralism)
				)

		;-------------------
		;   Transhumance
		;-------------------

			(defrule
			(can-research ri-transhumance)
			(up-compare-goal g-game-focus != DEFENSIVE)
			(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-IMPERIAL-COMPLETE)
			(population >= NINETY-FIVE-PERCENT-POP)
			=>
			(research ri-transhumance)
			)

	#end-if

	;-----------------
	;	Wheelbarrow
	;-----------------

        (defrule
		(up-compare-goal g-difficulty > EASIEST)
        (can-research-with-escrow ri-wheel-barrow)
		(or
			(building-type-count town-center > 1)
			(up-compare-goal g-usable-farm-count >= 18))
		(up-compare-goal g-usable-farm-count >= 14)
		(or
			(up-compare-goal g-game-focus != DEFENSIVE)
			(up-compare-goal g-human-military-count g:>= g-min-military-pop))
        =>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-wheel-barrow c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow wood g:- g-wood-cost)
		(research ri-wheel-barrow)
        )

	;---------------
	;	Hand Cart
	;---------------

		(defrule
		(up-compare-goal g-difficulty > STANDARD)
		(goal g-game-focus BOOM)
		(can-research-with-escrow ri-hand-cart)
		(or
			(building-type-count town-center > 1)
			(up-compare-goal g-usable-farm-count >= 25))
		(up-compare-goal g-usable-farm-count >= 20)
		(population >= 80)
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(or
			(up-research-status c: ri-heavy-plow >= research-pending)
			(up-research-status c: ri-pastoralism >= research-pending))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-hand-cart c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow wood g:- g-wood-cost)
		(research ri-hand-cart)
		)

		(defrule
		(up-compare-goal g-difficulty > STANDARD)
		(or
			(population >= 100)
			(up-compare-goal g-usable-farm-count >= 25))
		(or
			(up-compare-goal g-game-focus != DEFENSIVE)
			(up-compare-goal g-human-military-count g:>= g-min-military-pop))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(or
			(up-research-status c: ri-heavy-plow >= research-pending)
			(up-research-status c: ri-pastoralism >= research-pending))
		(can-research ri-hand-cart)
		=>
		(research ri-hand-cart)
		)

    ;-----------------
    ;   Gold Mining
    ;-----------------

        (defrule
		(up-compare-goal g-difficulty > STANDARD)
        (up-compare-goal g-eco-tech-progress >= SECONDARY-CASTLE-COMPLETE)
		(or
			(up-compare-goal g-game-focus != DEFENSIVE)
			(up-compare-goal g-human-military-count g:>= g-min-military-pop))
		(unit-type-count villager-gold >= 7)
        (can-research ri-gold-mining)
        =>
		(research ri-gold-mining)
        )
		
	;-----------------------
    ;   Gold Shaft Mining
    ;-----------------------

        (defrule
		(current-age == castle-age)
        (or
			(up-compare-flag g-flag == FIRST-ATTACK-LAUNCHED)
			(goal g-position POCKET))
		(up-compare-goal g-eco-tech-progress >= SECONDARY-CASTLE-COMPLETE)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1200))
		(up-compare-goal g-game-focus != DEFENSIVE)
		(unit-type-count villager-gold >= 15)
        (can-research ri-gold-shaft-mining)
        =>
		(research ri-gold-shaft-mining)
        )

        (defrule
        (or
			(up-compare-flag g-flag == FIRST-ATTACK-LAUNCHED)
			(goal g-position POCKET))
		(up-compare-goal g-eco-tech-progress >= ALL-CASTLE-COMPLETE)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1200))
		(up-compare-goal g-game-focus != DEFENSIVE)
		(unit-type-count villager-gold >= 12)
        (can-research ri-gold-shaft-mining)
        =>
		(research ri-gold-shaft-mining)
        )

		(defrule
		(up-compare-goal g-eco-tech-progress >= ALL-CASTLE-COMPLETE)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1200))
		(up-compare-goal g-game-focus != DEFENSIVE)
		(population >= EIGHTY-PERCENT-POP)
		(can-research ri-gold-shaft-mining)
		(dropsite-min-distance gold < 255)
		=>
		(research ri-gold-shaft-mining)
		)
		
    ;------------------
    ;   Stone Mining
    ;------------------

        (defrule
        (up-compare-goal g-eco-tech-progress >= SECONDARY-CASTLE-COMPLETE)
		(or
			(goal g-current-strategy FC-CASTLE-DROP)
			(or
				(up-compare-goal g-desired-num-castle >= 3)
				(or
					(up-compare-goal g-desired-num-tower >= 3)
					(up-compare-goal g-desired-num-bombard-tower >= 3))))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1100))
		(up-compare-goal g-game-focus != DEFENSIVE)
		(unit-type-count villager-stone > 6)
        (can-research ri-stone-mining)
        =>
		(research ri-stone-mining)
        )

		(defrule
		(up-compare-goal g-eco-tech-progress >= ALL-CASTLE-COMPLETE)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1100))
		(up-compare-goal g-game-focus != DEFENSIVE)
		(population >= SEVENTY-PERCENT-POP)
		(can-research ri-stone-mining)
		(unit-type-count villager-stone > 6)
		(dropsite-min-distance stone < 255)
		=>
		(research ri-stone-mining)
		)

	;------------------------
    ;   Stone Shaft Mining
    ;------------------------

		(defrule
		(current-age == imperial-age)
		(up-compare-goal g-eco-tech-progress >= SECONDARY-IMPERIAL-COMPLETE)
		(up-compare-goal g-game-focus != DEFENSIVE)
		(population >= NINETY-FIVE-PERCENT-POP)
		(unit-type-count villager-stone > 6)
		(can-research ri-stone-shaft-mining)
		(dropsite-min-distance stone < 255)
		=>
		(research ri-stone-shaft-mining)
		)

;=========================<>=========================
;				    CRITICAL TECHS
;=========================<>=========================

	;----------
	;	Loom
	;----------

		; (defrule
		; (can-research-with-escrow ri-loom)
		; (or
		; 	(cc-players-unit-type-count 0 elephant > 0)
		; 	(cc-players-unit-type-count 0 rhino > 0))
		; (unit-type-count villager >= 10)
		; (up-compare-goal g-current-boar-count > 0)
		; ; (up-timer-status t-villager-training-delay != timer-running)
		; =>
		; (up-setup-cost-data 1 g-food-cost)
		; (up-add-research-cost c: ri-loom c: 1)
		; (up-modify-escrow gold g:- g-gold-cost)
		; (research ri-loom)
		; )

		(defrule
		(can-research-with-escrow ri-loom)
		(or
			(up-compare-goal g-map-style != WALLED-LAND)
			(up-compare-goal g-age-status >= TO-CASTLE))
		(or
			(up-object-type-count c: villager g:>= g-required-num-villager)
			(or
				(goal g-town-under-attack YES)
				(or
					(current-age >= castle-age)
					(players-military-population any-enemy > 1))))
		(unit-type-count villager >= 15)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-loom c: 1)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-loom)
		)

		(defrule
		(can-research-with-escrow ri-loom)
		(or
			(food-amount < 35)
			(housing-headroom == 0))
		(not
			(can-train villager))
		(up-pending-objects c: villager == 0)
		(unit-type-count villager >= 7)
		; (up-timer-status t-villager-training-delay != timer-running)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-loom c: 1)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-loom)
		; (chat-to-all "idle tc loom")
		)

		(defrule
		(can-research-with-escrow ri-loom)
		(or
			(civ-selected mayan)
			(or
				(civ-selected chinese)
				(civ-selected gothic)))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-loom c: 1)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-loom)
		)

	;-----------------
	;	Feudal Age
	;-----------------

		(defrule
		(can-research-with-escrow feudal-age)
		(or
			(up-object-type-count c: villager g:>= g-required-num-villager)
			(or
				(goal g-game-focus REBUILD)
				(goal g-game-focus DEFENSIVE)))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: feudal-age c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(research feudal-age)
		)
		
	;-----------------
	;	Castle Age
	;-----------------

		(defrule
		(can-research-with-escrow castle-age)
		(or
			(up-object-type-count c: villager g:>= g-required-num-villager)
			(or
				(goal g-game-focus REBUILD)
				(or
					(goal g-game-focus DEFENSIVE)
					(goal g-strategy-type FAST-CASTLE))))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: castle-age c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research castle-age)
		)
		
	;-----------------
	;	Imperial Age
	;-----------------

		(defrule
		(can-research-with-escrow imperial-age)
		(or
			(goal g-age-status SAVE-FOR-IMPERIAL)
			(or
				(up-object-type-count c: villager g:>= g-required-num-villager)
				(or
					(goal g-game-focus REBUILD)
					(goal g-game-focus DEFENSIVE))))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: imperial-age c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research imperial-age)
		)
		(defrule
		(up-get-fact current-age 0 g-temp)						;store our current age
		(up-get-fact-max any-enemy current-age 0 g-temp2)		;store current age of most advanced enemy
		(can-research-with-escrow imperial-age)
		(up-compare-goal g-temp g:< g-temp2)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: imperial-age c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research imperial-age)
		)

	;---------------------------------------------------------------
	;	Unique Unit Upgrade - Priority or Secondary Imperial Tech
	;---------------------------------------------------------------

		#load-if-not-defined KOREAN-CIV

			(defrule
			(or
				(goal g-game-focus BOOM)
				(goal g-game-focus REBUILD))
			(up-object-type-count-total c: town-center g:< g-desired-num-town-center)
			(or
				(civ-selected berbers)
				(civ-selected mayan))
			=>
			(up-jump-rule 3)
			)

				(defrule
				(goal g-primary-unit my-unique-unit)
				; (or
				; 	(unit-type-count-total my-unique-unit-line >= 7)
				; 	(unit-type-count-total my-unique-unit-line g:>= g-desired-num-unique-unit))
				(can-research-with-escrow my-unique-unit-upgrade)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: my-unique-unit-upgrade c: 1)
				(up-modify-escrow food g:- g-food-cost)
				(up-modify-escrow wood g:- g-wood-cost)
				(up-modify-escrow gold g:- g-gold-cost)
				(research my-unique-unit-upgrade)
				)
				(defrule
				(goal g-support-unit my-unique-unit)
				(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
				; (or
				; 	(unit-type-count-total my-unique-unit-line >= 7)
				; 	(unit-type-count-total my-unique-unit-line g:>= g-desired-num-unique-unit))
				(can-research-with-escrow my-unique-unit-upgrade)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: my-unique-unit-upgrade c: 1)
				(up-modify-escrow food g:- g-food-cost)
				(up-modify-escrow wood g:- g-wood-cost)
				(up-modify-escrow gold g:- g-gold-cost)
				(research my-unique-unit-upgrade)
				)

				(defrule
				(or
					(unit-type-count-total my-unique-unit-line >= 12)
					(and
						(population >= NINETY-PERCENT-POP)
						(or
							(up-compare-goal g-desired-num-unique-unit > 0)
							(unit-type-count-total my-unique-unit-line >= 6))))
				(can-research my-unique-unit-upgrade)
				=>
				(research my-unique-unit-upgrade)
				)

		#else

			(defrule
			(or
				(goal g-game-focus BOOM)
				(goal g-game-focus REBUILD))
			(up-object-type-count-total c: town-center g:< g-desired-num-town-center)
			(or
				(civ-selected berbers)
				(civ-selected mayan))
			=>
			(up-jump-rule 3)
			)

				(defrule
				(goal g-primary-unit my-unique-unit)
				; (or
				; 	(unit-type-count-total my-unique-unit-line >= 7)
				; 	(unit-type-count-total my-unique-unit-line g:>= g-desired-num-unique-unit))
				(can-research-with-escrow ri-elite-war-wagon)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-elite-war-wagon c: 1)
				(up-modify-escrow food g:- g-food-cost)
				(up-modify-escrow wood g:- g-wood-cost)
				(up-modify-escrow gold g:- g-gold-cost)
				(research ri-elite-war-wagon)
				)
				(defrule
				(goal g-support-unit my-unique-unit)
				(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
				; (or
				; 	(unit-type-count-total my-unique-unit-line >= 7)
				; 	(unit-type-count-total my-unique-unit-line g:>= g-desired-num-unique-unit))
				(can-research-with-escrow ri-elite-war-wagon)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-elite-war-wagon c: 1)
				(up-modify-escrow food g:- g-food-cost)
				(up-modify-escrow wood g:- g-wood-cost)
				(up-modify-escrow gold g:- g-gold-cost)
				(research ri-elite-war-wagon)
				)

				(defrule
				(or
					(unit-type-count-total my-unique-unit-line >= 12)
					(and
						(population >= NINETY-PERCENT-POP)
						(or
							(up-compare-goal g-desired-num-unique-unit > 0)
							(unit-type-count-total my-unique-unit-line >= 6))))
				(can-research ri-elite-war-wagon)
				=>
				(research ri-elite-war-wagon)
				)

		#end-if

;=========================<>=========================
;				     UNIQUE TECHS
;=========================<>=========================

	#load-if-defined ARMENIANS-CIV

		;--------------------
		;	Cilician Fleet
		;--------------------

			(defrule
			(up-compare-goal g-desired-num-galley >= 10)
			(research-completed ri-war-galley)
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(gold-amount >= 1100))
			(can-research-with-escrow ri-cilician-fleet)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-cilician-fleet c: 1)
			(up-modify-escrow wood g:- g-wood-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-cilician-fleet)
			)

			(defrule
			(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
			(or
				(unit-type-count galley-line > 15)
				(or
					(unit-type-count dromon > 1)
					(up-compare-goal g-desired-num-demolition-ship > 0)))
			(can-research ri-cilician-fleet)
			=>
			(research ri-cilician-fleet)
			)

		;--------------
		;	Fereters
		;--------------

			(defrule
			(or
				(goal g-primary-unit militiaman)
				(goal g-primary-unit warrior-priest))
			(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
			(can-research-with-escrow ri-fereters)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-fereters c: 1)
			(up-modify-escrow wood g:- g-wood-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-fereters)
			)
			(defrule
			(or
				(goal g-support-unit militiaman)
				(goal g-support-unit warrior-priest))
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
			(can-research-with-escrow ri-fereters)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-fereters c: 1)
			(up-modify-escrow wood g:- g-wood-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-fereters)
			)

			(defrule
			(or
				(and
					(up-compare-goal g-desired-num-militia > 10)
					(up-research-status c: ri-champion >= research-pending))
				(up-compare-goal g-desired-num-second-unique-unit > 10))
			(can-research ri-fereters)
			=>
			(research ri-fereters)
			)

	#end-if

	#load-if-defined AZTEC-CIV

		;------------------
		;	Garland Wars
		;------------------

			(defrule
			(up-research-status c: ri-champion < research-pending)
			(up-research-status c: ri-elite-eagle-warrior < research-pending)
			(up-research-status c: my-unique-unit-upgrade < research-pending)
			(population < NINETY-FIVE-PERCENT-POP)
			=>
			(up-jump-rule 3)
			)

				(defrule
				(goal g-primary-unit-class infantry-class)
				; (unit-type-count infantry-class >= 10)
				(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
				(can-research-with-escrow ri-garland-wars)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-garland-wars c: 1)
				(up-modify-escrow food g:- g-food-cost)
				(up-modify-escrow gold g:- g-gold-cost)
				(research ri-garland-wars)
				)
				(defrule
				(goal g-support-unit-class infantry-class)
				(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
				; (unit-type-count infantry-class >= 15)
				(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
				(can-research-with-escrow ri-garland-wars)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-garland-wars c: 1)
				(up-modify-escrow food g:- g-food-cost)
				(up-modify-escrow gold g:- g-gold-cost)
				(research ri-garland-wars)
				)

				(defrule
				(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
				(or
					(unit-type-count infantry-class > 20)
					(and
						(population >= NINETY-PERCENT-POP)
						(or
							(up-compare-goal g-desired-num-infantry-class > 0)
							(unit-type-count infantry-class >= 6))))
				(can-research ri-garland-wars)
				=>
				(research ri-garland-wars)
				)

		;------------
		;	Atlatl
		;------------

			(defrule
			(goal g-primary-unit skirmisher)
			(or
				(unit-type-count-total skirmisher-line >= 10)
				(unit-type-count-total skirmisher-line g:>= g-desired-num-skirmisher))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-compare-goal g-skirmisher-tech-progress >= SECONDARY-CASTLE-COMPLETE)
			(can-research-with-escrow ri-atlatl)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-atlatl c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-atlatl)
			)

			(defrule
			(goal g-support-unit skirmisher)
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(or
				(unit-type-count-total skirmisher-line >= 15)
				(unit-type-count-total skirmisher-line g:>= g-desired-num-skirmisher))
			(up-compare-goal g-skirmisher-tech-progress >= SECONDARY-CASTLE-COMPLETE)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-atlatl)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-atlatl c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-atlatl)
			)

			(defrule
			(current-age == imperial-age)
			(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
			(or
				(unit-type-count-total skirmisher-line >= 12)
				(and
					(population >= NINETY-PERCENT-POP)
					(or
						(up-compare-goal g-desired-num-skirmisher > 0)
						(unit-type-count-total skirmisher-line >= 6))))
			(can-research ri-atlatl)
			=>
			(research ri-atlatl)
			)

	#end-if

	#load-if-defined BENGALIS-CIV

		;-----------
		;	Paiks
		;-----------

			(defrule
			(or
				(goal g-game-focus BOOM)
				(goal g-game-focus REBUILD))
			(up-object-type-count-total c: town-center g:< g-desired-num-town-center)
			=>
			(up-jump-rule 3)
			)

				(defrule
				(or
					(goal g-primary-unit battle-elephant)
					(or
						(goal g-primary-unit elephant-archer)
						(and
							(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
							(or
								(goal g-support-unit battle-elephant)
								(goal g-support-unit elephant-archer)))))
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research-with-escrow ri-paiks)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-paiks c: 1)
				(up-modify-escrow wood g:- g-wood-cost)
				(up-modify-escrow gold g:- g-gold-cost)
				(research ri-paiks)
				)
				(defrule
				(or
					(goal g-primary-unit my-unique-unit)
					(and
						(goal g-support-unit my-unique-unit)
						(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research-with-escrow ri-paiks)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-paiks c: 1)
				(up-modify-escrow wood g:- g-wood-cost)
				(up-modify-escrow gold g:- g-gold-cost)
				(research ri-paiks)
				)

				(defrule
				(or
					(up-compare-goal g-desired-num-battle-elephant > 6)
					(or
						(up-compare-goal g-desired-num-elephant-archer > 6)
						(or
							(up-compare-goal g-desired-num-unique-unit > 6)
							(or
								(unit-type-count-total battle-elephant-line > 8)
								(or
									(unit-type-count elephant-archer-line > 8)
									(or
										(unit-type-count-total my-unique-unit-line > 10)
										(unit-type-count armored-elephant-line >= 2)))))))
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research ri-paiks)
				=>
				(research ri-paiks)
				)

		;--------------
		;	Mahayana
		;--------------

			(defrule
			(unit-type-count villager >= 120)
			(can-research ri-mahayana)
			(population-headroom <= 10)
			=>
			(research ri-mahayana)
			)

	#end-if

	#load-if-defined BERBERS-CIV

		;---------------------
		;	Maghrabi Camels
		;---------------------

			(defrule
			(or
				(goal g-primary-unit camel)
				(goal g-primary-unit my-unique-unit))
			(or
				(unit-type-count-total camel-line >= 10)
				(unit-type-count-total my-unique-unit-line >= 12))
			(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
			(can-research-with-escrow ri-maghrabi-camels)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-maghrabi-camels c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-maghrabi-camels)
			)
			(defrule
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(or
				(goal g-support-unit camel)
				(goal g-support-unit my-unique-unit))
			(or
				(unit-type-count-total camel-line >= 12)
				(unit-type-count-total my-unique-unit-line >= 15))
			(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
			(can-research-with-escrow ri-maghrabi-camels)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-maghrabi-camels c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-maghrabi-camels)
			)

			(defrule
			(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
			(or
				(unit-type-count-total camel-line >= 12)
				(and
					(population >= NINETY-PERCENT-POP)
					(or
						(up-compare-goal g-desired-num-camel > 0)
						(unit-type-count-total camel-line >= 6))))
			(can-research ri-maghrabi-camels)
			=>
			(research ri-maghrabi-camels)
			)
			(defrule
			(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
			(up-research-status c: ri-maghrabi-camels >= research-pending)
			(or
				(unit-type-count-total my-unique-unit-line >= 15)
				(and
					(population >= NINETY-PERCENT-POP)
					(or
						(up-compare-goal g-desired-num-unique-unit > 0)
						(unit-type-count-total my-unique-unit-line >= 8))))
			(can-research ri-maghrabi-camels)
			=>
			(research ri-maghrabi-camels)
			)

		;------------
		;	Kasbah
		;------------

			(defrule
			(goal g-primary-unit my-unique-unit)
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1250))
			(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-CASTLE-COMPLETE)
			(up-compare-goal g-current-age-primary-unit-tech-progress >= PRIORITY-COMPLETE)
			(can-research-with-escrow ri-kasbah)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-kasbah c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-kasbah)
			)
			(defrule
			(goal g-support-unit my-unique-unit)
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(up-compare-goal g-desired-num-support-unit >= 15)
			(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
			(can-research-with-escrow ri-kasbah)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-kasbah c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-kasbah)
			)

			(defrule
			(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
			(or
				(players-building-type-count any-ally castle > 1)
				(or
					(up-compare-goal g-desired-num-unique-unit >= 15)
					(and
						(population >= NINETY-PERCENT-POP)
						(up-compare-goal g-desired-num-unique-unit > 10))))
			(can-research ri-kasbah)
			=>
			(research ri-kasbah)
			)

	#end-if

	#load-if-defined BOHEMIANS-CIV

		;-----------------------
		;	Wagenburg Tactics
		;-----------------------

			(defrule
			(or
				(goal g-primary-unit hand-cannoneer)
				(or
					(goal g-primary-unit my-unique-unit)
					(and
						(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
						(or
							(goal g-support-unit hand-cannoneer)
							(goal g-support-unit my-unique-unit)))))
			(can-research-with-escrow ri-wagenburg-tactics)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-wagenburg-tactics c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-wagenburg-tactics)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-hand-cannoneer > 10)
				(or
					(unit-type-count hand-cannoneer > 15)
					(or
						(up-compare-goal g-desired-num-unique-unit > 10)
						(or
							(unit-type-count my-unique-unit > 15)
							(unit-type-count my-cannon-line >= 3)))))
			(can-research ri-wagenburg-tactics)
			=>
			(research ri-wagenburg-tactics)
			)

		;---------------------
		;	Hussite Reforms
		;---------------------

			(defrule
			(up-compare-goal g-desired-num-monk >= 6)
			(can-research ri-hussite-reforms)
			=>
			(research ri-hussite-reforms)
			)			

	#end-if

	#load-if-defined BRITON-CIV

		;------------
		;	Yeomen
		;------------

			;Archers
			(defrule
			(or
				(and
					(goal g-primary-unit-class archery-class)
					(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE))
				(and
					(goal g-support-unit-class archery-class)
					(and
						(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
						(up-compare-goal g-support-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE))))
			(or
				(unit-type-count archery-class >= 12)
				(unit-type-count archery-class g:>= g-desired-num-archery-class))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-yeomen)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-yeomen c: 1)
			(up-modify-escrow wood g:- g-wood-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-yeomen)
			)

			(defrule
			(up-compare-goal g-desired-num-archer > 6)
			(unit-type-count archery-class > 10)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-yeomen)
			=>
			(research ri-yeomen)
			)
			(defrule
			(population >= NINETY-PERCENT-POP)
			(unit-type-count archery-class > 10)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-yeomen)
			=>
			(research ri-yeomen)
			)

			;Towers
			(defrule
			(up-compare-goal g-desired-num-tower > 2)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(research-completed ri-keep)
			(can-research ri-yeomen)
			=>
			(research ri-yeomen)
			)

		;-------------
		;	Warwolf
		;-------------

			(defrule
			(or
				(goal g-game-focus BOOM)
				(goal g-game-focus REBUILD))
			(up-object-type-count-total c: town-center g:< g-desired-num-town-center)
			=>
			(up-jump-rule 3)
			)

				(defrule
				(up-compare-goal g-desired-num-trebuchet > 3)
				(unit-type-count trebuchet-set > 1)
				(can-research-with-escrow ri-warwolf)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-warwolf c: 1)
				(up-modify-escrow wood g:- g-wood-cost)
				(up-modify-escrow gold g:- g-gold-cost)
				(research ri-warwolf)
				)

				(defrule
				(up-compare-goal g-desired-num-trebuchet > 0)
				(unit-type-count trebuchet-set > 0)
				(can-research ri-warwolf)
				=>
				(research ri-warwolf)
				)
				(defrule
				(population >= NINETY-PERCENT-POP)
				(unit-type-count trebuchet-set > 0)
				(can-research ri-warwolf)
				=>
				(research ri-warwolf)
				)

	#end-if

	#load-if-defined BULGARIANS-CIV

		;--------------
		;	Stirrups
		;--------------

			(defrule
			(or
				(goal g-primary-unit-class cavalry-class)
				(and
					(goal g-support-unit-class cavalry-class)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-stirrups)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-stirrups c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-stirrups)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-cavalry-class > 6)
				(or
					(unit-type-count cavalry-class > 10)
					(unit-type-count scout-cavalry-line > 10)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-stirrups)
			=>
			(research ri-stirrups)
			)

		;-------------
		;	Bagains
		;-------------

			(defrule
			(or
				(goal g-primary-unit militiaman)
				(and
					(goal g-support-unit militiaman)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(can-research-with-escrow ri-bagains)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-bagains c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-bagains)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-militia > 10)
				(unit-type-count militiaman-line > 15))
			(can-research ri-bagains)
			=>
			(research ri-bagains)
			)

	#end-if

	#load-if-defined BURMESE-CIV

		;-------------
		;	Howdah
		;-------------

			(defrule
			(or
				(goal g-game-focus BOOM)
				(goal g-game-focus REBUILD))
			(up-object-type-count-total c: town-center g:< g-desired-num-town-center)
			=>
			(up-jump-rule 2)
			)

				(defrule
				(or
					(goal g-primary-unit battle-elephant)
					(and
						(goal g-support-unit battle-elephant)
						(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research-with-escrow ri-howdah)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-howdah c: 1)
				(up-modify-escrow food g:- g-food-cost)
				(up-modify-escrow wood g:- g-wood-cost)
				(research ri-howdah)
				)

				(defrule
				(or
					(up-compare-goal g-desired-num-battle-elephant > 6)
					(unit-type-count-total battle-elephant-line > 10))
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research ri-howdah)
				=>
				(research ri-howdah)
				)

		;---------------------
		;	Manipur Cavalry
		;---------------------

			(defrule
			(or
				(goal g-primary-unit-class cavalry-class)
				(and
					(goal g-support-unit-class cavalry-class)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(can-research-with-escrow ri-manipur-cavalry)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-manipur-cavalry c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-manipur-cavalry)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-cavalry-class > 10)
				(or
					(unit-type-count cavalry-class > 15)
					(or
						(unit-type-count scout-cavalry-line > 15)
						(or
							(up-compare-goal g-desired-num-unique-unit > 10)
							(unit-type-count-total my-unique-unit-line > 15)))))
			(can-research ri-manipur-cavalry)
			=>
			(research ri-manipur-cavalry)
			)

	#end-if

	#load-if-defined BYZANTINE-CIV

		;----------------
		;	Greek Fire
		;----------------

			(defrule
			(up-compare-goal g-desired-num-fire-ship >= 10)
			(research-completed ri-war-galley)
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1250))
			(can-research-with-escrow ri-greek-fire)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-greek-fire c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow wood g:- g-wood-cost)
			(research ri-greek-fire)
			)

			(defrule
			(up-compare-goal g-desired-num-fire-ship > 5)
			(research-completed ri-war-galley)
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1250))
			(can-research ri-greek-fire)
			=>
			(research ri-greek-fire)
			)

		;---------------
		;	Logistica
		;---------------

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(and
					(goal g-support-unit my-unique-unit)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(can-research-with-escrow ri-logistica)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-logistica c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-logistica)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-unique-unit > 10)
				(unit-type-count-total my-unique-unit-line > 15))
			(can-research ri-logistica)
			=>
			(research ri-logistica)
			)

	#end-if

	#load-if-defined CELTIC-CIV

		;-------------------
		;	Furor Celtica
		;-------------------

			(defrule
			(or
				(up-compare-goal g-desired-num-ram-type >= 3)
				(or
					(up-compare-goal g-desired-num-mangonel-type >= 3)
					(up-compare-goal g-desired-num-scorpion-type >= 5)))
			(can-research-with-escrow ri-furor-celtica)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-furor-celtica c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-furor-celtica)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-ram-type > 0)
				(or
					(up-compare-goal g-desired-num-mangonel-type > 0)
					(or
						(up-compare-goal g-desired-num-scorpion-type > 0)
						(or
							(unit-type-count battering-ram-line > 2)
							(or
								(unit-type-count-total my-mangonel-line > 2)
								(unit-type-count scorpion-line > 2))))))
			(can-research ri-furor-celtica)
			=>
			(research ri-furor-celtica)
			)

	#end-if

	#load-if-defined CHINESE-CIV

		;----------------
		;	Great Wall
		;----------------

			(defrule
			(or
				(up-compare-goal g-desired-num-tower > 4)
				(or
					(up-compare-goal g-desired-num-bombard-tower > 4)
					(unit-type-count gate-class > 2)))
			(can-research ri-great-wall)
			=>
			(research ri-great-wall)
			)

		;--------------
		;	Rocketry
		;--------------

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(or
					(and
						(goal g-support-unit my-unique-unit)
						(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS))
					(up-compare-goal g-desired-num-scorpion-type > 4)))
			(can-research-with-escrow ri-rocketry)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-rocketry c: 1)
			(up-modify-escrow wood g:- g-wood-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-rocketry)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-unique-unit > 10)
				(or
					(unit-type-count-total my-unique-unit-line > 15)
					(or
						(up-compare-goal g-desired-num-scorpion-type > 2)
						(unit-type-count scorpion-line > 3))))
			(can-research ri-rocketry)
			=>
			(research ri-rocketry)
			)

	#end-if

	#load-if-defined CUMANS-CIV

		;----------------------
		;	Steppe Husbandry
		;----------------------

			(defrule
			(or
				(goal g-primary-unit scout-cavalry)
				(or
					(goal g-primary-unit cavalry-archer)
					(goal g-primary-unit steppe-lancer)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-steppe-husbandry)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-steppe-husbandry c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow wood g:- g-wood-cost)
			(research ri-steppe-husbandry)
			)
			(defrule
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(or
				(goal g-support-unit scout-cavalry)
				(or
					(goal g-support-unit cavalry-archer)
					(goal g-support-unit steppe-lancer)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-steppe-husbandry)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-steppe-husbandry c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow wood g:- g-wood-cost)
			(research ri-steppe-husbandry)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-scout-cavalry > 10)
				(or
					(unit-type-count scout-cavalry-line > 15)
					(or
						(up-compare-goal g-desired-num-cavalry-archer > 10)
						(or
							(unit-type-count cavalry-archer-line > 15)
							(or
								(up-compare-goal g-desired-num-steppe-lancer > 10)
								(unit-type-count steppe-lancer-line > 15))))))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-steppe-husbandry)
			=>
			(research ri-steppe-husbandry)
			)

	#end-if

	#load-if-defined DRAVIDIANS-CIV

		;-----------------
		;	Wootz Steel
		;-----------------

			(defrule
			(or
				(goal g-primary-unit militiaman)
				(or
					(goal g-primary-unit condottiero)
					(goal g-primary-unit my-unique-unit)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-wootz-steel)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-wootz-steel c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-wootz-steel)
			)
			(defrule
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(or
				(goal g-support-unit militiaman)
				(or
					(goal g-support-unit condottiero)
					(goal g-support-unit my-unique-unit)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-wootz-steel)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-wootz-steel c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-wootz-steel)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-militia > 10)
				(or
					(unit-type-count militiaman-line > 15)
					(or
						(up-compare-goal g-desired-num-condottiero > 10)
						(or
							(unit-type-count condottiero > 15)
							(or
								(up-compare-goal g-desired-num-unique-unit > 10)
								(unit-type-count-total my-unique-unit-line > 15))))))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-wootz-steel)
			=>
			(research ri-wootz-steel)
			)

		;-------------------
		;	Medical Corps
		;-------------------

			(defrule
			(or
				(up-compare-goal g-desired-num-elephant-archer > 10)
				(unit-type-count elephant-archer-line > 15))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-medical-corps)
			=>
			(research ri-medical-corps)
			)

	#end-if

	#load-if-defined ETHIOPIAN-CIV

		;-----------------
		;	Royal Heirs
		;-----------------

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(and
					(goal g-support-unit my-unique-unit)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-royal-heirs)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-royal-heirs c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-royal-heirs)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-unique-unit > 10)
				(unit-type-count-total my-unique-unit-line > 15))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-royal-heirs)
			=>
			(research ri-royal-heirs)
			)

		;---------------------
		;	Torsion Engines
		;---------------------

			(defrule
			(or
				(up-compare-goal g-desired-num-ram-type >= 3)
				(or
					(up-compare-goal g-desired-num-mangonel-type >= 3)
					(up-compare-goal g-desired-num-scorpion-type >= 5)))
			(can-research-with-escrow ri-torsion-engines)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-torsion-engines c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-torsion-engines)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-ram-type > 0)
				(or
					(up-compare-goal g-desired-num-mangonel-type > 0)
					(or
						(up-compare-goal g-desired-num-scorpion-type > 0)
						(or
							(unit-type-count battering-ram-line > 2)
							(or
								(unit-type-count-total my-mangonel-line > 2)
								(unit-type-count scorpion-line > 2))))))
			(can-research ri-torsion-engines)
			=>
			(research ri-torsion-engines)
			)

	#end-if

	#load-if-defined FRANKISH-CIV

		;--------------
		;	Chivalry
		;--------------

			(defrule
			(or
				(goal g-game-focus BOOM)
				(goal g-game-focus REBUILD))
			(up-object-type-count-total c: town-center g:< g-desired-num-town-center)
			=>
			(up-jump-rule 2)
			)

				(defrule
				(or
					(goal g-primary-unit-class cavalry-class)
					(and
						(goal g-support-unit-class cavalry-class)
						(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research-with-escrow ri-chivalry)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-chivalry c: 1)
				(up-modify-escrow wood g:- g-wood-cost)
				(up-modify-escrow gold g:- g-gold-cost)
				(research ri-chivalry)
				)

				(defrule
				(or
					(up-compare-goal g-desired-num-scout-cavalry > 10)
					(up-compare-goal g-desired-num-knight > 10))
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research ri-chivalry)
				=>
				(research ri-chivalry)
				)

		;-----------------
		;	Bearded Axe
		;-----------------

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(and
					(goal g-support-unit my-unique-unit)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(can-research-with-escrow ri-bearded-axe)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-bearded-axe c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-bearded-axe)
			)

			(defrule
			(up-compare-goal g-desired-num-unique-unit > 6)
			(can-research ri-bearded-axe)
			=>
			(research ri-bearded-axe)
			)

	#end-if

	#load-if-defined GEORGIANS-CIV

		;-----------------
		;	Svan Towers
		;-----------------

			(defrule
			(up-compare-goal g-desired-num-tower >= 3)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-svan-towers)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-svan-towers c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-svan-towers)
			)

			(defrule
			(up-compare-goal g-tower-line >= 3)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-svan-towers)
			=>
			(research ri-svan-towers)
			)

		;---------------------
		;	Aznauri Cavalry
		;---------------------

			(defrule
			(or
				(unit-type-count cavalry-class >= 12)
				(unit-type-count cavalry-archer-class >= 12))
			(can-research ri-aznauri-cavalry)
			=>
			(research ri-aznauri-cavalry)
			)

	#end-if

	#load-if-defined GOTHIC-CIV
	
		;-------------
		;	Anarchy
		;-------------

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(and
					(goal g-support-unit my-unique-unit)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-anarchy)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-anarchy c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-anarchy)
			)

			(defrule
			(up-compare-goal g-desired-num-unique-unit > 10)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-anarchy)
			=>
			(research ri-anarchy)
			)
	
		;---------------
		;	Perfusion
		;---------------

			(defrule
			(or
				(goal g-primary-unit-class infantry-class)
				(and
					(goal g-support-unit-class infantry-class)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(can-research-with-escrow ri-perfusion)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-perfusion c: 1)
			(up-modify-escrow wood g:- g-wood-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-perfusion)
			)

			(defrule
			(up-compare-goal g-desired-num-infantry-class > 10)
			(can-research ri-perfusion)
			=>
			(research ri-perfusion)
			)

	#end-if

	#load-if-defined GURJARAS-CIV

		;----------------
		;	Kshatriyas
		;----------------

			(defrule
			(or
				(goal g-primary-unit camel)
				(or
					(goal g-primary-unit scout-cavalry)
					(or
						(goal g-primary-unit elephant-archer)
						(or
							(goal g-primary-unit my-unique-unit)
							(goal g-primary-unit my-second-unique-unit)))))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-kshatriyas)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-kshatriyas c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-kshatriyas)
			)
			(defrule
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(or
				(goal g-support-unit camel)
				(or
					(goal g-support-unit scout-cavalry)
					(or
						(goal g-support-unit elephant-archer)
						(or
							(goal g-support-unit my-unique-unit)
							(goal g-support-unit my-second-unique-unit)))))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-kshatriyas)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-kshatriyas c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-kshatriyas)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-camel > 10)
				(or
					(up-compare-goal g-desired-num-scout-cavalry > 10)
					(or
						(up-compare-goal g-desired-num-second-unique-unit > 10)
						(or
							(up-compare-goal g-desired-num-elephant-archer > 8)
							(or
								(up-compare-goal g-desired-num-unique-unit > 10)
								(up-compare-goal g-desired-num-militia > 15))))))
			(can-research ri-kshatriyas)
			=>
			(research ri-kshatriyas)
			)

		;---------------------
		;	Frontier Guards
		;---------------------

			(defrule
			(or
				(goal g-primary-unit camel)
				(goal g-primary-unit elephant-archer))
			(can-research-with-escrow ri-frontier-guards)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-frontier-guards c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-frontier-guards)
			)
			(defrule
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(or
				(goal g-support-unit camel)
				(goal g-support-unit elephant-archer))
			(can-research-with-escrow ri-frontier-guards)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-frontier-guards c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-frontier-guards)
			)

	#end-if

	#load-if-defined HUN-CIV

		;---------------
		;	Marauders
		;---------------

			(defrule
			(or
				(goal g-game-focus BOOM)
				(goal g-game-focus REBUILD))
			(up-object-type-count-total c: town-center g:< g-desired-num-town-center)
			=>
			(up-jump-rule 3)
			)

				(defrule
				(goal g-primary-unit my-unique-unit)
				(up-compare-goal g-unique-unit-tech-progress >= SECONDARY-CASTLE-COMPLETE)
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research-with-escrow ri-marauders)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-marauders c: 1)
				(up-modify-escrow wood g:- g-wood-cost)
				(up-modify-escrow gold g:- g-gold-cost)
				(research ri-marauders)
				)
				(defrule
				(goal g-support-unit my-unique-unit)
				(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
				(up-compare-goal g-unique-unit-tech-progress >= SECONDARY-CASTLE-COMPLETE)
				(up-compare-goal g-desired-num-unique-unit >= 12)
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research-with-escrow ri-marauders)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-marauders c: 1)
				(up-modify-escrow wood g:- g-wood-cost)
				(up-modify-escrow gold g:- g-gold-cost)
				(research ri-marauders)
				)

				(defrule
				(or
					(up-compare-goal g-desired-num-unique-unit > 15)
					(and
						(population >= NINETY-PERCENT-POP)
						(up-compare-goal g-desired-num-unique-unit > 10)))
				(up-compare-goal g-unique-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
				(can-research ri-marauders)
				=>
				(research ri-marauders)
				)

	#end-if

	#load-if-defined INCAN-CIV

		;------------------
		;	Andean Sling
		;------------------

			(defrule
			(goal g-primary-unit skirmisher)
			(or
				(unit-type-count-total skirmisher-line >= 10)
				(unit-type-count-total skirmisher-line g:>= g-desired-num-skirmisher))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1200))
			(can-research-with-escrow ri-andean-sling)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-andean-sling c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-andean-sling)
			)
			(defrule
			(goal g-primary-unit slinger)
			(or
				(unit-type-count slinger >= 10)
				(unit-type-count slinger g:>= g-desired-num-skirmisher))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1200))
			(can-research-with-escrow ri-andean-sling)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-andean-sling c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-andean-sling)
			)
			(defrule
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(goal g-support-unit skirmisher)
			(or
				(unit-type-count-total skirmisher-line >= 12)
				(unit-type-count-total skirmisher-line g:>= g-desired-num-skirmisher))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1200))
			(can-research-with-escrow ri-andean-sling)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-andean-sling c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-andean-sling)
			)
			(defrule
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(goal g-support-unit slinger)
			(or
				(unit-type-count slinger >= 12)
				(unit-type-count slinger g:>= g-desired-num-skirmisher))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1200))
			(can-research-with-escrow ri-andean-sling)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-andean-sling c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-andean-sling)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-skirmisher > 10)
				(up-compare-goal g-desired-num-second-unique-unit > 10))
			(or
				(unit-type-count-total skirmisher-line > 15)
				(unit-type-count slinger > 15))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1200))
			(can-research ri-andean-sling)
			=>
			(research ri-andean-sling)
			)
			(defrule
			(population >= NINETY-PERCENT-POP)
			(or
				(unit-type-count-total skirmisher-line > 5)
				(unit-type-count slinger > 5))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1200))
			(can-research ri-andean-sling)
			=>
			(research ri-andean-sling)
			)

		;-----------------------------
		;	Couriers/Fabric Shields
		;-----------------------------

			(defrule
			(or
				(goal g-primary-unit eagle-warrior)
				(or
					(goal g-primary-unit slinger)
					(goal g-primary-unit my-unique-unit)))
			(can-research-with-escrow ri-fabric-shields)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-fabric-shields c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-fabric-shields)
			)
			(defrule
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(or
				(goal g-support-unit eagle-warrior)
				(or
					(goal g-support-unit slinger)
					(goal g-support-unit my-unique-unit)))
			(can-research-with-escrow ri-fabric-shields)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-fabric-shields c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-fabric-shields)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-eagle-warrior > 10)
				(or
					(up-compare-goal g-desired-num-second-unique-unit > 10)
					(up-compare-goal g-desired-num-unique-unit > 10)))
			(or
				(unit-type-count-total eagle-warrior-line > 15)
				(or
					(unit-type-count slinger > 15)
					(unit-type-count-total my-unique-unit-line > 15)))
			(can-research ri-fabric-shields)
			=>
			(research ri-fabric-shields)
			)
			(defrule
			(population >= NINETY-PERCENT-POP)
			(or
				(unit-type-count-total eagle-warrior-line > 5)
				(or
					(unit-type-count slinger > 5)
					(unit-type-count-total my-unique-unit-line > 5)))
			(can-research ri-fabric-shields)
			=>
			(research ri-fabric-shields)
			)

	#end-if

	#load-if-defined INDIAN-CIV

		;----------------------
		;	Grand Trunk Road
		;----------------------

			(defrule
			(or
				(goal g-game-focus BOOM)
				(goal g-game-focus REBUILD))
			(up-object-type-count-total c: town-center g:< g-desired-num-town-center)
			=>
			(up-jump-rule 1)
			)

				(defrule
				(goal g-town-under-attack NO)
				(up-get-fact resource-amount amount-relics g-temp)
				(or
					(unit-type-count villager-gold > 10)
					(or
						(unit-type-count trade-cart > 10)
						(up-compare-goal g-temp >= 2)))
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research-with-escrow ri-grand-trunk-road)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-grand-trunk-road c: 1)
				(up-modify-escrow food g:- g-food-cost)
				(up-modify-escrow wood g:- g-wood-cost)
				(research ri-grand-trunk-road)
				)

			(defrule
			(goal g-town-under-attack NO)
			(up-get-fact resource-amount amount-relics g-temp)
			(or
				(unit-type-count villager-gold > 5)
				(or
					(unit-type-count trade-cart > 5)
					(up-compare-goal g-temp >= 2)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-research-status c: ri-grand-trunk-road == research-available)
			(building-type-count castle > 0)
			(can-research ri-grand-trunk-road)
			=>
			(research ri-grand-trunk-road)
			)

			(defrule
			(goal g-town-under-attack NO)
			(up-get-fact resource-amount amount-relics g-temp)
			(or
				(unit-type-count villager-gold > 5)
				(or
					(unit-type-count trade-cart > 5)
					(up-compare-goal g-temp >= 1)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-grand-trunk-road)
			=>
			(research ri-grand-trunk-road)
			)

		;--------------
		;	Shatagni
		;--------------

			(defrule
			(or
				(goal g-primary-unit hand-cannoneer)
				(and
					(goal g-support-unit hand-cannoneer)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(can-research-with-escrow ri-shatagni)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-shatagni c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-shatagni)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-hand-cannoneer > 10)
				(unit-type-count hand-cannoneer > 15))
			(can-research ri-shatagni)
			=>
			(research ri-shatagni)
			)

	#end-if

	#load-if-defined ITALIAN-CIV

		;------------
		;	Pavise
		;------------

			(defrule
			(or
				(goal g-primary-unit condottiero)
				(and
					(goal g-support-unit condottiero)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-research-status c: ri-chain-mail >= research-pending)
			(up-research-status c: ri-iron-casting >= research-pending)
			(can-research-with-escrow ri-pavise)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-pavise c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-pavise)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-condottiero > 10)
				(unit-type-count condottiero > 15))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-research-status c: ri-chain-mail >= research-pending)
			(up-research-status c: ri-iron-casting >= research-pending)
			(can-research ri-pavise)
			=>
			(research ri-pavise)
			)

			(defrule
			(or
				(goal g-primary-unit archer)
				(goal g-primary-unit my-unique-unit))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-research-status c: ri-leather-archer-armor >= research-pending)
			(up-research-status c: ri-bodkin-arrow >= research-pending)
			(can-research-with-escrow ri-pavise)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-pavise c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-pavise)
			)
			(defrule
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(or
				(goal g-support-unit archer)
				(goal g-support-unit my-unique-unit))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-research-status c: ri-leather-archer-armor >= research-pending)
			(up-research-status c: ri-bodkin-arrow >= research-pending)
			(can-research-with-escrow ri-pavise)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-pavise c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-pavise)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-archer > 10)
				(or
					(unit-type-count archer-line > 15)
					(or
						(up-compare-goal g-desired-num-unique-unit > 10)
						(unit-type-count-total my-unique-unit-line > 15))))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-research-status c: ri-leather-archer-armor >= research-pending)
			(up-research-status c: ri-bodkin-arrow >= research-pending)
			(can-research ri-pavise)
			=>
			(research ri-pavise)
			)

		;---------------
		;	Silk Road
		;---------------

			(defrule
			(or
				(up-compare-goal g-desired-num-trade-cart > 0)
				(up-compare-goal g-desired-num-trade-cog > 0))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-research-status c: ri-caravan >= research-pending)
			(can-research-with-escrow ri-silk-road)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-silk-road c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-silk-road)
			)

	#end-if

	#load-if-defined JAPANESE-CIV

		;------------
		;	Yasama
		;------------

			(defrule
			(or
				(goal g-game-focus BOOM)
				(goal g-game-focus REBUILD))
			(up-object-type-count-total c: town-center g:< g-desired-num-town-center)
			=>
			(up-jump-rule 2)
			)

				(defrule
				(up-compare-goal g-desired-num-tower >= 4)
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research-with-escrow ri-yasama)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-yasama c: 1)
				(up-modify-escrow food g:- g-food-cost)
				(up-modify-escrow wood g:- g-wood-cost)
				(research ri-yasama)
				)

				(defrule
				(or
					(up-compare-goal g-desired-num-tower > 1)
					(up-compare-goal g-tower-line > 3))
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research ri-yasama)
				=>
				(research ri-yasama)
				)

		;----------------
		;	Kataparuto
		;----------------

			(defrule
			(up-compare-goal g-desired-num-trebuchet >= 3)
			(can-research-with-escrow ri-kataparuto)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-kataparuto c: 1)
			(up-modify-escrow wood g:- g-wood-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-kataparuto)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-trebuchet > 1)
				(unit-type-count trebuchet-set > 1))
			(can-research ri-kataparuto)
			=>
			(research ri-kataparuto)
			)

	#end-if

	#load-if-defined JURCHENS-CIV

		;------------------------
		;	Fortified Bastions
		;------------------------

			(defrule
			(or
				(up-compare-goal g-desired-num-castle > 1)
				(and
					(up-compare-goal g-desired-num-castle > 0)
					(up-compare-goal g-game-focus == DEFENSIVE)))
			(can-research-with-escrow ri-fortified-bastions)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-fortified-bastions c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow wood g:- g-wood-cost)
			(research ri-fortified-bastions)
			)

			(defrule
			(building-type-count castle >= 2)
			(can-research ri-fortified-bastions)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			=>
			(research ri-fortified-bastions)
			)

		;-----------------------
		;	Thunderclap Bombs
		;-----------------------

			(defrule
			(or
				(up-compare-goal g-desired-num-second-unique-unit >= 10)
				(up-compare-goal g-desired-num-mangonel-type >= 3))
			(can-research-with-escrow ri-thunderclap-bombs)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-thunderclap-bombs c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-thunderclap-bombs)
			)

			(defrule
			(or
				(unit-type-count my-second-unique-unit-line >= 10)
				(or
					(unit-type-count my-mangonel-line >= 3)
					(unit-type-count lou-chuan >= 3)))
			(can-research ri-thunderclap-bombs)
			=>
			(research ri-thunderclap-bombs)
			)

	#end-if

	#load-if-defined KHITANS-CIV

		;--------------------
		;	Lamellar Armor
		;--------------------

			(defrule
			(or
				(goal g-primary-unit-class infantry-class)
				(goal g-primary-unit skirmisher))
			(can-research-with-escrow ri-lamellar-armor)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-lamellar-armor c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-lamellar-armor)
			(up-jump-rule 1)
			)
				(defrule
				(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
				(or
					(goal g-support-unit-class infantry-class)
					(goal g-support-unit skirmisher))
				(can-research-with-escrow ri-lamellar-armor)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-lamellar-armor c: 1)
				(up-modify-escrow food g:- g-food-cost)
				(up-modify-escrow gold g:- g-gold-cost)
				(research ri-lamellar-armor)
				)

			(defrule
			(or
				(unit-type-count infantry-class >= 10)
				(unit-type-count skirmisher-line >= 10))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-lamellar-armor)
			=>
			(research ri-lamellar-armor)
			)

		;------------------
		;	Ordo Cavalry
		;------------------

			(defrule
			(goal g-primary-unit-class cavalry-class)
			(unit-type-count cavalry-class >= 10)
			(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
			(can-research-with-escrow ri-ordo-cavalry)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-ordo-cavalry c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-ordo-cavalry)
			(up-jump-rule 1)
			)
				(defrule
				(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
				(goal g-support-unit-class cavalry-class)
				(unit-type-count cavalry-class >= 12)
				(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
				(can-research-with-escrow ri-ordo-cavalry)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-ordo-cavalry c: 1)
				(up-modify-escrow food g:- g-food-cost)
				(up-modify-escrow gold g:- g-gold-cost)
				(research ri-ordo-cavalry)
				)

			(defrule
			(unit-type-count cavalry-class >= 12)
			(can-research ri-ordo-cavalry)
			=>
			(research ri-ordo-cavalry)
			)

	#end-if

	#load-if-defined KHMER-CIV

		;-----------------
		;	Tusk Swords
		;-----------------

			(defrule
			(or
				(goal g-game-focus BOOM)
				(goal g-game-focus REBUILD))
			(up-object-type-count-total c: town-center g:< g-desired-num-town-center)
			=>
			(up-jump-rule 2)
			)
			
				(defrule
				(or
					(goal g-primary-unit battle-elephant)
					(and
						(goal g-support-unit battle-elephant)
						(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research-with-escrow ri-yasama)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-yasama c: 1)
				(up-modify-escrow wood g:- g-wood-cost)
				(up-modify-escrow gold g:- g-gold-cost)
				(research ri-yasama)
				)

				(defrule
				(or
					(up-compare-goal g-desired-num-battle-elephant > 6)
					(unit-type-count-total battle-elephant-line > 10))
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research ri-yasama)
				=>
				(research ri-yasama)
				)

		;---------------------
		;	Double Crossbow
		;---------------------
			
			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(or
					(and
						(goal g-support-unit my-unique-unit)
						(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS))
					(up-compare-goal g-desired-num-scorpion-type > 5)))
			(can-research-with-escrow ri-double-crossbow)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-double-crossbow c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-double-crossbow)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-unique-unit > 6)
				(or
					(unit-type-count-total my-unique-unit-line > 10)
					(or
						(up-compare-goal g-desired-num-scorpion-type > 2)
						(unit-type-count scorpion-line > 4))))
			(can-research ri-double-crossbow)
			=>
			(research ri-double-crossbow)
			)

	#end-if

	#load-if-defined KOREAN-CIV

		;--------------
		;	Eupseong
		;--------------

			(defrule
			(or
				(goal g-game-focus BOOM)
				(goal g-game-focus REBUILD))
			(up-object-type-count-total c: town-center g:< g-desired-num-town-center)
			=>
			(up-jump-rule 2)
			)
		
				(defrule
				(up-compare-goal g-desired-num-tower >= 3)
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research-with-escrow ri-eupseong)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-eupseong c: 1)
				(up-modify-escrow food g:- g-food-cost)
				(up-modify-escrow wood g:- g-wood-cost)
				(research ri-eupseong)
				)

				(defrule
				(or
					(up-compare-goal g-desired-num-tower > 2)
					(up-compare-goal g-tower-line > 3))
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research ri-eupseong)
				=>
				(research ri-eupseong)
				)

		;----------------
		;	Shinkichon
		;----------------

			(defrule
			(up-compare-goal g-desired-num-mangonel-type >= 3)
			(can-research-with-escrow ri-shinkichon)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-shinkichon c: 1)
			(up-modify-escrow wood g:- g-wood-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-shinkichon)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-mangonel-type > 2)
				(unit-type-count-total my-mangonel-line > 4))
			(can-research ri-shinkichon)
			=>
			(research ri-shinkichon)
			)

	#end-if

	#load-if-defined LITHUANIANS-CIV

		;----------------
		;	Hill Forts
		;----------------

			(defrule
			(building-type-count town-center >= 3)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-hill-forts)
			=>
			(research ri-hill-forts)
			)

		;-------------------
		;	Tower Shields
		;-------------------

			(defrule
			(or
				(goal g-primary-unit spearman)
				(goal g-primary-unit skirmisher))
			(can-research-with-escrow ri-tower-shields)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-tower-shields c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-tower-shields)
			)
			(defrule
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(or
				(goal g-support-unit spearman)
				(goal g-support-unit skirmisher))
			(can-research-with-escrow ri-tower-shields)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-tower-shields c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-tower-shields)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-spearman > 10)
				(or
					(unit-type-count spearman-line > 15)
					(or
						(up-compare-goal g-desired-num-skirmisher > 10)
						(unit-type-count-total skirmisher-line > 15))))
			(can-research ri-tower-shields)
			=>
			(research ri-tower-shields)
			)

	#end-if

	#load-if-defined MAGYAR-CIV

		;--------------------
		;	Corvinian Army
		;--------------------

			(defrule
			(goal g-primary-unit my-unique-unit)
			(up-compare-goal g-desired-num-unique-unit >= 15)
			(up-compare-goal g-unique-unit-tech-progress >= REQUIRED-IMPERIAL-COMPLETE)
			(can-research-with-escrow ri-corvinian-army)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-corvinian-army c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-corvinian-army)
			)
			(defrule
			(goal g-support-unit my-unique-unit)
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(up-compare-goal g-desired-num-unique-unit >= 15)
			(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
			(up-compare-goal g-unique-unit-tech-progress >= REQUIRED-IMPERIAL-COMPLETE)
			(can-research-with-escrow ri-corvinian-army)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-corvinian-army c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-corvinian-army)
			)
			(defrule
			(goal g-age-status LATE-IMPERIAL)
			(or
				(goal g-primary-unit my-unique-unit)
				(and
					(goal g-support-unit my-unique-unit)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(up-compare-goal g-desired-num-unique-unit > 10)
			(can-research-with-escrow ri-corvinian-army)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-corvinian-army c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-corvinian-army)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-unique-unit > 15)
				(and
					(population >= NINETY-PERCENT-POP)
					(up-compare-goal g-desired-num-unique-unit > 10)))
			(up-compare-goal g-unique-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
			(up-compare-goal g-desired-num-unique-unit > 10)
			(can-research ri-corvinian-army)
			=>
			(research ri-corvinian-army)
			)
			(defrule
			(goal g-age-status LATE-IMPERIAL)
			(up-compare-goal g-desired-num-unique-unit > 10)
			(can-research ri-corvinian-army)
			=>
			(research ri-corvinian-army)
			)

		;-----------------
		;	Recurve Bow
		;-----------------

			(defrule
			(goal g-primary-unit cavalry-archer)
			(up-compare-goal g-cavalry-archer-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
			(can-research-with-escrow ri-recurve-bow)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-recurve-bow c: 1)
			(up-modify-escrow wood g:- g-wood-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-recurve-bow)
			)
			(defrule
			(goal g-support-unit cavalry-archer)
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
			(up-compare-goal g-cavalry-archer-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
			(can-research-with-escrow ri-recurve-bow)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-recurve-bow c: 1)
			(up-modify-escrow wood g:- g-wood-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-recurve-bow)
			)

			(defrule
			(or
				(unit-type-count-total cavalry-archer-line > 15)
				(and
					(population >= NINETY-PERCENT-POP)
					(unit-type-count-total cavalry-archer-line > 8)))
			(up-compare-goal g-unique-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
			(can-research ri-recurve-bow)
			=>
			(research ri-recurve-bow)
			)

	#end-if

	#load-if-defined MALAY-CIV

		;-------------------
		;	Thalassocracy
		;-------------------

			(defrule
			(up-compare-goal g-desired-num-dock >= 4)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-thalassocracy)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-thalassocracy c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-thalassocracy)
			)

			(defrule
			(up-compare-goal g-desired-num-dock > 1)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-thalassocracy)
			=>
			(research ri-thalassocracy)
			)

		;-----------------
		;	Forced Levy
		;-----------------

			(defrule
			(or
				(goal g-primary-unit militiaman)
				(and
					(goal g-support-unit militiaman)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(can-research-with-escrow ri-forced-levy)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-forced-levy c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-forced-levy)
			)
			(defrule
			(up-compare-goal g-desired-num-militia > 10)
			(goal g-age-status LATE-IMPERIAL)
			(can-research-with-escrow ri-forced-levy)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-forced-levy c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-forced-levy)
			)

			(defrule
			(up-compare-goal g-desired-num-militia > 10)
			(can-research ri-forced-levy)
			=>
			(research ri-forced-levy)
			)

	#end-if

	#load-if-defined MALIAN-CIV
	
		;-----------
		;	Tigui
		;-----------

			(defrule
			(building-type-count town-center >= 3)
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1200))
			(can-research ri-tigui)
			=>
			(research ri-tigui)
			)

		;-------------
		;	Farimba
		;-------------

			(defrule
			(or
				(goal g-primary-unit-class cavalry-class)
				(and
					(goal g-support-unit-class cavalry-class)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(can-research-with-escrow ri-farimba)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-farimba c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-farimba)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-cavalry-class > 10)
				(or
					(unit-type-count cavalry-class > 15)
					(unit-type-count scout-cavalry-line > 15)))
			(can-research ri-farimba)
			=>
			(research ri-farimba)
			)

	#end-if

	#load-if-defined MAYAN-CIV
		
		;-------------------------
		;	Hul'Che Javelineers
		;-------------------------
			
			(defrule
			(or
				(goal g-primary-unit skirmisher)
				(and
					(goal g-support-unit skirmisher)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(or
				(unit-type-count-total skirmisher-line >= 12)
				(unit-type-count-total skirmisher-line g:>= g-desired-num-skirmisher))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-hulche-javelineers)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-hulche-javelineers c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-hulche-javelineers)
			)

			(defrule
			(up-compare-goal g-desired-num-skirmisher > 10)
			(unit-type-count-total skirmisher-line > 15)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-hulche-javelineers)
			=>
			(research ri-hulche-javelineers)
			)
			(defrule
			(population >= NINETY-PERCENT-POP)
			(unit-type-count-total skirmisher-line > 5)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-hulche-javelineers)
			=>
			(research ri-hulche-javelineers)
			)

		;---------------
		;	El Dorado
		;---------------
			
			(defrule
			(or
				(goal g-primary-unit eagle-warrior)
				(and
					(goal g-support-unit eagle-warrior)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(up-research-status c: ri-elite-eagle-warrior >= research-pending)
			(can-research-with-escrow ri-el-dorado)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-el-dorado c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-el-dorado)
			)

			(defrule
			(up-compare-goal g-desired-num-eagle-warrior > 10)
			(unit-type-count-total eagle-warrior-line > 15)
			(up-research-status c: ri-elite-eagle-warrior >= research-pending)
			(can-research ri-el-dorado)
			=>
			(research ri-el-dorado)
			)
			(defrule
			(population >= EIGHTY-FIVE-PERCENT-POP)
			(unit-type-count-total eagle-warrior-line > 5)
			(up-research-status c: ri-elite-eagle-warrior >= research-pending)
			(can-research ri-el-dorado)
			=>
			(research ri-el-dorado)
			)

	#end-if

	#load-if-defined MONGOL-CIV

		;-----------
		;	Drill
		;-----------

			(defrule
			(or
				(up-compare-goal g-desired-num-ram-type >= 3)
				(or
					(up-compare-goal g-desired-num-mangonel-type >= 3)
					(up-compare-goal g-desired-num-scorpion-type >= 5)))
			(can-research-with-escrow ri-drill)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-drill c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-drill)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-ram-type > 0)
				(or
					(up-compare-goal g-desired-num-mangonel-type > 0)
					(or
						(up-compare-goal g-desired-num-scorpion-type > 0)
						(or
							(unit-type-count battering-ram-line > 2)
							(or
								(unit-type-count-total my-mangonel-line > 2)
								(unit-type-count scorpion-line > 2))))))
			(can-research ri-drill)
			=>
			(research ri-drill)
			)

	#end-if

	#load-if-defined PERSIAN-CIV

		;----------------
		;	Kamandaran
		;----------------
			
			(defrule
			(or
				(goal g-primary-unit archer)
				(and
					(goal g-support-unit archer)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-kamandaran)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-kamandaran c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-kamandaran)
			)
			(defrule
			(up-compare-goal g-desired-num-archer > 10)
			(goal g-age-status LATE-IMPERIAL)
			(can-research-with-escrow ri-kamandaran)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-kamandaran c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-kamandaran)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-archer > 10)
				(unit-type-count archer-line > 15))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-kamandaran)
			=>
			(research ri-kamandaran)
			)

		;--------------
		;	Citadels
		;--------------

			(defrule
			(or
				(up-compare-goal g-desired-num-castle > 1)
				(and
					(up-compare-goal g-desired-num-castle > 0)
					(up-compare-goal g-game-focus == DEFENSIVE)))
			(can-research-with-escrow ri-citadels)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-citadels c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow stone g:- g-stone-cost)
			(research ri-citadels)
			)

			(defrule
			(building-type-count-total castle >= 2)
			(can-research ri-citadels)
			=>
			(research ri-citadels)
			)

	#end-if

	#load-if-defined POLES-CIV

		;-------------------------
		;	Szlachta Privileges
		;-------------------------
			
			(defrule
			(or
				(goal g-primary-unit knight)
				(and
					(goal g-support-unit knight)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-szlachta-privileges)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-szlachta-privileges c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-szlachta-privileges)
			)

			(defrule
			(up-compare-goal g-desired-num-knight > 10)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-szlachta-privileges)
			=>
			(research ri-szlachta-privileges)
			)

		;---------------------
		;	Lechitic Legacy
		;---------------------
			
			(defrule
			(or
				(goal g-primary-unit scout-cavalry)
				(and
					(goal g-support-unit scout-cavalry)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(can-research-with-escrow ri-lechitic-legacy)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-lechitic-legacy c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-lechitic-legacy)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-scout-cavalry > 10)
				(unit-type-count scout-cavalry-line > 15))
			(can-research ri-lechitic-legacy)
			=>
			(research ri-lechitic-legacy)
			)

	#end-if

	#load-if-defined PORTUGUESE-CIV

		;-------------
		;	Carrack
		;-------------

			(defrule
			(up-compare-goal g-desired-num-unique-ship > 2)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-carrack)
			=>
			(research ri-carrack)
			)

		;--------------
		;	Arquebus
		;--------------
			
			(defrule
			(or
				(goal g-primary-unit hand-cannoneer)
				(or
					(goal g-primary-unit my-unique-unit)
					(up-compare-goal g-desired-num-cannon-type > 2)))
			(can-research-with-escrow ri-arquebus)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-arquebus c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-arquebus)
			)
			(defrule
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(or
				(goal g-support-unit hand-cannoneer)
				(goal g-support-unit my-unique-unit))
			(can-research-with-escrow ri-arquebus)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-arquebus c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-arquebus)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-hand-cannoneer > 10)
				(or
					(unit-type-count hand-cannoneer > 15)
					(or
						(up-compare-goal g-desired-num-unique-unit > 6)
						(or
							(unit-type-count-total my-unique-unit-line > 10)
							(or
								(up-compare-goal g-desired-num-cannon-type > 1)
								(or
									(unit-type-count my-cannon-line > 2)
									(unit-type-count cannon-galleon-line > 2)))))))
			(can-research ri-arquebus)
			=>
			(research ri-arquebus)
			)

	#end-if

	#load-if-defined ROMANS-CIV	

		;---------------
		;	Ballistas
		;---------------
			
			(defrule
			(up-compare-goal g-desired-num-scorpion-type >= 4)
			(can-research-with-escrow ri-ballistas)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-ballistas c: 1)
			(up-modify-escrow wood g:- g-wood-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-ballistas)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-scorpion-type > 0)
				(or
					(unit-type-count scorpion-line > 2)
					(or
						(up-compare-goal g-desired-num-galley > 0)
						(unit-type-count galley-line > 2))))
			(can-research ri-ballistas)
			=>
			(research ri-ballistas)
			)

		;------------------
		;	Comitatenses
		;------------------
			
			(defrule
			(or
				(goal g-primary-unit militiaman)
				(or
					(goal g-primary-unit knight)
					(goal g-primary-unit my-unique-unit)))
			(can-research-with-escrow ri-comitatenses)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-comitatenses c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-comitatenses)
			)
			(defrule
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(or
				(goal g-support-unit militiaman)
				(or
					(goal g-support-unit knight)
					(goal g-support-unit my-unique-unit)))
			(can-research-with-escrow ri-comitatenses)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-comitatenses c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-comitatenses)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-militia > 10)
				(or
					(up-compare-goal g-desired-num-unique-unit > 10)
					(up-compare-goal g-desired-num-knight > 10)))
			(can-research ri-comitatenses)
			=>
			(research ri-comitatenses)
			)

	#end-if

	#load-if-defined SARACEN-CIV

		;----------------
		;	Bimaristan
		;----------------

			(defrule
			(up-research-status c: ri-block-printing >= research-pending)
			(or
				(up-compare-goal g-desired-num-monk > 3)
				(unit-type-count monk > 5))
			(can-research ri-bimaristan)
			=>
			(research ri-bimaristan)
			)

		;------------------------------
		;	Counterweight Trebuchets
		;------------------------------

			(defrule
			(up-research-status c: ri-siege-engineers >= research-pending)
			(or
				(up-compare-goal g-desired-num-trebuchet >= 2)
				(or
					(unit-type-count trebuchet-set >= 3)
					(or
						(up-compare-goal g-desired-num-mangonel-type >= 2)
						(unit-type-count-total my-mangonel-line >= 3))))
			(can-research ri-counterweights)
			=>
			(research ri-counterweights)
			)

	#end-if

	#load-if-defined SHU-CIV

		;--------------------------
		;	Coiled Serpent Array
		;--------------------------

			(defrule
			(or
				(goal g-primary-unit spearman)
				(goal g-primary-unit my-unique-unit))
			(can-research-with-escrow ri-coiled-serpent-array)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-coiled-serpent-array c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-coiled-serpent-array)
			(up-jump-rule 1)
			)
				(defrule
				(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
				(or
					(goal g-support-unit spearman)
					(goal g-support-unit my-unique-unit))
				(can-research-with-escrow ri-coiled-serpent-array)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-coiled-serpent-array c: 1)
				(up-modify-escrow food g:- g-food-cost)
				(up-modify-escrow gold g:- g-gold-cost)
				(research ri-coiled-serpent-array)
				)

			(defrule
			(or
				(unit-type-count spearman-line > 12)
				(unit-type-count my-unique-unit-line > 12))
			(can-research ri-coiled-serpent-array)
			=>
			(research ri-coiled-serpent-array)
			)

		;-------------------
		;	Bolt Magazine
		;-------------------

			(defrule
			(or
				(goal g-primary-unit archer)
				(or
					(and
						(goal g-support-unit archer)
						(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS))
					(up-compare-goal g-desired-num-scorpion-type > 4)))
			(can-research-with-escrow ri-bolt-magazine)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-bolt-magazine c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-bolt-magazine)
			)

			(defrule
			(or
				(unit-type-count archer-line > 12)
				(unit-type-count my-scorpion-line > 4))
			(can-research ri-bolt-magazine)
			=>
			(research ri-bolt-magazine)
			)

	#end-if

	#load-if-defined SICILIANS-CIV

		;-------------
		;	Hauberk
		;-------------
			
			(defrule
			(or
				(goal g-primary-unit knight)
				(and
					(goal g-support-unit knight)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(can-research-with-escrow ri-hauberk)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-hauberk c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-hauberk)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-knight > 10)
				(unit-type-count knight-line > 15))
			(can-research ri-hauberk)
			=>
			(research ri-hauberk)
			)

	#end-if

	#load-if-defined SLAVIC-CIV

		;--------------
		;	Detinets
		;--------------

			(defrule
			(or
				(up-object-type-count-total c: castle g:< g-desired-num-castle)
				(up-compare-goal g-tower-line g:< g-desired-num-tower))
			(can-research ri-detinets)
			=>
			(research ri-detinets)
			)
			
		;--------------
		;	Druzhina
		;--------------
			
			(defrule
			(or
				(goal g-primary-unit-class infantry-class)
				(and
					(goal g-support-unit-class infantry-class)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(can-research-with-escrow ri-druzhina)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-druzhina c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-druzhina)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-infantry-class > 10)
				(unit-type-count infantry-class > 15))
			(can-research ri-druzhina)
			=>
			(research ri-druzhina)
			)

	#end-if

	#load-if-defined SPANISH-CIV

		;-----------------
		;	Inquisition
		;-----------------

			(defrule
			(up-research-status c: ri-block-printing >= research-pending)
			(or
				(up-compare-goal g-desired-num-monk > 3)
				(unit-type-count monk > 5))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1100))
			(can-research ri-inquisition)
			=>
			(research ri-inquisition)
			)

		;---------------
		;	Supremacy
		;---------------

			(defrule
			(up-modify-goal g-temp g:= g-desired-num-villager)
			(up-modify-goal g-temp c:- 10)
			(up-object-type-count c: villager g:>= g-temp)	;we have at least ten less than the total number of villagers we want
			(can-research ri-supremacy)
			=>
			(research ri-supremacy)
			)

	#end-if

	#load-if-defined TATARS-CIV

		;----------------
		;	Silk Armor
		;----------------
			
			(defrule
			(or
				(goal g-primary-unit scout-cavalry)
				(or
					(goal g-primary-unit cavalry-archer)
					(goal g-primary-unit steppe-lancer)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-silk-armor)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-silk-armor c: 1)
			(up-modify-escrow wood g:- g-wood-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-silk-armor)
			)
			(defrule
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(or
				(goal g-support-unit scout-cavalry)
				(or
					(goal g-support-unit cavalry-archer)
					(goal g-support-unit steppe-lancer)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-silk-armor)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-silk-armor c: 1)
			(up-modify-escrow wood g:- g-wood-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-silk-armor)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-scout-cavalry > 10)
				(or
					(unit-type-count scout-cavalry-line > 15)
					(or
						(up-compare-goal g-desired-num-cavalry-archer > 10)
						(or
							(unit-type-count cavalry-archer-line > 15)
							(or
								(up-compare-goal g-desired-num-steppe-lancer > 10)
								(unit-type-count steppe-lancer-line > 15))))))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-silk-armor)
			=>
			(research ri-silk-armor)
			)

		;------------------------
		;	Timurid Siegecraft
		;------------------------

			(defrule
			(up-compare-goal g-desired-num-trebuchet >= 4)
			(can-research-with-escrow ri-timurid-siegecraft)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-timurid-siegecraft c: 1)
			(up-modify-escrow wood g:- g-wood-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-timurid-siegecraft)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-trebuchet >= 2)
				(unit-type-count trebuchet-set >= 3))
			(can-research ri-timurid-siegecraft)
			=>
			(research ri-timurid-siegecraft)
			)

	#end-if

	#load-if-defined TEUTONIC-CIV

		;--------------
		;	Ironclad
		;--------------

			(defrule
			(or
				(goal g-game-focus BOOM)
				(goal g-game-focus REBUILD))
			(up-object-type-count-total c: town-center g:< g-desired-num-town-center)
			=>
			(up-jump-rule 2)
			)

				(defrule
				(or
					(up-compare-goal g-desired-num-ram-type >= 3)
					(or
						(up-compare-goal g-desired-num-mangonel-type >= 3)
						(or
							(up-compare-goal g-desired-num-scorpion-type >= 5)
							(or
								(up-compare-goal g-desired-num-cannon-type >= 3)
								(up-compare-goal g-desired-num-trebuchet >= 3)))))
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research-with-escrow ri-ironclad)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-ironclad c: 1)
				(up-modify-escrow wood g:- g-wood-cost)
				(up-modify-escrow gold g:- g-gold-cost)
				(research ri-ironclad)
				)

				(defrule
				(or
					(up-compare-goal g-desired-num-ram-type >= 2)
					(or
						(up-compare-goal g-desired-num-mangonel-type >= 2)
						(or
							(up-compare-goal g-desired-num-scorpion-type >= 2)
							(or
								(up-compare-goal g-desired-num-cannon-type >= 2)
								(up-compare-goal g-desired-num-trebuchet >= 2)))))
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research ri-ironclad)
				=>
				(research ri-ironclad)
				)

		;-------------------
		;	Crenellations
		;-------------------
			
			(defrule
			(or
				(up-compare-goal g-desired-num-castle >= 2)
				(and
					(up-compare-goal g-desired-num-castle >= 1)
					(goal g-game-focus DEFENSIVE)))
			(can-research-with-escrow ri-crenellations)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-crenellations c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow stone g:- g-stone-cost)
			(research ri-crenellations)
			)

			(defrule
			(up-compare-goal g-desired-num-castle > 0)
			(can-research ri-crenellations)
			=>
			(research ri-crenellations)
			)

	#end-if

	#load-if-defined TURKISH-CIV

		;------------
		;	Sipahi
		;------------
			
			(defrule
			(or
				(goal g-primary-unit cavalry-archer)
				(goal g-primary-unit genitour))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-sipahi)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-sipahi c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-sipahi)
			)
			(defrule
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(or
				(goal g-support-unit cavalry-archer)
				(goal g-support-unit genitour))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-sipahi)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-sipahi c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-sipahi)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-cavalry-archer > 10)
				(or
					(unit-type-count cavalry-archer-line > 15)
					(or
						(up-compare-goal g-desired-num-genitour > 10)
						(unit-type-count-total genitour-line > 15))))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-sipahi)
			=>
			(research ri-sipahi)
			)

		;---------------
		;	Artillery
		;---------------

			(defrule
			(or
				(goal g-game-focus BOOM)
				(goal g-game-focus REBUILD))
			(up-object-type-count-total c: town-center g:< g-desired-num-town-center)
			=>
			(up-jump-rule 1)
			)
				(defrule
				(or
					(up-compare-goal g-desired-num-bombard-tower >= 3)
					(or
						(up-compare-goal g-desired-num-cannon-type >= 2)
						(up-compare-goal g-desired-num-cannon-galleon >= 2)))
				(can-research-with-escrow ri-artillery)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-artillery c: 1)
				(up-modify-escrow wood g:- g-wood-cost)
				(up-modify-escrow gold g:- g-gold-cost)
				(research ri-artillery)
				)

			(defrule
			(or
				(up-compare-goal g-desired-num-bombard-tower > 2)
				(or
					(building-type-count bombard-tower > 3)
					(or
						(up-compare-goal g-desired-num-cannon-type > 1)
						(or
							(unit-type-count my-cannon-line > 2)
							(or
								(up-compare-goal g-desired-num-cannon-galleon > 1)
								(unit-type-count cannon-galleon-line > 2))))))
			(can-research ri-artillery)
			=>
			(research ri-artillery)
			)

	#end-if

	#load-if-defined VIETNAMESE-CIV

		;-------------
		;	Chatras
		;-------------
			
			(defrule
			(or
				(goal g-primary-unit battle-elephant)
				(and
					(goal g-support-unit battle-elephant)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-chatras)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-chatras c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-chatras)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-battle-elephant > 6)
				(unit-type-count-total battle-elephant-line > 10))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-chatras)
			=>
			(research ri-chatras)
			)

		;-----------------
		;	Paper Money
		;-----------------

			(defrule
			(can-research ri-paper-money)
			(up-compare-goal g-game-focus != DEFENSIVE)
			(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-IMPERIAL-COMPLETE)
			(population >= EIGHTY-PERCENT-POP)
			=>
			(research ri-paper-money)
			)

	#end-if

	#load-if-defined VIKING-CIV

		;----------------
		;	Chieftains
		;----------------
			
			(defrule
			(or
				(goal g-primary-unit-class infantry-class)
				(and
					(goal g-support-unit-class infantry-class)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-chieftains)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-chieftains c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-chieftains)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-infantry-class > 10)
				(unit-type-count infantry-class > 15))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-chieftains)
			=>
			(research ri-chieftains)
			)

		;----------------
		;	Bogsveigar
		;----------------

			(defrule
			(or
				(goal g-primary-unit archer)
				(and
					(goal g-support-unit archer)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(can-research-with-escrow ri-bogsveigar)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-bogsveigar c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-bogsveigar)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-archer > 10)
				(unit-type-count-total archer-line > 15))
			(can-research ri-bogsveigar)
			=>
			(research ri-bogsveigar)
			)

	#end-if

	#load-if-defined WEI-CIV

		;-------------
		;	Tuntian
		;-------------

			(defrule
			(soldier-count >= 20)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-tuntian)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-tuntian c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow wood g:- g-wood-cost)
			(research ri-tuntian)
			)

		;----------------------
		;	Ming Guang Armor
		;----------------------

			(defrule
			(or
				(goal g-primary-unit-class cavalry-class)
				(goal g-primary-unit-class cavalry-archer-class))
			(can-research-with-escrow ri-ming-guang-armor)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-ming-guang-armor c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-ming-guang-armor)
			(up-jump-rule 1)
			)
				(defrule
				(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
				(or
					(goal g-support-unit-class cavalry-class)
					(goal g-support-unit-class cavalry-archer-class))
				(can-research-with-escrow ri-ming-guang-armor)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-ming-guang-armor c: 1)
				(up-modify-escrow food g:- g-food-cost)
				(up-modify-escrow gold g:- g-gold-cost)
				(research ri-ming-guang-armor)
				)

			(defrule
			(or
				(unit-type-count cavalry-class > 10)
				(unit-type-count cavalry-archer-class > 12))
			(can-research ri-ming-guang-armor)
			=>
			(research ri-ming-guang-armor)
			)

	#end-if

	#load-if-defined WU-CIV

		;------------------------
		;	Red Cliffs Tactics
		;------------------------

			(defrule
			(unit-type-count my-unique-unit-line >= 12)
			(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
			(can-research-with-escrow ri-red-cliffs-tactics)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-red-cliffs-tactics c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-red-cliffs-tactics)
			)

		;-------------------
		;	Sitting Tiger
		;-------------------

			(defrule
			(or
				(unit-type-count traction-trebuchet > 2)
				(unit-type-count lou-chuan > 2))
			(can-research ri-sitting-tiger)
			=>
			(research ri-sitting-tiger)
			)

	#end-if

;=========================<>=========================
;				    CAVALRY TECHS
;=========================<>=========================

	;-----------------------------------------------------
	;	Elite Battle Elephant - Secondary Imperial Tech
	;-----------------------------------------------------

		#load-if-defined UP-GAME-WK

			(defrule
			(or
				(goal g-primary-unit battle-elephant)
				(and
					(goal g-support-unit battle-elephant)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(can-research-with-escrow ri-elite-battle-elephant)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-elite-battle-elephant c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-elite-battle-elephant)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-battle-elephant > 6)
				(unit-type-count-total battle-elephant-line > 10))
			(can-research ri-elite-battle-elephant)
			=>
			(research ri-elite-battle-elephant)
			)

		#end-if

	;---------------------------------------
	;	Cavalier - Required Imperial Tech
	;---------------------------------------

		(defrule
		(or
			(goal g-primary-unit knight)
			(goal g-support-unit knight))
		(can-research-with-escrow ri-cavalier)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-cavalier c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-cavalier)
		)

		(defrule
		(up-compare-goal g-desired-num-knight > 10)
		(unit-type-count knight-line > 15)
		(can-research ri-cavalier)
		=>
		(research ri-cavalier)
		)
		(defrule
		(population >= NINETY-PERCENT-POP)
		(unit-type-count knight-line >= 5)
		(can-research ri-cavalier)
		=>
		(research ri-cavalier)
		)

	;---------------------------------------
	;	Paladin - Secondary Imperial Tech
	;---------------------------------------

		(defrule
		(or
			(goal g-primary-unit knight)
			(goal g-support-unit knight))
		(player-in-game any-ally)
		(can-research-with-escrow ri-paladin)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-paladin c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-paladin)
		)

		(defrule
		(up-compare-goal g-desired-num-knight > 10)
		(unit-type-count knight-line >= 25)
		(can-research ri-paladin)
		=>
		(research ri-paladin)
		)
		(defrule
		(population >= NINETY-FIVE-PERCENT-POP)
		(player-in-game any-ally)
		(unit-type-count knight-line >= 10)
		(can-research ri-paladin)
		=>
		(research ri-paladin)
		)

	;---------------------------------------
	;	Savar - Secondary Imperial Tech
	;---------------------------------------

		(defrule
		(or
			(goal g-primary-unit knight)
			(goal g-support-unit knight))
		(player-in-game any-ally)
		(can-research-with-escrow ri-savar)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-savar c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-savar)
		)

		(defrule
		(up-compare-goal g-desired-num-knight > 10)
		(unit-type-count knight-line >= 25)
		(can-research ri-savar)
		=>
		(research ri-savar)
		)
		(defrule
		(population >= NINETY-FIVE-PERCENT-POP)
		(player-in-game any-ally)
		(unit-type-count knight-line >= 10)
		(can-research ri-savar)
		=>
		(research ri-savar)
		)

	;-----------------------------------------------------
	;	Elite Shrivamsha Rider - Priority Imperial Tech
	;-----------------------------------------------------

		#load-if-defined GURJARAS-CIV

			(defrule
			(or
				(goal g-primary-unit shrivamsha-rider)
				(goal g-support-unit shrivamsha-rider))
			(can-research-with-escrow ri-elite-shrivamsha-rider)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-elite-shrivamsha-rider c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-elite-shrivamsha-rider)
			)

			(defrule
			(up-compare-goal g-desired-num-second-unique-unit > 10)
			(unit-type-count shrivamsha-rider-line > 15)
			(can-research ri-elite-shrivamsha-rider)
			=>
			(research ri-elite-shrivamsha-rider)
			)
			(defrule
			(population >= NINETY-PERCENT-POP)
			(unit-type-count shrivamsha-rider-line > 7)
			(can-research ri-elite-shrivamsha-rider)
			=>
			(research ri-elite-shrivamsha-rider)
			)

		#end-if

	;------------------------------------------
	;	Heavy Camel - Required Imperial Tech
	;------------------------------------------

		(defrule
		(or
			(goal g-primary-unit camel)
			(goal g-support-unit camel))
		(can-research-with-escrow ri-heavy-camel)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-heavy-camel c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-heavy-camel)
		)

		(defrule
		(up-compare-goal g-desired-num-camel > 10)
		(unit-type-count-total camel-line >= 15)
		(can-research ri-heavy-camel)
		=>
		(research ri-heavy-camel)
		)
		(defrule
		(population >= NINETY-PERCENT-POP)
		(unit-type-count-total camel-line >= 5)
		(can-research ri-heavy-camel)
		=>
		(research ri-heavy-camel)
		)

	;----------------------------------------------
	;	Imperial Camel - Secondary Imperial Tech
	;----------------------------------------------

		#load-if-defined INDIAN-CIV

			(defrule
			(or
				(goal g-primary-unit camel)
				(goal g-support-unit camel))
			(player-in-game any-ally)
			(can-research-with-escrow ri-imperial-camel)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-imperial-camel c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-imperial-camel)
			)

			(defrule
			(up-compare-goal g-desired-num-camel > 10)
			(unit-type-count-total camel-line > 25)
			(can-research ri-imperial-camel)
			=>
			(research ri-imperial-camel)
			)
			(defrule
			(population >= NINETY-FIVE-PERCENT-POP)
			(player-in-game any-ally)
			(unit-type-count-total camel-line > 10)
			(can-research ri-imperial-camel)
			=>
			(research ri-imperial-camel)
			)

		#end-if

	;--------------------------------------------------
	;	Elite Steppe Lancer - Priority Imperial Tech
	;--------------------------------------------------

		(defrule
		(or
			(goal g-primary-unit steppe-lancer)
			(goal g-support-unit steppe-lancer))
		(can-research-with-escrow ri-elite-steppe-lancer)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-elite-steppe-lancer c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-elite-steppe-lancer)
		)

		(defrule
		(up-compare-goal g-desired-num-steppe-lancer > 10)
		(unit-type-count steppe-lancer-line > 15)
		(can-research ri-elite-steppe-lancer)
		=>
		(research ri-elite-steppe-lancer)
		)
		(defrule
		(population >= NINETY-PERCENT-POP)
		(unit-type-count steppe-lancer-line > 7)
		(can-research ri-elite-steppe-lancer)
		=>
		(research ri-elite-steppe-lancer)
		)

	;------------------------------------------
	;	Light Cavalry - Required Castle Tech
	;------------------------------------------

		(defrule
		(or
			(up-compare-goal g-game-focus != BOOM)
			(or
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE)
				(goal g-primary-unit scout-cavalry)))
		(up-compare-goal g-desired-num-scout-cavalry > 0)
		(can-research-with-escrow ri-light-cavalry)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-light-cavalry c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-light-cavalry)
		)

		(defrule
		(unit-type-count scout-cavalry-line > 3)
		(can-research ri-light-cavalry)
		=>
		(research ri-light-cavalry)
		)

	;-------------------------------------
	;	Hussar - Priority Imperial Tech
	;-------------------------------------

		(defrule
		(or
			(goal g-primary-unit scout-cavalry)
			(or
				(goal g-support-unit scout-cavalry)
				(and
					(up-compare-goal g-desired-num-scout-cavalry > 0)
					(goal g-age-status LATE-IMPERIAL))))
		(can-research-with-escrow ri-hussar)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-hussar c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-hussar)
		)

		(defrule
		(up-compare-goal g-desired-num-scout-cavalry > 10)
		(unit-type-count scout-cavalry-line >= 15)
		(can-research ri-hussar)
		=>
		(research ri-hussar)
		)
		(defrule
		(or
			(population >= NINETY-PERCENT-POP)
			(goal g-age-status LATE-IMPERIAL))
		(unit-type-count scout-cavalry-line >= 5)
		(can-research ri-hussar)
		=>
		(research ri-hussar)
		)

    ;------------------------------------------------
    ;   Scale Barding Armor - Priority Castle Tech (>= 3 cavalry)
    ;------------------------------------------------

		(defrule
		(current-age == feudal-age)
		(up-compare-goal g-strategy-type < FAST-CASTLE)
		(goal g-primary-unit scout-cavalry)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-CASTLE)
			(food-amount >= 950))
		; (unit-type-count scout-cavalry-line >= 4)
		(can-research-with-escrow ri-scale-barding)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-scale-barding c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(research ri-scale-barding)
		)

		(defrule
		(current-age >= castle-age)
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(goal g-primary-unit-class cavalry-class)
		(or
			(unit-type-count cavalry-class >= 3)
			(or
				(unit-type-count scout-cavalry-line >= 3)
				(or
					(goal g-primary-unit scout-cavalry)
					(or
						(goal g-primary-unit camel)
						(up-compare-goal g-age-status >= TO-IMPERIAL)))))
		(can-research-with-escrow ri-scale-barding)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-scale-barding c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(research ri-scale-barding)
		)
		(defrule
		(current-age >= castle-age)
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(goal g-support-unit-class cavalry-class)
		(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
		(or
			(unit-type-count cavalry-class >= 3)
			(or
				(unit-type-count scout-cavalry-line >= 3)
				(up-compare-goal g-age-status >= TO-IMPERIAL)))
		(can-research-with-escrow ri-scale-barding)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-scale-barding c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(research ri-scale-barding)
		)

		(defrule
		(up-compare-goal g-desired-num-cavalry-class > 5)
		(or
			(unit-type-count cavalry-class >= 5)
			(or
				(unit-type-count scout-cavalry-line >= 5)
				(up-compare-goal g-age-status >= TO-IMPERIAL)))
		(or
			(and
				(up-compare-goal g-age-status >= TO-CASTLE)
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL))
			(or
				(food-amount >= 950)
				(up-compare-goal g-strategy-type < FAST-CASTLE)))
		(can-research ri-scale-barding)
		=>
		(research ri-scale-barding)
		)
		(defrule
		(up-compare-goal g-desired-num-cavalry-class > 0)
		(or
			(unit-type-count cavalry-class > 0)
			(unit-type-count scout-cavalry-line > 0))
		(or
			(up-compare-goal g-age-status >= TO-IMPERIAL)
			(population >= EIGHTY-PERCENT-POP))
		(can-research ri-scale-barding)
		=>
		(research ri-scale-barding)
		)

    ;-------------------------------------------------
    ;   Chain Barding Armor - Secondary Castle Tech (>= 12/15 cavalry or >= 8/10 camels)
    ;-------------------------------------------------

		(defrule
		(goal g-primary-unit-class cavalry-class)
		(or
			(unit-type-count cavalry-class >= 12)
			(or
				(unit-type-count scout-cavalry-line >= 12)
				(or
					(unit-type-count-total camel-line >= 8)
					(or
						(up-compare-goal g-age-status >= TO-IMPERIAL)
						(unit-type-count cavalry-class g:>= g-desired-num-cavalry-class)))))
		(can-research-with-escrow ri-chain-barding)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-chain-barding c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-chain-barding)
		)
		(defrule
		(goal g-support-unit-class cavalry-class)
		(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
		(or
			(unit-type-count cavalry-class >= 15)
			(or
				(unit-type-count scout-cavalry-line >= 15)
				(or
					(unit-type-count-total camel-line >= 10)
					(or
						(up-compare-goal g-age-status >= TO-IMPERIAL)
						(unit-type-count cavalry-class g:>= g-desired-num-cavalry-class)))))
		(can-research-with-escrow ri-chain-barding)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-chain-barding c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-chain-barding)
		)

		(defrule
		(unit-type-count cavalry-class >= 12)
		(or
			(unit-type-count cavalry-class >= 18)
			(or
				(unit-type-count scout-cavalry-line >= 18)
				(up-compare-goal g-age-status >= TO-IMPERIAL)))
		(can-research ri-chain-barding)
		=>
		(research ri-chain-barding)
		)

    ;--------------------------------------------------
    ;   Plate Barding Armor - Priority Imperial Tech
    ;--------------------------------------------------

		(defrule
		(current-age == imperial-age)
		(up-compare-const CAVALIER-AVAILABLE == YES)
		(up-compare-goal g-desired-num-knight >= 10)
		(up-research-status c: ri-cavalier < research-pending)
		=>
		(up-jump-rule 2)
		)
		(defrule
		(current-age == imperial-age)
		(up-compare-const HEAVY-CAMEL-AVAILABLE == YES)
		(up-compare-goal g-desired-num-camel >= 10)
		(up-research-status c: ri-heavy-camel < research-pending)
		=>
		(up-jump-rule 1)
		)
			(defrule
			(or
				(goal g-primary-unit-class cavalry-class)
				(and
					(goal g-support-unit-class cavalry-class)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(can-research-with-escrow ri-plate-barding)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-plate-barding c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-plate-barding)
			)

		(defrule
		(current-age == imperial-age)
		(up-compare-const CAVALIER-AVAILABLE == YES)
		(up-compare-goal g-desired-num-knight >= 10)
		(up-research-status c: ri-cavalier < research-pending)
		=>
		(up-jump-rule 2)
		)
		(defrule
		(current-age == imperial-age)
		(up-compare-const HEAVY-CAMEL-AVAILABLE == YES)
		(up-compare-goal g-desired-num-camel >= 10)
		(up-research-status c: ri-heavy-camel < research-pending)
		=>
		(up-jump-rule 1)
		)
			(defrule
			(up-compare-goal g-desired-num-cavalry-class > 10)
			(or
				(unit-type-count cavalry-class >= 20)
				(or
					(unit-type-count scout-cavalry-line >= 20)
					(population >= NINETY-FIVE-PERCENT-POP)))
			(can-research ri-plate-barding)
			=>
			(research ri-plate-barding)
			)

    ;----------------------------------------
    ;   Bloodlines - Secondary Castle Tech (>= 6 cavalry)
    ;----------------------------------------
		
		(defrule
		(or
			(unit-type-count cavalry-class < 4)
			(or
				(unit-type-count scout-cavalry-line < 4)
				(and
					(current-age >= castle-age)
					(unit-type-count cavalry-class < 6))))
		(unit-type-count cavalry-class g:< g-desired-num-cavalry-class)
		=>
		(up-jump-rule 2)
		)

			(defrule
			(current-age >= castle-age)
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(goal g-primary-unit-class cavalry-class)
			(can-research-with-escrow ri-bloodlines)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-bloodlines c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-bloodlines)
			)
			(defrule
			(current-age >= castle-age)
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(goal g-support-unit-class cavalry-class)
			(up-compare-goal g-support-unit != battle-elephant)
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-bloodlines)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-bloodlines c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-bloodlines)
			)

		(defrule
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(or
			(and
				(up-compare-goal g-age-status >= TO-CASTLE)
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL))
			(or
				(food-amount >= 950)
				(up-compare-goal g-strategy-type < FAST-CASTLE)))
		(up-compare-goal g-desired-num-cavalry-class > 6)
		(or
			(unit-type-count cavalry-class > 10)
			(unit-type-count scout-cavalry-line > 10))
		(can-research ri-bloodlines)
		=>
		(research ri-bloodlines)
		)
		(defrule
		(population >= EIGHTY-PERCENT-POP)
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(up-compare-goal g-age-status >= TO-CASTLE)
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(or
			(unit-type-count cavalry-class > 5)
			(unit-type-count scout-cavalry-line > 5))
		(can-research ri-bloodlines)
		=>
		(research ri-bloodlines)
		)

    ;---------------------------------------
    ;   Husbandry - Secondary Castle Tech (>= 6 cavalry)
    ;---------------------------------------

		(defrule
		(current-age >= castle-age)
		(goal g-current-strategy BOOMC-ARENA-LIGHT-MONK)
		(unit-type-count-total scout-cavalry-line > 2)
		(can-research-with-escrow ri-husbandry)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-husbandry c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(research ri-husbandry)
		)
		
		(defrule
		(or
			(unit-type-count cavalry-class < 6)
			(unit-type-count scout-cavalry-line < 6))
		(or
			(unit-type-count cavalry-class g:< g-desired-num-cavalry-class)
			(unit-type-count scout-cavalry-line g:< g-desired-num-cavalry-class))
		=>
		(up-jump-rule 2)
		)

			(defrule
			(current-age >= castle-age)
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(up-research-status c: ri-bloodlines >= research-pending)
				(up-compare-const BLOODLINES-AVAILABLE == NO))
			(goal g-primary-unit-class cavalry-class)
			(can-research-with-escrow ri-husbandry)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-husbandry c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(research ri-husbandry)
			)
			(defrule
			(current-age >= castle-age)
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(up-research-status c: ri-bloodlines >= research-pending)
				(up-compare-const BLOODLINES-AVAILABLE == NO))
			(goal g-support-unit-class cavalry-class)
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-husbandry)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-husbandry c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(research ri-husbandry)
			)

		(defrule
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(or
			(up-research-status c: ri-bloodlines >= research-pending)
			(up-compare-const BLOODLINES-AVAILABLE == NO))
		(up-compare-goal g-desired-num-cavalry-class >= 10)
		(or
			(unit-type-count cavalry-class >= 15)
			(unit-type-count scout-cavalry-line >= 15))
		(or
			(up-compare-goal g-strategy-type < FAST-CASTLE)
			(military-population > 12))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1150))
		(can-research ri-husbandry)
		=>
		(research ri-husbandry)
		)

;=========================<>=========================
;				    ARCHERY TECHS
;=========================<>=========================

	;-----------------------------------------------------
	;	Elite Elephant Archer - Secondary Imperial Tech
	;-----------------------------------------------------

		(defrule
		(or
			(goal g-primary-unit elephant-archer)
			(goal g-support-unit elephant-archer))
		(can-research-with-escrow ri-elite-elephant-archer)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-elite-elephant-archer c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-elite-elephant-archer)
		)

		(defrule
		(up-compare-goal g-desired-num-elephant-archer > 10)
		(unit-type-count elephant-archer-line > 15)
		(can-research ri-elite-elephant-archer)
		=>
		(research ri-elite-elephant-archer)
		)
		(defrule
		(population >= NINETY-PERCENT-POP)
		(unit-type-count elephant-archer-line > 8)
		(can-research ri-elite-elephant-archer)
		=>
		(research ri-elite-elephant-archer)
		)

	;----------------------------------------------------
	;	Heavy Cavalry Archer - Secondary Imperial Tech
	;----------------------------------------------------

		(defrule
		(or
			(goal g-primary-unit cavalry-archer)
			(goal g-support-unit cavalry-archer))
		(can-research-with-escrow ri-heavy-cavalry-archer)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-heavy-cavalry-archer c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-heavy-cavalry-archer)
		)

		(defrule
		(up-compare-goal g-desired-num-cavalry-archer > 10)
		(unit-type-count cavalry-archer-line > 15)
		(can-research ri-heavy-cavalry-archer)
		=>
		(research ri-heavy-cavalry-archer)
		)
		(defrule
		(population >= NINETY-PERCENT-POP)
		(unit-type-count cavalry-archer-line > 8)
		(can-research ri-heavy-cavalry-archer)
		=>
		(research ri-heavy-cavalry-archer)
		)

	;----------------------------------------------
	;	Elite Genitour - Secondary Imperial Tech
	;----------------------------------------------

		#load-if-defined UP-GAME-WK

			(defrule
			(or
				(goal g-game-focus BOOM)
				(goal g-game-focus REBUILD))
			(up-object-type-count-total c: town-center g:< g-desired-num-town-center)
			=>
			(up-jump-rule 3)
			)

				(defrule
				(or
					(goal g-primary-unit genitour)
					(goal g-support-unit genitour))
				(can-research-with-escrow ri-elite-genitour)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-elite-genitour c: 1)
				(up-modify-escrow food g:- g-food-cost)
				(up-modify-escrow wood g:- g-wood-cost)
				(research ri-elite-genitour)
				)

				(defrule
				(up-compare-goal g-desired-num-genitour > 10)
				(unit-type-count-total genitour-line > 15)
				(can-research ri-elite-genitour)
				=>
				(research ri-elite-genitour)
				)
				(defrule
				(population >= NINETY-PERCENT-POP)
				(unit-type-count-total genitour-line > 5)
				(can-research ri-elite-genitour)
				=>
				(research ri-elite-genitour)
				)

		#end-if

	;----------------------------------------
	;	Crossbowman - Required Castle Tech (>= 5 archers)
	;----------------------------------------

		(defrule
		; (or
		; 	(up-compare-goal g-game-focus != BOOM)
		; 	(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(or
			(goal g-primary-unit archer)
			(goal g-support-unit archer))
		; (or
		; 	(unit-type-count archer-line >= 5)
		; 	(or
		; 		(unit-type-count archer-line g:>= g-desired-num-archer)
		; 		(up-compare-goal g-age-status >= TO-IMPERIAL)))
		(can-research-with-escrow ri-crossbow)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-crossbow c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-crossbow)
		)

		(defrule
		(up-compare-goal g-desired-num-archer > 5)
		(unit-type-count archer-line > 10)
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-crossbow)
		=>
		(research ri-crossbow)
		)
		(defrule
		(population >= EIGHTY-PERCENT-POP)
		(unit-type-count archer-line > 4)
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-crossbow)
		=>
		(research ri-crossbow)
		)

	;---------------------------------------
	;	Arbalest - Priority Imperial Tech
	;---------------------------------------

		(defrule
		(or
			(goal g-primary-unit archer)
			(goal g-support-unit archer))
		(can-research-with-escrow ri-arbalest)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-arbalest c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-arbalest)
		)

		(defrule
		(up-compare-goal g-desired-num-archer > 10)
		(unit-type-count archer-line >= 15)
		(can-research ri-arbalest)
		=>
		(research ri-arbalest)
		)
		(defrule
		(population >= NINETY-PERCENT-POP)
		(unit-type-count archer-line >= 5)
		(can-research ri-arbalest)
		=>
		(research ri-arbalest)
		)

	;---------------------------------------------
	;	Elite Skirmisher - Priority Castle Tech (>= 8 skirms)
	;---------------------------------------------

		(defrule
		(or
			(goal g-game-focus BOOM)
			(goal g-game-focus REBUILD))
		(up-object-type-count-total c: town-center g:< g-desired-num-town-center)
		=>
		(up-jump-rule 4)
		)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(goal g-primary-unit skirmisher)
			(can-research-with-escrow ri-elite-skirmisher)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-elite-skirmisher c: 1)
			(up-modify-escrow wood g:- g-wood-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-elite-skirmisher)
			)
			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(goal g-support-unit skirmisher)
			(or
				(unit-type-count-total skirmisher-line >= 6)
				(or
					(unit-type-count-total skirmisher-line g:>= g-desired-num-skirmisher)
					(up-compare-goal g-age-status >= TO-IMPERIAL)))
			(can-research-with-escrow ri-elite-skirmisher)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-elite-skirmisher c: 1)
			(up-modify-escrow wood g:- g-wood-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-elite-skirmisher)
			)

			(defrule
			(up-compare-goal g-desired-num-skirmisher > 6)
			(unit-type-count-total skirmisher-line > 10)
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(gold-amount >= 950))
			(can-research ri-elite-skirmisher)
			=>
			(research ri-elite-skirmisher)
			)
			(defrule
			(population >= EIGHTY-PERCENT-POP)
			(unit-type-count-total skirmisher-line > 5)
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(gold-amount >= 950))
			(can-research ri-elite-skirmisher)
			=>
			(research ri-elite-skirmisher)
			)

	;--------------------------------------------------
	;	Imperial Skirmisher - Priority Imperial Tech
	;--------------------------------------------------

		#load-if-defined UP-GAME-WK

			(defrule
			(or
				(goal g-primary-unit skirmisher)
				(and
					(goal g-support-unit skirmisher)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(can-research-with-escrow ri-imperial-skirmisher)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-imperial-skirmisher c: 1)
			(up-modify-escrow wood g:- g-wood-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-imperial-skirmisher)
			)

			(defrule
			(up-compare-goal g-desired-num-skirmisher > 10)
			(unit-type-count-total skirmisher-line > 15)
			(can-research ri-imperial-skirmisher)
			=>
			(research ri-imperial-skirmisher)
			)
			(defrule
			(population >= NINETY-PERCENT-POP)
			(unit-type-count-total skirmisher-line > 15)
			(can-research ri-imperial-skirmisher)
			=>
			(research ri-imperial-skirmisher)
			)

		#end-if

	;---------------
	;	Chemistry
	;---------------

        (defrule
        (can-research-with-escrow ri-chemistry)
		(or
			(up-compare-goal g-desired-num-hand-cannoneer > 0)
			(or
				(up-compare-goal g-desired-num-cannon-galleon > 0)
				(and
					(up-compare-goal g-desired-num-cannon-type > 0)
					(up-compare-const my-cannon-type == bombard-cannon))))
        =>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-chemistry c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-chemistry)
        )

		(defrule
		(up-compare-goal g-desired-num-archery-class > 10)
		(or
			(unit-type-count archery-class > 15)
			(or
				(up-compare-goal g-desired-num-cavalry-archer-class > 10)
				(unit-type-count cavalry-archer-class > 15)))
		(can-research ri-chemistry)
		=>
		(research ri-chemistry)
		)

	;--------------------------------------
	;	Fletching - Priority Castle Tech (>= 4 ranged units)
	;--------------------------------------

		(defrule
		(current-age == feudal-age)
		(up-compare-goal g-age-status < SAVE-FOR-CASTLE)
		(up-compare-goal g-strategy-type < FAST-CASTLE)
		(or
			(goal g-primary-unit-class archery-class)
			(goal g-support-unit-class archery-class))
		(or
			(unit-type-count archery-class >= 4)
			(up-compare-goal g-age-status >= TO-IMPERIAL))
		(can-research-with-escrow ri-fletching)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-fletching c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-fletching)
		)

		(defrule
		(current-age >= castle-age)
		(up-compare-const CROSSBOWMAN-AVAILABLE == YES)
		(up-compare-goal g-desired-num-archer >= 5)
		(up-research-status c: ri-crossbow < research-pending)
		=>
		(up-jump-rule 2)
		)

			(defrule
			(up-compare-goal g-age-status >= TO-CASTLE)
			(or
				(goal g-primary-unit-class archery-class)
				(goal g-primary-unit-class cavalry-archer-class))
			(or
				(unit-type-count archery-class >= 4)
				(or
					(unit-type-count cavalry-archer-class >= 4)
					(up-compare-goal g-age-status >= TO-IMPERIAL)))
			(can-research-with-escrow ri-fletching)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-fletching c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-fletching)
			)

			(defrule
			(up-compare-goal g-age-status >= TO-CASTLE)
			(or
				(goal g-support-unit-class archery-class)
				(goal g-support-unit-class cavalry-archer-class))
			(or
				(unit-type-count archery-class >= 4)
				(or
					(unit-type-count cavalry-archer-class >= 4)
					(up-compare-goal g-age-status >= TO-IMPERIAL)))
			(can-research-with-escrow ri-fletching)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-fletching c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-fletching)
			)

		(defrule
		(up-compare-goal g-age-status >= TO-CASTLE)
		(goal g-current-strategy FC-CASTLE-DROP)
		(up-compare-goal g-tower-line > 0)
		(up-set-target-by-id g: g-wall-id-under-attack)
		(can-research-with-escrow ri-fletching)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-fletching c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-fletching)
		)

		(defrule
		(current-age >= castle-age)
		(up-compare-const CROSSBOWMAN-AVAILABLE == YES)
		(up-compare-goal g-desired-num-archer >= 10)
		(up-research-status c: ri-crossbow < research-pending)
		=>
		(up-jump-rule 1)
		)

			(defrule
			(current-age >= castle-age)
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(and
					(up-compare-goal g-desired-num-archery-class > 6)
					(unit-type-count archery-class > 10))
				(and
					(up-compare-goal g-desired-num-cavalry-archer-class > 6)
					(unit-type-count cavalry-archer-class > 10)))
			(can-research ri-fletching)
			=>
			(research ri-fletching)
			)

		(defrule
		(population >= SEVENTY-PERCENT-POP)
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(or
			(unit-type-count archery-class > 5)
			(unit-type-count cavalry-archer-class > 5))
		(can-research ri-fletching)
		=>
		(research ri-fletching)
		)

	;------------------------------------------
	;	Bodkin Arrow - Priority Castle Tech (>= 8/12 ranged units)
	;------------------------------------------

		(defrule
		(goal g-primary-unit-class archery-class)
		(or
			(unit-type-count archery-class >= 8)
			(unit-type-count archery-class g:>= g-desired-num-archery-class))
		(can-research-with-escrow ri-bodkin-arrow)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-bodkin-arrow c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-bodkin-arrow)
		)
		(defrule
		(goal g-support-unit-class archery-class)
		(or
			(unit-type-count archery-class >= 12)
			(unit-type-count archery-class g:>= g-desired-num-archery-class))
		(can-research-with-escrow ri-bodkin-arrow)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-bodkin-arrow c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-bodkin-arrow)
		)
		(defrule
		(goal g-primary-unit-class cavalry-archer-class)
		(or
			(unit-type-count cavalry-archer-class >= 8)
			(unit-type-count cavalry-archer-class g:>= g-desired-num-cavalry-archer-class))
		(can-research-with-escrow ri-bodkin-arrow)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-bodkin-arrow c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-bodkin-arrow)
		)
		(defrule
		(goal g-support-unit-class cavalry-archer-class)
		(or
			(unit-type-count cavalry-archer-class >= 12)
			(unit-type-count cavalry-archer-class g:>= g-desired-num-cavalry-archer-class))
		(can-research-with-escrow ri-bodkin-arrow)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-bodkin-arrow c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-bodkin-arrow)
		)
		(defrule
		(or
			(goal g-primary-unit-class archery-class)
			(or
				(goal g-support-unit-class archery-class)
				(or
					(goal g-primary-unit-class cavalry-archer-class)
					(goal g-support-unit-class cavalry-archer-class))))
		(up-compare-goal g-age-status >= TO-IMPERIAL)
		(can-research-with-escrow ri-bodkin-arrow)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-bodkin-arrow c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-bodkin-arrow)
		)

		(defrule
		(or
			(and
				(up-compare-goal g-desired-num-archery-class > 6)
				(unit-type-count archery-class > 10))
			(and
				(up-compare-goal g-desired-num-cavalry-archer-class > 6)
				(unit-type-count cavalry-archer-class > 10)))
		(or
			(up-compare-goal g-age-status >= MID-CASTLE)
			(up-compare-flag g-flag == FIRST-ATTACK-LAUNCHED))
		(can-research ri-bodkin-arrow)
		=>
		(research ri-bodkin-arrow)
		)
		(defrule
		(population >= EIGHTY-PERCENT-POP)
		(or
			(unit-type-count archery-class > 5)
			(unit-type-count cavalry-archer-class > 5))
		(or
			(up-compare-goal g-age-status >= MID-CASTLE)
			(up-compare-flag g-flag == FIRST-ATTACK-LAUNCHED))
		(can-research ri-bodkin-arrow)
		=>
		(research ri-bodkin-arrow)
		)

	;-------------------------------------
	;	Bracer - Priority Imperial Tech
	;-------------------------------------

		(defrule
		(or
			(goal g-primary-unit-class archery-class)
			(goal g-support-unit-class archery-class))
		(current-age-time > 5)
		(can-research-with-escrow ri-bracer)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-bracer c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-bracer)
		)
		(defrule
		(or
			(goal g-primary-unit-class cavalry-archer-class)
			(goal g-support-unit-class cavalry-archer-class))
		(current-age-time > 5)
		(can-research-with-escrow ri-bracer)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-bracer c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-bracer)
		)

		(defrule
		(or
			(and
				(up-compare-goal g-desired-num-archery-class > 10)
				(unit-type-count archery-class > 15))
			(and
				(up-compare-goal g-desired-num-cavalry-archer-class > 10)
				(unit-type-count cavalry-archer-class > 15)))
		(current-age-time > 5)
		(can-research ri-bracer)
		=>
		(research ri-bracer)
		)
		(defrule
		(population >= NINETY-PERCENT-POP)
		(or
			(unit-type-count archery-class > 5)
			(unit-type-count cavalry-archer-class > 5))
		(current-age-time > 5)
		(can-research ri-bracer)
		=>
		(research ri-bracer)
		)

	;-----------------------------------------
	;	Thumb Ring - Priority Imperial Tech (Secondary Castle for cav archers) (>= 7/10 cav archers)
	;-----------------------------------------

		(defrule
		(or
			(goal g-game-focus BOOM)
			(goal g-game-focus REBUILD))
		(up-object-type-count-total c: town-center g:< g-desired-num-town-center)
		=>
		(up-jump-rule 3)
		)

			(defrule
			(or
				(and
					(goal g-primary-unit cavalry-archer)
					(or
						(unit-type-count cavalry-archer-line >= 7)
						(unit-type-count cavalry-archer-line g:>= g-desired-num-cavalry-archer)))
				(and
					(goal g-support-unit cavalry-archer)
					(or
						(unit-type-count cavalry-archer-line >= 10)
						(unit-type-count cavalry-archer-line g:>= g-desired-num-cavalry-archer))))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-thumb-ring)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-thumb-ring c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow wood g:- g-wood-cost)
			(research ri-thumb-ring)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-archery-class > 6)
				(up-compare-goal g-desired-num-cavalry-archer-class > 6))
			(or
				(unit-type-count archery-class > 12)
				(unit-type-count cavalry-archer-class > 10))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-thumb-ring)
			=>
			(research ri-thumb-ring)
			)
			(defrule
			(population >= NINETY-PERCENT-POP)
			(or
				(unit-type-count archery-class > 6)
				(unit-type-count cavalry-archer-class > 6))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-thumb-ring)
			=>
			(research ri-thumb-ring)
			)

    ;----------------
    ;   Bloodlines
    ;----------------
		
		(defrule
		(unit-type-count cavalry-archer-class < 4)
		(unit-type-count cavalry-cannon-class < 4)
		=>
		(up-jump-rule 3)
		)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-compare-goal g-desired-num-cavalry-archer-class > 6)
			(unit-type-count cavalry-archer-class > 10)
			(can-research ri-bloodlines)
			=>
			(research ri-bloodlines)
			)
			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-compare-goal g-desired-num-unique-unit > 6)
			(up-compare-const UNIQUE-UNIT-CLASS == cavalry-cannon-class)
			(unit-type-count-total my-unique-unit-line > 10)
			(can-research ri-bloodlines)
			=>
			(research ri-bloodlines)
			)
			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(population >= NINETY-PERCENT-POP)
			(or
				(unit-type-count cavalry-archer-class > 5)
				(and
					(up-compare-const UNIQUE-UNIT-CLASS == cavalry-cannon-class)
					(unit-type-count-total my-unique-unit-line > 5)))
			(can-research ri-bloodlines)
			=>
			(research ri-bloodlines)
			)

    ;----------------
    ;   Husbandry
    ;----------------
		
		(defrule
		(unit-type-count cavalry-archer-class < 6)
		(unit-type-count cavalry-cannon-class < 6)
		=>
		(up-jump-rule 3)
		)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-compare-goal g-desired-num-cavalry-archer-class > 6)
			(unit-type-count cavalry-archer-class > 10)
			(can-research ri-husbandry)
			=>
			(research ri-husbandry)
			)
			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-compare-goal g-desired-num-unique-unit > 6)
			(up-compare-const UNIQUE-UNIT-CLASS == cavalry-cannon-class)
			(unit-type-count-total my-unique-unit-line > 10)
			(can-research ri-husbandry)
			=>
			(research ri-husbandry)
			)
			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(population >= NINETY-PERCENT-POP)
			(or
				(unit-type-count cavalry-archer-class > 5)
				(and
					(up-compare-const UNIQUE-UNIT-CLASS == cavalry-cannon-class)
					(unit-type-count-total my-unique-unit-line > 5)))
			(can-research ri-husbandry)
			=>
			(research ri-husbandry)
			)

	;----------------------
	;	Parthian Tactics
	;----------------------

		(defrule
		(up-compare-goal g-desired-num-cavalry-archer-class > 10)
		(unit-type-count cavalry-archer-class > 12)
		(can-research ri-parthian-tactics)
		=>
		(research ri-parthian-tactics)
		)
		(defrule
		(population >= NINETY-PERCENT-POP)
		(unit-type-count cavalry-archer-class > 6)
		(can-research ri-parthian-tactics)
		=>
		(research ri-parthian-tactics)
		)

	;-------------------------------------------------
	;	Padded Archer Armor - Secondary Castle Tech (>= 7/10 ranged units)
	;-------------------------------------------------

		(defrule
		(current-age == feudal-age)
		(up-compare-goal g-strategy-type < FAST-CASTLE)
		(goal g-primary-unit-class archery-class)
		(unit-type-count archery-class >= 7)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-CASTLE)
			(food-amount >= 900))
		(can-research-with-escrow ri-padded-archer-armor)
		(or
			(up-research-status c: ri-fletching >= research-pending)
			(food-amount > 250))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-padded-archer-armor c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(research ri-padded-archer-armor)
		)
		(defrule
		(current-age == feudal-age)
		(up-compare-goal g-strategy-type < FAST-CASTLE)
		(goal g-support-unit-class archery-class)
		(unit-type-count archery-class >= 10)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-CASTLE)
			(food-amount >= 900))
		(can-research-with-escrow ri-padded-archer-armor)
		(or
			(up-research-status c: ri-fletching >= research-pending)
			(food-amount > 250))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-padded-archer-armor c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(research ri-padded-archer-armor)
		)

		(defrule
		(or
			(and
				(up-compare-goal g-game-focus == BOOM)
				(up-compare-goal g-eco-tech-progress < PRIORITY-CASTLE-COMPLETE))
			(and
				(up-research-status c: ri-fletching < research-pending)
				(food-amount <= 250)))
		=>
		(up-jump-rule 2)
		)

			(defrule
			(current-age >= castle-age)
			(or
				(goal g-primary-unit-class archery-class)
				(goal g-support-unit-class archery-class))
			(or
				(unit-type-count archery-class >= 8)
				(or
					(unit-type-count archery-class g:>= g-desired-num-archery-class)
					(up-compare-goal g-age-status >= TO-IMPERIAL)))
			(can-research-with-escrow ri-padded-archer-armor)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-padded-archer-armor c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(research ri-padded-archer-armor)
			)
			(defrule
			(current-age >= castle-age)
			(or
				(goal g-primary-unit-class cavalry-archer-class)
				(goal g-support-unit-class cavalry-archer-class))
			(or
				(unit-type-count cavalry-archer-class >= 8)
				(or
					(unit-type-count cavalry-archer-class g:>= g-desired-num-cavalry-archer-class)
					(up-compare-goal g-age-status >= TO-IMPERIAL)))
			(can-research-with-escrow ri-padded-archer-armor)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-padded-archer-armor c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(research ri-padded-archer-armor)
			)

		(defrule
		(current-age >= castle-age)
		(or
			(goal g-primary-unit-class archery-cannon-class)
			(goal g-support-unit-class archery-cannon-class))
		(or
			(unit-type-count archery-cannon-class >= 8)
			(or
				(unit-type-count archery-cannon-class g:>= g-desired-num-cannoneer-classes)
				(up-compare-goal g-age-status >= TO-IMPERIAL)))
		(can-research-with-escrow ri-padded-archer-armor)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-padded-archer-armor c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(research ri-padded-archer-armor)
		)
		(defrule
		(current-age >= castle-age)
		(or
			(goal g-primary-unit-class cavalry-cannon-class)
			(goal g-support-unit-class cavalry-cannon-class))
		(or
			(unit-type-count cavalry-cannon-class >= 8)
			(or
				(unit-type-count cavalry-cannon-class g:>= g-desired-num-cannoneer-classes)
				(up-compare-goal g-age-status >= TO-IMPERIAL)))
		(can-research-with-escrow ri-padded-archer-armor)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-padded-archer-armor c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(research ri-padded-archer-armor)
		)

		(defrule
		(current-age == feudal-age)
		(up-compare-goal g-desired-num-archery-class > 6)
		(unit-type-count archery-class > 10)
		(or
			(up-research-status c: ri-fletching >= research-pending)
			(food-amount > 250))
		(or
			(up-compare-goal g-age-status >= TO-CASTLE)
			(or
				(food-amount >= 900)
				(up-compare-goal g-strategy-type < FAST-CASTLE)))
		(can-research ri-padded-archer-armor)
		=>
		(research ri-padded-archer-armor)
		)

		(defrule
		(current-age >= castle-age)
		(up-compare-const CROSSBOWMAN-AVAILABLE == YES)
		(up-compare-goal g-desired-num-archer >= 10)
		(up-research-status c: ri-crossbow < research-pending)
		=>
		(up-jump-rule 4)
		)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(current-age >= castle-age)
			(up-compare-goal g-desired-num-archery-class > 6)
			(unit-type-count archery-class > 10)
			(or
				(up-research-status c: ri-fletching >= research-pending)
				(food-amount > 250))
			(can-research ri-padded-archer-armor)
			=>
			(research ri-padded-archer-armor)
			)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(current-age >= castle-age)
			(up-compare-goal g-desired-num-cavalry-archer-class > 6)
			(unit-type-count cavalry-archer-class > 10)
			(or
				(up-research-status c: ri-fletching >= research-pending)
				(food-amount > 250))
			(can-research ri-padded-archer-armor)
			=>
			(research ri-padded-archer-armor)
			)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(current-age >= castle-age)
			(up-compare-goal g-desired-num-hand-cannoneer > 6)
			(or
				(unit-type-count archery-cannon-class > 10)
				(unit-type-count cavalry-cannon-class > 10))
			(can-research ri-padded-archer-armor)
			=>
			(research ri-padded-archer-armor)
			)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(current-age >= castle-age)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(or
				(civ-selected turkish)
				(or
					(civ-selected spanish)
					(civ-selected burmese)))
			(up-compare-goal g-desired-num-unique-unit > 6)
			(unit-type-count-total my-unique-unit-line > 6)
			(can-research ri-padded-archer-armor)
			=>
			(research ri-padded-archer-armor)
			)

	;---------------------------------------------------
	;	Leather Archer Armor - Priority Imperial Tech (Secondary Castle for Skirms) (>= 11 ranged units)
	;---------------------------------------------------

		(defrule
		(or
			(goal g-primary-unit-class archery-class)
			(goal g-support-unit-class archery-class))
		(or
			(unit-type-count archery-class >= 11)
			(or
				(unit-type-count archery-class g:>= g-desired-num-archery-class)
				(up-compare-goal g-age-status >= TO-IMPERIAL)))
		(or
			(up-research-status c: ri-bodkin-arrow >= research-pending)
			(food-amount > 350))
		(can-research-with-escrow ri-leather-archer-armor)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-leather-archer-armor c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-leather-archer-armor)
		)
		(defrule
		(or
			(goal g-primary-unit-class cavalry-archer-class)
			(goal g-support-unit-class cavalry-archer-class))
		(or
			(unit-type-count cavalry-archer-class >= 11)
			(or
				(unit-type-count cavalry-archer-class g:>= g-desired-num-cavalry-archer-class)
				(up-compare-goal g-age-status >= TO-IMPERIAL)))
		(or
			(up-research-status c: ri-bodkin-arrow >= research-pending)
			(food-amount > 350))
		(can-research-with-escrow ri-leather-archer-armor)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-leather-archer-armor c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-leather-archer-armor)
		)
		(defrule
		(or
			(goal g-primary-unit-class archery-cannon-class)
			(goal g-support-unit-class archery-cannon-class))
		(or
			(unit-type-count archery-cannon-class >= 11)
			(or
				(unit-type-count archery-cannon-class g:>= g-desired-num-cannoneer-classes)
				(up-compare-goal g-age-status >= TO-IMPERIAL)))
		(can-research-with-escrow ri-leather-archer-armor)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-leather-archer-armor c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-leather-archer-armor)
		)
		(defrule
		(or
			(goal g-primary-unit-class cavalry-cannon-class)
			(goal g-support-unit-class cavalry-cannon-class))
		(or
			(unit-type-count cavalry-cannon-class >= 11)
			(or
				(unit-type-count cavalry-cannon-class g:>= g-desired-num-cannoneer-classes)
				(up-compare-goal g-age-status >= TO-IMPERIAL)))
		(can-research-with-escrow ri-leather-archer-armor)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-leather-archer-armor c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-leather-archer-armor)
		)

		(defrule
		(or
			(and
				(goal g-primary-unit-class archery-cannon-class)
				(unit-type-count archery-cannon-class >= 10))
			(and
				(goal g-primary-unit-class cavalry-cannon-class)
				(unit-type-count cavalry-cannon-class >= 10)))
		(can-research-with-escrow ri-leather-archer-armor)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-leather-archer-armor c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-leather-archer-armor)
		)
		(defrule
		(or
			(and
				(goal g-support-unit-class archery-cannon-class)
				(unit-type-count archery-cannon-class >= 12))
			(and
				(goal g-support-unit-class cavalry-cannon-class)
				(unit-type-count cavalry-cannon-class >= 12)))
		(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
		(can-research-with-escrow ri-leather-archer-armor)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-leather-archer-armor c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-leather-archer-armor)
		)
		(defrule
		(or
			(goal g-primary-unit-class archery-cannon-class)
			(or
				(goal g-primary-unit-class cavalry-cannon-class)
				(or
					(goal g-support-unit-class archery-cannon-class)
					(goal g-support-unit-class cavalry-cannon-class))))
		(up-compare-goal g-age-status >= TO-IMPERIAL)
		(can-research-with-escrow ri-leather-archer-armor)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-leather-archer-armor c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-leather-archer-armor)
		)

		(defrule
		(or
			(and
				(up-compare-goal g-desired-num-archery-class > 6)
				(unit-type-count archery-class > 10))
			(and
				(up-compare-goal g-desired-num-cavalry-archer-class > 6)
				(unit-type-count cavalry-archer-class > 10)))
		(or
			(up-research-status c: ri-bodkin-arrow >= research-pending)
			(food-amount > 350))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-leather-archer-armor)
		=>
		(research ri-leather-archer-armor)
		)

		(defrule
		(up-compare-goal g-desired-num-hand-cannoneer > 6)
		(unit-type-count hand-cannoneer > 10)
		(can-research ri-leather-archer-armor)
		=>
		(research ri-leather-archer-armor)
		)

		(defrule
		(or
			(civ-selected turkish)
			(civ-selected spanish))
		(up-compare-goal g-desired-num-unique-unit > 6)
		(or
			(unit-type-count archery-cannon-class > 10)
			(unit-type-count cavalry-cannon-class > 10))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-leather-archer-armor)
		=>
		(research ri-leather-archer-armor)
		)

	;-------------------------------------------------
	;	Ring Archer Armor - Secondary Imperial Tech (Priority Imperial for Skirms)
	;-------------------------------------------------			

		(defrule
		(or
			(goal g-primary-unit-class archery-class)
			(or
				(goal g-primary-unit-class cavalry-archer-class)
				(or
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
					(and
						(goal g-support-unit-class archery-class)
						(goal g-support-unit-class cavalry-archer-class)))))
		(or
			(up-research-status c: ri-bracer >= research-pending)
			(up-compare-const BRACER-AVAILABLE == NO))
		(can-research-with-escrow ri-ring-archer-armor)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-ring-archer-armor c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-ring-archer-armor)
		)
		(defrule
		(or
			(goal g-primary-unit-class archery-cannon-class)
			(or
				(goal g-primary-unit-class cavalry-cannon-class)
				(or
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
					(and
						(goal g-support-unit-class archery-cannon-class)
						(goal g-support-unit-class cavalry-cannon-class)))))
		(can-research-with-escrow ri-ring-archer-armor)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-ring-archer-armor c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-ring-archer-armor)
		)

		(defrule
		(or
			(and
				(up-compare-goal g-desired-num-archery-class > 6)
				(unit-type-count archery-class > 10))
			(and
				(up-compare-goal g-desired-num-cavalry-archer-class > 6)
				(unit-type-count cavalry-archer-class > 10)))
		(or
			(up-research-status c: ri-bracer >= research-pending)
			(up-compare-const BRACER-AVAILABLE == NO))
		(can-research ri-ring-archer-armor)
		=>
		(research ri-ring-archer-armor)
		)

		(defrule
		(up-compare-goal g-desired-num-hand-cannoneer > 6)
		(unit-type-count hand-cannoneer > 10)
		(can-research ri-ring-archer-armor)
		=>
		(research ri-ring-archer-armor)
		)

		(defrule
		(or
			(civ-selected turkish)
			(civ-selected spanish))
		(up-compare-goal g-desired-num-unique-unit > 6)
		(or
			(unit-type-count archery-cannon-class > 10)
			(unit-type-count cavalry-cannon-class > 10))
		(can-research ri-ring-archer-armor)
		=>
		(research ri-ring-archer-armor)
		)

	;-----------------------------------------
	;	Ballistics - Priority Imperial Tech (>= 11 ranged units)
	;-----------------------------------------

		(defrule
		(or
			(goal g-game-focus BOOM)
			(goal g-game-focus REBUILD))
		(up-object-type-count-total c: town-center g:< g-desired-num-town-center)
		=>
		(up-jump-rule 2)
		)

			(defrule
			(or
				(goal g-primary-unit-class archery-class)
				(goal g-support-unit-class archery-class))
			(or
				(unit-type-count archery-class >= 11)
				(or
					(unit-type-count archery-class g:>= g-desired-num-archery-class)
					(up-compare-goal g-age-status >= TO-IMPERIAL)))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(gold-amount >= 975))
			(can-research-with-escrow ri-ballistics)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-ballistics c: 1)
			(up-modify-escrow wood g:- g-wood-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-ballistics)
			)
			(defrule
			(or
				(goal g-primary-unit-class cavalry-archer-class)
				(goal g-support-unit-class cavalry-archer-class))
			(or
				(unit-type-count cavalry-archer-class >= 11)
				(or
					(unit-type-count cavalry-archer-class g:>= g-desired-num-cavalry-archer-class)
					(up-compare-goal g-age-status >= TO-IMPERIAL)))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(gold-amount >= 975))
			(can-research-with-escrow ri-ballistics)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-ballistics c: 1)
			(up-modify-escrow wood g:- g-wood-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-ballistics)
			)

		(defrule
		(or
			(up-compare-goal g-desired-num-archery-class > 6)
			(or
				(unit-type-count archery-class > 10)
				(or
					(up-compare-goal g-desired-num-cavalry-archer-class > 6)
					(unit-type-count cavalry-archer-class > 10))))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-ballistics)
		=>
		(research ri-ballistics)
		)
		(defrule
		(population >= NINETY-PERCENT-POP)
		(or
			(unit-type-count archery-class > 6)
			(unit-type-count cavalry-archer-class > 6))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-ballistics)
		=>
		(research ri-ballistics)
		)

		#load-if-defined BURMESE-CIV

			(defrule
			(or
				(goal g-game-focus BOOM)
				(goal g-game-focus REBUILD))
			(up-object-type-count-total c: town-center g:< g-desired-num-town-center)
			=>
			(up-jump-rule 1)
			)

				(defrule
				(or
					(goal g-primary-unit my-unique-unit)
					(goal g-support-unit my-unique-unit))
				(or
					(unit-type-count-total my-unique-unit-line >= 11)
					(or
						(unit-type-count-total my-unique-unit-line g:>= g-desired-num-unique-unit)
						(up-compare-goal g-age-status >= TO-IMPERIAL)))
				(or
					(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
					(gold-amount >= 975))
				(can-research-with-escrow ri-ballistics)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: ri-ballistics c: 1)
				(up-modify-escrow wood g:- g-wood-cost)
				(up-modify-escrow gold g:- g-gold-cost)
				(research ri-ballistics)
				)

			(defrule
			(up-compare-goal g-desired-num-unique-unit > 6)
			(unit-type-count-total my-unique-unit-line > 10)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-ballistics)
			=>
			(research ri-ballistics)
			)
			(defrule
			(population >= NINETY-PERCENT-POP)
			(unit-type-count-total my-unique-unit-line > 6)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-ballistics)
			=>
			(research ri-ballistics)
			)

		#end-if

;=========================<>=========================
;				    INFANTRY TECHS
;=========================<>=========================

	;------------------------------------------
	;	Eagle Warrior - Required Castle Tech
	;------------------------------------------

		#load-if-defined UP-GAME-WK

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(goal g-primary-unit eagle-warrior)
				(goal g-support-unit eagle-warrior))
			(can-research-with-escrow ri-eagle-warrior)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-eagle-warrior c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-eagle-warrior)
			)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(up-compare-goal g-desired-num-eagle-warrior > 6)
				(unit-type-count-total eagle-warrior-line > 10))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-eagle-warrior)
			=>
			(research ri-eagle-warrior)
			)

		#end-if

	;--------------------------------------------------
	;	Elite Eagle Warrior - Required Imperial Tech
	;--------------------------------------------------

		(defrule
		(or
			(goal g-primary-unit eagle-warrior)
			(goal g-support-unit eagle-warrior))
		(can-research-with-escrow ri-elite-eagle-warrior)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-elite-eagle-warrior c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-elite-eagle-warrior)
		)

		(defrule
		(up-compare-goal g-desired-num-eagle-warrior > 10)
		(unit-type-count-total eagle-warrior-line > 15)
		(can-research ri-elite-eagle-warrior)
		=>
		(research ri-elite-eagle-warrior)
		)
		(defrule
		(population >= SEVENTY-PERCENT-POP)
		(unit-type-count-total eagle-warrior-line > 5)
		(can-research ri-elite-eagle-warrior)
		=>
		(research ri-elite-eagle-warrior)
		)

	;------------------------------------
	;	Pikeman - Required Castle Tech
	;------------------------------------

		(defrule
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(up-compare-goal g-desired-num-spearman > 0)
		(can-research-with-escrow ri-pikeman)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-pikeman c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-pikeman)
		)

		(defrule
		(or
			(up-compare-goal g-desired-num-spearman >= 4)
			(unit-type-count spearman-line >= 6))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-pikeman)
		=>
		(research ri-pikeman)
		)

	;-----------------------------------------
	;	Halberdier - Priority Imperial Tech
	;-----------------------------------------

		(defrule
		(or
			(goal g-primary-unit spearman)
			(goal g-support-unit spearman))
		(can-research-with-escrow ri-halberdier)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-halberdier c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-halberdier)
		)

		(defrule
		(up-compare-goal g-desired-num-spearman > 10)
		(unit-type-count spearman-line >= 15)
		(can-research ri-halberdier)
		=>
		(research ri-halberdier)
		)
		(defrule
		(population >= EIGHTY-PERCENT-POP)
		(unit-type-count spearman-line >= 5)
		(can-research ri-halberdier)
		=>
		(research ri-halberdier)
		)

	;----------------------------------------
	;	Man-at-Arms - Priority Feudal Tech
	;----------------------------------------

        (defrule
		(or
			(goal g-primary-unit militiaman)
			(goal g-support-unit militiaman))
		(up-compare-goal g-age-status != SAVE-FOR-CASTLE)
        (can-research-with-escrow ri-man-at-arms)
        =>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-man-at-arms c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
        (research ri-man-at-arms)
        )

        (defrule
		(or
			(up-compare-goal g-desired-num-militia > 3)
			(unit-type-count militiaman-line >= 8))
		(up-compare-goal g-age-status != SAVE-FOR-CASTLE)
        (can-research ri-man-at-arms)
        =>
        (research ri-man-at-arms)
        )

		#load-if-defined AZTEC-CIV

			(defrule
			(goal g-position FLANK)
			(goal g-primary-unit eagle-warrior)
			(up-compare-goal g-enemy-swordsmen-count > 0)
			(up-compare-goal g-eagle-warrior-tech-progress >= SECONDARY-CASTLE-COMPLETE)
			(can-research ri-man-at-arms)
			=>
			(research ri-man-at-arms)
			)

		#end-if

	;-------------------------------------------
	;	Long Swordsman - Required Castle Tech
	;-------------------------------------------

		(defrule
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(or
			(goal g-primary-unit militiaman)
			(goal g-support-unit militiaman))
		(can-research-with-escrow ri-long-swordsman)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-long-swordsman c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-long-swordsman)
		)

		(defrule
		(or
			(up-compare-goal g-desired-num-militia > 6)
			(or
				(and
					(up-compare-goal g-desired-num-militia > 0)
					(up-compare-goal g-enemy-eagle-warriors-count > 6))
				(unit-type-count militiaman-line >= 10)))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-long-swordsman)
		=>
		(research ri-long-swordsman)
		)

		#load-if-defined AZTEC-CIV

			(defrule
			(goal g-position FLANK)
			(goal g-primary-unit eagle-warrior)
			(up-compare-goal g-enemy-swordsmen-count > 0)
			(can-research ri-long-swordsman)
			=>
			(research ri-long-swordsman)
			)

		#end-if

	#load-if-not-defined ROMANS-CIV

		;---------------------------------------------------
		;	Two-Handed Swordsman - Required Imperial Tech
		;---------------------------------------------------

			(defrule
			(or
				(goal g-primary-unit militiaman)
				(goal g-support-unit militiaman))
			(can-research-with-escrow ri-two-handed-swordsman)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-two-handed-swordsman c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-two-handed-swordsman)
			)

			(defrule
			(up-compare-goal g-desired-num-militia > 10)
			(unit-type-count militiaman-line > 15)
			(can-research ri-two-handed-swordsman)
			=>
			(research ri-two-handed-swordsman)
			)
			(defrule
			(population >= EIGHTY-PERCENT-POP)
			(unit-type-count militiaman-line > 15)
			(can-research ri-two-handed-swordsman)
			=>
			(research ri-two-handed-swordsman)
			)

		;---------------------------------------
		;	Champion - Priority Imperial Tech
		;---------------------------------------

			(defrule
			(or
				(goal g-primary-unit militiaman)
				(and
					(goal g-support-unit militiaman)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(can-research-with-escrow ri-champion)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-champion c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-champion)
			)

			(defrule
			(up-compare-goal g-desired-num-militia > 10)
			(unit-type-count militiaman-line > 15)
			(can-research ri-champion)
			=>
			(research ri-champion)
			)
			(defrule
			(population >= NINETY-PERCENT-POP)
			(unit-type-count militiaman-line > 5)
			(can-research ri-champion)
			=>
			(research ri-champion)
			)

	#else

		;---------------------------------------
		;	Legionary - Priority Imperial Tech
		;---------------------------------------

			(defrule
			(or
				(goal g-primary-unit militiaman)
				(and
					(goal g-support-unit militiaman)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(can-research-with-escrow ri-legionary)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-legionary c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-legionary)
			)

			(defrule
			(up-compare-goal g-desired-num-militia > 10)
			(unit-type-count militiaman-line > 15)
			(can-research ri-legionary)
			=>
			(research ri-legionary)
			)
			(defrule
			(population >= NINETY-PERCENT-POP)
			(unit-type-count militiaman-line > 5)
			(can-research ri-legionary)
			=>
			(research ri-legionary)
			)

	#end-if

	;---------------------------------------
	;	Scale Mail - Priority Castle Tech (>= 4 infantry)
	;---------------------------------------

		(defrule
		(current-age == feudal-age)
		(or
			(goal g-primary-unit-class infantry-class)
			(and
				(goal g-support-unit-class infantry-class)
				(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
		(or
			(unit-type-count infantry-class >= 4)
			(up-compare-goal g-age-status >= TO-IMPERIAL))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-CASTLE)
			(food-amount >= 900))
		(can-research-with-escrow ri-scale-mail)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-scale-mail c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(research ri-scale-mail)
		)

		(defrule
		(current-age >= castle-age)
		(up-compare-const LONG-SWORDSMAN-AVAILABLE == YES)
		(up-compare-goal g-desired-num-militia >= 10)
		(up-research-status c: ri-long-swordsman < research-pending)
		=>
		(up-jump-rule 2)
		)

		(defrule
		(current-age >= castle-age)
		(up-compare-const PIKEMAN-AVAILABLE == YES)
		(up-compare-goal g-desired-num-spearman >= 10)
		(up-research-status c: ri-pikeman < research-pending)
		=>
		(up-jump-rule 1)
		)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(current-age >= castle-age)
			(or
				(goal g-primary-unit-class infantry-class)
				(and
					(goal g-support-unit-class infantry-class)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(or
				(unit-type-count infantry-class >= 4)
				(up-compare-goal g-age-status >= TO-IMPERIAL))
			(can-research-with-escrow ri-scale-mail)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-scale-mail c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(research ri-scale-mail)
			)

		(defrule
		(current-age >= castle-age)
		(up-compare-const LONG-SWORDSMAN-AVAILABLE == YES)
		(up-compare-goal g-desired-num-militia >= 10)
		(up-research-status c: ri-long-swordsman < research-pending)
		=>
		(up-jump-rule 2)
		)

		(defrule
		(current-age >= castle-age)
		(up-compare-const PIKEMAN-AVAILABLE == YES)
		(up-compare-goal g-desired-num-spearman >= 10)
		(up-research-status c: ri-pikeman < research-pending)
		=>
		(up-jump-rule 1)
		)

			(defrule
			(up-compare-goal g-desired-num-infantry-class > 5)
			(unit-type-count infantry-class > 8)
			(or
				(up-compare-goal g-age-status >= TO-CASTLE)
				(or
					(food-amount >= 900)
					(up-compare-goal g-strategy-type < FAST-CASTLE)))
			(can-research ri-scale-mail)
			=>
			(research ri-scale-mail)
			)

		(defrule
		(population >= SEVENTY-PERCENT-POP)
		(or
			(unit-type-count infantry-class >= 4)
			(up-compare-goal g-age-status >= TO-IMPERIAL))
		(or
			(up-compare-goal g-age-status >= TO-CASTLE)
			(or
				(food-amount >= 900)
				(up-compare-goal g-strategy-type < FAST-CASTLE)))
		(can-research ri-scale-mail)
		=>
		(research ri-scale-mail)
		)

	;----------------------------------------
	;	Chain Mail - Secondary Castle Tech (>= 9 infantry)
	;----------------------------------------

		(defrule
		(current-age >= castle-age)
		(up-compare-const PIKEMAN-AVAILABLE == YES)
		(up-compare-goal g-desired-num-spearman >= 10)
		(up-research-status c: ri-pikeman < research-pending)
		=>
		(up-jump-rule 2)
		)

			(defrule
			(goal g-primary-unit-class infantry-class)
			(or
				(unit-type-count infantry-class >= 9)
				(or
					(unit-type-count infantry-class g:>= g-desired-num-infantry-class)
					(up-compare-goal g-age-status >= TO-IMPERIAL)))
			(or
				(up-compare-goal g-target-military-parity > 0)
				(up-compare-goal g-age-status >= MID-CASTLE))
			(can-research-with-escrow ri-chain-mail)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-chain-mail c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-chain-mail)
			)
			(defrule
			(goal g-support-unit-class infantry-class)
			(or
				(unit-type-count infantry-class >= 9)
				(or
					(unit-type-count infantry-class g:>= g-desired-num-infantry-class)
					(up-compare-goal g-age-status >= TO-IMPERIAL)))
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(up-compare-goal g-age-status >= MID-CASTLE)
			(can-research-with-escrow ri-chain-mail)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-chain-mail c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-chain-mail)
			)

		(defrule
		(current-age >= castle-age)
		(up-compare-const PIKEMAN-AVAILABLE == YES)
		(up-compare-goal g-desired-num-spearman >= 10)
		(up-research-status c: ri-pikeman < research-pending)
		=>
		(up-jump-rule 1)
		)

			(defrule
			(up-compare-goal g-desired-num-infantry-class > 6)
			(unit-type-count infantry-class > 10)
			(or
				(up-compare-goal g-current-strategy != FC-EAGLES-REVENGE)
				(or
					(up-compare-goal g-age-status >= MID-CASTLE)
					(military-population > 14)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-chain-mail)
			=>
			(research ri-chain-mail)
			)

		(defrule
		(population >= EIGHTY-PERCENT-POP)
		(unit-type-count infantry-class > 5)
		(or
			(up-compare-goal g-current-strategy != FC-EAGLES-REVENGE)
			(or
				(up-compare-goal g-age-status >= MID-CASTLE)
				(military-population > 14)))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-chain-mail)
		=>
		(research ri-chain-mail)
		)

	;-----------------------------------------
	;	Plate Mail - Priority Imperial Tech
	;-----------------------------------------

		(defrule
		(or
			(goal g-primary-unit-class infantry-class)
			(and
				(goal g-support-unit-class infantry-class)
				(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
		(can-research-with-escrow ri-plate-mail)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-plate-mail c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-plate-mail)
		)

		(defrule
		(up-compare-goal g-desired-num-infantry-class > 10)
		(unit-type-count infantry-class > 15)
		(can-research ri-plate-mail)
		=>
		(research ri-plate-mail)
		)
		(defrule
		(population >= NINETY-PERCENT-POP)
		(unit-type-count infantry-class > 5)
		(can-research ri-plate-mail)
		=>
		(research ri-plate-mail)
		)

	;--------------------------------------
	;	Forging - Required Imperial Tech (>= 9 infantry or >= 12 cavalry)
	;--------------------------------------

		(defrule
		(current-age >= castle-age)
		(up-compare-goal g-game-focus == BOOM)
		(up-compare-goal g-eco-tech-progress < PRIORITY-CASTLE-COMPLETE)
		=>
		(up-jump-rule 9)
		)

		(defrule
		(current-age >= castle-age)
		(up-compare-const LONG-SWORDSMAN-AVAILABLE == YES)
		(up-compare-goal g-desired-num-militia >= 10)
		(up-research-status c: ri-long-swordsman < research-pending)
		(food-amount <= 450)
		=>
		(up-jump-rule 8)
		)

		(defrule
		(current-age >= castle-age)
		(up-compare-const PIKEMAN-AVAILABLE == YES)
		(up-compare-goal g-desired-num-spearman >= 10)
		(up-research-status c: ri-pikeman < research-pending)
		(food-amount <= 465)
		=>
		(up-jump-rule 7)
		)

		(defrule
		(current-age >= castle-age)
		(up-compare-const EAGLE-SCOUT-AVAILABLE == YES)
		(up-compare-goal g-desired-num-eagle-warrior >= 10)
		(up-research-status c: ri-eagle-warrior < research-pending)
		(food-amount <= 450)
		=>
		(up-jump-rule 6)
		)

		(defrule
		(current-age >= castle-age)
		(up-compare-const LIGHT-CAVALRY-AVAILABLE == YES)
		(up-compare-goal g-desired-num-scout-cavalry >= 6)
		(up-research-status c: ri-light-cavalry < research-pending)
		(food-amount <= 400)
		=>
		(up-jump-rule 5)
		)

		(defrule
		(current-age >= castle-age)
		(or
			(goal g-primary-unit-class infantry-class)
			(goal g-support-unit-class infantry-class))
		(up-research-status c: ri-scale-mail < research-pending)
		(food-amount <= 350)
		=>
		(up-jump-rule 4)
		)

		(defrule
		(current-age >= castle-age)
		(or
			(goal g-primary-unit-class cavalry-class)
			(goal g-support-unit-class cavalry-class))
		(up-research-status c: ri-scale-barding < research-pending)
		(food-amount <= 400)
		=>
		(up-jump-rule 3)
		)

			(defrule
			(current-age >= castle-age)
			(or
				(goal g-primary-unit-class infantry-class)
				(goal g-support-unit-class infantry-class))
			(can-research-with-escrow ri-forging)
			(or
				(unit-type-count infantry-class >= 9)
				(or
					(unit-type-count infantry-class g:>= g-desired-num-infantry-class)
					(up-compare-goal g-age-status >= TO-IMPERIAL)))
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-forging c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(research ri-forging)
			)
			(defrule
			(current-age >= castle-age)
			(or
				(goal g-primary-unit-class cavalry-class)
				(goal g-support-unit-class cavalry-class))
			(can-research-with-escrow ri-forging)
			(or
				(unit-type-count cavalry-class >= 12)
				(or
					(unit-type-count scout-cavalry-line >= 12)
					(or
						(unit-type-count steppe-lancer-line >= 8)
						(or
							(unit-type-count cavalry-class g:>= g-desired-num-cavalry-class)
							(up-compare-goal g-age-status >= TO-IMPERIAL)))))
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-forging c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(research ri-forging)
			)

			(defrule
			(or
				(unit-type-count infantry-class > 12)
				(or
					(unit-type-count cavalry-class >= 12)
					(or
						(unit-type-count scout-cavalry-line >= 12)
						(unit-type-count steppe-lancer-line >= 10))))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-forging)
			=>
			(research ri-forging)
			)

	;-------------------------------------------
	;	Iron Casting - Priority Imperial Tech (>= 15 infantry or cavalry)
	;-------------------------------------------

		(defrule
		(or
			(goal g-primary-unit-class infantry-class)
			(goal g-support-unit-class infantry-class))
		(or
			(up-research-status c: ri-chain-mail < research-pending)
			(up-compare-const CHAIN-MAIL-ARMOR-AVAILABLE == NO))
		(or
			(food-amount <= 420)
			(gold-amount <= 220))
		=>
		(up-jump-rule 6)
		)

		(defrule
		(or
			(goal g-primary-unit-class cavalry-class)
			(goal g-support-unit-class cavalry-class))
		(or
			(up-research-status c: ri-chain-barding < research-pending)
			(up-compare-const CHAIN-BARDING-ARMOR-AVAILABLE == NO))
		(or
			(food-amount <= 470)
			(gold-amount <= 270))
		=>
		(up-jump-rule 5)
		)

			(defrule
			(goal g-primary-unit-class infantry-class)
			(or
				(unit-type-count infantry-class >= 15)
				(or
					(unit-type-count infantry-class g:>= g-desired-num-infantry-class)
					(up-compare-goal g-age-status >= TO-IMPERIAL)))
			(up-compare-goal g-age-status >= MID-CASTLE)
			(can-research-with-escrow ri-iron-casting)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-iron-casting c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-iron-casting)
			)
			(defrule
			(goal g-primary-unit-class cavalry-class)
			(or
				(unit-type-count cavalry-class >= 15)
				(or
					(unit-type-count scout-cavalry-line >= 15)
					(or
						(unit-type-count steppe-lancer-line >= 12)
						(or
							(unit-type-count cavalry-class g:>= g-desired-num-cavalry-class)
							(up-compare-goal g-age-status >= TO-IMPERIAL)))))
			(up-compare-goal g-age-status >= MID-CASTLE)
			(can-research-with-escrow ri-iron-casting)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-iron-casting c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-iron-casting)
			)
			(defrule
			(goal g-support-unit-class infantry-class)
			(or
				(unit-type-count infantry-class >= 15)
				(or
					(unit-type-count infantry-class g:>= g-desired-num-infantry-class)
					(up-compare-goal g-age-status >= TO-IMPERIAL)))
			(up-compare-goal g-age-status >= MID-CASTLE)
			(can-research-with-escrow ri-iron-casting)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-iron-casting c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-iron-casting)
			)
			(defrule
			(goal g-support-unit-class cavalry-class)
			(or
				(unit-type-count cavalry-class >= 15)
				(or
					(unit-type-count scout-cavalry-line >= 15)
					(or
						(unit-type-count steppe-lancer-line >= 12)
						(or
							(unit-type-count cavalry-class g:>= g-desired-num-cavalry-class)
							(up-compare-goal g-age-status >= TO-IMPERIAL)))))
			(up-compare-goal g-age-status >= MID-CASTLE)
			(can-research-with-escrow ri-iron-casting)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-iron-casting c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-iron-casting)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-infantry-class >= 10)
				(up-compare-goal g-desired-num-cavalry-class >= 10))
			(or
				(unit-type-count infantry-class >= 24)
				(or
					(unit-type-count cavalry-class >= 24)
					(or
						(unit-type-count scout-cavalry-line >= 24)
						(or
							(unit-type-count steppe-lancer-line >= 16)
							(population >= EIGHTY-FIVE-PERCENT-POP)))))
			(up-compare-goal g-age-status >= MID-CASTLE)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-iron-casting)
			=>
			(research ri-iron-casting)
			)

	;--------------------------------------------
	;	Blast Furnace - Secondary Imperial Tech (Priority for Throwing Axemen)
	;--------------------------------------------

		(defrule
		(or
			(goal g-primary-unit-class infantry-class)
			(goal g-support-unit-class infantry-class))
		(up-research-status c: ri-plate-mail < research-pending)
		(up-compare-const PLATE-MAIL-ARMOR-AVAILABLE == YES)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-plate-mail c: 1)
		(up-add-research-cost c: ri-blast-furnace c: 1)
		)

		(defrule
		(or
			(goal g-primary-unit-class infantry-class)
			(goal g-support-unit-class infantry-class))
		(up-research-status c: ri-plate-mail < research-pending)
		(up-compare-const PLATE-MAIL-ARMOR-AVAILABLE == YES)
		(or
			(food-amount g:< g-food-cost)
			(gold-amount g:< g-gold-cost))
		=>
		(up-jump-rule 6)
		)

		(defrule
		(or
			(goal g-primary-unit-class cavalry-class)
			(goal g-support-unit-class cavalry-class))
		(up-research-status c: ri-plate-barding < research-pending)
		(up-compare-const PLATE-BARDING-ARMOR-AVAILABLE == YES)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-plate-barding c: 1)
		(up-add-research-cost c: ri-blast-furnace c: 1)
		)

		(defrule
		(or
			(goal g-primary-unit-class cavalry-class)
			(goal g-support-unit-class cavalry-class))
		(up-research-status c: ri-plate-barding < research-pending)
		(up-compare-const PLATE-BARDING-ARMOR-AVAILABLE == YES)
		(or
			(food-amount g:< g-food-cost)
			(gold-amount g:< g-gold-cost))
		=>
		(up-jump-rule 4)
		)

			(defrule
			(or
				(goal g-primary-unit-class infantry-class)
				(goal g-primary-unit-class cavalry-class))
			(can-research-with-escrow ri-blast-furnace)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-blast-furnace c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-blast-furnace)
			)
			(defrule
			(or
				(goal g-support-unit-class infantry-class)
				(goal g-support-unit-class cavalry-class))
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(can-research-with-escrow ri-blast-furnace)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-blast-furnace c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-blast-furnace)
			)

			(defrule
			(or
				(unit-type-count infantry-class >= 24)
				(or
					(unit-type-count cavalry-class >= 24)
					(or
						(unit-type-count scout-cavalry-line >= 24)
						(unit-type-count steppe-lancer-line >= 16))))
			(can-research ri-blast-furnace)
			=>
			(research ri-blast-furnace)
			)
			(defrule
			(population >= NINETY-PERCENT-POP)
			(or
				(unit-type-count infantry-class >= 12)
				(or
					(unit-type-count cavalry-class >= 12)
					(or
						(unit-type-count scout-cavalry-line >= 12)
						(unit-type-count steppe-lancer-line >= 8))))
			(can-research ri-blast-furnace)
			=>
			(research ri-blast-furnace)
			)

	;---------------------------------------
	;	Gambesons - Secondary Castle Tech
	;---------------------------------------

		(defrule
		(or
			(goal g-primary-unit militiaman)
			(and
				(goal g-support-unit militiaman)
				(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
		(can-research-with-escrow ri-gambesons)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-gambesons c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-gambesons)
		)

		(defrule
		(up-compare-goal g-desired-num-militia > 6)
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-gambesons)
		=>
		(research ri-gambesons)
		)

	;-------------------------------------
	;	Squires - Secondary Castle Tech (>= 8 infantry)
	;-------------------------------------
		
		(defrule
		(unit-type-count infantry-class < 8)
		(unit-type-count infantry-class g:< g-desired-num-infantry-class)
		=>
		(up-jump-rule 2)
		)

			(defrule
			(current-age >= castle-age)
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(up-research-status c: ri-chain-mail >= research-pending)
				(up-compare-const CHAIN-MAIL-ARMOR-AVAILABLE == NO))
			(or
				(up-research-status c: ri-iron-casting >= research-pending)
				(up-compare-const IRON-CASTING-AVAILABLE == NO))
			(goal g-primary-unit-class infantry-class)
			(can-research-with-escrow ri-squires)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-squires c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(research ri-squires)
			)
			(defrule
			(current-age >= castle-age)
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(up-research-status c: ri-chain-mail >= research-pending)
				(up-compare-const CHAIN-MAIL-ARMOR-AVAILABLE == NO))
			(or
				(up-research-status c: ri-iron-casting >= research-pending)
				(up-compare-const IRON-CASTING-AVAILABLE == NO))
			(goal g-support-unit-class infantry-class)
			(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-squires)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-squires c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(research ri-squires)
			)

		(defrule
		(or
			(up-research-status c: ri-chain-mail >= research-pending)
			(up-compare-const CHAIN-MAIL-ARMOR-AVAILABLE == NO))
		(or
			(up-research-status c: ri-iron-casting >= research-pending)
			(up-compare-const IRON-CASTING-AVAILABLE == NO))
		(up-compare-goal g-desired-num-infantry-class > 6)
		(unit-type-count infantry-class > 14)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1100))
		(can-research ri-squires)
		=>
		(research ri-squires)
		)

	;-----------
	;	Arson
	;-----------

		(defrule
		(current-age == castle-age)
		(or
			(up-research-status c: ri-iron-casting >= research-pending)
			(up-compare-const IRON-CASTING-AVAILABLE == NO))
		(or
			(up-research-status c: ri-chain-mail >= research-pending)
			(up-compare-const CHAIN-MAIL-ARMOR-AVAILABLE == NO))
		(unit-type-count infantry-class > 20)
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-arson)
		=>
		(research ri-arson)
		)
		(defrule
		(current-age == imperial-age)
		(or
			(up-research-status c: ri-blast-furnace >= research-pending)
			(up-compare-const BLAST-FURNACE-AVAILABLE == NO))
		(or
			(up-research-status c: ri-plate-mail >= research-pending)
			(up-compare-const PLATE-MAIL-ARMOR-AVAILABLE == NO))
		(unit-type-count infantry-class > 20)
		(can-research ri-arson)
		=>
		(research ri-arson)
		)

;=========================<>=========================
;				     SIEGE TECHS
;=========================<>=========================

	;------------
	;	Onager
	;------------

		(defrule
		(up-compare-goal g-desired-num-mangonel-type > 2)
		(can-research-with-escrow ri-onager)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-onager c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-onager)
		)

		(defrule
		(or
			(up-compare-goal g-desired-num-mangonel-type > 1)
			(unit-type-count-total my-mangonel-line > 2))
		(can-research ri-onager)
		=>
		(research ri-onager)
		)

	;------------------
	;	Siege Onager
	;------------------

		(defrule
		(up-compare-goal g-desired-num-mangonel-type > 2)
		(can-research-with-escrow ri-siege-onager)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-siege-onager c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-siege-onager)
		)

		(defrule
		(or
			(up-compare-goal g-desired-num-mangonel-type > 1)
			(unit-type-count-total my-mangonel-line > 3))
		(can-research ri-siege-onager)
		=>
		(research ri-siege-onager)
		)

	;-----------------------
	;	Heavy Rocket Cart
	;-----------------------

		(defrule
		(up-compare-goal g-desired-num-mangonel-type > 2)
		(can-research-with-escrow ri-heavy-rocket-cart)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-heavy-rocket-cart c: 1)
		(up-modify-escrow wood g:- g-wood-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-heavy-rocket-cart)
		)

		(defrule
		(or
			(up-compare-goal g-desired-num-mangonel-type > 1)
			(unit-type-count-total my-mangonel-line > 3))
		(can-research ri-heavy-rocket-cart)
		=>
		(research ri-heavy-rocket-cart)
		)

	;--------------------
	;	Heavy Scorpion
	;--------------------

		(defrule
		(or
			(goal g-game-focus BOOM)
			(goal g-game-focus REBUILD))
		(up-object-type-count-total c: town-center g:< g-desired-num-town-center)
		=>
		(up-jump-rule 2)
		)

			(defrule
			(up-compare-goal g-desired-num-scorpion-type > 3)
			(can-research-with-escrow ri-heavy-scorpion)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-heavy-scorpion c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow wood g:- g-wood-cost)
			(research ri-heavy-scorpion)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-scorpion-type > 1)
				(unit-type-count scorpion-line > 3))
			(can-research ri-heavy-scorpion)
			=>
			(research ri-heavy-scorpion)
			)

	;----------------
	;	Capped Ram
	;----------------

		(defrule
		(up-compare-goal g-desired-num-ram-type > 1)
		(can-research-with-escrow ri-capped-ram)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-capped-ram c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(research ri-capped-ram)
		)

		(defrule
		(or
			(up-compare-goal g-desired-num-ram-type > 0)
			(unit-type-count battering-ram-line > 2))
		(can-research ri-capped-ram)
		=>
		(research ri-capped-ram)
		)

	;---------------
	;	Siege Ram
	;---------------

		(defrule
		(up-compare-goal g-desired-num-ram-type > 2)
		(can-research-with-escrow ri-siege-ram)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-siege-ram c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(research ri-siege-ram)
		)

		(defrule
		(or
			(up-compare-goal g-desired-num-ram-type > 1)
			(unit-type-count battering-ram-line > 3))
		(can-research ri-siege-ram)
		=>
		(research ri-siege-ram)
		)

	;---------------------
	;	Siege Engineers
	;---------------------

		(defrule
		(or
			(goal g-game-focus BOOM)
			(goal g-game-focus REBUILD))
		(up-object-type-count-total c: town-center g:< g-desired-num-town-center)
		=>
		(up-jump-rule 2)
		)

			(defrule
			(up-compare-goal g-desired-num-siege-classes > 0)
			(can-research-with-escrow ri-siege-engineers)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-siege-engineers c: 1)
			(up-modify-escrow food g:- g-food-cost)
			(up-modify-escrow wood g:- g-wood-cost)
			(research ri-siege-engineers)
			)

			(defrule
			(up-compare-goal g-desired-num-siege-classes > 0)
			(can-research ri-siege-engineers)
			=>
			(research ri-siege-engineers)
			)

;=========================<>=========================
;				      MONK TECHS
;=========================<>=========================

	;------------
	;	Heresy
	;------------

		(defrule
		(up-compare-goal g-enemy-monks-count >= 12)
		(can-research-with-escrow ri-heresy)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-heresy c: 1)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-heresy)
		)

		(defrule
		(up-compare-goal g-enemy-monks-count >= 5)
		(can-research ri-heresy)
		=>
		(research ri-heresy)
		)

		;Battle Elephants
		(defrule
		(goal g-primary-unit battle-elephant)
		(can-research-with-escrow ri-heresy)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-heresy c: 1)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-heresy)
		)

		(defrule
		(or
			(up-compare-goal g-desired-num-battle-elephant > 6)
			(unit-type-count-total battle-elephant-line > 10))
		(up-compare-goal g-battle-elephant-tech-progress >= SECONDARY-IMPERIAL-COMPLETE)
		(can-research ri-heresy)
		=>
		(research ri-heresy)
		)

	;-----------
	;	Faith
	;-----------

		(defrule
		(up-compare-goal g-enemy-monks-count >= 5)
		(up-compare-const HERESY-AVAILABLE == NO)
		(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-IMPERIAL-COMPLETE)
		(can-research ri-faith)
		=>
		(research ri-faith)
		)

		;Battle Elephants
		(defrule
		(or
			(up-compare-goal g-desired-num-battle-elephant > 6)
			(unit-type-count-total battle-elephant-line > 10))
		(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-IMPERIAL-COMPLETE)
		(can-research ri-faith)
		=>
		(research ri-faith)
		)

		;War Elephants
		#load-if-defined PERSIAN-CIV
		
			(defrule
			(or
				(up-compare-goal g-desired-num-unique-unit > 6)
				(unit-type-count-total my-unique-unit-line > 10))
			(can-research ri-faith)
			=>
			(research ri-faith)
			)

		#end-if

	;----------------
	;	Redemption
	;----------------

		(defrule
		(or
			(goal g-primary-unit monk)
			(and
				(goal g-support-unit monk)
				(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
		(or
			(up-compare-goal g-enemy-field-siege-count > 0)
			(or
				(up-research-status c: ri-sanctity >= research-pending)
				(up-compare-const SANCTITY-AVAILABLE == NO)))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(gold-amount >= 1275))
		(can-research-with-escrow ri-redemption)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-redemption c: 1)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-redemption)
		)

		(defrule
		(up-compare-goal g-desired-num-monk >= 4)
		(or
			(up-compare-goal g-enemy-field-siege-count > 0)
			(and
				(up-compare-goal g-desired-num-monk >= 7)
				(or
					(up-research-status c: ri-sanctity >= research-pending)
					(up-compare-const SANCTITY-AVAILABLE == NO))))
		(up-compare-goal g-current-age-primary-unit-tech-progress >= SECONDARY-COMPLETE)
		(can-research ri-redemption)
		=>
		(research ri-redemption)
		)

	;--------------------
	;	Block Printing
	;--------------------

		(defrule
		(or
			(goal g-primary-unit monk)
			(and
				(goal g-support-unit monk)
				(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
		(can-research-with-escrow ri-block-printing)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-block-printing c: 1)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-block-printing)
		)

		(defrule
		(up-compare-goal g-desired-num-monk >= 4)
		(up-compare-goal g-current-age-primary-unit-tech-progress >= SECONDARY-COMPLETE)
		(can-research ri-block-printing)
		=>
		(research ri-block-printing)
		)

	;--------------
	;	Sanctity
	;--------------

		(defrule
		(or
			(goal g-primary-unit monk)
			(and
				(goal g-support-unit monk)
				(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
		(or
			(up-research-status c: ri-block-printing >= research-pending)
			(or
				(current-age == castle-age)
				(up-compare-const BLOCK-PRINTING-AVAILABLE == NO)))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(gold-amount >= 920))
		(can-research-with-escrow ri-sanctity)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-sanctity c: 1)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-sanctity)
		)

		(defrule
		(up-compare-goal g-human-military-count g:>= g-min-military-pop)
		(up-compare-goal g-desired-num-monk >= 3)
		(unit-type-count monastery-class >= 3)
		(up-compare-goal g-current-age-primary-unit-tech-progress >= SECONDARY-COMPLETE)
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-sanctity)
		=>
		(research ri-sanctity)
		)

	;------------
	;	Fervor
	;------------

		#load-if-defined UP-GAME-WK		;Fervor actually had no effect in the original game

			(defrule
			(or
				(goal g-primary-unit monk)
				(and
					(goal g-support-unit monk)
					(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
			(or
				(up-research-status c: ri-block-printing >= research-pending)
				(or
					(current-age == castle-age)
					(up-compare-const BLOCK-PRINTING-AVAILABLE == NO)))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(gold-amount >= 940))
			(can-research-with-escrow ri-fervor)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-fervor c: 1)
			(up-modify-escrow gold g:- g-gold-cost)
			(research ri-fervor)
			)

			(defrule
			(up-compare-goal g-human-military-count g:>= g-min-military-pop)
			(up-compare-goal g-desired-num-monk >= 3)
			(unit-type-count monastery-class >= 3)
			(up-compare-goal g-current-age-primary-unit-tech-progress >= SECONDARY-COMPLETE)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-fervor)
			=>
			(research ri-fervor)
			)

		#end-if

	;---------------
	;	Theocracy
	;---------------

		(defrule
		(or
			(goal g-primary-unit monk)
			(and
				(goal g-support-unit monk)
				(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
		(or
			(up-research-status c: ri-block-printing >= research-pending)
			(up-compare-const BLOCK-PRINTING-AVAILABLE == NO))
		(can-research-with-escrow ri-theocracy)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-theocracy c: 1)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-theocracy)
		)

		(defrule
		(or
			(up-research-status c: ri-block-printing >= research-pending)
			(up-compare-const BLOCK-PRINTING-AVAILABLE == NO))
		(up-compare-goal g-desired-num-monk >= 5)
		(can-research ri-theocracy)
		=>
		(research ri-theocracy)
		)

		(defrule
		(or
			(up-research-status c: ri-block-printing >= research-pending)
			(up-compare-const BLOCK-PRINTING-AVAILABLE == NO))
		(up-compare-goal g-desired-num-monk >= 4)
		(up-compare-goal g-current-age-primary-unit-tech-progress >= SECONDARY-COMPLETE)
		(can-research ri-theocracy)
		=>
		(research ri-theocracy)
		)

	;------------------
	;	Illumination
	;------------------

		(defrule
		(or
			(goal g-primary-unit monk)
			(and
				(goal g-support-unit monk)
				(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
		(or
			(up-research-status c: ri-theocracy >= research-pending)
			(up-compare-const THEOCRACY-AVAILABLE == NO))
		(can-research-with-escrow ri-illumination)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-illumination c: 1)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-illumination)
		)

		(defrule
		(or
			(up-research-status c: ri-theocracy >= research-pending)
			(or
				(up-compare-const THEOCRACY-AVAILABLE == NO)
				(up-compare-goal g-desired-num-monk < 5)))
		(up-compare-goal g-desired-num-monk >= 4)
		(or
			(unit-type-count monastery-class >= 5)
			(population >= NINETY-FIVE-PERCENT-POP))
		(can-research ri-illumination)
		=>
		(research ri-illumination)
		)

	;---------------
	;	Atonement
	;---------------

		(defrule
		(or
			(goal g-primary-unit monk)
			(and
				(goal g-support-unit monk)
				(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS)))
		(up-compare-goal g-enemy-monks-count >= 5)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(gold-amount >= 1125))
		(can-research-with-escrow ri-atonement)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-atonement c: 1)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-atonement)
		)

		(defrule
		(up-compare-goal g-desired-num-monastery-class >= 5)
		(up-compare-goal g-enemy-monks-count >= 5)
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(or
			(unit-type-count monastery-class >= 5)
			(population >= NINETY-FIVE-PERCENT-POP))
		(can-research ri-atonement)
		=>
		(research ri-atonement)
		)

	;----------------------
	;	Aztec Monk Techs
	;----------------------

		#load-if-defined AZTEC-CIV

			(defrule
			(or
				(goal g-primary-unit monk)
				(and
					(goal g-support-unit monk)
					(and
						(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-CASTLE-COMPLETE)
						(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS))))
			(research-completed ri-redemption)
			(research-completed ri-sanctity)
			(research-completed ri-fervor)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-atonement)
			=>
			(research ri-atonement)
			)

			(defrule
			(or
				(goal g-primary-unit monk)
				(and
					(goal g-support-unit monk)
					(and
						(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-IMPERIAL-COMPLETE)
						(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS))))
			(research-completed ri-redemption)
			(research-completed ri-sanctity)
			(research-completed ri-fervor)
			(research-completed ri-atonement)
			(or
				(unit-type-count monastery-class >= 7)
				(population >= NINETY-FIVE-PERCENT-POP))
			(can-research ri-herbal-medicine)
			=>
			(research ri-herbal-medicine)
			)

			(defrule
			(or
				(goal g-primary-unit monk)
				(and
					(goal g-support-unit monk)
					(and
						(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-CASTLE-COMPLETE)
						(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS))))
			(research-completed ri-redemption)
			(research-completed ri-sanctity)
			(research-completed ri-fervor)
			(research-completed ri-atonement)
			(or
				(up-compare-goal g-enemy-monks-count >= 5)
				(population >= NINETY-PERCENT-POP))
			(can-research ri-heresy)
			=>
			(research ri-heresy)
			)

			(defrule
			(or
				(goal g-primary-unit monk)
				(and
					(goal g-support-unit monk)
					(and
						(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-CASTLE-COMPLETE)
						(up-compare-flag g-flag == SAVE-FOR-SUPPORT-UNIT-TECHS))))
			(research-completed ri-redemption)
			(research-completed ri-sanctity)
			(research-completed ri-fervor)
			(research-completed ri-atonement)
			(research-completed ri-herbal-medicine)
			(research-completed ri-heresy)
			(can-research ri-faith)
			=>
			(research ri-faith)
			)

		#end-if

;=========================<>=========================
;				     OTHER TECHS
;=========================<>=========================

	;------------------
	;	Conscription
	;------------------

		(defrule
		(can-research-with-escrow ri-conscription)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-conscription c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-conscription)
		)

	;-----------------
	;	Cartography
	;-----------------

		(defrule
		(current-age >= castle-age)
		(or
			(up-compare-flag g-flag == FIRST-ATTACK-LAUNCHED)
			(and
				(goal g-position POCKET)
				(up-compare-goal g-eco-tech-progress >= ALL-CASTLE-COMPLETE)))
		(goal g-town-under-attack NO)
		(player-in-game any-ally)
		(can-research ri-cartography)
		=>
		(research ri-cartography)
		)

	;--------------
	;	Caravan
	;--------------

        (defrule
		(or
			(up-compare-goal g-desired-num-trade-cart > 0)
			(up-compare-goal g-desired-num-trade-cog > 0))
        (can-research-with-escrow ri-caravan)
        =>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-caravan c: 1)
		(up-modify-escrow food g:- g-food-cost)
		(up-modify-escrow gold g:- g-gold-cost)
		(research ri-caravan)
        )

	;-------------
	;	Coinage
	;-------------

		(defrule
		(or
			(current-age == imperial-age)
			(population >= EIGHTY-PERCENT-POP))
		(population >= SEVENTY-PERCENT-POP)
		(player-in-game any-ally)
		(can-research ri-coinage)
		=>
		(research ri-coinage)
		)

	;-------------
	;	Banking
	;-------------

		(defrule
		(population >= EIGHTY-PERCENT-POP)
		(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-IMPERIAL-COMPLETE)
		(player-in-game any-ally)
		(can-research ri-banking)
		=>
		(research ri-banking)
		)

	;------------
	;	Guilds
	;------------

		(defrule
		(or
			(dropsite-min-distance gold > 50)
			(or
				(unit-type-count villager-gold == 0)
				(up-compare-goal g-current-strategy >= 1301)))	;Late Imperial
		(current-age == imperial-age)
		(can-research ri-guilds)
		=>
		(research ri-guilds)
		)

	;------------------
	;	Murder Holes
	;------------------

		(defrule
		(can-research ri-murder-holes)
		(or
			(building-type-count castle > 2)
			(building-type-count tower-class > 5))
		(current-age == imperial-age)
		(population >= EIGHTY-FIVE-PERCENT-POP)
		=>
		(research ri-murder-holes)
		)

	;---------------
	;	Hoardings
	;---------------

		(defrule
		(can-research ri-hoardings)
		(building-type-count castle > 1)
		(up-get-fact military-population 0 g-temp)
		(up-get-fact-max any-enemy military-population 0 g-temp2)
		(up-modify-goal g-temp g:- g-temp2)
		(or
			(goal g-town-under-attack YES)
			(or
				(up-compare-goal g-temp < 10)
				(and
					(building-type-count castle > 2)
					(population >= NINETY-PERCENT-POP))))
		=>
		(research ri-hoardings)
		)

	;----------------
	;	Town Watch
	;----------------

		(defrule
		(current-age >= castle-age)
		(building-type-count town-center > 1)
		(or
			(and
				(goal g-game-focus DEFENSIVE)
				(goal g-town-under-attack NO))
			(up-building-type-in-town c: watch-tower >= 4))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1075))
		(can-research ri-town-watch)
		=>
		(research ri-town-watch)
		)

		(defrule
		(building-type-count town-center > 1)
		(up-compare-goal g-eco-tech-progress >= ALL-CASTLE-COMPLETE)
		(population >= SEVENTY-PERCENT-POP)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1075))
		(can-research ri-town-watch)
		=>
		(research ri-town-watch)
		)

	;-----------------
	;	Town Patrol
	;-----------------

		(defrule
		(building-type-count town-center > 2)
		(up-compare-goal g-eco-tech-progress >= SECONDARY-IMPERIAL-COMPLETE)
		(population >= NINETY-PERCENT-POP)
		(can-research ri-town-patrol)
		=>
		(research ri-town-patrol)
		)
		
	;-------------
	;	Masonry
	;-------------

		(defrule
		(current-age >= castle-age)
		(up-compare-goal g-eco-tech-progress >= ALL-CASTLE-COMPLETE)
		(up-compare-goal g-current-age-primary-unit-tech-progress >= PRIORITY-COMPLETE)
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-masonry)
		=>
		(research ri-masonry)
		)
		
	;------------------
	;	Architecture
	;------------------

		(defrule
		(up-compare-goal g-eco-tech-progress >= ALL-CASTLE-COMPLETE)
		(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-IMPERIAL-COMPLETE)
		(building-type-count castle >= 2)
		(population >= NINETY-PERCENT-POP)
		(can-research ri-architecture)
		=>
		(research ri-architecture)
		)
		
	;---------------------
	;	Treadmill Crane
	;---------------------

		(defrule
		(current-age == imperial-age)
		(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-IMPERIAL-COMPLETE)
		(up-compare-goal g-support-unit-tech-progress >= SECONDARY-IMPERIAL-COMPLETE)
		(up-compare-goal g-eco-tech-progress >= SECONDARY-IMPERIAL-COMPLETE)
		(can-research ri-treadmill-crane)
		=>
		(research ri-treadmill-crane)
		)

		(defrule
		(up-compare-goal g-desired-num-wonder > 0)
		(building-type-count wonder == 0)
		(can-research ri-treadmill-crane)
		=>
		(research ri-treadmill-crane)
		)
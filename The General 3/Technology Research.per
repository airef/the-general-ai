;Technology Research.per

;-----------
;	Reset
;-----------

	(defrule
	(up-compare-goal g-wood-escrow-type != ACCUMULATED)
	=>
	(release-escrow wood)
	)

	(defrule
	(up-compare-goal g-food-escrow-type != ACCUMULATED)
	=>
	(release-escrow food)
	)

	(defrule
	(up-compare-goal g-gold-escrow-type != ACCUMULATED)
	=>
	(release-escrow gold)
	)

	(defrule
	(up-compare-goal g-stone-escrow-type != ACCUMULATED)
	=>
	(release-escrow stone)
	)

	(defrule
	(true)
	=>
	(up-reset-cost-data g-max-food-needed)
	(set-escrow-percentage food 0)
	(set-escrow-percentage wood 0)
	(set-escrow-percentage gold 0)
	(set-escrow-percentage stone 0)
	)

;=========================<>=========================
;				      ECO TECHS
;=========================<>=========================
			
	;--------------------
	;	Double-Bit Axe
	;--------------------

		(defrule
		(or
			(goal g-strategy-type DRUSH)
			(or
				(goal g-strategy-type FLUSH)
				(and
					(up-compare-goal g-current-strategy >= 1201)	;Boom Imperial Strats
					(up-compare-goal g-current-strategy < 1301))))
		(can-research-with-escrow ri-double-bit-axe)
		=>
		(release-escrow food)
		(release-escrow wood)
		(research ri-double-bit-axe)
		)

		(defrule
		(or
			(goal g-strategy-type FAST-CASTLE)
			(goal g-strategy-type FAST-IMPERIAL))
		(or
			(up-compare-goal g-current-strategy != FC-STRONGBOW)
			(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(can-research-with-escrow ri-double-bit-axe)
		(up-compare-goal g-age-status >= TO-CASTLE)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1100))
		=>
		(release-escrow food)
		(release-escrow wood)
		(research ri-double-bit-axe)
		)

		(defrule
		(or
			(goal g-strategy-type FAST-CASTLE)
			(goal g-strategy-type FAST-IMPERIAL))
		(or
			(up-compare-goal g-current-strategy != FC-STRONGBOW)
			(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(up-research-status c: ri-double-bit-axe == research-available)
		(up-compare-goal g-age-status >= TO-CASTLE)
		(building-type-count lumber-camp > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-double-bit-axe c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-strategy-type FAST-CASTLE)
		; 	(goal g-strategy-type FAST-IMPERIAL))
		; (or
		; 	(up-compare-goal g-current-strategy != FC-STRONGBOW)
		; 	(up-compare-goal g-primary-unit-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		; (up-research-status c: ri-double-bit-axe == research-available)
		; (up-compare-goal g-age-status >= TO-CASTLE)
		; (building-type-count lumber-camp > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for DBA, FC")
		; )

		(defrule
		(or
			(goal g-strategy-type DRUSH)
			(or
				(goal g-strategy-type FLUSH)
				(and
					(up-compare-goal g-current-strategy >= 1201)	;Boom Imperial Strats
					(up-compare-goal g-current-strategy < 1301))))
		(up-research-status c: ri-double-bit-axe == research-available)
		(building-type-count lumber-camp > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-double-bit-axe c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-strategy-type DRUSH)
		; 	(or
		; 		(goal g-strategy-type FLUSH)
		; 		(and
		; 			(up-compare-goal g-current-strategy >= 1201)	;Boom Imperial Strats
		; 			(up-compare-goal g-current-strategy < 1301))))
		; (up-research-status c: ri-double-bit-axe == research-available)
		; (building-type-count lumber-camp > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for DBA, flush")
		; )

    ;-------------
    ;   Bow Saw
    ;-------------

		(defrule
		(can-research-with-escrow ri-bow-saw)
		(or
			(up-compare-goal g-current-strategy != FC-STRONGBOW)
			(up-compare-goal g-age-status >= MID-CASTLE))
		;(goal g-town-under-attack NO)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1150))
		(or
			(up-object-type-count c: town-center g:>= g-desired-num-town-center)
			(building-type-count town-center >= 2))
		=>
		(release-escrow food)
		(release-escrow wood)
		(research ri-bow-saw)
		)

		(defrule
		(up-research-status c: ri-bow-saw < research-pending)
		(up-compare-goal g-age-status >= TO-CASTLE)
		(or
			(up-compare-goal g-current-strategy != FC-STRONGBOW)
			(up-compare-goal g-age-status >= MID-CASTLE))
		;(goal g-town-under-attack NO)
		(building-type-count lumber-camp > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-bow-saw c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-research-status c: ri-bow-saw < research-pending)
		; (up-compare-goal g-age-status >= TO-CASTLE)
		; (or
		; 	(up-compare-goal g-current-strategy != FC-STRONGBOW)
		; 	(up-compare-goal g-age-status >= MID-CASTLE))
		; ;(goal g-town-under-attack NO)
		; (building-type-count lumber-camp > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Bow Saw")
		; )

    ;-----------------
    ;   Two-Man Saw
    ;-----------------

		(defrule
		(can-research-with-escrow ri-two-man-saw)
		(population > SIXTY-PERCENT-POP)
		;(goal g-town-under-attack NO)
		=>
		(release-escrow food)
		(release-escrow wood)
		(research ri-two-man-saw)
		)

		(defrule
		(up-research-status c: ri-two-man-saw == research-available)
		(population > SIXTY-PERCENT-POP)
		;(goal g-town-under-attack NO)
		(building-type-count lumber-camp > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-two-man-saw c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-research-status c: ri-two-man-saw == research-available)
		; (population > SIXTY-PERCENT-POP)
		; ;(goal g-town-under-attack NO)
		; (building-type-count lumber-camp > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Two-Man Saw")
		; )

		(defrule
		(can-research ri-two-man-saw)
		;(goal g-town-under-attack NO)
		=>
		(research ri-two-man-saw)
		)

	;--------------------
	;	Horse Collar
	;--------------------

		(defrule
		(or
			(goal g-strategy-type FAST-CASTLE)
			(goal g-strategy-type FAST-IMPERIAL))
		(or
			(up-compare-goal g-current-strategy != FC-STRONGBOW)
			(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-CASTLE-COMPLETE))
		(up-research-status c: ri-double-bit-axe >= research-pending)
		(can-research-with-escrow ri-horse-collar)
		(up-compare-goal g-age-status >= TO-CASTLE)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1075))
		=>
		(release-escrow food)
		(release-escrow wood)
		(research ri-horse-collar)
		)

		(defrule
		(or
			(goal g-strategy-type FAST-CASTLE)
			(goal g-strategy-type FAST-IMPERIAL))
		(or
			(up-compare-goal g-current-strategy != FC-STRONGBOW)
			(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-CASTLE-COMPLETE))
		(up-research-status c: ri-double-bit-axe >= research-pending)
		(up-research-status c: ri-horse-collar == research-available)
		(up-compare-goal g-age-status >= TO-CASTLE)
		(building-type-count mill > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-horse-collar c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-strategy-type FAST-CASTLE)
		; 	(goal g-strategy-type FAST-IMPERIAL))
		; (or
		; 	(up-compare-goal g-current-strategy != FC-STRONGBOW)
		; 	(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-CASTLE-COMPLETE))
		; (up-research-status c: ri-double-bit-axe >= research-pending)
		; (up-research-status c: ri-horse-collar == research-available)
		; (up-compare-goal g-age-status >= TO-CASTLE)
		; (building-type-count mill > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Horse Collar")
		; )

    ;----------------
    ;   Heavy Plow
    ;----------------

		(defrule
		(can-research-with-escrow ri-heavy-plow)
		(up-research-status c: ri-bow-saw >= research-pending)
		;(goal g-town-under-attack NO)
		(or
			(goal g-first-attack-launched YES)
			(and
				(goal g-position POCKET)
				(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-CASTLE-COMPLETE)))
		(up-object-type-count c: town-center g:>= g-desired-num-town-center)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1125))
		=>
		(release-escrow food)
		(release-escrow wood)
		(research ri-heavy-plow)
		)

		(defrule
		(up-research-status c: ri-heavy-plow == research-available)
		(up-research-status c: ri-bow-saw >= research-pending)
		;(goal g-town-under-attack NO)
		(or
			(goal g-first-attack-launched YES)
			(and
				(goal g-position POCKET)
				(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-CASTLE-COMPLETE)))
		(up-object-type-count c: town-center g:>= g-desired-num-town-center)
		(building-type-count mill > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-heavy-plow c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-research-status c: ri-heavy-plow == research-available)
		; (up-research-status c: ri-bow-saw >= research-pending)
		; ;(goal g-town-under-attack NO)
		; (or
		; 	(goal g-first-attack-launched YES)
		; 	(and
		; 		(goal g-position POCKET)
		; 		(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-CASTLE-COMPLETE)))
		; (up-object-type-count c: town-center g:>= g-desired-num-town-center)
		; (building-type-count mill > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Heavy Plow")
		; )

    ;-------------------
    ;   Crop Rotation
    ;-------------------

		(defrule
		(can-research-with-escrow ri-crop-rotation)
		(population > SIXTY-PERCENT-POP)
		;(goal g-town-under-attack NO)
		=>
		(release-escrow food)
		(release-escrow wood)
		(research ri-crop-rotation)
		)

		(defrule
		(up-research-status c: ri-crop-rotation == research-available)
		(population > SIXTY-PERCENT-POP)
		;(goal g-town-under-attack NO)
		(building-type-count mill > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-crop-rotation c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-research-status c: ri-crop-rotation == research-available)
		; (population > SIXTY-PERCENT-POP)
		; ;(goal g-town-under-attack NO)
		; (building-type-count mill > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Crop Rotation")
		; )

		(defrule
		(can-research ri-crop-rotation)
		;(goal g-town-under-attack NO)
		=>
		(research ri-crop-rotation)
		)

	;-----------------
	;	Wheelbarrow
	;-----------------

        (defrule
        (can-research-with-escrow ri-wheel-barrow)
		(or
			(unit-type-count villager >= 45)
			(and
				(up-compare-goal g-game-focus != AGGRESSIVE)
				(unit-type-count villager >= 30)))
		(goal g-first-attack-launched YES)
		(current-age == feudal-age)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-CASTLE)
			(food-amount >= 975))
        =>
		(release-escrow food)
		(release-escrow wood)
		(research ri-wheel-barrow)
        )

        (defrule
        (can-research-with-escrow ri-wheel-barrow)
		(or
			(unit-type-count villager >= 45)
			(and
				(up-compare-goal g-game-focus != AGGRESSIVE)
				(unit-type-count villager >= 30)))
		(goal g-first-attack-launched YES)
		(building-type-count town-center > 1)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1175))
        =>
		(release-escrow food)
		(release-escrow wood)
		(research ri-wheel-barrow)
        )

        (defrule
        (can-research-with-escrow ri-wheel-barrow)
		(or
			(unit-type-count villager >= 45)
			(and
				(up-compare-goal g-game-focus != AGGRESSIVE)
				(unit-type-count villager >= 30)))
		(goal g-position POCKET)
		(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-CASTLE-COMPLETE)
		(or
			(building-type-count town-center > 1)
			(current-age == feudal-age))
		(up-compare-goal g-age-status != SAVE-FOR-CASTLE)
        =>
		(release-escrow food)
		(release-escrow wood)
		(research ri-wheel-barrow)
        )

        (defrule
		(goal g-game-focus BOOM)
        (can-research-with-escrow ri-wheel-barrow)
		(unit-type-count villager >= 30)
		(or
			(current-age == feudal-age)
			(and
				(building-type-count-total town-center > 1)
				(up-compare-goal g-desired-num-town-center <= 1)))
		(up-compare-goal g-age-status != SAVE-FOR-CASTLE)
        =>
		(release-escrow food)
		(release-escrow wood)
		(research ri-wheel-barrow)
        )

		(defrule
		(or
			(unit-type-count villager >= 45)
			(and
				(up-compare-goal g-game-focus != AGGRESSIVE)
				(unit-type-count villager >= 30)))
		(goal g-first-attack-launched YES)
		(up-research-status c: ri-wheel-barrow == research-available)
		(or
			(building-type-count town-center > 1)
			(current-age == feudal-age))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-wheel-barrow c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		(set-goal g-allow-queued-villagers NO)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(unit-type-count villager >= 45)
		; 	(and
		; 		(up-compare-goal g-game-focus != AGGRESSIVE)
		; 		(unit-type-count villager >= 30)))
		; (goal g-first-attack-launched YES)
		; (up-research-status c: ri-wheel-barrow == research-available)
		; (or
		; 	(building-type-count town-center > 1)
		; 	(current-age == feudal-age))
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Wheelbarrow, default")
		; )

		(defrule
		(or
			(unit-type-count villager >= 45)
			(and
				(up-compare-goal g-game-focus != AGGRESSIVE)
				(unit-type-count villager >= 30)))
		(goal g-position POCKET)
		(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-CASTLE-COMPLETE)
		(up-research-status c: ri-wheel-barrow == research-available)
		(or
			(building-type-count town-center > 1)
			(current-age == feudal-age))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-wheel-barrow c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		(set-goal g-allow-queued-villagers NO)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(unit-type-count villager >= 45)
		; 	(and
		; 		(up-compare-goal g-game-focus != AGGRESSIVE)
		; 		(unit-type-count villager >= 30)))
		; (goal g-position POCKET)
		; (up-compare-goal g-primary-unit-tech-progress >= SECONDARY-CASTLE-COMPLETE)
		; (up-research-status c: ri-wheel-barrow == research-available)
		; (or
		; 	(building-type-count town-center > 1)
		; 	(current-age == feudal-age))
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Wheelbarrow, pocket")
		; )

		(defrule
		(goal g-game-focus BOOM)
		(unit-type-count villager >= 30)
		(or
			(current-age == feudal-age)
			(and
				(building-type-count-total town-center > 1)
				(up-compare-goal g-desired-num-town-center <= 1)))
		(up-research-status c: ri-wheel-barrow == research-available)
		(up-compare-goal g-age-status != SAVE-FOR-CASTLE)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-wheel-barrow c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		(set-goal g-allow-queued-villagers NO)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-game-focus BOOM)
		; (unit-type-count villager >= 30)
		; (or
		; 	(current-age == feudal-age)
		; 	(and
		; 		(building-type-count-total town-center > 1)
		; 		(up-compare-goal g-desired-num-town-center <= 1)))
		; (up-research-status c: ri-wheel-barrow == research-available)
		; (up-compare-goal g-age-status != SAVE-FOR-CASTLE)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Wheelbarrow, boom")
		; )

	;---------------
	;	Hand Cart
	;---------------

        (defrule
        (can-research-with-escrow ri-hand-cart)
		(or
			(unit-type-count villager >= 100)
			(and
				(up-compare-goal g-game-focus != AGGRESSIVE)
				(unit-type-count villager >= 75)))
		(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-CASTLE-COMPLETE)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1300))
		(building-type-count town-center >= 3)
        =>
		(release-escrow food)
		(release-escrow wood)
		(research ri-hand-cart)
        )

		(defrule
		(or
			(unit-type-count villager >= 100)
			(and
				(up-compare-goal g-game-focus != AGGRESSIVE)
				(unit-type-count villager >= 75)))
		(goal g-first-attack-launched YES)
		(up-research-status c: ri-hand-cart == research-available)
		(building-type-count town-center >= 3)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-hand-cart c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		(set-goal g-allow-queued-villagers NO)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(unit-type-count villager >= 100)
		; 	(and
		; 		(up-compare-goal g-game-focus != AGGRESSIVE)
		; 		(unit-type-count villager >= 75)))
		; (goal g-first-attack-launched YES)
		; (up-research-status c: ri-hand-cart == research-available)
		; (building-type-count town-center >= 3)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Hand Cart, default")
		; )

		(defrule
		(or
			(unit-type-count villager >= 100)
			(and
				(up-compare-goal g-game-focus != AGGRESSIVE)
				(unit-type-count villager >= 75)))
		(goal g-position POCKET)
		(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-CASTLE-COMPLETE)
		(up-research-status c: ri-hand-cart == research-available)
		(building-type-count town-center >= 3)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-hand-cart c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		(set-goal g-allow-queued-villagers NO)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(unit-type-count villager >= 100)
		; 	(and
		; 		(up-compare-goal g-game-focus != AGGRESSIVE)
		; 		(unit-type-count villager >= 75)))
		; (goal g-position POCKET)
		; (up-compare-goal g-primary-unit-tech-progress >= SECONDARY-CASTLE-COMPLETE)
		; (up-research-status c: ri-hand-cart == research-available)
		; (building-type-count town-center >= 3)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Hand Cart, pocket")
		; )

		(defrule
		(population >= FIFTY-PERCENT-POP)
		(can-research ri-hand-cart)
		=>
		(research ri-hand-cart)
		)

    ;-----------------
    ;   Gold Mining
    ;-----------------

        (defrule
        (up-compare-goal g-eco-tech-progress >= SECONDARY-CASTLE-COMPLETE)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1100))
		(unit-type-count villager-gold >= 6)
        (can-research ri-gold-mining)
        =>
		(research ri-gold-mining)
        )
		
	;-----------------------
    ;   Gold Shaft Mining
    ;-----------------------

        (defrule
		(current-age == castle-age)
        (or
			(goal g-first-attack-launched YES)
			(goal g-position POCKET))
		(up-compare-goal g-eco-tech-progress >= SECONDARY-CASTLE-COMPLETE)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1200))
		(unit-type-count villager-gold >= 6)
        (can-research ri-gold-shaft-mining)
        =>
		(research ri-gold-shaft-mining)
        )

        (defrule
        (or
			(goal g-first-attack-launched YES)
			(goal g-position POCKET))
		(up-compare-goal g-eco-tech-progress >= ALL-CASTLE-COMPLETE)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1200))
		(unit-type-count villager-gold >= 6)
        (can-research ri-gold-shaft-mining)
        =>
		(research ri-gold-shaft-mining)
        )

		(defrule
		(up-compare-goal g-eco-tech-progress >= ALL-CASTLE-COMPLETE)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1200))
		(population >= EIGHTY-PERCENT-POP)
		(can-research ri-gold-shaft-mining)
		(dropsite-min-distance gold < 255)
		=>
		(research ri-gold-shaft-mining)
		)
		
    ;------------------
    ;   Stone Mining
    ;------------------

        (defrule
        (up-compare-goal g-eco-tech-progress >= SECONDARY-CASTLE-COMPLETE)
		(or
			(goal g-current-strategy FC-CASTLE-DROP)
			(or
				(up-compare-goal g-desired-num-castle >= 3)
				(or
					(up-compare-goal g-desired-num-watch-tower >= 3)
					(up-compare-goal g-desired-num-bombard-tower >= 3))))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1100))
		(unit-type-count villager-stone >= 6)
        (can-research ri-stone-mining)
        =>
		(research ri-stone-mining)
        )

		(defrule
		(up-compare-goal g-eco-tech-progress >= ALL-CASTLE-COMPLETE)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1100))
		(population >= SEVENTY-PERCENT-POP)
		(can-research ri-stone-mining)
		(dropsite-min-distance stone < 255)
		=>
		(research ri-stone-mining)
		)

	;------------------------
    ;   Stone Shaft Mining
    ;------------------------

        (defrule
		(current-age == castle-age)
        (or
			(goal g-first-attack-launched YES)
			(goal g-position POCKET))
		(up-compare-goal g-eco-tech-progress >= ALL-CASTLE-COMPLETE)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1200))
		(unit-type-count villager-stone > 6)
        (can-research ri-stone-shaft-mining)
        =>
		(research ri-stone-shaft-mining)
        )

        (defrule
		(current-age == imperial-age)
        (or
			(goal g-first-attack-launched YES)
			(goal g-position POCKET))
		(up-compare-goal g-eco-tech-progress >= ALL-IMPERIAL-COMPLETE)
		(unit-type-count villager-stone > 6)
        (can-research ri-stone-shaft-mining)
        =>
		(research ri-stone-shaft-mining)
        )

		(defrule
		(up-compare-goal g-eco-tech-progress >= ALL-IMPERIAL-COMPLETE)
		(population >= EIGHTY-PERCENT-POP)
		(can-research ri-stone-shaft-mining)
		(dropsite-min-distance stone < 255)
		=>
		(research ri-stone-shaft-mining)
		)

;=========================<>=========================
;				    CRITICAL TECHS
;=========================<>=========================

	;----------
	;	Loom
	;----------

		(defrule
		(can-research-with-escrow ri-loom)
		(goal g-far-boar YES)
		(unit-type-count villager >= FAR-BOAR-HUNTING-VILS-NEEDED)
		=>
		(release-escrow gold)
		(research ri-loom)
		; (chat-to-player my-player-number "Research Loom for boar hunting")
		)

		(defrule
		(can-research-with-escrow ri-loom)
		(or
			(up-object-type-count c: villager g:>= g-required-num-villager)
			(or
				(goal g-town-under-attack YES)
				(players-military-population any-enemy > 1)))
		(unit-type-count villager >= 7)
		=>
		(release-escrow gold)
		(research ri-loom)
		; (chat-to-player my-player-number "Research Loom")
		)

		(defrule
		(can-research-with-escrow ri-loom)
		(food-amount < 45)
		(not
			(can-train villager))
		(unit-type-count villager >= 7)
		=>
		(release-escrow gold)
		(research ri-loom)
		; (chat-to-player my-player-number "Research Loom to prevent idle TC")
		)

		#load-if-defined DE-AVAILABLE

			(defrule
			(can-research-with-escrow ri-loom)
			(or
				(civ-selected mayan)
				(or
					(civ-selected chinese)
					(civ-selected gothic)))
			=>
			(release-escrow gold)
			(research ri-loom)
			)

		#else

			(defrule
			(can-research-with-escrow ri-loom)
			(or
				(civ-selected mayan)
				(civ-selected chinese))
			=>
			(release-escrow gold)
			(research ri-loom)
			)
		
		#end-if

	;-----------------
	;	Feudal Age
	;-----------------

		(defrule
		(can-research-with-escrow feudal-age)
		(or
			(up-object-type-count c: villager g:>= g-required-num-villager)
			(and
				(or
					(goal g-game-focus REBUILD)
					(goal g-game-focus DEFENSIVE))
				(goal g-top-enemy-age-parity WE-ARE-BEHIND)))
		=>
		(release-escrow food)
		(research feudal-age)
		)
		
	;-----------------
	;	Castle Age
	;-----------------

		(defrule
		(can-research-with-escrow castle-age)
		(or
			(up-object-type-count c: villager g:>= g-required-num-villager)
			(and
				(or
					(goal g-game-focus REBUILD)
					(goal g-game-focus DEFENSIVE))
				(goal g-top-enemy-age-parity WE-ARE-BEHIND)))
		=>
		(release-escrow food)
		(release-escrow gold)
		(research castle-age)
		)

		(defrule
		(current-age == feudal-age)
		(up-research-status c: castle-age == research-available)
		(or
			(up-object-type-count c: villager g:>= g-required-num-villager)
			(and
				(or
					(goal g-game-focus REBUILD)
					(goal g-game-focus DEFENSIVE))
				(goal g-top-enemy-age-parity WE-ARE-BEHIND)))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: castle-age c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (current-age == feudal-age)
		; (up-research-status c: castle-age == research-available)
		; (or
		; 	(up-object-type-count c: villager g:>= g-required-num-villager)
		; 	(and
		; 		(or
		; 			(goal g-game-focus REBUILD)
		; 			(goal g-game-focus DEFENSIVE))
		; 		(goal g-top-enemy-age-parity WE-ARE-BEHIND)))
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Castle Age")
		; )
		
	;-----------------
	;	Imperial Age
	;-----------------

		(defrule
		(can-research-with-escrow imperial-age)
		(or
			(up-object-type-count c: villager g:>= g-required-num-villager)
			(and
				(or
					(goal g-game-focus REBUILD)
					(goal g-game-focus DEFENSIVE))
				(and
					(goal g-top-enemy-age-parity WE-ARE-BEHIND)
					(unit-type-count villager >= 60))))
		=>
		(release-escrow food)
		(release-escrow gold)
		(research imperial-age)
		)

		(defrule
		(current-age == castle-age)
		(up-research-status c: imperial-age == research-available)
		(up-object-type-count c: villager g:>= g-required-num-villager)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: imperial-age c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (current-age == castle-age)
		; (up-research-status c: imperial-age == research-available)
		; (up-object-type-count c: villager g:>= g-required-num-villager)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Imperial Age, normal requirements")
		; )

		(defrule
		(current-age == castle-age)
		(up-research-status c: imperial-age == research-available)
		(or
			(goal g-game-focus REBUILD)
			(goal g-game-focus DEFENSIVE))
		(goal g-top-enemy-age-parity WE-ARE-BEHIND)
		(unit-type-count villager >= 60)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: imperial-age c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (current-age == castle-age)
		; (up-research-status c: imperial-age == research-available)
		; (or
		; 	(goal g-game-focus REBUILD)
		; 	(goal g-game-focus DEFENSIVE))
		; (goal g-top-enemy-age-parity WE-ARE-BEHIND)
		; (unit-type-count villager >= 60)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Imperial Age, rebuild or defensive")
		; )

	;-------------------------
	;	Unique Unit Upgrade
	;-------------------------

		(defrule
		(or
			(goal g-primary-unit my-unique-unit)
			(goal g-support-unit my-unique-unit))
		(can-research-with-escrow my-unique-unit-upgrade)
		=>
		(release-escrow wood)
		(release-escrow food)
		(release-escrow gold)
		(research my-unique-unit-upgrade)
		)

		(defrule
		(or
			(goal g-primary-unit my-unique-unit)
			(goal g-support-unit my-unique-unit))
		(up-compare-goal g-age-status >= TO-IMPERIAL)
		(up-research-status c: my-unique-unit-upgrade < research-pending)
		(building-type-count castle > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: my-unique-unit-upgrade c: 1)
		(up-modify-goal g-max-wood-needed g:max g-food-cost)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit my-unique-unit)
		; 	(goal g-support-unit my-unique-unit))
		; (up-compare-goal g-age-status >= TO-IMPERIAL)
		; (up-research-status c: my-unique-unit-upgrade < research-pending)
		; (building-type-count castle > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Unique Unit Upgrade")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-unique-unit > 10)
			(up-compare-goal g-unique-unit-line >= 15))
		(can-research my-unique-unit-upgrade)
		=>
		(research my-unique-unit-upgrade)
		)

;=========================<>=========================
;				     UNIQUE TECHS
;=========================<>=========================

	#load-if-defined AZTEC-CIV

		;------------------
		;	Garland Wars
		;------------------

			(defrule
			(or
				(goal g-primary-unit-class infantry-class)
				(goal g-support-unit-class infantry-class))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit-class infantry-class)
				(goal g-support-unit-class infantry-class))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit-class infantry-class)
			; 	(goal g-support-unit-class infantry-class))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Garland Wars for swordsmen")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-infantry > 10)
				(unit-type-count infantry-class > 15))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

		;------------
		;	Atlatl
		;------------

			(defrule
			(or
				(goal g-primary-unit skirmisher)
				(goal g-support-unit skirmisher))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow my-second-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-second-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit skirmisher)
				(goal g-support-unit skirmisher))
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-second-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit skirmisher)
			; 	(goal g-support-unit skirmisher))
			; (up-research-status c: my-second-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Atlatl")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-skirmisher > 6)
				(up-compare-goal g-skirmisher-line > 10))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

	#end-if

	#load-if-defined BERBERS-CIV

		;---------------------
		;	Maghrabi Camels
		;---------------------

			;Camels
			(defrule
			(or
				(goal g-primary-unit camel)
				(or
					(goal g-support-unit camel)
					(or
						(goal g-primary-unit my-unique-unit)
						(goal g-support-unit my-unique-unit))))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit camel)
				(or
					(goal g-support-unit camel)
					(or
						(goal g-primary-unit my-unique-unit)
						(goal g-support-unit my-unique-unit))))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit camel)
			; 	(or
			; 		(goal g-support-unit camel)
			; 		(or
			; 			(goal g-primary-unit my-unique-unit)
			; 			(goal g-support-unit my-unique-unit))))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Maghrabi Camels for camels")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-camel > 10)
				(or
					(up-compare-goal g-camel-line > 15)
					(or
						(up-compare-goal g-desired-num-unique-unit > 10)
						(up-compare-goal g-unique-unit-line > 15))))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

		;------------
		;	Kasbah
		;------------

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(goal g-support-unit my-unique-unit))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1250))
			(can-research-with-escrow my-second-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-second-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(goal g-support-unit my-unique-unit))
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-second-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit my-unique-unit)
			; 	(goal g-support-unit my-unique-unit))
			; (up-research-status c: my-second-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Kasbah")
			; )

			(load "The General 3/Functions/Reset")

			(defrule
			(can-research my-second-unique-research)
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1250))
			=>
			(up-modify-sn sn-focus-player-number g:= g-team-partner)
			(up-get-focus-fact allied-goal g-identity g-temp)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-unique-unit > 10)
				(players-building-type-count any-ally castle > 1))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1250))
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

	#end-if

	#load-if-defined BRITON-CIV

		;------------
		;	Yeomen
		;------------

			;Archers
			(defrule
			(or
				(goal g-primary-unit-class archery-class)
				(goal g-support-unit-class archery-class))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow wood)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit-class archery-class)
				(goal g-support-unit-class archery-class))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-wood-needed g:max g-wood-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit-class archery-class)
			; 	(goal g-support-unit-class archery-class))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Yeomen for archers")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-archer > 6)
				(unit-type-count archery-class > 10))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

			;Towers
			(defrule
			(up-compare-goal g-desired-num-watch-tower > 2)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(research-completed ri-keep)
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

		;-------------
		;	Warwolf
		;-------------

			(defrule
			(up-compare-goal g-desired-num-trebuchet > 3)
			(can-research-with-escrow my-second-unique-research)
			=>
			(release-escrow gold)
			(release-escrow wood)
			(research my-second-unique-research)
			)

			(defrule
			(up-compare-goal g-desired-num-trebuchet > 3)
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-second-unique-research c: 1)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			(up-modify-goal g-max-wood-needed g:max g-wood-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (up-compare-goal g-desired-num-trebuchet > 3)
			; (up-research-status c: my-second-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Warwolf")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-trebuchet > 0)
				(unit-type-count trebuchet-set > 0))
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

	#end-if

	#load-if-defined BULGARIANS-CIV

		;--------------
		;	Stirrups
		;--------------

			(defrule
			(or
				(goal g-primary-unit-class cavalry-class)
				(goal g-support-unit-class cavalry-class))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow my-second-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-second-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit-class cavalry-class)
				(goal g-support-unit-class cavalry-class))
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-second-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit-class cavalry-class)
			; 	(goal g-support-unit-class cavalry-class))
			; (up-research-status c: my-second-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Stirrups")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-cavalry > 6)
				(unit-type-count cavalry-class > 10))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;-------------
		;	Bagains
		;-------------

			(defrule
			(or
				(goal g-primary-unit militiaman)
				(goal g-support-unit militiaman))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit militiaman)
				(goal g-support-unit militiaman))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit militiaman)
			; 	(goal g-support-unit militiaman))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Bagains")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-militia > 10)
				(unit-type-count militiaman-line > 15))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined BURMESE-CIV

		;-------------
		;	Howdah
		;-------------

			(defrule
			(or
				(goal g-primary-unit battle-elephant)
				(goal g-support-unit battle-elephant))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow my-second-unique-research)
			=>
			(release-escrow food)
			(release-escrow wood)
			(research my-second-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit battle-elephant)
				(goal g-support-unit battle-elephant))
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-second-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-wood-needed g:max g-wood-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit battle-elephant)
			; 	(goal g-support-unit battle-elephant))
			; (up-research-status c: my-second-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Howdah")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-battle-elephant > 6)
				(up-compare-goal g-battle-elephant-line > 10))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;---------------------
		;	Manipur Cavalry
		;---------------------

			(defrule
			(or
				(goal g-primary-unit-class cavalry-class)
				(or
					(goal g-support-unit-class cavalry-class)
					(or
						(goal g-primary-unit my-unique-unit)
						(goal g-support-unit my-unique-unit))))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-second-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit-class cavalry-class)
				(or
					(goal g-support-unit-class cavalry-class)
					(or
						(goal g-primary-unit my-unique-unit)
						(goal g-support-unit my-unique-unit))))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit-class cavalry-class)
			; 	(or
			; 		(goal g-support-unit-class cavalry-class)
			; 		(or
			; 			(goal g-primary-unit my-unique-unit)
			; 			(goal g-support-unit my-unique-unit))))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Manipur Cavalry")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-cavalry > 10)
				(or
					(unit-type-count cavalry-class > 15)
					(or
						(up-compare-goal g-desired-num-unique-unit > 10)
						(up-compare-goal g-unique-unit-line > 15))))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined BYZANTINE-CIV

		;----------------
		;	Greek Fire
		;----------------

			(defrule
			(up-compare-goal g-desired-num-fire-ship >= 10)
			(research-completed ri-war-galley)
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1250))
			(can-research-with-escrow my-second-unique-research)
			=>
			(release-escrow food)
			(release-escrow wood)
			(research my-second-unique-research)
			)

			(defrule
			(up-compare-goal g-desired-num-fire-ship >= 10)
			(research-completed ri-war-galley)
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-second-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-wood-needed g:max g-wood-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (up-compare-goal g-desired-num-fire-ship >= 10)
			; (research-completed ri-war-galley)
			; (up-research-status c: my-second-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Greek Fire")
			; )

			(defrule
			(up-compare-goal g-desired-num-fire-ship > 5)
			(research-completed ri-war-galley)
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1250))
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;---------------
		;	Logistica
		;---------------

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(goal g-support-unit my-unique-unit))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(goal g-support-unit my-unique-unit))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit my-unique-unit)
			; 	(goal g-support-unit my-unique-unit))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Logistica")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-unique-unit > 10)
				(up-compare-goal g-unique-unit-line > 15))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined CELTIC-CIV

		;-------------------
		;	Furor Celtica
		;-------------------

			(defrule
			(or
				(up-compare-goal g-desired-num-battering-ram >= 3)
				(or
					(up-compare-goal g-desired-num-mangonel >= 3)
					(up-compare-goal g-desired-num-scorpion >= 5)))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-battering-ram >= 3)
				(or
					(up-compare-goal g-desired-num-mangonel >= 3)
					(up-compare-goal g-desired-num-scorpion >= 5)))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(up-compare-goal g-desired-num-battering-ram >= 3)
			; 	(or
			; 		(up-compare-goal g-desired-num-mangonel >= 3)
			; 		(up-compare-goal g-desired-num-scorpion >= 5)))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Furor Celtica")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-battering-ram > 0)
				(or
					(up-compare-goal g-desired-num-mangonel > 0)
					(or
						(up-compare-goal g-desired-num-scorpion > 0)
						(or
							(unit-type-count battering-ram-line > 2)
							(or
								(up-compare-goal g-mangonel-line > 2)
								(unit-type-count scorpion-line > 2))))))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined CHINESE-CIV

		;----------------
		;	Great Wall
		;----------------

			(defrule
			(or
				(up-compare-goal g-desired-num-watch-tower > 4)
				(or
					(up-compare-goal g-desired-num-bombard-tower > 4)
					(unit-type-count gate-class > 2)))
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;--------------
		;	Rocketry
		;--------------

			;Chu Ko Nu
			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(or
					(goal g-support-unit my-unique-unit)
					(up-compare-goal g-desired-num-scorpion > 4)))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow wood)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(or
					(goal g-support-unit my-unique-unit)
					(up-compare-goal g-desired-num-scorpion > 4)))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-wood-needed g:max g-wood-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit my-unique-unit)
			; 	(or
			; 		(goal g-support-unit my-unique-unit)
			; 		(up-compare-goal g-desired-num-scorpion > 4)))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Rocketry")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-unique-unit > 10)
				(or
					(up-compare-goal g-unique-unit-line > 15)
					(or
						(up-compare-goal g-desired-num-scorpion > 2)
						(unit-type-count scorpion-line > 3))))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined CUMANS-CIV

		;----------------------
		;	Steppe Husbandry
		;----------------------

			;Scouts
			(defrule
			(or
				(goal g-primary-unit scout-cavalry)
				(or
					(goal g-support-unit scout-cavalry)
					(or
						(goal g-primary-unit cavalry-archer)
						(or
							(goal g-support-unit cavalry-archer)
							(or
								(goal g-primary-unit steppe-lancer)
								(goal g-support-unit steppe-lancer))))))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow my-second-unique-research)
			=>
			(release-escrow food)
			(release-escrow wood)
			(research my-second-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit scout-cavalry)
				(or
					(goal g-support-unit scout-cavalry)
					(or
						(goal g-primary-unit cavalry-archer)
						(goal g-support-unit cavalry-archer))))
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-wood-needed g:max g-wood-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit scout-cavalry)
			; 	(or
			; 		(goal g-support-unit scout-cavalry)
			; 		(or
			; 			(goal g-primary-unit cavalry-archer)
			; 			(goal g-support-unit cavalry-archer))))
			; (up-research-status c: my-second-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Steppe Husbandry for scouts")
			; )

			(defrule
			(or
				(goal g-primary-unit steppe-lancer)
				(goal g-support-unit steppe-lancer))
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-wood-needed g:max g-wood-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit steppe-lancer)
			; 	(goal g-support-unit steppe-lancer))
			; (up-research-status c: my-second-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Steppe Husbandry for scouts")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-scout-cavalry > 10)
				(or
					(unit-type-count scout-cavalry-line > 15)
					(or
						(up-compare-goal g-desired-num-cavalry-archer > 10)
						(or
							(unit-type-count cavalry-archer-line > 15)
							(or
								(up-compare-goal g-desired-num-steppe-lancer > 10)
								(unit-type-count steppe-lancer-line > 15))))))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

	#end-if

	#load-if-defined ETHIOPIAN-CIV

		;-----------------
		;	Royal Heirs
		;-----------------

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(goal g-support-unit my-unique-unit))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow my-second-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-second-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(goal g-support-unit my-unique-unit))
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit my-unique-unit)
			; 	(goal g-support-unit my-unique-unit))
			; (up-research-status c: my-second-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Royal Heirs")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-unique-unit > 10)
				(up-compare-goal g-unique-unit-line > 15))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;---------------------
		;	Torsion Engines
		;---------------------

			(defrule
			(or
				(up-compare-goal g-desired-num-battering-ram >= 3)
				(or
					(up-compare-goal g-desired-num-mangonel >= 3)
					(up-compare-goal g-desired-num-scorpion >= 5)))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-battering-ram >= 3)
				(or
					(up-compare-goal g-desired-num-mangonel >= 3)
					(up-compare-goal g-desired-num-scorpion >= 5)))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(up-compare-goal g-desired-num-battering-ram >= 3)
			; 	(or
			; 		(up-compare-goal g-desired-num-mangonel >= 3)
			; 		(up-compare-goal g-desired-num-scorpion >= 5)))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Torsion Engines")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-battering-ram > 0)
				(or
					(up-compare-goal g-desired-num-mangonel > 0)
					(or
						(up-compare-goal g-desired-num-scorpion > 0)
						(or
							(unit-type-count battering-ram-line > 2)
							(or
								(up-compare-goal g-mangonel-line > 2)
								(unit-type-count scorpion-line > 2))))))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined FRANKISH-CIV

		;--------------
		;	Chivalry
		;--------------

			(defrule
			(or
				(goal g-primary-unit-class cavalry-class)
				(goal g-support-unit-class cavalry-class))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow my-second-unique-research)
			=>
			(release-escrow wood)
			(release-escrow gold)
			(research my-second-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit-class cavalry-class)
				(goal g-support-unit-class cavalry-class))
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-second-unique-research c: 1)
			(up-modify-goal g-max-wood-needed g:max g-wood-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit-class cavalry-class)
			; 	(goal g-support-unit-class cavalry-class))
			; (up-research-status c: my-second-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Chivalry")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-scout-cavalry > 10)
				(up-compare-goal g-desired-num-knight > 10))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;-----------------
		;	Bearded Axe
		;-----------------

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(goal g-support-unit my-unique-unit))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(goal g-support-unit my-unique-unit))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit my-unique-unit)
			; 	(goal g-support-unit my-unique-unit))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Bearded Axe")
			; )

			(defrule
			(up-compare-goal g-desired-num-unique-unit > 6)
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined GOTHIC-CIV
	
		;-------------
		;	Anarchy
		;-------------

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(goal g-support-unit my-unique-unit))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(goal g-support-unit my-unique-unit))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit my-unique-unit)
			; 	(goal g-support-unit my-unique-unit))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Anarchy")
			; )

			(defrule
			(up-compare-goal g-desired-num-unique-unit > 10)
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)
	
		;---------------
		;	Perfusion
		;---------------

			(defrule
			(or
				(goal g-primary-unit-class infantry-class)
				(goal g-support-unit-class infantry-class))
			(can-research-with-escrow my-second-unique-research)
			=>
			(release-escrow wood)
			(release-escrow gold)
			(research my-second-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit-class infantry-class)
				(goal g-support-unit-class infantry-class))
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-second-unique-research c: 1)
			(up-modify-goal g-max-wood-needed g:max g-wood-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit-class infantry-class)
			; 	(goal g-support-unit-class infantry-class))
			; (up-research-status c: my-second-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Perfusion for swordsmen")
			; )

			(defrule
			(up-compare-goal g-desired-num-infantry > 10)
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

	#end-if

	#load-if-defined HUN-CIV

		;---------------
		;	Marauders
		;---------------

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(goal g-support-unit my-unique-unit))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow my-second-unique-research)
			=>
			(release-escrow wood)
			(release-escrow gold)
			(research my-second-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(goal g-support-unit my-unique-unit))
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-second-unique-research c: 1)
			(up-modify-goal g-max-wood-needed g:max g-wood-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit my-unique-unit)
			; 	(goal g-support-unit my-unique-unit))
			; (up-research-status c: my-second-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Marauders")
			; )

			(defrule
			(up-compare-goal g-desired-num-unique-unit > 10)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

	#end-if

	#load-if-defined INCAN-CIV

		;------------------
		;	Andean Sling
		;------------------

			;Skirmishers
			(defrule
			(or
				(goal g-primary-unit skirmisher)
				(or
					(goal g-support-unit skirmisher)
					(or
						(goal g-primary-unit slinger)
						(goal g-support-unit slinger))))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1200))
			(can-research-with-escrow my-second-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-second-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit skirmisher)
				(or
					(goal g-support-unit skirmisher)
					(or
						(goal g-primary-unit slinger)
						(goal g-support-unit slinger))))
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-second-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit skirmisher)
			; 	(or
			; 		(goal g-support-unit skirmisher)
			; 		(or
			; 			(goal g-primary-unit slinger)
			; 			(goal g-support-unit slinger))))
			; (up-research-status c: my-second-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Andean Sling for skirms")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-skirmisher > 10)
				(or
					(up-compare-goal g-skirmisher-line > 15)
					(or
						(up-compare-goal g-desired-num-slinger > 10)
						(unit-type-count slinger > 15))))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1200))
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;-----------------------------
		;	Couriers/Fabric Shields
		;-----------------------------

			(defrule
			(or
				(goal g-primary-unit eagle-warrior)
				(or
					(goal g-support-unit eagle-warrior)
					(or
						(goal g-primary-unit slinger)
						(or
							(goal g-support-unit slinger)
							(or
								(goal g-primary-unit my-unique-unit)
								(goal g-support-unit my-unique-unit))))))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit eagle-warrior)
				(or
					(goal g-support-unit eagle-warrior)
					(or
						(goal g-primary-unit slinger)
						(goal g-support-unit slinger))))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit eagle-warrior)
			; 	(or
			; 		(goal g-support-unit eagle-warrior)
			; 		(or
			; 			(goal g-primary-unit slinger)
			; 			(goal g-support-unit slinger))))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Fabric Shields for eagles")
			; )

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(goal g-support-unit my-unique-unit))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit my-unique-unit)
			; 	(goal g-support-unit my-unique-unit))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Fabric Shields for eagles")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-eagle-warrior > 10)
				(or
					(up-compare-goal g-eagle-scout-line > 15)
					(or
						(up-compare-goal g-desired-num-slinger > 10)
						(or
							(unit-type-count slinger > 15)
							(or
								(up-compare-goal g-desired-num-unique-unit > 10)
								(up-compare-goal g-unique-unit-line > 15))))))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined INDIAN-CIV

		(load "The General 3/Functions/Reset")

		;-------------
		;	Sultans
		;-------------

			(defrule
			(goal g-town-under-attack NO)
			(up-get-fact resource-amount amount-relics g-temp)
			(or
				(unit-type-count villager-gold > 10)
				(or
					(unit-type-count trade-cart > 10)
					(up-compare-goal g-temp >= 2)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow my-second-unique-research)
			=>
			(release-escrow food)
			(release-escrow wood)
			(research my-second-unique-research)
			)

			(defrule
			(goal g-town-under-attack NO)
			(up-get-fact resource-amount amount-relics g-temp)
			(or
				(unit-type-count villager-gold > 5)
				(or
					(unit-type-count trade-cart > 5)
					(up-compare-goal g-temp >= 2)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(research my-second-unique-research)
			)

			(defrule
			(goal g-town-under-attack NO)
			(up-get-fact resource-amount amount-relics g-temp)
			(or
				(unit-type-count villager-gold > 5)
				(or
					(unit-type-count trade-cart > 5)
					(up-compare-goal g-temp >= 1)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;--------------
		;	Shatagni
		;--------------

			(defrule
			(or
				(goal g-primary-unit hand-cannoneer)
				(goal g-support-unit hand-cannoneer))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit hand-cannoneer)
				(goal g-support-unit hand-cannoneer))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit hand-cannoneer)
			; 	(goal g-support-unit hand-cannoneer))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Shatagni")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-hand-cannoneer > 10)
				(unit-type-count hand-cannoneer > 15))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined ITALIAN-CIV

		;------------
		;	Pavise
		;------------

			#load-if-defined DE-AVAILABLE

				(defrule
				(or
					(goal g-primary-unit condottiero)
					(goal g-support-unit condottiero))
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research-with-escrow my-second-unique-research)
				=>
				(release-escrow food)
				(release-escrow gold)
				(research my-second-unique-research)
				)

				(defrule
				(or
					(goal g-primary-unit condottiero)
					(goal g-support-unit condottiero))
				(up-research-status c: my-second-unique-research == research-available)
				(building-type-count castle > 0)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: my-second-unique-research c: 1)
				(up-modify-goal g-max-food-needed g:max g-food-cost)
				(up-modify-goal g-max-gold-needed g:max g-gold-cost)
				)

				; (defrule
				; (taunt-detected TAUNT-PLAYER 246)
				; (or
				; 	(goal g-primary-unit condottiero)
				; 	(goal g-support-unit condottiero))
				; (up-research-status c: my-second-unique-research == research-available)
				; (building-type-count castle > 0)
				; =>
				; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Pavise for condos")
				; )

				(defrule
				(or
					(up-compare-goal g-desired-num-condottiero > 10)
					(unit-type-count condottiero > 15))
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research my-second-unique-research)
				=>
				(research my-second-unique-research)
				)

			#end-if

			(defrule
			(or
				(goal g-primary-unit archer)
				(or
					(goal g-support-unit archer)
					(or
						(goal g-primary-unit my-unique-unit)
						(goal g-support-unit my-unique-unit))))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow my-second-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-second-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit archer)
				(or
					(goal g-support-unit archer)
					(or
						(goal g-primary-unit my-unique-unit)
						(goal g-support-unit my-unique-unit))))
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-second-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit archer)
			; 	(or
			; 		(goal g-support-unit archer)
			; 		(or
			; 			(goal g-primary-unit my-unique-unit)
			; 			(goal g-support-unit my-unique-unit))))
			; (up-research-status c: my-second-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Pavise for archers")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-archer > 10)
				(or
					(unit-type-count archer-line > 15)
					(or
						(up-compare-goal g-desired-num-unique-unit > 10)
						(up-compare-goal g-unique-unit-line > 15))))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;---------------
		;	Silk Road
		;---------------

			(defrule
			(or
				(up-compare-goal g-desired-num-trade-cart > 0)
				(up-compare-goal g-desired-num-trade-cog > 0))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-research-status c: ri-caravan >= research-pending)
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-trade-cart > 0)
				(up-compare-goal g-desired-num-trade-cog > 0))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(up-compare-goal g-desired-num-trade-cart > 0)
			; 	(up-compare-goal g-desired-num-trade-cog > 0))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Silk Roads")
			; )

	#end-if

	#load-if-defined JAPANESE-CIV

		;------------
		;	Yasama
		;------------

			(defrule
			(up-compare-goal g-desired-num-watch-tower >= 4)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow my-second-unique-research)
			=>
			(release-escrow food)
			(release-escrow wood)
			(research my-second-unique-research)
			)

			(defrule
			(up-compare-goal g-desired-num-watch-tower >= 4)
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-second-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-wood-needed g:max g-wood-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (up-compare-goal g-desired-num-watch-tower >= 4)
			; (up-research-status c: my-second-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Yasama")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-watch-tower > 1)
				(up-compare-goal g-watch-tower-line > 3))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;----------------
		;	Kataparuto
		;----------------

			(defrule
			(up-compare-goal g-desired-num-trebuchet >= 3)
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow wood)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(up-compare-goal g-desired-num-trebuchet >= 3)
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-wood-needed g:max g-wood-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (up-compare-goal g-desired-num-trebuchet >= 3)
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Kataparuto")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-trebuchet > 1)
				(unit-type-count trebuchet-set > 1))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined KHMER-CIV

		;-----------------
		;	Tusk Swords
		;-----------------
			
			(defrule
			(or
				(goal g-primary-unit battle-elephant)
				(goal g-support-unit battle-elephant))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow my-second-unique-research)
			=>
			(release-escrow wood)
			(release-escrow gold)
			(research my-second-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit battle-elephant)
				(goal g-support-unit battle-elephant))
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-second-unique-research c: 1)
			(up-modify-goal g-max-wood-needed g:max g-wood-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit battle-elephant)
			; 	(goal g-support-unit battle-elephant))
			; (up-research-status c: my-second-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Tusk Swords")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-battle-elephant > 6)
				(up-compare-goal g-battle-elephant-line > 10))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;---------------------
		;	Double Crossbow
		;---------------------
			
			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(or
					(goal g-support-unit my-unique-unit)
					(up-compare-goal g-desired-num-scorpion > 5)))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(or
					(goal g-support-unit my-unique-unit)
					(up-compare-goal g-desired-num-scorpion > 5)))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit my-unique-unit)
			; 	(or
			; 		(goal g-support-unit my-unique-unit)
			; 		(up-compare-goal g-desired-num-scorpion > 5)))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Double Crossbow")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-unique-unit > 6)
				(or
					(up-compare-goal g-unique-unit-line > 10)
					(or
						(up-compare-goal g-desired-num-scorpion > 2)
						(unit-type-count scorpion-line > 4))))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined KOREAN-CIV

		#load-if-defined DE-AVAILABLE

			;--------------
			;	Eupseong
			;--------------
			
				(defrule
				(up-compare-goal g-desired-num-watch-tower >= 3)
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research-with-escrow my-second-unique-research)
				=>
				(release-escrow food)
				(release-escrow wood)
				(research my-second-unique-research)
				)

				(defrule
				(up-compare-goal g-desired-num-watch-tower >= 3)
				(up-research-status c: my-second-unique-research == research-available)
				(building-type-count castle > 0)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: my-second-unique-research c: 1)
				(up-modify-goal g-max-food-needed g:max g-food-cost)
				(up-modify-goal g-max-wood-needed g:max g-wood-cost)
				)

				; (defrule
				; (taunt-detected TAUNT-PLAYER 246)
				; (up-compare-goal g-desired-num-watch-tower >= 3)
				; (up-research-status c: my-second-unique-research == research-available)
				; (building-type-count castle > 0)
				; =>
				; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Eupseong")
				; )

				(defrule
				(or
					(up-compare-goal g-desired-num-watch-tower > 2)
					(up-compare-goal g-watch-tower-line > 3))
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research my-second-unique-research)
				=>
				(research my-second-unique-research)
				)

		#else

			;---------------
			;	Panokseon
			;---------------

				(defrule
				(up-compare-goal g-desired-num-unique-ship > 2)
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research my-second-unique-research)
				=>
				(research my-second-unique-research)
				)

		#end-if

		;----------------
		;	Shinkichon
		;----------------

			(defrule
			(up-compare-goal g-desired-num-mangonel >= 3)
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow wood)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(up-compare-goal g-desired-num-mangonel >= 3)
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-wood-needed g:max g-wood-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (up-compare-goal g-desired-num-mangonel >= 3)
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Shinkichon")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-mangonel > 2)
				(up-compare-goal g-mangonel-line > 4))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined LITHUANIANS-CIV

		;----------------
		;	Hill Forts
		;----------------

			(defrule
			(building-type-count town-center >= 3)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;-------------------
		;	Tower Shields
		;-------------------

			;Spearmen
			(defrule
			(or
				(goal g-primary-unit spearman)
				(or
					(goal g-support-unit spearman)
					(or
						(goal g-primary-unit skirmisher)
						(goal g-support-unit skirmisher))))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit spearman)
				(or
					(goal g-support-unit spearman)
					(or
						(goal g-primary-unit skirmisher)
						(goal g-support-unit skirmisher))))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit spearman)
			; 	(or
			; 		(goal g-support-unit spearman)
			; 		(or
			; 			(goal g-primary-unit skirmisher)
			; 			(goal g-support-unit skirmisher))))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Tower Shields for spears")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-spearman > 10)
				(or
					(unit-type-count spearman-line > 15)
					(or
						(up-compare-goal g-desired-num-skirmisher > 10)
						(up-compare-goal g-skirmisher-line > 15))))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined MAGYAR-CIV

		;--------------------
		;	Corvinian Army
		;--------------------

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(or
					(goal g-support-unit my-unique-unit)
					(and
						(up-compare-goal g-desired-num-unique-unit > 10)
						(goal g-age-status LATE-IMPERIAL))))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1200))
			(can-research-with-escrow my-second-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-second-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(or
					(goal g-support-unit my-unique-unit)
					(and
						(up-compare-goal g-desired-num-unique-unit > 10)
						(goal g-age-status LATE-IMPERIAL))))
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-second-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit my-unique-unit)
			; 	(or
			; 		(goal g-support-unit my-unique-unit)
			; 		(and
			; 			(up-compare-goal g-desired-num-unique-unit > 10)
			; 			(goal g-age-status LATE-IMPERIAL))))
			; (up-research-status c: my-second-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Corvininan Army, normal")
			; )

			(defrule
			(up-compare-goal g-desired-num-unique-unit > 10)
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1200))
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;-----------------
		;	Recurve Bow
		;-----------------

			(defrule
			(or
				(goal g-primary-unit cavalry-archer)
				(goal g-support-unit cavalry-archer))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow wood)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			; (or
			; 	(goal g-primary-unit cavalry-archer)
			; 	(goal g-support-unit cavalry-archer))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-wood-needed g:max g-wood-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit cavalry-archer)
			; 	(goal g-support-unit cavalry-archer))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Recurve Bow")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-cavalry-archer > 10)
				(unit-type-count cavalry-archer-line > 15))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined MALAY-CIV

		;-------------------
		;	Thalassocracy
		;-------------------

			(defrule
			(up-compare-goal g-desired-num-dock >= 4)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow my-second-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-second-unique-research)
			)

			(defrule
			(up-compare-goal g-desired-num-dock >= 4)
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-second-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (up-compare-goal g-desired-num-dock >= 4)
			; (up-research-status c: my-second-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Thalassocracy")
			; )

			(defrule
			(up-compare-goal g-desired-num-dock > 1)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;-----------------
		;	Forced Levy
		;-----------------

			(defrule
			(or
				(goal g-primary-unit militiaman)
				(or
					(goal g-support-unit militiaman)
					(and
						(up-compare-goal g-desired-num-militia > 10)
						(goal g-age-status LATE-IMPERIAL))))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit militiaman)
				(or
					(goal g-support-unit militiaman)
					(and
						(up-compare-goal g-desired-num-militia > 10)
						(goal g-age-status LATE-IMPERIAL))))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit militiaman)
			; 	(or
			; 		(goal g-support-unit militiaman)
			; 		(and
			; 			(up-compare-goal g-desired-num-militia > 10)
			; 			(goal g-age-status LATE-IMPERIAL))))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Forced Levy")
			; )

			(defrule
			(up-compare-goal g-desired-num-militia > 10)
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined MALIAN-CIV
	
		;-----------
		;	Tigui
		;-----------

			(defrule
			(building-type-count town-center >= 3)
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1200))
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;-------------
		;	Farimba
		;-------------

			(defrule
			(or
				(goal g-primary-unit-class cavalry-class)
				(goal g-support-unit-class cavalry-class))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit-class cavalry-class)
				(goal g-support-unit-class cavalry-class))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit-class cavalry-class)
			; 	(goal g-support-unit-class cavalry-class))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Farimba")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-cavalry > 10)
				(unit-type-count cavalry-class > 15))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined MAYAN-CIV

		#load-if-not-defined DE-AVAILABLE
		
			;---------------------
			;	Obsidian Arrows
			;---------------------
				
				(defrule
				(or
					(goal g-primary-unit archer)
					(goal g-support-unit archer))
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research-with-escrow my-second-unique-research)
				=>
				(release-escrow food)
				(release-escrow gold)
				(research my-second-unique-research)
				)

				(defrule
				(or
					(goal g-primary-unit archer)
					(goal g-support-unit archer))
				(up-research-status c: my-second-unique-research == research-available)
				(building-type-count castle > 0)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: my-second-unique-research c: 1)
				(up-modify-goal g-max-food-needed g:max g-food-cost)
				(up-modify-goal g-max-gold-needed g:max g-gold-cost)
				)

				; (defrule
				; (taunt-detected TAUNT-PLAYER 246)
				; (or
				; 	(goal g-primary-unit archer)
				; 	(goal g-support-unit archer))
				; (up-research-status c: my-second-unique-research == research-available)
				; (building-type-count castle > 0)
				; =>
				; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Obsidian Arrows")
				; )

				(defrule
				(or
					(up-compare-goal g-desired-num-archer > 10)
					(unit-type-count archer-line > 15))
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research my-second-unique-research)
				=>
				(research my-second-unique-research)
				)

		#else
		
			;-------------------------
			;	Hul'Che Javelineers
			;-------------------------
				
				(defrule
				(or
					(goal g-primary-unit skirmisher)
					(goal g-support-unit skirmisher))
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research-with-escrow my-second-unique-research)
				=>
				(release-escrow food)
				(release-escrow gold)
				(research my-second-unique-research)
				)

				(defrule
				(or
					(goal g-primary-unit skirmisher)
					(goal g-support-unit skirmisher))
				(up-research-status c: my-second-unique-research == research-available)
				(building-type-count castle > 0)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: my-second-unique-research c: 1)
				(up-modify-goal g-max-food-needed g:max g-food-cost)
				(up-modify-goal g-max-gold-needed g:max g-gold-cost)
				)

				; (defrule
				; (taunt-detected TAUNT-PLAYER 246)
				; (or
				; 	(goal g-primary-unit skirmisher)
				; 	(goal g-support-unit skirmisher))
				; (up-research-status c: my-second-unique-research == research-available)
				; (building-type-count castle > 0)
				; =>
				; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Obsidian Arrows")
				; )

				(defrule
				(or
					(up-compare-goal g-desired-num-skirmisher > 10)
					(up-compare-goal g-skirmisher-line > 15))
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research my-second-unique-research)
				=>
				(research my-second-unique-research)
				)

		#end-if

		;---------------
		;	El Dorado
		;---------------
			
			(defrule
			(or
				(goal g-primary-unit eagle-warrior)
				(goal g-support-unit eagle-warrior))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit eagle-warrior)
				(goal g-support-unit eagle-warrior))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit eagle-warrior)
			; 	(goal g-support-unit eagle-warrior))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for El Dorado")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-eagle-warrior > 10)
				(up-compare-goal g-eagle-scout-line > 15))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined MONGOL-CIV

		;------------
		;	Nomads
		;------------

			(defrule
			(or
				(goal g-game-focus DEFENSIVE)
				(or
					(goal g-game-focus REBUILD)
					(players-military-population any-enemy >= 40)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;-----------
		;	Drill
		;-----------

			(defrule
			(or
				(up-compare-goal g-desired-num-battering-ram >= 3)
				(or
					(up-compare-goal g-desired-num-mangonel >= 3)
					(up-compare-goal g-desired-num-scorpion >= 5)))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-battering-ram >= 3)
				(or
					(up-compare-goal g-desired-num-mangonel >= 3)
					(up-compare-goal g-desired-num-scorpion >= 5)))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(up-compare-goal g-desired-num-battering-ram >= 3)
			; 	(or
			; 		(up-compare-goal g-desired-num-mangonel >= 3)
			; 		(up-compare-goal g-desired-num-scorpion >= 5)))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Drill")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-battering-ram > 0)
				(or
					(up-compare-goal g-desired-num-mangonel > 0)
					(or
						(up-compare-goal g-desired-num-scorpion > 0)
						(or
							(unit-type-count battering-ram-line > 2)
							(or
								(up-compare-goal g-mangonel-line > 2)
								(unit-type-count scorpion-line > 2))))))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined PERSIAN-CIV

		;----------------
		;	Kamandaran
		;----------------
			
			#load-if-defined DE-AVAILABLE
			
				(defrule
				(or
					(goal g-primary-unit archer)
					(or
						(goal g-support-unit archer)
						(and
							(up-compare-goal g-desired-num-archer > 10)
							(goal g-age-status LATE-IMPERIAL))))
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research-with-escrow my-second-unique-research)
				=>
				(release-escrow food)
				(release-escrow gold)
				(research my-second-unique-research)
				)

				(defrule
				(or
					(goal g-primary-unit archer)
					(or
						(goal g-support-unit archer)
						(and
							(up-compare-goal g-desired-num-archer > 10)
							(goal g-age-status LATE-IMPERIAL))))
				(up-research-status c: my-second-unique-research == research-available)
				(building-type-count castle > 0)
				=>
				(up-setup-cost-data 1 g-food-cost)
				(up-add-research-cost c: my-second-unique-research c: 1)
				(up-modify-goal g-max-food-needed g:max g-food-cost)
				(up-modify-goal g-max-gold-needed g:max g-gold-cost)
				)

				; (defrule
				; (taunt-detected TAUNT-PLAYER 246)
				; (or
				; 	(goal g-primary-unit archer)
				; 	(or
				; 		(goal g-support-unit archer)
				; 		(and
				; 			(up-compare-goal g-desired-num-archer > 10)
				; 			(goal g-age-status LATE-IMPERIAL))))
				; (up-research-status c: my-second-unique-research == research-available)
				; (building-type-count castle > 0)
				; =>
				; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Kamandaran")
				; )

				(defrule
				(or
					(up-compare-goal g-desired-num-archer > 10)
					(unit-type-count archer-line > 15))
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(can-research my-second-unique-research)
				=>
				(research my-second-unique-research)
				)

			#end-if

		;-------------
		;	Mahouts
		;-------------
			
			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(goal g-support-unit my-unique-unit))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(goal g-support-unit my-unique-unit))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit my-unique-unit)
			; 	(goal g-support-unit my-unique-unit))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Mahouts")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-unique-unit > 10)
				(up-compare-goal g-unique-unit-line > 15))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined PORTUGUESE-CIV

		;-------------
		;	Carrack
		;-------------

			(defrule
			(up-compare-goal g-desired-num-unique-ship > 2)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;--------------
		;	Arquebus
		;--------------
			
			(defrule
			(or
				(goal g-primary-unit hand-cannoneer)
				(or
					(goal g-support-unit hand-cannoneer)
					(or
						(goal g-primary-unit my-unique-unit)
						(or
							(goal g-support-unit my-unique-unit)
							(up-compare-goal g-desired-num-bombard-cannon > 2)))))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit hand-cannoneer)
				(or
					(goal g-support-unit hand-cannoneer)
					(or
						(goal g-primary-unit my-unique-unit)
						(or
							(goal g-support-unit my-unique-unit)
							(up-compare-goal g-desired-num-bombard-cannon > 2)))))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit hand-cannoneer)
			; 	(or
			; 		(goal g-support-unit hand-cannoneer)
			; 		(or
			; 			(goal g-primary-unit my-unique-unit)
			; 			(or
			; 				(goal g-support-unit my-unique-unit)
			; 				(up-compare-goal g-desired-num-bombard-cannon > 2)))))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Arquebus")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-hand-cannoneer > 10)
				(or
					(unit-type-count hand-cannoneer > 15)
					(or
						(up-compare-goal g-desired-num-unique-unit > 6)
						(or
							(up-compare-goal g-unique-unit-line > 10)
							(or
								(up-compare-goal g-desired-num-bombard-cannon > 1)
								(or
									(unit-type-count bombard-cannon > 2)
									(unit-type-count cannon-galleon-line > 2)))))))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined SARACEN-CIV

		;--------------
		;	Madrasah
		;--------------

			(defrule
			(up-research-status c: ri-block-printing >= research-pending)
			(or
				(up-compare-goal g-desired-num-monk > 5)
				(unit-type-count monk > 6))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1200))
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;--------------
		;	Zealotry
		;--------------
			
			(defrule
			(or
				(goal g-primary-unit camel)
				(or
					(goal g-support-unit camel)
					(or
						(goal g-primary-unit my-unique-unit)
						(goal g-support-unit my-unique-unit))))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit camel)
				(or
					(goal g-support-unit camel)
					(or
						(goal g-primary-unit my-unique-unit)
						(goal g-support-unit my-unique-unit))))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit camel)
			; 	(or
			; 		(goal g-support-unit camel)
			; 		(or
			; 			(goal g-primary-unit my-unique-unit)
			; 			(goal g-support-unit my-unique-unit))))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Zealotry for camels")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-camel > 10)
				(or
					(up-compare-goal g-camel-line > 15)
					(or
						(up-compare-goal g-desired-num-unique-unit > 10)
						(up-compare-goal g-unique-unit-line > 15))))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined SLAVIC-CIV

		;---------------
		;	Orthodoxy
		;---------------

			(defrule
			(up-research-status c: ri-theocracy >= research-pending)
			(or
				(up-compare-goal g-desired-num-monk > 3)
				(unit-type-count monk > 5))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1200))
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)
			
		;--------------
		;	Druzhina
		;--------------
			
			(defrule
			(or
				(goal g-primary-unit-class infantry-class)
				(goal g-support-unit-class infantry-class))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit-class infantry-class)
				(goal g-support-unit-class infantry-class))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit-class infantry-class)
			; 	(goal g-support-unit-class infantry-class))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Druzhina for swordsmen")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-infantry > 10)
				(unit-type-count infantry-class > 15))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined SPANISH-CIV

		;-----------------
		;	Inquisition
		;-----------------

			(defrule
			(up-research-status c: ri-block-printing >= research-pending)
			(or
				(up-compare-goal g-desired-num-monk > 3)
				(unit-type-count monk > 5))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1100))
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;---------------
		;	Supremacy
		;---------------

			(defrule
			(up-modify-goal g-temp g:= g-desired-num-villager)
			(up-modify-goal g-temp c:- 10)
			(up-object-type-count c: villager g:>= g-temp)	;we have at least ten less than the total number of villagers we want
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined TATARS-CIV

		;----------------
		;	Silk Armor
		;----------------
			
			(defrule
			(or
				(goal g-primary-unit scout-cavalry)
				(or
					(goal g-support-unit scout-cavalry)
					(or
						(goal g-primary-unit cavalry-archer)
						(or
							(goal g-support-unit cavalry-archer)
							(or
								(goal g-primary-unit steppe-lancer)
								(goal g-support-unit steppe-lancer))))))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow my-second-unique-research)
			=>
			(release-escrow wood)
			(release-escrow gold)
			(research my-second-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit scout-cavalry)
				(or
					(goal g-support-unit scout-cavalry)
					(or
						(goal g-primary-unit cavalry-archer)
						(goal g-support-unit cavalry-archer))))
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-second-unique-research c: 1)
			(up-modify-goal g-max-wood-needed g:max g-wood-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			(defrule
			(or
				(goal g-primary-unit steppe-lancer)
				(goal g-support-unit steppe-lancer))
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-second-unique-research c: 1)
			(up-modify-goal g-max-wood-needed g:max g-wood-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit scout-cavalry)
			; 	(or
			; 		(goal g-support-unit scout-cavalry)
			; 		(or
			; 			(goal g-primary-unit cavalry-archer)
			; 			(or
			; 				(goal g-support-unit cavalry-archer)
			; 				(or
			; 					(goal g-primary-unit steppe-lancer)
			; 					(goal g-support-unit steppe-lancer))))))
			; (up-research-status c: my-second-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Silk Armor for scouts")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-scout-cavalry > 10)
				(or
					(unit-type-count scout-cavalry-line > 15)
					(or
						(up-compare-goal g-desired-num-cavalry-archer > 10)
						(or
							(unit-type-count cavalry-archer-line > 15)
							(or
								(up-compare-goal g-desired-num-steppe-lancer > 10)
								(unit-type-count steppe-lancer-line > 15))))))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;------------------------
		;	Timurid Siegecraft
		;------------------------

			(defrule
			(up-compare-goal g-desired-num-trebuchet >= 4)
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow wood)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(up-compare-goal g-desired-num-trebuchet >= 4)
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-wood-needed g:max g-wood-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (up-compare-goal g-desired-num-trebuchet >= 4)
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Timurid Siegecraft")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-trebuchet >= 2)
				(unit-type-count trebuchet-set >= 3))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined TEUTONIC-CIV

		;--------------
		;	Ironclad
		;--------------

			(defrule
			(or
				(up-compare-goal g-desired-num-battering-ram >= 3)
				(or
					(up-compare-goal g-desired-num-mangonel >= 3)
					(or
						(up-compare-goal g-desired-num-scorpion >= 5)
						(or
							(up-compare-goal g-desired-num-bombard-cannon >= 3)
							(up-compare-goal g-desired-num-trebuchet >= 3)))))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow my-second-unique-research)
			=>
			(release-escrow wood)
			(release-escrow gold)
			(research my-second-unique-research)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-battering-ram >= 3)
				(or
					(up-compare-goal g-desired-num-mangonel >= 3)
					(or
						(up-compare-goal g-desired-num-scorpion >= 5)
						(or
							(up-compare-goal g-desired-num-bombard-cannon >= 3)
							(up-compare-goal g-desired-num-trebuchet >= 3)))))
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-second-unique-research c: 1)
			(up-modify-goal g-max-wood-needed g:max g-wood-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(up-compare-goal g-desired-num-battering-ram >= 3)
			; 	(or
			; 		(up-compare-goal g-desired-num-mangonel >= 3)
			; 		(or
			; 			(up-compare-goal g-desired-num-scorpion >= 5)
			; 			(or
			; 				(up-compare-goal g-desired-num-bombard-cannon >= 3)
			; 				(up-compare-goal g-desired-num-trebuchet >= 3)))))
			; (up-research-status c: my-second-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Ironclad")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-battering-ram >= 2)
				(or
					(up-compare-goal g-desired-num-mangonel >= 2)
					(or
						(up-compare-goal g-desired-num-scorpion >= 2)
						(or
							(up-compare-goal g-desired-num-bombard-cannon >= 2)
							(up-compare-goal g-desired-num-trebuchet >= 2)))))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;-------------------
		;	Crenellations
		;-------------------
			
			(defrule
			(or
				(up-compare-goal g-desired-num-castle >= 2)
				(and
					(up-compare-goal g-desired-num-castle >= 1)
					(goal g-game-focus DEFENSIVE)))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow stone)
			(research my-unique-research)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-castle > 1)
				(and
					(up-compare-goal g-desired-num-castle > 0)
					(goal g-game-focus DEFENSIVE)))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-stone-needed g:max g-stone-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(up-compare-goal g-desired-num-castle > 1)
			; 	(and
			; 		(up-compare-goal g-desired-num-castle > 0)
			; 		(goal g-game-focus DEFENSIVE)))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Crenellations")
			; )

			(defrule
			(up-compare-goal g-desired-num-castle > 0)
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined TURKISH-CIV

		;------------
		;	Sipahi
		;------------
			
			(defrule
			(or
				(goal g-primary-unit cavalry-archer)
				(goal g-support-unit cavalry-archer))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow my-second-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-second-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit cavalry-archer)
				(goal g-support-unit cavalry-archer))
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-second-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit cavalry-archer)
			; 	(goal g-support-unit cavalry-archer))
			; (up-research-status c: my-second-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Sipahi")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-cavalry-archer > 10)
				(unit-type-count cavalry-archer-line > 15))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;---------------
		;	Artillery
		;---------------

			(defrule
			(or
				(up-compare-goal g-desired-num-bombard-tower >= 3)
				(or
					(up-compare-goal g-desired-num-bombard-cannon >= 2)
					(up-compare-goal g-desired-num-cannon-galleon >= 2)))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow stone)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(up-compare-goal g-desired-num-bombard-tower >= 3)
				(or
					(up-compare-goal g-desired-num-bombard-cannon >= 2)
					(up-compare-goal g-desired-num-cannon-galleon >= 2)))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-stone-needed g:max g-stone-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(up-compare-goal g-desired-num-bombard-tower >= 3)
			; 	(or
			; 		(up-compare-goal g-desired-num-bombard-cannon >= 2)
			; 		(up-compare-goal g-desired-num-cannon-galleon >= 2)))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Artillery for bombard towers")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-bombard-tower > 2)
				(or
					(building-type-count bombard-tower > 3)
					(or
						(up-compare-goal g-desired-num-bombard-cannon > 1)
						(or
							(unit-type-count bombard-cannon > 2)
							(or
								(up-compare-goal g-desired-num-cannon-galleon > 1)
								(unit-type-count cannon-galleon-line > 2))))))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined VIETNAMESE-CIV

		;-------------
		;	Chatras
		;-------------
			
			(defrule
			(or
				(goal g-primary-unit battle-elephant)
				(goal g-support-unit battle-elephant))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow my-second-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-second-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit battle-elephant)
				(goal g-support-unit battle-elephant))
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-second-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit battle-elephant)
			; 	(goal g-support-unit battle-elephant))
			; (up-research-status c: my-second-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Chatras")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-battle-elephant > 6)
				(up-compare-goal g-battle-elephant-line > 10))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;-----------------
		;	Paper Money
		;-----------------

			(defrule
			(or
				(up-players-in-game ally >= 3)
				(goal g-age-status LATE-IMPERIAL))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

			(defrule
			(food-amount >= 1000)
			(wood-amount >= 1000)
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

	#load-if-defined VIKING-CIV

		;----------------
		;	Chieftains
		;----------------
			
			(defrule
			(or
				(goal g-primary-unit-class infantry-class)
				(goal g-support-unit-class infantry-class))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow my-second-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-second-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit-class infantry-class)
				(goal g-support-unit-class infantry-class))
			(up-research-status c: my-second-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-second-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit-class infantry-class)
			; 	(goal g-support-unit-class infantry-class))
			; (up-research-status c: my-second-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Chieftains for swordsmen")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-infantry > 10)
				(unit-type-count infantry-class > 15))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research my-second-unique-research)
			=>
			(research my-second-unique-research)
			)

		;-------------------
		;	Berserkergang
		;-------------------

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(goal g-support-unit my-unique-unit))
			(can-research-with-escrow my-unique-research)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research my-unique-research)
			)

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(goal g-support-unit my-unique-unit))
			(up-research-status c: my-unique-research == research-available)
			(building-type-count castle > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: my-unique-research c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit my-unique-unit)
			; 	(goal g-support-unit my-unique-unit))
			; (up-research-status c: my-unique-research == research-available)
			; (building-type-count castle > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Berserkergang")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-unique-unit > 10)
				(up-compare-goal g-unique-unit-line > 15))
			(can-research my-unique-research)
			=>
			(research my-unique-research)
			)

	#end-if

;=========================<>=========================
;				    CAVALRY TECHS
;=========================<>=========================

	;---------------------------
	;	Elite Battle Elephant
	;---------------------------

		#load-if-defined UP-GAME-WK

			(defrule
			(or
				(goal g-primary-unit battle-elephant)
				(goal g-support-unit battle-elephant))
			(can-research-with-escrow ri-elite-battle-elephant)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research ri-elite-battle-elephant)
			)

			(defrule
			(or
				(goal g-primary-unit battle-elephant)
				(goal g-support-unit battle-elephant))
			(up-research-status c: ri-elite-battle-elephant == research-available)
			(building-type-count stable > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-elite-battle-elephant c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit battle-elephant)
			; 	(goal g-support-unit battle-elephant))
			; (up-research-status c: ri-elite-battle-elephant == research-available)
			; (building-type-count stable > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Elite Battle Elephant")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-battle-elephant > 6)
				(up-compare-goal g-battle-elephant-line > 10))
			(can-research ri-elite-battle-elephant)
			=>
			(research ri-elite-battle-elephant)
			)

		#end-if

	;--------------
	;	Cavalier
	;--------------

		(defrule
		(or
			(goal g-primary-unit knight)
			(goal g-support-unit knight))
		(can-research-with-escrow ri-cavalier)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-cavalier)
		)

		(defrule
		(goal g-primary-unit knight)
		(goal g-age-status TO-IMPERIAL)
		(up-compare-const CAVALIER-AVAILABLE == YES)
		(building-type-count stable > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-cavalier c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-primary-unit knight)
		; (goal g-age-status TO-IMPERIAL)
		; (up-compare-const CAVALIER-AVAILABLE == YES)
		; (building-type-count stable > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Cavalier, pre-Imperial")
		; )

		(defrule
		(or
			(goal g-primary-unit knight)
			(goal g-support-unit knight))
		(up-research-status c: ri-cavalier == research-available)
		(building-type-count stable > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-cavalier c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit knight)
		; 	(goal g-support-unit knight))
		; (up-research-status c: ri-cavalier == research-available)
		; (building-type-count stable > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Cavalier, normal")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-knight > 10)
			(unit-type-count knight-line > 15))
		(can-research ri-cavalier)
		=>
		(research ri-cavalier)
		)

	;-------------
	;	Paladin
	;-------------

		(defrule
		(or
			(goal g-primary-unit knight)
			(goal g-support-unit knight))
		(can-research-with-escrow ri-paladin)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-paladin)
		)

		(defrule
		(or
			(goal g-primary-unit knight)
			(goal g-support-unit knight))
		(up-research-status c: ri-paladin == research-available)
		(building-type-count stable > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-paladin c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit knight)
		; 	(goal g-support-unit knight))
		; (up-research-status c: ri-paladin == research-available)
		; (building-type-count stable > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Paladin")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-knight > 10)
			(unit-type-count knight-line > 15))
		(can-research ri-paladin)
		=>
		(research ri-paladin)
		)

	;-----------------
	;	Heavy Camel
	;-----------------

		(defrule
		(or
			(goal g-primary-unit camel)
			(goal g-support-unit camel))
		(can-research-with-escrow ri-heavy-camel)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-heavy-camel)
		)

		(defrule
		(goal g-primary-unit camel)
		(goal g-age-status TO-IMPERIAL)
		(up-compare-const HEAVY-CAMEL-AVAILABLE == YES)
		(building-type-count stable > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-heavy-camel c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-primary-unit camel)
		; (goal g-age-status TO-IMPERIAL)
		; (up-compare-const HEAVY-CAMEL-AVAILABLE == YES)
		; (building-type-count stable > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Heavy camel, pre-Imp")
		; )

		(defrule
		(or
			(goal g-primary-unit camel)
			(goal g-support-unit camel))
		(up-research-status c: ri-heavy-camel == research-available)
		(building-type-count stable > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-heavy-camel c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit camel)
		; 	(goal g-support-unit camel))
		; (up-research-status c: ri-heavy-camel == research-available)
		; (building-type-count stable > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Heavy Camel, normal")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-camel > 10)
			(up-compare-goal g-camel-line >= 15))
		(can-research ri-heavy-camel)
		=>
		(research ri-heavy-camel)
		)

	;--------------------
	;	Imperial Camel
	;--------------------

		#load-if-defined UP-GAME-WK

			(defrule
			(or
				(goal g-primary-unit camel)
				(goal g-support-unit camel))
			(can-research-with-escrow ri-imperial-camel)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research ri-imperial-camel)
			)

			(defrule
			(or
				(goal g-primary-unit camel)
				(goal g-support-unit camel))
			(up-research-status c: ri-imperial-camel == research-available)
			(building-type-count stable > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-imperial-camel c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit camel)
			; 	(goal g-support-unit camel))
			; (up-research-status c: ri-imperial-camel == research-available)
			; (building-type-count stable > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Imperial Camel")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-camel > 10)
				(up-compare-goal g-camel-line > 15))
			(can-research ri-imperial-camel)
			=>
			(research ri-imperial-camel)
			)

		#end-if

	;-------------------------
	;	Elite Steppe Lancer
	;-------------------------

		(defrule
		(or
			(goal g-primary-unit steppe-lancer)
			(goal g-support-unit steppe-lancer))
		(can-research-with-escrow ri-elite-steppe-lancer)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-elite-steppe-lancer)
		)

		(defrule
		(goal g-primary-unit steppe-lancer)
		(goal g-age-status TO-IMPERIAL)
		(up-compare-const ELITE-STEPPE-LANCER-AVAILABLE == YES)
		(building-type-count stable > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-elite-steppe-lancer c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-primary-unit steppe-lancer)
		; (goal g-age-status TO-IMPERIAL)
		; (up-compare-const ELITE-STEPPE-LANCER-AVAILABLE == YES)
		; (building-type-count stable > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Elite Steppe Lancer, pre-Imp")
		; )

		(defrule
		(or
			(goal g-primary-unit steppe-lancer)
			(goal g-support-unit steppe-lancer))
		(up-research-status c: ri-elite-steppe-lancer == research-available)
		(building-type-count stable > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-elite-steppe-lancer c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit steppe-lancer)
		; 	(goal g-support-unit steppe-lancer))
		; (up-research-status c: ri-elite-steppe-lancer == research-available)
		; (building-type-count stable > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Elite Steppe Lancer, support")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-steppe-lancer > 10)
			(unit-type-count steppe-lancer-line > 15))
		(can-research ri-elite-steppe-lancer)
		=>
		(research ri-elite-steppe-lancer)
		)

	;-------------------
	;	Light Cavalry
	;-------------------

		(defrule
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(up-compare-goal g-desired-num-scout-cavalry > 0)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(and
				(food-amount >= 1150)
				(gold-amount >= 850)))
		(can-research-with-escrow ri-light-cavalry)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-light-cavalry)
		)

		(defrule
		(goal g-primary-unit scout-cavalry)
		(goal g-age-status TO-CASTLE)
		(up-compare-const LIGHT-CAVALRY-AVAILABLE == YES)
		(building-type-count stable > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-light-cavalry c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-primary-unit scout-cavalry)
		; (goal g-age-status TO-CASTLE)
		; (up-compare-const LIGHT-CAVALRY-AVAILABLE == YES)
		; (building-type-count stable > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Light Cavalry, pre-Castle")
		; )

		(defrule
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(up-compare-goal g-desired-num-scout-cavalry > 0)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(and
				(food-amount >= 1150)
				(gold-amount >= 850)))
		(up-research-status c: ri-light-cavalry == research-available)
		(building-type-count stable > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-light-cavalry c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(up-compare-goal g-game-focus != BOOM)
		; 	(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		; (up-compare-goal g-desired-num-scout-cavalry > 0)
		; (or
		; 	(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		; 	(and
		; 		(food-amount >= 1150)
		; 		(gold-amount >= 850)))
		; (up-research-status c: ri-light-cavalry == research-available)
		; (building-type-count stable > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Light Cavalry, normal")
		; )

		(defrule
		(unit-type-count scout-cavalry-line > 5)
		(can-research ri-light-cavalry)
		=>
		(research ri-light-cavalry)
		)

	;------------
	;	Hussar
	;------------

		(defrule
		(or
			(goal g-primary-unit scout-cavalry)
			(or
				(goal g-support-unit scout-cavalry)
				(and
					(up-compare-goal g-desired-num-scout-cavalry > 0)
					(goal g-age-status LATE-IMPERIAL))))
		(can-research-with-escrow ri-hussar)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-hussar)
		)

		(defrule
		(goal g-primary-unit scout-cavalry)
		(goal g-age-status TO-IMPERIAL)
		(research-completed ri-light-cavalry)
		(up-compare-const HUSSAR-AVAILABLE == YES)
		(building-type-count stable > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-hussar c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-primary-unit scout-cavalry)
		; (research-completed ri-light-cavalry)
		; (goal g-age-status TO-IMPERIAL)
		; (up-compare-const HUSSAR-AVAILABLE == YES)
		; (building-type-count stable > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Hussar, pre-Imp")
		; )

		(defrule
		(or
			(goal g-primary-unit scout-cavalry)
			(or
				(goal g-support-unit scout-cavalry)
				(and
					(up-compare-goal g-desired-num-scout-cavalry > 0)
					(goal g-age-status LATE-IMPERIAL))))
		(up-research-status c: ri-hussar == research-available)
		(building-type-count stable > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-hussar c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit scout-cavalry)
		; 	(or
		; 		(goal g-support-unit scout-cavalry)
		; 		(and
		; 			(up-compare-goal g-desired-num-scout-cavalry > 0)
		; 			(goal g-age-status LATE-IMPERIAL))))
		; (up-research-status c: ri-hussar == research-available)
		; (building-type-count stable > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Hussar, normal")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-scout-cavalry > 10)
			(unit-type-count scout-cavalry-line >= 15))
		(can-research ri-hussar)
		=>
		(research ri-hussar)
		)

    ;-------------------------
    ;   Scale Barding Armor
    ;-------------------------

		(defrule
		(current-age == feudal-age)
		(up-compare-goal g-strategy-type < FAST-CASTLE)
		(or
			(goal g-primary-unit scout-cavalry)
			(goal g-support-unit scout-cavalry))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-CASTLE)
			(food-amount >= 950))
		(can-research-with-escrow ri-scale-barding)
		=>
		(release-escrow food)
		(research ri-scale-barding)
		)

		(defrule
		(current-age == feudal-age)
		(up-compare-goal g-strategy-type < FAST-CASTLE)
		(or
			(goal g-primary-unit scout-cavalry)
			(goal g-support-unit scout-cavalry))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-CASTLE)
			(food-amount >= 950))
		(up-research-status c: ri-scale-barding == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-scale-barding c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (current-age == feudal-age)
		; (up-compare-goal g-strategy-type < FAST-CASTLE)
		; (or
		; 	(goal g-primary-unit scout-cavalry)
		; 	(goal g-support-unit scout-cavalry))
		; (or
		; 	(up-compare-goal g-age-status != SAVE-FOR-CASTLE)
		; 	(food-amount >= 950))
		; (up-research-status c: ri-scale-barding == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Scale Barding, feudal")
		; )

		(defrule
		(current-age >= castle-age)
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(or
			(goal g-primary-unit-class cavalry-class)
			(goal g-support-unit-class cavalry-class))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1150))
		(can-research-with-escrow ri-scale-barding)
		=>
		(release-escrow food)
		(research ri-scale-barding)
		)

		(defrule
		(current-age >= castle-age)
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(or
			(goal g-primary-unit-class cavalry-class)
			(goal g-support-unit-class cavalry-class))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1150))
		(up-research-status c: ri-scale-barding == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-scale-barding c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (current-age >= castle-age)
		; (or
		; 	(up-compare-goal g-game-focus != BOOM)
		; 	(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		; (or
		; 	(goal g-primary-unit-class cavalry-class)
		; 	(goal g-support-unit-class cavalry-class))
		; (or
		; 	(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		; 	(food-amount >= 1150))
		; (up-research-status c: ri-scale-barding == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Scale Barding, Castle")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-cavalry > 5)
			(unit-type-count cavalry-class >= 8))
		(or
			(and
				(up-compare-goal g-age-status >= TO-CASTLE)
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL))
			(or
				(food-amount >= 950)
				(up-compare-goal g-strategy-type < FAST-CASTLE)))
		(can-research ri-scale-barding)
		=>
		(research ri-scale-barding)
		)

    ;-------------------------
    ;   Chain Barding Armor
    ;-------------------------

		(defrule
		(goal g-primary-unit-class cavalry-class)
		(or
			(military-population > 10)
			(or
				(up-compare-goal g-target-military-parity > 0)
				(up-compare-goal g-age-status >= MID-CASTLE)))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research-with-escrow ri-chain-barding)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-chain-barding)
		)

		(defrule
		(goal g-support-unit-class cavalry-class)
		(up-compare-goal g-age-status >= MID-CASTLE)
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research-with-escrow ri-chain-barding)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-chain-barding)
		)

		(defrule
		(goal g-primary-unit-class cavalry-class)
		(or
			(military-population > 10)
			(or
				(up-compare-goal g-target-military-parity > 0)
				(up-compare-goal g-age-status >= MID-CASTLE)))
		(up-research-status c: ri-chain-barding == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-chain-barding c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-primary-unit-class cavalry-class)
		; (or
		; 	(military-population > 10)
		; 	(or
		; 		(up-compare-goal g-target-military-parity > 0)
		; 		(up-compare-goal g-age-status >= MID-CASTLE)))
		; (up-research-status c: ri-chain-barding == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Chain Barding, primary")
		; )

		(defrule
		(goal g-support-unit-class cavalry-class)
		(up-compare-goal g-age-status >= MID-CASTLE)
		(up-research-status c: ri-chain-barding == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-chain-barding c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-support-unit-class cavalry-class)
		; (up-compare-goal g-age-status >= MID-CASTLE)
		; (up-research-status c: ri-chain-barding == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Chain Barding, support")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-cavalry > 6)
			(unit-type-count cavalry-class > 10))
		(up-compare-goal g-age-status >= MID-CASTLE)
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-chain-barding)
		=>
		(research ri-chain-barding)
		)

    ;-------------------------
    ;   Plate Barding Armor
    ;-------------------------

		(defrule
		(current-age == imperial-age)
		(up-compare-const CAVALIER-AVAILABLE == YES)
		(up-compare-goal g-desired-num-knight >= 10)
		(up-research-status c: ri-cavalier < research-pending)
		=>
		(up-jump-rule 2)
		)

		(defrule
		(current-age == imperial-age)
		(up-compare-const HEAVY-CAMEL-AVAILABLE == YES)
		(up-compare-goal g-desired-num-camel >= 10)
		(up-research-status c: ri-heavy-camel < research-pending)
		=>
		(up-jump-rule 1)
		)

			(defrule
			(or
				(goal g-primary-unit-class cavalry-class)
				(goal g-support-unit-class cavalry-class))
			(can-research-with-escrow ri-plate-barding)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research ri-plate-barding)
			)

		(defrule
		(goal g-primary-unit-class cavalry-class)
		(goal g-age-status TO-IMPERIAL)
		(research-completed ri-chain-barding)
		(up-compare-const PLATE-BARDING-ARMOR-AVAILABLE == YES)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-plate-barding c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-primary-unit-class cavalry-class)
		; (goal g-age-status TO-IMPERIAL)
		; (research-completed ri-chain-barding)
		; (up-compare-const PLATE-BARDING-ARMOR-AVAILABLE == YES)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Plate Barding for scouts, pre-Imp")
		; )

		(defrule
		(or
			(goal g-primary-unit-class cavalry-class)
			(goal g-support-unit-class cavalry-class))
		(up-research-status c: ri-plate-barding == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-plate-barding c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit-class cavalry-class)
		; 	(goal g-support-unit-class cavalry-class))
		; (up-research-status c: ri-plate-barding == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Plate Barding for scouts, normal")
		; )

		(defrule
		(current-age == imperial-age)
		(up-compare-const CAVALIER-AVAILABLE == YES)
		(up-compare-goal g-desired-num-knight >= 10)
		(up-research-status c: ri-cavalier < research-pending)
		=>
		(up-jump-rule 2)
		)

		(defrule
		(current-age == imperial-age)
		(up-compare-const HEAVY-CAMEL-AVAILABLE == YES)
		(up-compare-goal g-desired-num-camel >= 10)
		(up-research-status c: ri-heavy-camel < research-pending)
		=>
		(up-jump-rule 1)
		)

			(defrule
			(or
				(up-compare-goal g-desired-num-cavalry > 10)
				(unit-type-count cavalry-class > 15))
			(can-research ri-plate-barding)
			=>
			(research ri-plate-barding)
			)

	;-------------
	;	Forging
	;-------------

		(defrule
		(current-age >= castle-age)
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(or
			(goal g-primary-unit-class cavalry-class)
			(goal g-support-unit-class cavalry-class))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1150))
		(or
			(up-research-status c: ri-scale-barding >= research-pending)
			(food-amount > 300))
		(can-research-with-escrow ri-forging)
		=>
		(release-escrow food)
		(research ri-forging)
		)

		(defrule
		(current-age >= castle-age)
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(or
			(goal g-primary-unit-class cavalry-class)
			(goal g-support-unit-class cavalry-class))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1150))
		(up-research-status c: ri-forging == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-forging c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (current-age >= castle-age)
		; (or
		; 	(up-compare-goal g-game-focus != BOOM)
		; 	(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		; (or
		; 	(goal g-primary-unit-class cavalry-class)
		; 	(goal g-support-unit-class cavalry-class))
		; (or
		; 	(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		; 	(food-amount >= 1150))
		; (up-research-status c: ri-forging == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Forging for cavalry")
		; )

		(defrule
		(current-age == feudal-age)
		(goal g-primary-unit scout-cavalry)
		(up-research-status c: ri-scale-barding >= research-pending)
		(or
			(up-research-status c: ri-scale-barding >= research-pending)
			(food-amount > 300))
		(can-research ri-forging)
		=>
		(research ri-forging)
		)

		(defrule
		(current-age >= castle-age)
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(or
			(up-compare-goal g-desired-num-cavalry > 6)
			(unit-type-count cavalry-class > 10))
		(or
			(up-research-status c: ri-scale-barding >= research-pending)
			(food-amount > 300))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1150))
		(can-research ri-forging)
		=>
		(research ri-forging)
		)

	;------------------
	;	Iron Casting
	;------------------

		(defrule
		(or
			(goal g-primary-unit-class cavalry-class)
			(goal g-support-unit-class cavalry-class))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(or
			(up-research-status c: ri-chain-barding >= research-pending)
			(food-amount > 350))
		(can-research-with-escrow ri-iron-casting)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-iron-casting)
		)

		(defrule
		(or
			(goal g-primary-unit-class cavalry-class)
			(goal g-support-unit-class cavalry-class))
		(up-research-status c: ri-iron-casting == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-iron-casting c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit-class cavalry-class)
		; 	(goal g-support-unit-class cavalry-class))
		; (up-research-status c: ri-iron-casting == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Iron Casting for scouts")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-cavalry > 6)
			(unit-type-count cavalry-class > 10))
		(or
			(up-research-status c: ri-chain-barding >= research-pending)
			(food-amount > 350))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-iron-casting)
		=>
		(research ri-iron-casting)
		)
		
	;-------------------
	;	Blast Furnace
	;-------------------

		(defrule
		(current-age == imperial-age)
		(up-compare-const CAVALIER-AVAILABLE == YES)
		(up-compare-goal g-desired-num-knight >= 10)
		(up-research-status c: ri-cavalier < research-pending)
		=>
		(up-jump-rule 2)
		)

		(defrule
		(current-age == imperial-age)
		(up-compare-const HEAVY-CAMEL-AVAILABLE == YES)
		(up-compare-goal g-desired-num-camel >= 10)
		(up-research-status c: ri-heavy-camel < research-pending)
		=>
		(up-jump-rule 1)
		)

			(defrule
			(or
				(goal g-primary-unit-class cavalry-class)
				(goal g-support-unit-class cavalry-class))
			(can-research-with-escrow ri-blast-furnace)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research ri-blast-furnace)
			)

		(defrule
		(or
			(goal g-primary-unit-class cavalry-class)
			(goal g-support-unit-class cavalry-class))
		(goal g-age-status TO-IMPERIAL)
		(research-completed ri-iron-casting)
		(up-compare-const BLAST-FURNACE-AVAILABLE == YES)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-blast-furnace c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit-class cavalry-class)
		; 	(goal g-support-unit-class cavalry-class))
		; (goal g-age-status TO-IMPERIAL)
		; (research-completed ri-iron-casting)
		; (up-compare-const BLAST-FURNACE-AVAILABLE == YES)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Blast Furnace for cavalry, pre-Imp")
		; )

		(defrule
		(or
			(goal g-primary-unit-class cavalry-class)
			(goal g-support-unit-class cavalry-class))
		(up-research-status c: ri-blast-furnace == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-blast-furnace c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit-class cavalry-class)
		; 	(goal g-support-unit-class cavalry-class))
		; (up-research-status c: ri-blast-furnace == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Blast Furnace for cavalry, normal")
		; )

		(defrule
		(current-age == imperial-age)
		(up-compare-const CAVALIER-AVAILABLE == YES)
		(up-compare-goal g-desired-num-knight >= 10)
		(up-research-status c: ri-cavalier < research-pending)
		=>
		(up-jump-rule 2)
		)

		(defrule
		(current-age == imperial-age)
		(up-compare-const HEAVY-CAMEL-AVAILABLE == YES)
		(up-compare-goal g-desired-num-camel >= 10)
		(up-research-status c: ri-heavy-camel < research-pending)
		=>
		(up-jump-rule 1)
		)

			(defrule
			(or
				(up-compare-goal g-desired-num-cavalry > 10)
				(unit-type-count cavalry-class > 15))
			(can-research ri-blast-furnace)
			=>
			(research ri-blast-furnace)
			)

    ;----------------
    ;   Bloodlines
    ;----------------
		
		(defrule
		(unit-type-count cavalry-class < 4)
		=>
		(up-jump-rule 4)
		)

			(defrule
			(current-age >= castle-age)
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(goal g-primary-unit-class cavalry-class)
				(and
					(goal g-support-unit-class cavalry-class)
					(goal g-support-unit battle-elephant)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-bloodlines)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research ri-bloodlines)
			)

			(defrule
			(current-age >= castle-age)
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(goal g-primary-unit-class cavalry-class)
				(and
					(goal g-support-unit-class cavalry-class)
					(goal g-support-unit battle-elephant)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-research-status c: ri-bloodlines == research-available)
			(building-type-count stable > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-bloodlines c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			(defrule
			(taunt-detected TAUNT-PLAYER 246)
			(current-age >= castle-age)
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(goal g-primary-unit-class cavalry-class)
				(and
					(goal g-support-unit-class cavalry-class)
					(goal g-support-unit battle-elephant)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-research-status c: ri-bloodlines == research-available)
			(building-type-count stable > 0)
			=>
			(chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Bloodlines for cavalry")
			)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(and
					(up-compare-goal g-age-status >= TO-CASTLE)
					(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL))
				(or
					(food-amount >= 950)
					(up-compare-goal g-strategy-type < FAST-CASTLE)))
			(or
				(up-compare-goal g-desired-num-cavalry > 6)
				(unit-type-count cavalry-class > 10))
			(can-research ri-bloodlines)
			=>
			(research ri-bloodlines)
			)

    ;----------------
    ;   Husbandry
    ;----------------
		
		(defrule
		(unit-type-count cavalry-class < 6)
		=>
		(up-jump-rule 4)
		)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(goal g-primary-unit-class cavalry-class)
				(goal g-support-unit-class cavalry-class))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-husbandry)
			=>
			(release-escrow food)
			(research ri-husbandry)
			)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(goal g-primary-unit-class cavalry-class)
				(goal g-support-unit-class cavalry-class))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-research-status c: ri-husbandry == research-available)
			(building-type-count stable > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-husbandry c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			)

			(defrule
			(taunt-detected TAUNT-PLAYER 246)
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(goal g-primary-unit-class cavalry-class)
				(goal g-support-unit-class cavalry-class))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-research-status c: ri-husbandry == research-available)
			(building-type-count stable > 0)
			=>
			(chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Husbandry for cavalry")
			)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(up-compare-goal g-desired-num-cavalry > 6)
				(unit-type-count cavalry-class > 10))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1150))
			(can-research ri-husbandry)
			=>
			(research ri-husbandry)
			)

;=========================<>=========================
;				    ARCHERY TECHS
;=========================<>=========================

	;--------------------------
	;	Heavy Cavalry Archer
	;--------------------------

		(defrule
		(or
			(goal g-primary-unit cavalry-archer)
			(goal g-support-unit cavalry-archer))
		(can-research-with-escrow ri-heavy-cavalry-archer)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-heavy-cavalry-archer)
		)

		(defrule
		(or
			(goal g-primary-unit cavalry-archer)
			(goal g-support-unit cavalry-archer))
		(up-research-status c: ri-heavy-cavalry-archer == research-available)
		(building-type-count archery-range > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-heavy-cavalry-archer c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit cavalry-archer)
		; 	(goal g-support-unit cavalry-archer))
		; (up-research-status c: ri-heavy-cavalry-archer == research-available)
		; (building-type-count archery-range > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Heavy Cavalry Archer")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-cavalry-archer > 10)
			(unit-type-count cavalry-archer-line > 15))
		(can-research ri-heavy-cavalry-archer)
		=>
		(research ri-heavy-cavalry-archer)
		)

	;--------------------
	;	Elite Genitour
	;--------------------

		#load-if-defined UP-GAME-WK

			(defrule
			(or
				(goal g-primary-unit genitour)
				(goal g-support-unit genitour))
			(can-research-with-escrow ri-elite-genitour)
			=>
			(release-escrow food)
			(release-escrow wood)
			(research ri-elite-genitour)
			)

			(defrule
			(goal g-primary-unit genitour)
			(goal g-age-status TO-IMPERIAL)
			(up-research-status c: ri-elite-genitour < research-pending)
			(building-type-count archery-range > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-elite-genitour c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-wood-needed g:max g-wood-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (goal g-primary-unit genitour)
			; (goal g-age-status TO-IMPERIAL)
			; (up-research-status c: ri-elite-genitour < research-pending)
			; (building-type-count archery-range > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Elite Genitour, pre-imp")
			; )

			(defrule
			(or
				(goal g-primary-unit genitour)
				(goal g-support-unit genitour))
			(up-research-status c: ri-elite-genitour == research-available)
			(building-type-count archery-range > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-elite-genitour c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-wood-needed g:max g-wood-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit genitour)
			; 	(goal g-support-unit genitour))
			; (up-research-status c: ri-elite-genitour == research-available)
			; (building-type-count archery-range > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Elite Genitour, support")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-genitour > 10)
				(up-compare-goal g-genitour-line > 15))
			(can-research ri-elite-genitour)
			=>
			(research ri-elite-genitour)
			)

		#end-if

	;-----------------
	;	Crossbowman
	;-----------------

		(defrule
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(or
			(goal g-primary-unit archer)
			(goal g-support-unit archer))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research-with-escrow ri-crossbow)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-crossbow)
		)

		(defrule
		(goal g-primary-unit archer)
		(goal g-age-status TO-CASTLE)
		(up-compare-const CROSSBOWMAN-AVAILABLE == YES)
		(building-type-count archery-range > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-crossbow c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-primary-unit archer)
		; (goal g-age-status TO-CASTLE)
		; (up-compare-const CROSSBOWMAN-AVAILABLE == YES)
		; (building-type-count archery-range > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Crossbowman, pre-Castle")
		; )

		(defrule
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(or
			(goal g-primary-unit archer)
			(goal g-support-unit archer))
		(up-research-status c: ri-crossbow == research-available)
		(building-type-count archery-range > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-crossbow c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(up-compare-goal g-game-focus != BOOM)
		; 	(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		; (or
		; 	(goal g-primary-unit archer)
		; 	(goal g-support-unit archer))
		; (up-research-status c: ri-crossbow == research-available)
		; (building-type-count archery-range > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Crossbowman, normal")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-archer > 6)
			(unit-type-count archer-line > 10))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-crossbow)
		=>
		(research ri-crossbow)
		)

	;--------------
	;	Arbalest
	;--------------

		(defrule
		(or
			(goal g-primary-unit archer)
			(goal g-support-unit archer))
		(can-research-with-escrow ri-arbalest)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-arbalest)
		)

		(defrule
		(goal g-primary-unit archer)
		(goal g-age-status TO-IMPERIAL)
		(up-compare-const ARBALEST-AVAILABLE == YES)
		(building-type-count archery-range > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-arbalest c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-primary-unit archer)
		; (goal g-age-status TO-IMPERIAL)
		; (up-compare-const ARBALEST-AVAILABLE == YES)
		; (building-type-count archery-range > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Arbalest, pre-Imp")
		; )

		(defrule
		(or
			(goal g-primary-unit archer)
			(goal g-support-unit archer))
		(up-research-status c: ri-arbalest == research-available)
		(building-type-count archery-range > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-arbalest c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit archer)
		; 	(goal g-support-unit archer))
		; (up-research-status c: ri-arbalest == research-available)
		; (building-type-count archery-range > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Arbalest, normal")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-archer > 10)
			(unit-type-count archer-line >= 15))
		(can-research ri-arbalest)
		=>
		(research ri-arbalest)
		)

	;----------------------
	;	Elite Skirmisher
	;----------------------

		(defrule
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(or
			(goal g-primary-unit skirmisher)
			(goal g-support-unit skirmisher))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(gold-amount >= 950))
		(can-research-with-escrow ri-elite-skirmisher)
		=>
		(release-escrow wood)
		(release-escrow gold)
		(research ri-elite-skirmisher)
		)

		(defrule
		(goal g-primary-unit skirmisher)
		(goal g-age-status TO-CASTLE)
		(up-compare-const ELITE-SKIRMISHER-AVAILABLE == YES)
		(building-type-count archery-range > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-elite-skirmisher c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-primary-unit skirmisher)
		; (goal g-age-status TO-CASTLE)
		; (up-compare-const ELITE-SKIRMISHER-AVAILABLE == YES)
		; (building-type-count archery-range > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Elite Skirmisher, pre-Castle")
		; )

		(defrule
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(or
			(goal g-primary-unit skirmisher)
			(goal g-support-unit skirmisher))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(gold-amount >= 950))
		(up-research-status c: ri-elite-skirmisher == research-available)
		(building-type-count archery-range > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-elite-skirmisher c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(up-compare-goal g-game-focus != BOOM)
		; 	(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		; (or
		; 	(goal g-primary-unit skirmisher)
		; 	(goal g-support-unit skirmisher))
		; (or
		; 	(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		; 	(gold-amount >= 950))
		; (up-research-status c: ri-elite-skirmisher == research-available)
		; (building-type-count archery-range > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Elite Skirmisher, normal")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-skirmisher > 6)
			(up-compare-goal g-skirmisher-line > 10))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(gold-amount >= 950))
		(can-research ri-elite-skirmisher)
		=>
		(research ri-elite-skirmisher)
		)

	;-------------------------
	;	Imperial Skirmisher
	;-------------------------

		#load-if-defined UP-GAME-WK

			(defrule
			(or
				(goal g-primary-unit skirmisher)
				(goal g-support-unit skirmisher))
			(can-research-with-escrow ri-imperial-skirmisher)
			=>
			(release-escrow wood)
			(release-escrow gold)
			(research ri-imperial-skirmisher)
			)

			(defrule
			(goal g-primary-unit skirmisher)
			(goal g-age-status TO-IMPERIAL)
			(or
				(civ-selected vietnamese)
				(players-civ any-ally vietnamese))
			(building-type-count archery-range > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-imperial-skirmisher c: 1)
			(up-modify-goal g-max-wood-needed g:max g-wood-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (goal g-primary-unit skirmisher)
			; (goal g-age-status TO-IMPERIAL)
			; (or
			; 	(civ-selected vietnamese)
			; 	(players-civ any-ally vietnamese))
			; (building-type-count archery-range > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Imperial Skirmisher, pre-Imp")
			; )

			(defrule
			(or
				(goal g-primary-unit skirmisher)
				(goal g-support-unit skirmisher))
			(up-research-status c: ri-imperial-skirmisher == research-available)
			(building-type-count archery-range > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-imperial-skirmisher c: 1)
			(up-modify-goal g-max-wood-needed g:max g-wood-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit skirmisher)
			; 	(goal g-support-unit skirmisher))
			; (up-research-status c: ri-imperial-skirmisher == research-available)
			; (building-type-count archery-range > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Imperial Skirmisher, normal")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-skirmisher > 10)
				(up-compare-goal g-skirmisher-line > 15))
			(can-research ri-imperial-skirmisher)
			=>
			(research ri-imperial-skirmisher)
			)

		#end-if

	;---------------
	;	Chemistry
	;---------------

        (defrule
        (can-research-with-escrow ri-chemistry)
		(or
			(up-compare-goal g-desired-num-hand-cannoneer > 0)
			(or
				(up-compare-goal g-desired-num-bombard-cannon > 0)
				(or
					(up-compare-goal g-desired-num-cannon-galleon > 0)
					(up-compare-goal g-desired-num-bombard-cannon > 0))))
        =>
		(release-escrow food)
		(release-escrow gold)
		(research ri-chemistry)
        )

		(defrule
		(up-research-status c: ri-chemistry == research-available)
		(goal g-primary-unit hand-cannoneer)
		(goal g-age-status TO-IMPERIAL)
		(building-type-count university > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-chemistry c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-research-status c: ri-chemistry == research-available)
		; (goal g-primary-unit hand-cannoneer)
		; (goal g-age-status TO-IMPERIAL)
		; (building-type-count university > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Chemistry for hand cannons, pre-Imp")
		; )

		(defrule
		(up-research-status c: ri-chemistry == research-available)
		(or
			(up-compare-goal g-desired-num-hand-cannoneer > 0)
			(or
				(up-compare-goal g-desired-num-bombard-cannon > 0)
				(or
					(up-compare-goal g-desired-num-cannon-galleon > 0)
					(up-compare-goal g-desired-num-bombard-cannon > 0))))
		(building-type-count university > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-chemistry c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-research-status c: ri-chemistry == research-available)
		; (or
		; 	(up-compare-goal g-desired-num-hand-cannoneer > 0)
		; 	(or
		; 		(up-compare-goal g-desired-num-bombard-cannon > 0)
		; 		(or
		; 			(up-compare-goal g-desired-num-cannon-galleon > 0)
		; 			(up-compare-goal g-desired-num-bombard-cannon > 0))))
		; (building-type-count university > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Chemistry for gunpowder")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-foot-archers > 10)
			(or
				(unit-type-count archery-class > 15)
				(or
					(up-compare-goal g-desired-num-cavalry-archers > 10)
					(unit-type-count cavalry-archer-class > 15))))
		(can-research ri-chemistry)
		=>
		(research ri-chemistry)
		)

		(defrule
		(or
			(goal g-primary-enemy-threat g-enemy-swordsmen-count)
			(or
				(goal g-primary-enemy-threat g-enemy-spearmen-count)
				(goal g-primary-enemy-threat g-enemy-eagle-warrior-count)))
		(can-research ri-chemistry)
		=>
		(research ri-chemistry)
		)

	;---------------
	;	Fletching
	;---------------

		(defrule
		(current-age == feudal-age)
		(up-compare-goal g-age-status < SAVE-FOR-CASTLE)
		(up-compare-goal g-strategy-type < FAST-CASTLE)
		(or
			(goal g-primary-unit-class archery-class)
			(goal g-support-unit-class archery-class))
		(can-research-with-escrow ri-fletching)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-fletching)
		)

		(defrule
		(current-age == feudal-age)
		(up-compare-goal g-age-status < SAVE-FOR-CASTLE)
		(up-compare-goal g-strategy-type < FAST-CASTLE)
		(or
			(goal g-primary-unit-class archery-class)
			(goal g-support-unit-class archery-class))
		(up-research-status c: ri-fletching == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-fletching c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (current-age == feudal-age)
		; (up-compare-goal g-age-status < SAVE-FOR-CASTLE)
		; (up-compare-goal g-strategy-type < FAST-CASTLE)
		; (or
		; 	(goal g-primary-unit-class archery-class)
		; 	(goal g-support-unit-class archery-class))
		; (up-research-status c: ri-fletching == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Fletching, feudal")
		; )

		(defrule
		(current-age >= castle-age)
		(up-compare-const CROSSBOWMAN-AVAILABLE == YES)
		(up-compare-goal g-desired-num-archer >= 10)
		(up-research-status c: ri-crossbow < research-pending)
		=>
		(up-jump-rule 2)
		)

		(defrule
		(current-age >= castle-age)
		(up-compare-const ELITE-SKIRMISHER-AVAILABLE == YES)
		(up-compare-goal g-desired-num-skirmisher >= 10)
		(up-research-status c: ri-elite-skirmisher < research-pending)
		=>
		(up-jump-rule 1)
		)

			(defrule
			(up-compare-goal g-age-status >= TO-CASTLE)
			(or
				(goal g-primary-unit-class archery-class)
				(goal g-primary-unit-class cavalry-archer-class))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1100))
			(can-research-with-escrow ri-fletching)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research ri-fletching)
			)

		(defrule
		(up-compare-goal g-age-status >= TO-CASTLE)
		(or
			(goal g-primary-unit-class archery-class)
			(goal g-primary-unit-class cavalry-archer-class))
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-fletching c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-compare-goal g-age-status >= TO-CASTLE)
		; (or
		; 	(goal g-primary-unit-class archery-class)
		; 	(goal g-primary-unit-class cavalry-archer-class))
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Fletching, primary")
		; )

		(defrule
		(current-age >= castle-age)
		(or
			(goal g-support-unit-class archery-class)
			(goal g-support-unit-class cavalry-archer-class))
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-fletching c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (current-age >= castle-age)
		; (or
		; 	(goal g-support-unit-class archery-class)
		; 	(goal g-support-unit-class cavalry-archer-class))
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Fletching, support")
		; )

		(defrule
		(current-age == feudal-age)
		(or
			(up-compare-goal g-desired-num-foot-archers > 5)
			(unit-type-count archery-class > 8))
		(or
			(and
				(up-compare-goal g-age-status >= TO-CASTLE)
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL))
			(or
				(food-amount >= 900)
				(up-compare-goal g-strategy-type < FAST-CASTLE)))
		(can-research ri-fletching)
		=>
		(research ri-fletching)
		)

		(defrule
		(current-age >= castle-age)
		(up-compare-const CROSSBOWMAN-AVAILABLE == YES)
		(up-compare-goal g-desired-num-archer >= 10)
		(up-research-status c: ri-crossbow < research-pending)
		=>
		(up-jump-rule 2)
		)

		(defrule
		(current-age >= castle-age)
		(up-compare-const ELITE-SKIRMISHER-AVAILABLE == YES)
		(up-compare-goal g-desired-num-skirmisher >= 10)
		(up-research-status c: ri-elite-skirmisher < research-pending)
		=>
		(up-jump-rule 1)
		)

			(defrule
			(current-age >= castle-age)
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(up-compare-goal g-desired-num-foot-archers > 6)
				(or
					(unit-type-count archery-class > 10)
					(or
						(up-compare-goal g-desired-num-cavalry-archers > 6)
						(unit-type-count cavalry-archer-class > 10))))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-fletching)
			=>
			(research ri-fletching)
			)
		
	;------------------
	;	Bodkin Arrow
	;------------------

		(defrule
		(or
			(goal g-primary-unit-class archery-class)
			(or
				(goal g-support-unit archery-class)
				(or
					(goal g-primary-unit-class cavalry-archer-class)
					(goal g-support-unit-class cavalry-archer-class))))
		(or
			(up-compare-goal g-target-military-parity > 3)
			(goal g-first-attack-launched YES))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research-with-escrow ri-bodkin-arrow)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-bodkin-arrow)
		)

		(defrule
		(or
			(goal g-primary-unit-class archery-class)
			(or
				(goal g-support-unit archery-class)
				(or
					(goal g-primary-unit-class cavalry-archer-class)
					(goal g-support-unit-class cavalry-archer-class))))
		(or
			(up-compare-goal g-age-status >= MID-CASTLE)
			(goal g-first-attack-launched YES))
		(up-research-status c: ri-bodkin-arrow < research-pending)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-bodkin-arrow c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit-class archery-class)
		; 	(or
		; 		(goal g-support-unit archery-class)
		; 		(or
		; 			(goal g-primary-unit-class cavalry-archer-class)
		; 			(goal g-support-unit-class cavalry-archer-class))))
		; (or
		; 	(up-compare-goal g-target-military-parity > 3)
		; 	(goal g-first-attack-launched YES))
		; (up-research-status c: ri-bodkin-arrow < research-pending)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Bodkin Arrow")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-foot-archers > 6)
			(or
				(unit-type-count archery-class > 10)
				(or
					(up-compare-goal g-desired-num-cavalry-archers > 6)
					(unit-type-count cavalry-archer-class > 10))))
		(or
			(up-compare-goal g-age-status >= MID-CASTLE)
			(goal g-first-attack-launched YES))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-bodkin-arrow)
		=>
		(research ri-bodkin-arrow)
		)

	;------------
	;	Bracer
	;------------

		(defrule
		(or
			(goal g-primary-unit-class archery-class)
			(or
				(goal g-support-unit-class archery-class)
				(or
					(goal g-primary-unit-class cavalry-archer-class)
					(goal g-support-unit-class cavalry-archer-class))))
		(can-research-with-escrow ri-bracer)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-bracer)
		)

		(defrule
		(or
			(goal g-primary-unit-class archery-class)
			(goal g-primary-unit-class cavalry-archer-class))
		(goal g-age-status TO-IMPERIAL)
		(up-compare-const BRACER-AVAILABLE == YES)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-bracer c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit-class archery-class)
		; 	(goal g-primary-unit-class cavalry-archer-class))
		; (goal g-age-status TO-IMPERIAL)
		; (up-compare-const BRACER-AVAILABLE == YES)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Bracer, pre-Imp")
		; )

		(defrule
		(or
			(goal g-primary-unit-class archery-class)
			(or
				(goal g-support-unit-class archery-class)
				(or
					(goal g-primary-unit-class cavalry-archer-class)
					(goal g-support-unit-class cavalry-archer-class))))
		(up-research-status c: ri-bracer == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-bracer c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit-class archery-class)
		; 	(or
		; 		(goal g-support-unit-class archery-class)
		; 		(or
		; 			(goal g-primary-unit-class cavalry-archer-class)
		; 			(goal g-support-unit-class cavalry-archer-class))))
		; (up-research-status c: ri-bracer == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Bracer, normal")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-foot-archers > 10)
			(or
				(unit-type-count archery-class > 15)
				(or
					(up-compare-goal g-desired-num-cavalry-archers > 10)
					(unit-type-count cavalry-archer-class > 15))))
		(can-research ri-bracer)
		=>
		(research ri-bracer)
		)

	;----------------
	;	Thumb Ring
	;----------------

		(defrule
		(or
			(and
				(goal g-primary-unit-class archery-class)
				(up-compare-goal g-primary-unit != skirmisher))
			(or
				(and
					(goal g-support-unit-class archery-class)
					(up-compare-goal g-support-unit != skirmisher))
				(or
					(goal g-primary-unit-class cavalry-archer-class)
					(goal g-support-unit-class cavalry-archer-class))))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research-with-escrow ri-thumb-ring)
		=>
		(release-escrow food)
		(release-escrow wood)
		(research ri-thumb-ring)
		)

		(defrule
		(or
			(and
				(goal g-primary-unit-class archery-class)
				(up-compare-goal g-primary-unit != skirmisher))
			(and
				(goal g-support-unit-class archery-class)
				(up-compare-goal g-support-unit != skirmisher)))
		(up-research-status c: ri-thumb-ring == research-available)
		(building-type-count archery-range > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-thumb-ring c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(and
		; 		(goal g-primary-unit-class archery-class)
		; 		(up-compare-goal g-primary-unit != skirmisher))
		; 	(and
		; 		(goal g-support-unit-class archery-class)
		; 		(up-compare-goal g-support-unit != skirmisher)))
		; (up-research-status c: ri-thumb-ring == research-available)
		; (building-type-count archery-range > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Thumb Ring for archers")
		; )

		(defrule
		(or
			(goal g-primary-unit-class cavalry-archer-class)
			(goal g-support-unit-class cavalry-archer-class))
		(up-research-status c: ri-thumb-ring == research-available)
		(building-type-count archery-range > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-thumb-ring c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit-class cavalry-archer-class)
		; 	(goal g-support-unit-class cavalry-archer-class))
		; (up-research-status c: ri-thumb-ring == research-available)
		; (building-type-count archery-range > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Thumb Ring for cav archers")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-foot-archers > 6)
			(or
				(unit-type-count archery-class > 10)
				(or
					(up-compare-goal g-desired-num-cavalry-archers > 6)
					(unit-type-count cavalry-archer-class > 10))))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-thumb-ring)
		=>
		(research ri-thumb-ring)
		)

    ;----------------
    ;   Bloodlines
    ;----------------
		
		(defrule
		(unit-type-count cavalry-archer-class < 4)
		(unit-type-count cavalry-cannon-class < 4)
		=>
		(up-jump-rule 6)
		)

			(defrule
			(current-age >= castle-age)
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(goal g-primary-unit-class cavalry-archer-class)
				(or
					(goal g-support-unit-class cavalry-archer-class)
					(or
						(goal g-primary-unit-class cavalry-cannon-class)
						(goal g-support-unit-class cavalry-cannon-class))))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-bloodlines)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research ri-bloodlines)
			)

			(defrule
			(current-age >= castle-age)
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(goal g-primary-unit-class cavalry-archer-class)
				(goal g-support-unit-class cavalry-archer-class))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-research-status c: ri-bloodlines == research-available)
			(building-type-count stable > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-bloodlines c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			(defrule
			(taunt-detected TAUNT-PLAYER 246)
			(current-age >= castle-age)
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(goal g-primary-unit-class cavalry-archer-class)
				(goal g-support-unit-class cavalry-archer-class))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-research-status c: ri-bloodlines == research-available)
			(building-type-count stable > 0)
			=>
			(chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Bloodlines for cavalry archers")
			)

			(defrule
			(current-age >= castle-age)
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(goal g-primary-unit-class cavalry-cannon-class)
				(goal g-support-unit-class cavalry-cannon-class))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-research-status c: ri-bloodlines == research-available)
			(building-type-count stable > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-bloodlines c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			(defrule
			(taunt-detected TAUNT-PLAYER 246)
			(current-age >= castle-age)
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(goal g-primary-unit-class cavalry-cannon-class)
				(goal g-support-unit-class cavalry-cannon-class))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-research-status c: ri-bloodlines == research-available)
			(building-type-count stable > 0)
			=>
			(chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Bloodlines for conqs/arambai")
			)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(or
				(up-compare-goal g-desired-num-cavalry-archers > 6)
				(unit-type-count cavalry-archer-class > 10))
			(can-research ri-bloodlines)
			=>
			(research ri-bloodlines)
			)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(or
				(and
					(up-compare-goal g-desired-num-unique-unit > 6)
					(up-compare-const UNIQUE-UNIT-CLASS == cavalry-cannon-class))
				(and
					(up-compare-goal g-unique-unit-line > 10)
					(up-compare-const UNIQUE-UNIT-CLASS == cavalry-cannon-class)))
			(can-research ri-bloodlines)
			=>
			(research ri-bloodlines)
			)

    ;----------------
    ;   Husbandry
    ;----------------
		
		(defrule
		(unit-type-count cavalry-archer-class < 6)
		(unit-type-count cavalry-cannon-class < 6)
		=>
		(up-jump-rule 6)
		)

			(defrule
			(current-age >= castle-age)
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(goal g-primary-unit-class cavalry-archer-class)
				(or
					(goal g-support-unit-class cavalry-archer-class)
					(or
						(goal g-primary-unit-class cavalry-cannon-class)
						(goal g-support-unit-class cavalry-cannon-class))))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-husbandry)
			=>
			(release-escrow food)
			(research ri-husbandry)
			)

			(defrule
			(current-age >= castle-age)
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(goal g-primary-unit-class cavalry-archer-class)
				(goal g-support-unit-class cavalry-archer-class))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-research-status c: ri-husbandry == research-available)
			(building-type-count stable > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-husbandry c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			)

			(defrule
			(taunt-detected TAUNT-PLAYER 246)
			(current-age >= castle-age)
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(goal g-primary-unit-class cavalry-archer-class)
				(goal g-support-unit-class cavalry-archer-class))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-research-status c: ri-husbandry == research-available)
			(building-type-count stable > 0)
			=>
			(chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for husbandry for cavalry archers")
			)

			(defrule
			(current-age >= castle-age)
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(goal g-primary-unit-class cavalry-cannon-class)
				(goal g-support-unit-class cavalry-cannon-class))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-research-status c: ri-husbandry == research-available)
			(building-type-count stable > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-husbandry c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			)

			(defrule
			(taunt-detected TAUNT-PLAYER 246)
			(current-age >= castle-age)
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(goal g-primary-unit-class cavalry-cannon-class)
				(goal g-support-unit-class cavalry-cannon-class))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(up-research-status c: ri-husbandry == research-available)
			(building-type-count stable > 0)
			=>
			(chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for husbandry for conqs/arambai")
			)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(or
				(up-compare-goal g-desired-num-cavalry-archers > 6)
				(unit-type-count cavalry-archer-class > 10))
			(can-research ri-husbandry)
			=>
			(research ri-husbandry)
			)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(or
				(and
					(up-compare-goal g-desired-num-unique-unit > 6)
					(up-compare-const UNIQUE-UNIT-CLASS == cavalry-cannon-class))
				(and
					(up-compare-goal g-unique-unit-line > 10)
					(up-compare-const UNIQUE-UNIT-CLASS == cavalry-cannon-class)))
			(can-research ri-husbandry)
			=>
			(research ri-husbandry)
			)

	;----------------------
	;	Parthian Tactics
	;----------------------

		(defrule
		(or
			(goal g-primary-unit-class cavalry-archer)
			(goal g-support-unit-class cavalry-archer))
		(can-research-with-escrow ri-parthian-tactics)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-parthian-tactics)
		)

		(defrule
		(or
			(goal g-primary-unit-class cavalry-archer)
			(goal g-support-unit-class cavalry-archer))
		(up-research-status c: ri-parthian-tactics == research-available)
		(building-type-count archery-range > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-parthian-tactics c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit-class cavalry-archer)
		; 	(goal g-support-unit-class cavalry-archer))
		; (up-research-status c: ri-parthian-tactics == research-available)
		; (building-type-count archery-range > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Parthian Tactics")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-cavalry-archers > 10)
			(unit-type-count cavalry-archer-class > 15))
		(can-research ri-parthian-tactics)
		=>
		(research ri-parthian-tactics)
		)

	;-------------------------
	;	Padded Archer Armor
	;-------------------------

		(defrule
		(current-age == feudal-age)
		(up-compare-goal g-strategy-type < FAST-CASTLE)
		(or
			(goal g-primary-unit-class archery-class)
			(goal g-support-unit-class archery-class))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-CASTLE)
			(food-amount >= 900))
		(can-research-with-escrow ri-padded-archer-armor)
		(or
			(up-research-status c: ri-fletching >= research-pending)
			(food-amount > 250))
		=>
		(release-escrow food)
		(research ri-padded-archer-armor)
		)

		(defrule
		(current-age == feudal-age)
		(up-compare-goal g-strategy-type < FAST-CASTLE)
		(or
			(goal g-primary-unit-class archery-class)
			(goal g-support-unit-class archery-class))
		(up-research-status c: ri-padded-archer-armor == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-padded-archer-armor c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (current-age == feudal-age)
		; (up-compare-goal g-strategy-type < FAST-CASTLE)
		; (or
		; 	(goal g-primary-unit-class archery-class)
		; 	(goal g-support-unit-class archery-class))
		; (up-research-status c: ri-padded-archer-armor == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Padded Archer Armor, feudal")
		; )

		(defrule
		(current-age >= castle-age)
		(up-compare-const CROSSBOWMAN-AVAILABLE == YES)
		(up-compare-goal g-desired-num-archer >= 10)
		(up-research-status c: ri-crossbow < research-pending)
		=>
		(up-jump-rule 2)
		)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(current-age >= castle-age)
			(or
				(goal g-primary-unit-class archery-class)
				(goal g-support-unit-class archery-class))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1100))
			(can-research-with-escrow ri-padded-archer-armor)
			(or
				(up-research-status c: ri-fletching >= research-pending)
				(food-amount > 250))
			=>
			(release-escrow food)
			(research ri-padded-archer-armor)
			)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(current-age >= castle-age)
			(or
				(goal g-primary-unit-class cavalry-archer-class)
				(goal g-support-unit-class cavalry-archer-class))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1100))
			(can-research-with-escrow ri-padded-archer-armor)
			(or
				(up-research-status c: ri-fletching >= research-pending)
				(food-amount > 250))
			=>
			(release-escrow food)
			(research ri-padded-archer-armor)
			)

		(defrule
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(current-age >= castle-age)
		(or
			(goal g-primary-unit-class archery-class)
			(or
				(goal g-support-unit-class archery-class)
				(or
					(goal g-primary-unit-class cavalry-archer-class)
					(goal g-support-unit-class cavalry-archer-class))))
		(up-research-status c: ri-padded-archer-armor == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-padded-archer-armor c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(up-compare-goal g-game-focus != BOOM)
		; 	(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		; (current-age >= castle-age)
		; (or
		; 	(goal g-primary-unit-class archery-class)
		; 	(or
		; 		(goal g-support-unit-class archery-class)
		; 		(or
		; 			(goal g-primary-unit-class cavalry-archer-class)
		; 			(goal g-support-unit-class cavalry-archer-class))))
		; (up-research-status c: ri-padded-archer-armor == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Padded Archer Armor, castle")
		; )

		(defrule
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(current-age >= castle-age)
		(or
			(goal g-primary-unit-class archery-cannon-class)
			(or
				(goal g-support-unit-class archery-cannon-class)
				(or
					(goal g-primary-unit-class cavalry-cannon-class)
					(goal g-support-unit-class cavalry-cannon-class))))
		(up-research-status c: ri-padded-archer-armor == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-padded-archer-armor c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(up-compare-goal g-game-focus != BOOM)
		; 	(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		; (current-age >= castle-age)
		; (or
		; 	(goal g-primary-unit-class archery-cannon-class)
		; 	(or
		; 		(goal g-support-unit-class archery-cannon-class)
		; 		(or
		; 			(goal g-primary-unit-class cavalry-cannon-class)
		; 			(goal g-support-unit-class cavalry-cannon-class))))
		; (up-research-status c: ri-padded-archer-armor == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Padded Archer Armor, cannoneer units")
		; )

		(defrule
		(current-age == feudal-age)
		(or
			(up-compare-goal g-desired-num-foot-archers > 6)
			(unit-type-count archery-class > 10))
		(or
			(up-research-status c: ri-fletching >= research-pending)
			(food-amount > 250))
		(or
			(and
				(up-compare-goal g-age-status >= TO-CASTLE)
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL))
			(or
				(food-amount >= 900)
				(up-compare-goal g-strategy-type < FAST-CASTLE)))
		(can-research ri-padded-archer-armor)
		=>
		(research ri-padded-archer-armor)
		)

		(defrule
		(current-age >= castle-age)
		(up-compare-const CROSSBOWMAN-AVAILABLE == YES)
		(up-compare-goal g-desired-num-archer >= 10)
		(up-research-status c: ri-crossbow < research-pending)
		=>
		(up-jump-rule 4)
		)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(current-age >= castle-age)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(or
				(up-compare-goal g-desired-num-foot-archers > 6)
				(unit-type-count archery-class > 10))
			(or
				(up-research-status c: ri-fletching >= research-pending)
				(food-amount > 250))
			(can-research ri-padded-archer-armor)
			=>
			(research ri-padded-archer-armor)
			)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(current-age >= castle-age)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(or
				(up-compare-goal g-desired-num-cavalry-archers > 6)
				(unit-type-count cavalry-archer-class > 10))
			(or
				(up-research-status c: ri-fletching >= research-pending)
				(food-amount > 250))
			(can-research ri-padded-archer-armor)
			=>
			(research ri-padded-archer-armor)
			)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(current-age >= castle-age)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(or
				(up-compare-goal g-desired-num-hand-cannoneer > 6)
				(or
					(unit-type-count archery-cannon-class > 10)
					(unit-type-count cavalry-cannon-class > 10)))
			(can-research ri-padded-archer-armor)
			=>
			(research ri-padded-archer-armor)
			)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(current-age >= castle-age)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(or
				(civ-selected turkish)
				(or
					(civ-selected spanish)
					(civ-selected burmese)))
			(up-compare-goal g-desired-num-unique-unit > 6)
			(can-research ri-padded-archer-armor)
			=>
			(research ri-padded-archer-armor)
			)

	;--------------------------
	;	Leather Archer Armor
	;--------------------------

		(defrule
		(or
			(goal g-primary-unit-class archery-class)
			(or
				(goal g-support-unit-class archery-class)
				(or
					(goal g-primary-unit-class cavalry-archer-class)
					(goal g-support-unit-class cavalry-archer-class))))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(or
			(up-research-status c: ri-bodkin-arrow >= research-pending)
			(food-amount > 350))
		(can-research-with-escrow ri-leather-archer-armor)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-leather-archer-armor)
		)

		(defrule
		(or
			(goal g-primary-unit-class archery-class)
			(or
				(goal g-support-unit-class archery-class)
				(or
					(goal g-primary-unit-class cavalry-archer-class)
					(goal g-support-unit-class cavalry-archer-class))))
		(up-research-status c: ri-leather-archer-armor == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-leather-archer-armor c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit-class archery-class)
		; 	(or
		; 		(goal g-support-unit-class archery-class)
		; 		(or
		; 			(goal g-primary-unit-class cavalry-archer-class)
		; 			(goal g-support-unit-class cavalry-archer-class))))
		; (up-research-status c: ri-leather-archer-armor == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Leather Archer Armor")
		; )

		(defrule
		(or
			(goal g-primary-unit-class archery-cannon-class)
			(or
				(goal g-support-unit-class archery-cannon-class)
				(or
					(goal g-primary-unit-class cavalry-cannon-class)
					(goal g-support-unit-class cavalry-cannon-class))))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research-with-escrow ri-leather-archer-armor)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-leather-archer-armor)
		)

		(defrule
		(or
			(goal g-primary-unit-class archery-cannon-class)
			(or
				(goal g-support-unit-class archery-cannon-class)
				(or
					(goal g-primary-unit-class cavalry-cannon-class)
					(goal g-support-unit-class cavalry-cannon-class))))
		(up-research-status c: ri-leather-archer-armor == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-leather-archer-armor c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit-class archery-cannon-class)
		; 	(or
		; 		(goal g-support-unit-class archery-cannon-class)
		; 		(or
		; 			(goal g-primary-unit-class cavalry-cannon-class)
		; 			(goal g-support-unit-class cavalry-cannon-class))))
		; (up-research-status c: ri-leather-archer-armor == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Leather Archer Armor for gunpower units")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-foot-archers > 6)
			(or
				(unit-type-count archery-class > 10)
				(or
					(up-compare-goal g-desired-num-cavalry-archers > 6)
					(unit-type-count cavalry-archer-class > 10))))
		(or
			(up-research-status c: ri-bodkin-arrow >= research-pending)
			(food-amount > 350))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-leather-archer-armor)
		=>
		(research ri-leather-archer-armor)
		)

		(defrule
		(or
			(civ-selected turkish)
			(civ-selected spanish))
		(or
			(up-compare-goal g-desired-num-unique-unit > 6)
			(or
				(unit-type-count archery-cannon-class > 10)
				(unit-type-count cavalry-cannon-class > 10)))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-leather-archer-armor)
		=>
		(research ri-leather-archer-armor)
		)

	;-----------------------
	;	Ring Archer Armor
	;-----------------------

		(defrule
		(current-age == imperial-age)
		(up-compare-const ARBALEST-AVAILABLE == YES)
		(up-compare-goal g-desired-num-archer >= 10)
		(up-research-status c: ri-arbalest < research-pending)
		=>
		(up-jump-rule 1)
		)

			(defrule
			(or
				(goal g-primary-unit-class archery-class)
				(or
					(goal g-support-unit-class archery-class)
					(or
						(goal g-primary-unit-class cavalry-archer-class)
						(goal g-support-unit-class cavalry-archer-class))))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-ring-archer-armor)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research ri-ring-archer-armor)
			)

		(defrule
		(or
			(goal g-primary-unit-class archery-class)
			(or
				(goal g-support-unit-class archery-class)
				(or
					(goal g-primary-unit-class cavalry-archer-class)
					(goal g-support-unit-class cavalry-archer-class))))
		(up-research-status c: ri-ring-archer-armor == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-ring-archer-armor c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit-class archery-class)
		; 	(or
		; 		(goal g-support-unit-class archery-class)
		; 		(or
		; 			(goal g-primary-unit-class cavalry-archer-class)
		; 			(goal g-support-unit-class cavalry-archer-class))))
		; (up-research-status c: ri-ring-archer-armor == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Ring Archer Armor")
		; )

		(defrule
		(or
			(goal g-primary-unit-class archery-cannon-class)
			(or
				(goal g-support-unit-class archery-cannon-class)
				(or
					(goal g-primary-unit-class cavalry-cannon-class)
					(goal g-support-unit-class cavalry-cannon-class))))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research-with-escrow ri-ring-archer-armor)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-ring-archer-armor)
		)

		(defrule
		(or
			(goal g-primary-unit-class archery-cannon-class)
			(or
				(goal g-support-unit-class archery-cannon-class)
				(or
					(goal g-primary-unit-class cavalry-cannon-class)
					(goal g-support-unit-class cavalry-cannon-class))))
		(up-research-status c: ri-ring-archer-armor == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-ring-archer-armor c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit-class archery-cannon-class)
		; 	(or
		; 		(goal g-support-unit-class archery-cannon-class)
		; 		(or
		; 			(goal g-primary-unit-class cavalry-cannon-class)
		; 			(goal g-support-unit-class cavalry-cannon-class))))
		; (up-research-status c: ri-ring-archer-armor == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Ring Archer Armor for gunpower units")
		; )

		(defrule
		(current-age == imperial-age)
		(up-compare-const ARBALEST-AVAILABLE == YES)
		(up-compare-goal g-desired-num-archer >= 10)
		(up-research-status c: ri-arbalest < research-pending)
		=>
		(up-jump-rule 2)
		)

			(defrule
			(or
				(up-compare-goal g-desired-num-foot-archers > 6)
				(or
					(unit-type-count archery-class > 10)
					(or
						(up-compare-goal g-desired-num-cavalry-archers > 6)
						(unit-type-count cavalry-archer-class > 10))))
			(can-research ri-ring-archer-armor)
			=>
			(research ri-ring-archer-armor)
			)

			(defrule
			(or
				(and
					(up-compare-goal g-desired-num-unique-unit > 6)
					(or
						(civ-selected turkish)
						(civ-selected spanish)))
				(or
					(unit-type-count archery-cannon-class > 10)
					(unit-type-count cavalry-cannon-class > 10)))
			(can-research ri-ring-archer-armor)
			=>
			(research ri-ring-archer-armor)
			)

	;----------------
	;	Ballistics
	;----------------

		(defrule
		(or
			(goal g-primary-unit-class archery-class)
			(or
				(goal g-support-unit-class archery-class)
				(or
					(goal g-primary-unit-class cavalry-archer-class)
					(goal g-support-unit-class cavalry-archer-class))))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(gold-amount >= 975))
		(can-research-with-escrow ri-ballistics)
		=>
		(release-escrow wood)
		(release-escrow gold)
		(research ri-ballistics)
		)

		(defrule
		(or
			(goal g-primary-unit-class archery-class)
			(or
				(goal g-support-unit-class archery-class)
				(or
					(goal g-primary-unit-class cavalry-archer-class)
					(goal g-support-unit-class cavalry-archer-class))))
		(up-research-status c: ri-ballistics == research-available)
		(building-type-count university > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-ballistics c: 1)
		(up-modify-goal g-max-wood-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit-class archery-class)
		; 	(or
		; 		(goal g-support-unit-class archery-class)
		; 		(or
		; 			(goal g-primary-unit-class cavalry-archer-class)
		; 			(goal g-support-unit-class cavalry-archer-class))))
		; (up-research-status c: ri-ballistics == research-available)
		; (building-type-count university > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Ballistics")
		; )

		#load-if-defined BURMESE-CIV

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(goal g-support-unit my-unique-unit))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(gold-amount >= 975))
			(can-research-with-escrow ri-ballistics)
			=>
			(release-escrow wood)
			(release-escrow gold)
			(research ri-ballistics)
			)

			(defrule
			(or
				(goal g-primary-unit my-unique-unit)
				(goal g-support-unit my-unique-unit))
			(up-research-status c: ri-ballistics == research-available)
			(building-type-count university > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-ballistics c: 1)
			(up-modify-goal g-max-wood-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit my-unique-unit)
			; 	(goal g-support-unit my-unique-unit))
			; (up-research-status c: ri-ballistics == research-available)
			; (building-type-count university > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Ballistics for arambai")
			; )

		#end-if

		(defrule
		(or
			(up-compare-goal g-desired-num-foot-archers > 6)
			(or
				(unit-type-count archery-class > 10)
				(or
					(up-compare-goal g-desired-num-cavalry-archers > 6)
					(or
						(unit-type-count cavalry-archer-class > 10)
						(and
							(civ-selected burmese)
							(or
								(up-compare-goal g-desired-num-unique-unit > 6)
								(up-compare-goal g-unique-unit-line > 10)))))))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-ballistics)
		=>
		(research ri-ballistics)
		)

;=========================<>=========================
;				    INFANTRY TECHS
;=========================<>=========================

	;-------------------
	;	Eagle Warrior
	;-------------------

		#load-if-defined UP-GAME-WK

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(goal g-primary-unit eagle-warrior)
				(goal g-support-unit eagle-warrior))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-eagle-warrior)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research ri-eagle-warrior)
			)

			(defrule
			(goal g-primary-unit eagle-warrior)
			(goal g-age-status TO-CASTLE)
			(building-type-count barracks > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-eagle-warrior c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (goal g-primary-unit eagle-warrior)
			; (goal g-age-status TO-CASTLE)
			; (building-type-count barracks > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Eagle Warrior upgrade, pre-Castle")
			; )

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(goal g-primary-unit eagle-warrior)
				(goal g-support-unit eagle-warrior))
			(up-research-status c: ri-eagle-warrior == research-available)
			(building-type-count barracks > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-eagle-warrior c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(up-compare-goal g-game-focus != BOOM)
			; 	(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			; (or
			; 	(goal g-primary-unit eagle-warrior)
			; 	(goal g-support-unit eagle-warrior))
			; (up-research-status c: ri-eagle-warrior == research-available)
			; (building-type-count barracks > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Eagle Warrior upgrade")
			; )

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(or
				(up-compare-goal g-desired-num-eagle-warrior > 6)
				(up-compare-goal g-eagle-scout-line > 10))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-eagle-warrior)
			=>
			(research ri-eagle-warrior)
			)

		#end-if

	;-------------------------
	;	Elite Eagle Warrior
	;-------------------------

		(defrule
		(or
			(goal g-primary-unit eagle-warrior)
			(goal g-support-unit eagle-warrior))
		(can-research-with-escrow ri-elite-eagle-warrior)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-elite-eagle-warrior)
		)

		(defrule
		(goal g-primary-unit eagle-warrior)
		(goal g-age-status TO-IMPERIAL)
		(building-type-count barracks > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-elite-eagle-warrior c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-primary-unit eagle-warrior)
		; (goal g-age-status TO-IMPERIAL)
		; (building-type-count barracks > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Elite Eagle Warrior, pre-Imp")
		; )

		(defrule
		(or
			(goal g-primary-unit eagle-warrior)
			(goal g-support-unit eagle-warrior))
		(up-research-status c: ri-elite-eagle-warrior == research-available)
		(building-type-count barracks > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-elite-eagle-warrior c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit eagle-warrior)
		; 	(goal g-support-unit eagle-warrior))
		; (up-research-status c: ri-elite-eagle-warrior == research-available)
		; (building-type-count barracks > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Elite Eagle Warrior, normal")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-eagle-warrior > 10)
			(up-compare-goal g-eagle-scout-line > 15))
		(can-research ri-elite-eagle-warrior)
		=>
		(research ri-elite-eagle-warrior)
		)

	;-------------
	;	Pikeman
	;-------------

		(defrule
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(up-compare-goal g-desired-num-spearman > 0)
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research-with-escrow ri-pikeman)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-pikeman)
		)

		(defrule
		(goal g-primary-unit spearman)
		(goal g-age-status TO-CASTLE)
		(up-compare-const PIKEMAN-AVAILABLE == YES)
		(building-type-count barracks > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-pikeman c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-primary-unit spearman)
		; (goal g-age-status TO-CASTLE)
		; (up-compare-const PIKEMAN-AVAILABLE == YES)
		; (building-type-count barracks > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Pikeman, pre-Castle")
		; )

		(defrule
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(up-compare-goal g-desired-num-spearman > 0)
		(up-research-status c: ri-pikeman == research-available)
		(building-type-count barracks > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-pikeman c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(up-compare-goal g-game-focus != BOOM)
		; 	(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		; (up-compare-goal g-desired-num-spearman > 0)
		; (up-research-status c: ri-pikeman == research-available)
		; (building-type-count barracks > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Pikeman")
		; )

		(defrule
		(unit-type-count spearman-line >= 6)
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-pikeman)
		=>
		(research ri-pikeman)
		)

	;----------------
	;	Halberdier
	;----------------

		(defrule
		(or
			(goal g-primary-unit spearman)
			(goal g-support-unit spearman))
		(can-research-with-escrow ri-halberdier)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-halberdier)
		)

		(defrule
		(goal g-primary-unit spearman)
		(goal g-age-status TO-IMPERIAL)
		(up-compare-const HALBERDIER-AVAILABLE == YES)
		(building-type-count barracks > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-halberdier c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-primary-unit spearman)
		; (goal g-age-status TO-IMPERIAL)
		; (up-compare-const HALBERDIER-AVAILABLE == YES)
		; (building-type-count barracks > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Halberdier, primary")
		; )

		(defrule
		(or
			(goal g-primary-unit spearman)
			(goal g-support-unit spearman))
		(up-research-status c: ri-halberdier == research-available)
		(building-type-count barracks > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-halberdier c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit spearman)
		; 	(goal g-support-unit spearman))
		; (up-research-status c: ri-halberdier == research-available)
		; (building-type-count barracks > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Halberdier, support")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-spearman > 10)
			(unit-type-count spearman-line >= 15))
		(can-research ri-halberdier)
		=>
		(research ri-halberdier)
		)

	;-----------------
	;	Man-at-Arms
	;-----------------

        (defrule
		(or
			(goal g-primary-unit militiaman)
			(goal g-support-unit militiaman))
		(up-compare-goal g-age-status != SAVE-FOR-CASTLE)
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
        (can-research-with-escrow ri-man-at-arms)
        =>
		(release-escrow food)
		(release-escrow gold)
        (research ri-man-at-arms)
        )

		(defrule
		(goal g-primary-unit militiaman)
		(goal g-age-status TO-FEUDAL)
		(building-type-count barracks > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-man-at-arms c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-primary-unit militiaman)
		; (goal g-age-status TO-FEUDAL)
		; (building-type-count barracks > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Man-at-Arms, pre-Feudal")
		; )

		(defrule
		(or
			(goal g-primary-unit militiaman)
			(goal g-support-unit militiaman))
		(up-compare-goal g-age-status != SAVE-FOR-CASTLE)
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(up-research-status c: ri-man-at-arms == research-available)
		(building-type-count barracks > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-man-at-arms c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit militiaman)
		; 	(goal g-support-unit militiaman))
		; (up-compare-goal g-age-status != SAVE-FOR-CASTLE)
		; (up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		; (up-research-status c: ri-man-at-arms == research-available)
		; (building-type-count barracks > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Man-at-Arms, normal")
		; )

        (defrule
		(or
			(up-compare-goal g-desired-num-militia > 5)
			(unit-type-count militiaman-line >= 8))
		(up-compare-goal g-age-status != SAVE-FOR-CASTLE)
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
        (can-research ri-man-at-arms)
        =>
        (research ri-man-at-arms)
        )

	;--------------------
	;	Long Swordsman
	;--------------------

		(defrule
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(or
			(goal g-primary-unit militiaman)
			(goal g-support-unit militiaman))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research-with-escrow ri-long-swordsman)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-long-swordsman)
		)

		(defrule
		(goal g-primary-unit militiaman)
		(goal g-age-status TO-CASTLE)
		(building-type-count barracks > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-long-swordsman c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-primary-unit militiaman)
		; (goal g-age-status TO-CASTLE)
		; (building-type-count barracks > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Long Swordsman, pre-Castle")
		; )

		(defrule
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(or
			(goal g-primary-unit militiaman)
			(goal g-support-unit militiaman))
		(up-research-status c: ri-long-swordsman == research-available)
		(building-type-count barracks > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-long-swordsman c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(up-compare-goal g-game-focus != BOOM)
		; 	(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		; (or
		; 	(goal g-primary-unit militiaman)
		; 	(goal g-support-unit militiaman))
		; (up-research-status c: ri-long-swordsman == research-available)
		; (building-type-count barracks > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Long Swordsman, normal")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-militia > 6)
			(unit-type-count militiaman-line >= 10))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-long-swordsman)
		=>
		(research ri-long-swordsman)
		)

	;--------------------------
	;	Two-Handed Swordsman
	;--------------------------

		(defrule
		(or
			(goal g-primary-unit militiaman)
			(goal g-support-unit militiaman))
		(can-research-with-escrow ri-two-handed-swordsman)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-two-handed-swordsman)
		)

		(defrule
		(goal g-primary-unit militiaman)
		(goal g-age-status TO-IMPERIAL)
		(up-compare-const TWO-HANDED-SWORDSMAN-AVAILABLE == YES)
		(building-type-count barracks > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-two-handed-swordsman c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-primary-unit militiaman)
		; (goal g-age-status TO-IMPERIAL)
		; (up-compare-const TWO-HANDED-SWORDSMAN-AVAILABLE == YES)
		; (building-type-count barracks > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Two-handed Swordsman, pre-Imp")
		; )

		(defrule
		(or
			(goal g-primary-unit militiaman)
			(goal g-support-unit militiaman))
		(up-research-status c: ri-two-handed-swordsman == research-available)
		(building-type-count barracks > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-two-handed-swordsman c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit militiaman)
		; 	(goal g-support-unit militiaman))
		; (up-research-status c: ri-two-handed-swordsman == research-available)
		; (building-type-count barracks > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Two-handed Swordsman, normal")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-militia > 10)
			(unit-type-count militiaman-line > 15))
		(can-research ri-two-handed-swordsman)
		=>
		(research ri-two-handed-swordsman)
		)

	;--------------
	;	Champion
	;--------------

		(defrule
		(or
			(goal g-primary-unit militiaman)
			(goal g-support-unit militiaman))
		(can-research-with-escrow ri-champion)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-champion)
		)

		(defrule
		(or
			(goal g-primary-unit militiaman)
			(goal g-support-unit militiaman))
		(up-research-status c: ri-champion == research-available)
		(building-type-count barracks > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-champion c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit militiaman)
		; 	(goal g-support-unit militiaman))
		; (up-research-status c: ri-champion == research-available)
		; (building-type-count barracks > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Champion")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-militia > 10)
			(unit-type-count militiaman-line > 15))
		(can-research ri-champion)
		=>
		(research ri-champion)
		)

	;----------------
	;	Scale Mail
	;----------------

		(defrule
		(current-age == feudal-age)
		(or
			(goal g-primary-unit-class infantry-class)
			(goal g-support-unit-class infantry-class))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-CASTLE)
			(food-amount >= 900))
		(can-research-with-escrow ri-scale-mail)
		=>
		(release-escrow food)
		(research ri-scale-mail)
		)

		(defrule
		(current-age >= castle-age)
		(up-compare-goal g-desired-num-militia >= 10)
		(up-research-status c: ri-long-swordsman < research-pending)
		=>
		(up-jump-rule 2)
		)

		(defrule
		(current-age >= castle-age)
		(up-compare-const PIKEMAN-AVAILABLE == YES)
		(up-compare-goal g-desired-num-spearman >= 10)
		(up-research-status c: ri-pikeman < research-pending)
		=>
		(up-jump-rule 1)
		)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(current-age >= castle-age)
			(or
				(goal g-primary-unit-class infantry-class)
				(goal g-support-unit-class infantry-class))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1100))
			(can-research-with-escrow ri-scale-mail)
			=>
			(release-escrow food)
			(research ri-scale-mail)
			)

		(defrule
		(current-age == feudal-age)
		(or
			(goal g-primary-unit-class infantry-class)
			(goal g-support-unit-class infantry-class))
		(up-research-status c: ri-scale-mail == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-scale-mail c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (current-age == feudal-age)
		; (or
		; 	(goal g-primary-unit-class infantry-class)
		; 	(goal g-support-unit-class infantry-class))
		; (up-research-status c: ri-scale-mail == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Scale Mail for infantry, feudal")
		; )

		(defrule
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(current-age >= castle-age)
		(or
			(goal g-primary-unit-class infantry-class)
			(goal g-support-unit-class infantry-class))
		(up-research-status c: ri-scale-mail == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-scale-mail c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(up-compare-goal g-game-focus != BOOM)
		; 	(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		; (current-age >= castle-age)
		; (or
		; 	(goal g-primary-unit-class infantry-class)
		; 	(goal g-support-unit-class infantry-class))
		; (up-research-status c: ri-scale-mail == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Scale Mail for infantry, castle")
		; )

		(defrule
		(current-age >= castle-age)
		(up-compare-goal g-desired-num-militia >= 10)
		(up-research-status c: ri-long-swordsman < research-pending)
		=>
		(up-jump-rule 2)
		)

		(defrule
		(current-age >= castle-age)
		(up-compare-const PIKEMAN-AVAILABLE == YES)
		(up-compare-goal g-desired-num-spearman >= 10)
		(up-research-status c: ri-pikeman < research-pending)
		=>
		(up-jump-rule 1)
		)

			(defrule
			(or
				(up-compare-goal g-desired-num-infantry > 5)
				(unit-type-count infantry-class > 8))
			(or
				(and
					(up-compare-goal g-age-status >= TO-CASTLE)
					(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL))
				(or
					(food-amount >= 900)
					(up-compare-goal g-strategy-type < FAST-CASTLE)))
			(can-research ri-scale-mail)
			=>
			(research ri-scale-mail)
			)

	;----------------
	;	Chain Mail
	;----------------

		(defrule
		(current-age >= castle-age)
		(up-compare-const PIKEMAN-AVAILABLE == YES)
		(up-compare-goal g-desired-num-spearman >= 10)
		(up-research-status c: ri-pikeman < research-pending)
		=>
		(up-jump-rule 2)
		)

			(defrule
			(goal g-primary-unit-class infantry-class)
			(or
				(military-population > 12)
				(or
					(up-compare-goal g-target-military-parity > 0)
					(up-compare-goal g-age-status >= MID-CASTLE)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-chain-mail)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research ri-chain-mail)
			)

			(defrule
			(goal g-support-unit-class infantry-class)
			(up-compare-goal g-age-status >= MID-CASTLE)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-chain-mail)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research ri-chain-mail)
			)

		(defrule
		(goal g-primary-unit-class infantry-class)
		(or
			(military-population > 12)
			(or
				(up-compare-goal g-target-military-parity > 0)
				(up-compare-goal g-age-status >= MID-CASTLE)))
		(up-research-status c: ri-chain-mail == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-chain-mail c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-primary-unit-class infantry-class)
		; (or
		; 	(military-population > 12)
		; 	(or
		; 		(up-compare-goal g-target-military-parity > 0)
		; 		(up-compare-goal g-age-status >= MID-CASTLE)))
		; (up-research-status c: ri-chain-mail == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Chain Mail for infantry, primary")
		; )

		(defrule
		(goal g-support-unit-class infantry-class)
		(up-compare-goal g-age-status >= MID-CASTLE)
		(up-research-status c: ri-chain-mail == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-chain-mail c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-support-unit-class infantry-class)
		; (up-compare-goal g-age-status >= MID-CASTLE)
		; (up-research-status c: ri-chain-mail == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Chain Mail for infantry, support")
		; )

		(defrule
		(current-age >= castle-age)
		(up-compare-const PIKEMAN-AVAILABLE == YES)
		(up-compare-goal g-desired-num-spearman >= 10)
		(up-research-status c: ri-pikeman < research-pending)
		=>
		(up-jump-rule 1)
		)

			(defrule
			(or
				(up-compare-goal g-desired-num-infantry > 6)
				(unit-type-count infantry-class > 10))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-chain-mail)
			=>
			(research ri-chain-mail)
			)

	;----------------
	;	Plate Mail
	;----------------

		(defrule
		(or
			(goal g-primary-unit-class infantry-class)
			(goal g-support-unit-class infantry-class))
		(can-research-with-escrow ri-plate-mail)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-plate-mail)
		)

		(defrule
		(goal g-primary-unit-class infantry-class)
		(goal g-age-status TO-IMPERIAL)
		(up-compare-const PLATE-MAIL-ARMOR-AVAILABLE == YES)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-plate-mail c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-primary-unit-class infantry-class)
		; (goal g-age-status TO-IMPERIAL)
		; (up-compare-const PLATE-MAIL-ARMOR-AVAILABLE == YES)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Plate Mail for infantry, pre-Imp")
		; )

		(defrule
		(or
			(goal g-primary-unit-class infantry-class)
			(goal g-support-unit-class infantry-class))
		(up-research-status c: ri-plate-mail == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-plate-mail c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit-class infantry-class)
		; 	(goal g-support-unit-class infantry-class))
		; (up-research-status c: ri-plate-mail == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Plate Mail for infantry, normal")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-infantry > 10)
			(unit-type-count infantry-class > 15))
		(can-research ri-plate-mail)
		=>
		(research ri-plate-mail)
		)
		
	;-------------
	;	Forging
	;-------------

		(defrule
		(current-age >= castle-age)
		(up-compare-goal g-desired-num-militia >= 10)
		(up-research-status c: ri-long-swordsman < research-pending)
		=>
		(up-jump-rule 3)
		)

		(defrule
		(current-age >= castle-age)
		(up-compare-const PIKEMAN-AVAILABLE == YES)
		(up-compare-goal g-desired-num-spearman >= 10)
		(up-research-status c: ri-pikeman < research-pending)
		=>
		(up-jump-rule 2)
		)

		(defrule
		(current-age >= castle-age)
		(up-compare-const EAGLE-SCOUT-AVAILABLE == YES)
		(up-compare-goal g-desired-num-eagle-warrior >= 10)
		(up-research-status c: ri-eagle-warrior < research-pending)
		=>
		(up-jump-rule 1)
		)

			(defrule
			(or
				(up-compare-goal g-game-focus != BOOM)
				(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
			(current-age >= castle-age)
			(or
				(goal g-primary-unit-class infantry-class)
				(goal g-support-unit-class infantry-class))
			(or
				(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
				(food-amount >= 1150))
			(can-research-with-escrow ri-forging)
			(or
				(up-research-status c: ri-scale-mail >= research-pending)
				(food-amount > 300))
			=>
			(release-escrow food)
			(research ri-forging)
			)

		(defrule
		(or
			(up-compare-goal g-game-focus != BOOM)
			(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		(current-age >= castle-age)
		(or
			(goal g-primary-unit-class infantry-class)
			(goal g-support-unit-class infantry-class))
		(up-research-status c: ri-forging == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-forging c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(up-compare-goal g-game-focus != BOOM)
		; 	(up-compare-goal g-eco-tech-progress >= PRIORITY-CASTLE-COMPLETE))
		; (current-age >= castle-age)
		; (or
		; 	(goal g-primary-unit-class infantry-class)
		; 	(goal g-support-unit-class infantry-class))
		; (up-research-status c: ri-forging == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Forging for infantry")
		; )

		(defrule
		(current-age >= castle-age)
		(up-compare-goal g-desired-num-militia >= 10)
		(up-research-status c: ri-long-swordsman < research-pending)
		=>
		(up-jump-rule 3)
		)

		(defrule
		(current-age >= castle-age)
		(up-compare-const PIKEMAN-AVAILABLE == YES)
		(up-compare-goal g-desired-num-spearman >= 10)
		(up-research-status c: ri-pikeman < research-pending)
		=>
		(up-jump-rule 2)
		)

		(defrule
		(current-age >= castle-age)
		(up-compare-const EAGLE-SCOUT-AVAILABLE == YES)
		(up-compare-goal g-desired-num-eagle-warrior >= 10)
		(up-research-status c: ri-eagle-warrior < research-pending)
		=>
		(up-jump-rule 1)
		)

			(defrule
			(up-research-status c: ri-scale-mail >= research-pending)
			(or
				(up-compare-goal g-desired-num-infantry > 6)
				(unit-type-count infantry-class > 10))
			(or
				(up-research-status c: ri-scale-mail >= research-pending)
				(food-amount > 300))
			(or
				(up-compare-goal g-age-status >= TO-CASTLE)
				(or
					(food-amount >= 950)
					(up-compare-goal g-strategy-type < FAST-CASTLE)))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-forging)
			=>
			(research ri-forging)
			)

	;------------------
	;	Iron Casting
	;------------------

		(defrule
		(or
			(goal g-primary-unit-class infantry-class)
			(goal g-support-unit militiaman))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(or
			(up-research-status c: ri-chain-mail >= research-pending)
			(food-amount > 350))
		(can-research-with-escrow ri-iron-casting)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-iron-casting)
		)

		(defrule
		(or
			(goal g-primary-unit-class infantry-class)
			(goal g-support-unit militiaman))
		(up-research-status c: ri-iron-casting == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-iron-casting c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit-class infantry-class)
		; 	(goal g-support-unit militiaman))
		; (up-research-status c: ri-iron-casting == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Iron Casting for swords")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-infantry > 6)
			(unit-type-count infantry-class > 10))
		(or
			(up-research-status c: ri-chain-mail >= research-pending)
			(food-amount > 350))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-iron-casting)
		=>
		(research ri-iron-casting)
		)
		
	;-------------------
	;	Blast Furnace
	;-------------------

		(defrule
		(or
			(goal g-primary-unit-class infantry-class)
			(goal g-support-unit-class infantry-class))
		(can-research-with-escrow ri-blast-furnace)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-blast-furnace)
		)

		(defrule
		(goal g-primary-unit militiaman)
		(goal g-age-status TO-IMPERIAL)
		(up-compare-const BLAST-FURNACE-AVAILABLE == YES)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-blast-furnace c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-primary-unit militiaman)
		; (goal g-age-status TO-IMPERIAL)
		; (up-compare-const BLAST-FURNACE-AVAILABLE == YES)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Blast Furnace for infantry, pre-Imp")
		; )

		(defrule
		(or
			(goal g-primary-unit-class infantry-class)
			(goal g-support-unit-class infantry-class))
		(up-research-status c: ri-blast-furnace == research-available)
		(building-type-count blacksmith > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-blast-furnace c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit-class infantry-class)
		; 	(goal g-support-unit-class infantry-class))
		; (up-research-status c: ri-blast-furnace == research-available)
		; (building-type-count blacksmith > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Blast Furnace for infantry, normal")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-infantry > 10)
			(unit-type-count infantry-class > 15))
		(can-research ri-blast-furnace)
		=>
		(research ri-blast-furnace)
		)

	;--------------
	;	Supplies
	;--------------

		#load-if-defined DE-AVAILABLE

			(defrule
			(or
				(goal g-primary-unit militiaman)
				(goal g-support-unit militiaman))
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research-with-escrow ri-supplies)
			=>
			(release-escrow food)
			(release-escrow gold)
			(research ri-supplies)
			)

			(defrule
			(or
				(goal g-primary-unit militiaman)
				(goal g-support-unit militiaman))
			(up-research-status c: ri-supplies == research-available)
			(building-type-count barracks > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-supplies c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (or
			; 	(goal g-primary-unit militiaman)
			; 	(goal g-support-unit militiaman))
			; (up-research-status c: ri-supplies == research-available)
			; (building-type-count barracks > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Supplies")
			; )

			(defrule
			(up-compare-goal g-desired-num-militia > 6)
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(can-research ri-supplies)
			=>
			(research ri-supplies)
			)

		#end-if

	;-----------
	;	Arson
	;-----------

		(defrule
		(up-research-status c: ri-iron-casting >= research-pending)
		(up-research-status c: ri-chain-mail >= research-pending)
		(unit-type-count infantry-class > 6)
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-arson)
		=>
		(research ri-arson)
		)

	;-------------
	;	Squires
	;-------------

		(defrule
		(or
			(goal g-primary-unit-class infantry-class)
			(goal g-support-unit-class infantry-class))
		(or
			(up-research-status c: ri-chain-mail >= research-pending)
			(up-compare-const CHAIN-MAIL-ARMOR-AVAILABLE == NO))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1100))
		(can-research-with-escrow ri-squires)
		=>
		(release-escrow food)
		(research ri-squires)
		)

		(defrule
		(or
			(goal g-primary-unit-class infantry-class)
			(goal g-support-unit-class infantry-class))
		(or
			(up-research-status c: ri-chain-mail >= research-pending)
			(up-compare-const CHAIN-MAIL-ARMOR-AVAILABLE == NO))
		(up-research-status c: ri-squires == research-available)
		(building-type-count barracks > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-squires c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit-class infantry-class)
		; 	(goal g-support-unit-class infantry-class))
		; (or
		; 	(up-research-status c: ri-chain-mail >= research-pending)
		; 	(up-compare-const CHAIN-MAIL-ARMOR-AVAILABLE == NO))
		; (up-research-status c: ri-squires == research-available)
		; (building-type-count barracks > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Squires")
		; )

		(defrule
		(or
			(up-research-status c: ri-chain-mail >= research-pending)
			(up-compare-const CHAIN-MAIL-ARMOR-AVAILABLE == NO))
		(or
			(up-compare-goal g-desired-num-infantry > 6)
			(unit-type-count infantry-class > 10))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1100))
		(can-research ri-squires)
		=>
		(research ri-squires)
		)

	;--------------
	;	Tracking
	;--------------

		; #load-if-not-defined DE-AVAILABLE

		; 	(defrule
		; 	(current-age == castle-age)
		; 	(goal g-first-attack-launched YES)
		; 	(can-research ri-tracking)
		; 	(unit-type-count infantry-class >= 10)
		; 	(or
		; 		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		; 		(food-amount >= 1050))
		; 	=>
		; 	(research ri-tracking)
		; 	)

		; 	(defrule
		; 	(current-age == imperial-age)
		; 	(goal g-first-attack-launched YES)
		; 	(can-research ri-tracking)
		; 	(unit-type-count infantry-class >= 10)
		; 	=>
		; 	(research ri-tracking)
		; 	)

		; #end-if

;=========================<>=========================
;				     SIEGE TECHS
;=========================<>=========================

	;------------
	;	Onager
	;------------

		(defrule
		(up-compare-goal g-desired-num-mangonel > 2)
		(can-research-with-escrow ri-onager)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-onager)
		)

		(defrule
		(up-compare-goal g-desired-num-mangonel > 2)
		(up-research-status c: ri-onager == research-available)
		(building-type-count siege-workshop > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-onager c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-compare-goal g-desired-num-mangonel > 2)
		; (up-research-status c: ri-onager == research-available)
		; (building-type-count siege-workshop > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Onager")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-mangonel > 1)
			(up-compare-goal g-mangonel-line > 2))
		(can-research ri-onager)
		=>
		(research ri-onager)
		)

	;------------------
	;	Siege Onager
	;------------------

		(defrule
		(up-compare-goal g-desired-num-mangonel > 2)
		(can-research-with-escrow ri-siege-onager)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-siege-onager)
		)

		(defrule
		(up-compare-goal g-desired-num-mangonel > 2)
		(up-research-status c: ri-siege-onager == research-available)
		(building-type-count siege-workshop > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-siege-onager c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-compare-goal g-desired-num-mangonel > 2)
		; (up-research-status c: ri-siege-onager == research-available)
		; (building-type-count siege-workshop > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Siege Onager")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-mangonel > 1)
			(up-compare-goal g-mangonel-line > 3))
		(can-research ri-siege-onager)
		=>
		(research ri-siege-onager)
		)

	;--------------------
	;	Heavy Scorpion
	;--------------------

		(defrule
		(up-compare-goal g-desired-num-scorpion > 3)
		(can-research-with-escrow ri-heavy-scorpion)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-heavy-scorpion)
		)

		(defrule
		(up-compare-goal g-desired-num-scorpion > 3)
		(up-research-status c: ri-heavy-scorpion == research-available)
		(building-type-count siege-workshop > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-heavy-scorpion c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-compare-goal g-desired-num-scorpion > 3)
		; (up-research-status c: ri-heavy-scorpion == research-available)
		; (building-type-count siege-workshop > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Heavy Scorpion")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-scorpion > 1)
			(unit-type-count scorpion-line > 3))
		(can-research ri-heavy-scorpion)
		=>
		(research ri-heavy-scorpion)
		)

	;----------------
	;	Capped Ram
	;----------------

		(defrule
		(up-compare-goal g-desired-num-battering-ram > 1)
		(can-research-with-escrow ri-capped-ram)
		=>
		(release-escrow food)
		(research ri-capped-ram)
		)

		(defrule
		(up-compare-goal g-desired-num-battering-ram > 1)
		(up-research-status c: ri-capped-ram == research-available)
		(building-type-count siege-workshop > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-capped-ram c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-compare-goal g-desired-num-battering-ram > 1)
		; (up-research-status c: ri-capped-ram == research-available)
		; (building-type-count siege-workshop > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Capped Ram")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-battering-ram > 0)
			(unit-type-count battering-ram-line > 2))
		(can-research ri-capped-ram)
		=>
		(research ri-capped-ram)
		)

	;---------------
	;	Siege Ram
	;---------------

		(defrule
		(up-compare-goal g-desired-num-battering-ram > 2)
		(can-research-with-escrow ri-siege-ram)
		=>
		(release-escrow food)
		(research ri-siege-ram)
		)

		(defrule
		(up-compare-goal g-desired-num-battering-ram > 2)
		(up-research-status c: ri-siege-ram == research-available)
		(building-type-count siege-workshop > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-siege-ram c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-compare-goal g-desired-num-battering-ram > 2)
		; (up-research-status c: ri-siege-ram == research-available)
		; (building-type-count siege-workshop > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Siege Ram")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-battering-ram > 1)
			(unit-type-count battering-ram-line > 3))
		(can-research ri-siege-ram)
		=>
		(research ri-siege-ram)
		)

	;---------------------
	;	Siege Engineers
	;---------------------

		(defrule
		(up-compare-goal g-desired-num-siege > 0)
		(can-research-with-escrow ri-siege-engineers)
		=>
		(release-escrow food)
		(release-escrow wood)
		(research ri-siege-engineers)
		)

		(defrule
		(up-compare-goal g-desired-num-siege > 0)
		(up-research-status c: ri-siege-engineers == research-available)
		(building-type-count university > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-siege-engineers c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-compare-goal g-desired-num-siege > 0)
		; (up-research-status c: ri-siege-engineers == research-available)
		; (building-type-count university > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Siege Engineers")
		; )

;=========================<>=========================
;				      MONK TECHS
;=========================<>=========================

	;------------
	;	Heresy
	;------------

		(defrule
		(up-compare-goal g-enemy-monks-count >= 12)
		(can-research-with-escrow ri-heresy)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(gold-amount >= 2000))
		=>
		(release-escrow gold)
		(research ri-heresy)
		)

		(defrule
		(up-compare-goal g-enemy-monks-count >= 12)
		(building-type-count-total monastery == 0)
		=>
		(up-modify-goal g-desired-num-monastery c:max 1)
		)

		(defrule
		(up-compare-goal g-enemy-monks-count >= 12)
		(up-research-status c: ri-heresy == research-available)
		(building-type-count monastery > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-heresy c: 1)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-compare-goal g-enemy-monks-count >= 12)
		; (up-research-status c: ri-heresy == research-available)
		; (building-type-count monastery > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Heresy")
		; )

		(defrule
		(up-compare-goal g-enemy-monks-count >= 5)
		(can-research ri-heresy)
		=>
		(research ri-heresy)
		)

		;Battle Elephants
		(defrule
		(goal g-primary-unit battle-elephant)
		(can-research-with-escrow ri-heresy)
		=>
		(release-escrow gold)
		(research ri-heresy)
		)

		(defrule
		(goal g-primary-unit battle-elephant)
		(building-type-count-total monastery == 0)
		=>
		(up-modify-goal g-desired-num-monastery c:max 1)
		)

		(defrule
		(goal g-primary-unit battle-elephant)
		(goal g-primary-enemy-threat g-enemy-monks-count)
		(up-research-status c: ri-heresy == research-available)
		(building-type-count monastery > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-heresy c: 1)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-primary-unit battle-elephant)
		; (goal g-primary-enemy-threat g-enemy-monks-count)
		; (up-research-status c: ri-heresy == research-available)
		; (building-type-count monastery > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Heresy against battle elephants")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-battle-elephant > 6)
			(up-compare-goal g-battle-elephant-line > 10))
		(can-research ri-heresy)
		=>
		(research ri-heresy)
		)

	;-----------
	;	Faith
	;-----------

		(defrule
		(up-compare-goal g-enemy-monks-count >= 12)
		(up-compare-const HERESY-AVAILABLE == NO)
		(can-research-with-escrow ri-faith)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-faith)
		)

		(defrule
		(up-compare-goal g-enemy-monks-count >= 12)
		(up-compare-const HERESY-AVAILABLE == NO)
		(building-type-count-total monastery == 0)
		=>
		(up-modify-goal g-desired-num-monastery c:max 1)
		)

		(defrule
		(up-compare-goal g-enemy-monks-count >= 12)
		(up-compare-const HERESY-AVAILABLE == NO)
		(up-research-status c: ri-faith == research-available)
		(building-type-count monastery > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-faith c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-compare-goal g-enemy-monks-count >= 12)
		; (up-compare-const HERESY-AVAILABLE == NO)
		; (up-research-status c: ri-faith == research-available)
		; (building-type-count monastery > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Faith")
		; )

		(defrule
		(up-compare-goal g-enemy-monks-count >= 5)
		(up-compare-const HERESY-AVAILABLE == NO)
		(can-research ri-faith)
		=>
		(research ri-faith)
		)

		;Battle Elephants
		(defrule
		(goal g-primary-unit battle-elephant)
		(can-research-with-escrow ri-faith)
		=>
		(release-escrow gold)
		(research ri-faith)
		)

		(defrule
		(goal g-primary-unit battle-elephant)
		(building-type-count-total monastery == 0)
		=>
		(up-modify-goal g-desired-num-monastery c:max 1)
		)

		(defrule
		(goal g-primary-unit battle-elephant)
		(goal g-primary-enemy-threat g-enemy-monks-count)
		(building-type-count monastery > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-faith c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-primary-unit battle-elephant)
		; (goal g-primary-enemy-threat g-enemy-monks-count)
		; (building-type-count monastery > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Faith against battle eles")
		; )

		(defrule
		(or
			(up-compare-goal g-desired-num-battle-elephant > 6)
			(up-compare-goal g-battle-elephant-line > 10))
		(can-research ri-faith)
		=>
		(research ri-faith)
		)

		;War Elephants
		#load-if-defined PERSIAN-CIV

			(defrule
			(goal g-primary-unit my-unique-unit)
			(can-research-with-escrow ri-faith)
			=>
			(release-escrow gold)
			(research ri-faith)
			)

			(defrule
			(goal g-primary-unit my-unique-unit)
			(building-type-count-total monastery == 0)
			=>
			(up-modify-goal g-desired-num-monastery c:max 1)
			)

			(defrule
			(goal g-primary-unit my-unique-unit)
			(goal g-primary-enemy-threat g-enemy-monks-count)
			(up-research-status c: ri-faith == research-available)
			(building-type-count monastery > 0)
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-research-cost c: ri-faith c: 1)
			(up-modify-goal g-max-food-needed g:max g-food-cost)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (goal g-primary-unit my-unique-unit)
			; (goal g-primary-enemy-threat g-enemy-monks-count)
			; (up-research-status c: ri-faith == research-available)
			; (building-type-count monastery > 0)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Faith against war elephants")
			; )

			(defrule
			(or
				(up-compare-goal g-desired-num-unique-unit > 6)
				(up-compare-goal g-unique-unit-line > 10))
			(can-research ri-faith)
			=>
			(research ri-faith)
			)

		#end-if

	;----------------
	;	Redemption
	;----------------

		(defrule
		(or
			(goal g-primary-unit monk)
			(goal g-support-unit monk))
		(or
			(up-compare-goal g-enemy-field-siege-count > 0)
			(or
				(up-research-status c: ri-sanctity >= research-pending)
				(up-compare-const SANCTITY-AVAILABLE == NO)))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(gold-amount >= 1275))
		(can-research-with-escrow ri-redemption)
		=>
		(release-escrow gold)
		(research ri-redemption)
		)

		(defrule
		(or
			(goal g-primary-unit monk)
			(goal g-support-unit monk))
		(up-compare-goal g-enemy-field-siege-count > 0)
		(up-research-status c: ri-redemption == research-available)
		(building-type-count monastery > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-redemption c: 1)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit monk)
		; 	(goal g-support-unit monk))
		; (up-compare-goal g-enemy-field-siege-count > 0)
		; (up-research-status c: ri-redemption == research-available)
		; (building-type-count monastery > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Redemption to counter siege")
		; )

		(defrule
		(or
			(goal g-primary-unit monk)
			(goal g-support-unit monk))
		(or
			(up-research-status c: ri-sanctity >= research-pending)
			(up-compare-const SANCTITY-AVAILABLE == NO))
		(up-research-status c: ri-redemption == research-available)
		(building-type-count monastery > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-redemption c: 1)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit monk)
		; 	(goal g-support-unit monk))
		; (or
		; 	(up-research-status c: ri-sanctity >= research-pending)
		; 	(up-compare-const SANCTITY-AVAILABLE == NO))
		; (up-research-status c: ri-redemption == research-available)
		; (building-type-count monastery > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Redeption after Sanctity")
		; )

		(defrule
		(up-compare-goal g-desired-num-monk >= 3)
		(or
			(up-compare-goal g-enemy-field-siege-count > 0)
			(and
				(up-compare-goal g-desired-num-monk >= 7)
				(or
					(up-research-status c: ri-sanctity >= research-pending)
					(up-compare-const SANCTITY-AVAILABLE == NO))))
		(can-research ri-redemption)
		=>
		(research ri-redemption)
		)

		(defrule
		(up-compare-goal g-desired-num-monk > 0)
		(or
			(up-compare-goal g-enemy-field-siege-count > 0)
			(and
				(up-compare-goal g-desired-num-monk >= 7)
				(or
					(up-research-status c: ri-sanctity >= research-pending)
					(up-compare-const SANCTITY-AVAILABLE == NO))))
		(can-research ri-redemption)
		=>
		(research ri-redemption)
		)

	;--------------------
	;	Block Printing
	;--------------------

		(defrule
		(or
			(goal g-primary-unit monk)
			(goal g-support-unit monk))
		(can-research-with-escrow ri-block-printing)
		=>
		(release-escrow gold)
		(research ri-block-printing)
		)

		(defrule
		(or
			(goal g-primary-unit monk)
			(goal g-support-unit monk))
		(up-research-status c: ri-block-printing == research-available)
		(building-type-count monastery > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-block-printing c: 1)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit monk)
		; 	(goal g-support-unit monk))
		; (up-research-status c: ri-block-printing == research-available)
		; (building-type-count monastery > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Block Printing")
		; )

		(defrule
		(up-compare-goal g-desired-num-monk >= 3)
		(can-research ri-block-printing)
		=>
		(research ri-block-printing)
		)

	;--------------
	;	Sanctity
	;--------------

		(defrule
		(or
			(goal g-primary-unit monk)
			(goal g-support-unit monk))
		(or
			(up-research-status c: ri-block-printing >= research-pending)
			(or
				(current-age == castle-age)
				(up-compare-const BLOCK-PRINTING-AVAILABLE == NO)))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(gold-amount >= 920))
		(can-research-with-escrow ri-sanctity)
		=>
		(release-escrow gold)
		(research ri-sanctity)
		)

		(defrule
		(goal g-primary-unit monk)
		(goal g-age-status TO-CASTLE)
		(goal g-current-strategy FC-DEMON)
		(up-compare-const SANCTITY-AVAILABLE == YES)
		(building-type-count monastery > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-sanctity c: 1)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (goal g-primary-unit monk)
		; (goal g-age-status TO-CASTLE)
		; (goal g-current-strategy FC-DEMON)
		; (up-compare-const SANCTITY-AVAILABLE == YES)
		; (building-type-count monastery > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Sanctity for monk rush")
		; )

		(defrule
		(or
			(goal g-primary-unit monk)
			(goal g-support-unit monk))
		(or
			(up-research-status c: ri-block-printing >= research-pending)
			(or
				(current-age == castle-age)
				(up-compare-const BLOCK-PRINTING-AVAILABLE == NO)))
		(up-research-status c: ri-sanctity == research-available)
		(building-type-count monastery > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-sanctity c: 1)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit monk)
		; 	(goal g-support-unit monk))
		; (or
		; 	(up-research-status c: ri-block-printing >= research-pending)
		; 	(or
		; 		(current-age == castle-age)
		; 		(up-compare-const BLOCK-PRINTING-AVAILABLE == NO)))
		; (up-research-status c: ri-sanctity == research-available)
		; (building-type-count monastery > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Sanctity")
		; )

		(defrule
		(or
			(up-research-status c: ri-block-printing >= research-pending)
			(or
				(current-age == castle-age)
				(up-compare-const BLOCK-PRINTING-AVAILABLE == NO)))
		(military-population g:>= g-min-military-pop)
		(or
			(up-compare-goal g-desired-num-monk > 2)
			(unit-type-count monastery-class > 4))
		(can-research ri-sanctity)
		=>
		(research ri-sanctity)
		)

	;------------
	;	Fervor
	;------------

		(defrule
		(or
			(goal g-primary-unit monk)
			(goal g-support-unit monk))
		(or
			(up-research-status c: ri-block-printing >= research-pending)
			(or
				(current-age == castle-age)
				(up-compare-const BLOCK-PRINTING-AVAILABLE == NO)))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(gold-amount >= 940))
		(can-research-with-escrow ri-fervor)
		=>
		(release-escrow gold)
		(research ri-fervor)
		)

		(defrule
		(or
			(goal g-primary-unit monk)
			(goal g-support-unit monk))
		(or
			(up-research-status c: ri-block-printing >= research-pending)
			(or
				(current-age == castle-age)
				(up-compare-const BLOCK-PRINTING-AVAILABLE == NO)))
		(up-research-status c: ri-fervor == research-available)
		(building-type-count monastery > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-fervor c: 1)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit monk)
		; 	(goal g-support-unit monk))
		; (or
		; 	(up-research-status c: ri-block-printing >= research-pending)
		; 	(or
		; 		(current-age == castle-age)
		; 		(up-compare-const BLOCK-PRINTING-AVAILABLE == NO)))
		; (up-research-status c: ri-fervor == research-available)
		; (building-type-count monastery > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Fervor")
		; )

		(defrule
		(or
			(up-research-status c: ri-block-printing >= research-pending)
			(or
				(current-age == castle-age)
				(up-compare-const BLOCK-PRINTING-AVAILABLE == NO)))
		(military-population g:>= g-min-military-pop)
		(up-compare-goal g-desired-num-monk > 2)
		(can-research ri-fervor)
		=>
		(research ri-fervor)
		)

	;---------------
	;	Theocracy
	;---------------

		(defrule
		(or
			(goal g-primary-unit monk)
			(goal g-support-unit monk))
		(or
			(up-research-status c: ri-block-printing >= research-pending)
			(up-compare-const BLOCK-PRINTING-AVAILABLE == NO))
		(can-research-with-escrow ri-theocracy)
		=>
		(release-escrow gold)
		(research ri-theocracy)
		)

		(defrule
		(or
			(goal g-primary-unit monk)
			(goal g-support-unit monk))
		(or
			(up-research-status c: ri-block-printing >= research-pending)
			(up-compare-const BLOCK-PRINTING-AVAILABLE == NO))
		(up-research-status c: ri-theocracy == research-available)
		(building-type-count monastery > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-theocracy c: 1)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit monk)
		; 	(goal g-support-unit monk))
		; (or
		; 	(up-research-status c: ri-block-printing >= research-pending)
		; 	(up-compare-const BLOCK-PRINTING-AVAILABLE == NO))
		; (up-research-status c: ri-theocracy == research-available)
		; (building-type-count monastery > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Theocracy")
		; )

		(defrule
		(or
			(up-research-status c: ri-block-printing >= research-pending)
			(up-compare-const BLOCK-PRINTING-AVAILABLE == NO))
		(up-compare-goal g-desired-num-monk >= 5)
		(can-research ri-theocracy)
		=>
		(research ri-theocracy)
		)

		(defrule
		(or
			(up-research-status c: ri-block-printing >= research-pending)
			(up-compare-const BLOCK-PRINTING-AVAILABLE == NO))
		(up-compare-goal g-desired-num-monk > 0)
		(can-research ri-theocracy)
		=>
		(research ri-theocracy)
		)

	;------------------
	;	Illumination
	;------------------

		(defrule
		(or
			(goal g-primary-unit monk)
			(goal g-support-unit monk))
		(or
			(up-research-status c: ri-theocracy >= research-pending)
			(up-compare-const THEOCRACY-AVAILABLE == NO))
		(can-research-with-escrow ri-illumination)
		=>
		(release-escrow gold)
		(research ri-illumination)
		)

		(defrule
		(or
			(goal g-primary-unit monk)
			(goal g-support-unit monk))
		(or
			(up-research-status c: ri-theocracy >= research-pending)
			(up-compare-const THEOCRACY-AVAILABLE == NO))
		(up-research-status c: ri-illumination == research-available)
		(building-type-count monastery > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-illumination c: 1)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit monk)
		; 	(goal g-support-unit monk))
		; (or
		; 	(up-research-status c: ri-theocracy >= research-pending)
		; 	(up-compare-const THEOCRACY-AVAILABLE == NO))
		; (up-research-status c: ri-illumination == research-available)
		; (building-type-count monastery > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Illumination")
		; )

		(defrule
		(or
			(up-research-status c: ri-theocracy >= research-pending)
			(or
				(up-compare-const THEOCRACY-AVAILABLE == NO)
				(up-compare-goal g-desired-num-monk < 5)))
		(up-compare-goal g-desired-num-monk >= 3)
		(can-research ri-illumination)
		=>
		(research ri-illumination)
		)

		(defrule
		(or
			(up-research-status c: ri-theocracy >= research-pending)
			(or
				(up-compare-const THEOCRACY-AVAILABLE == NO)
				(up-compare-goal g-desired-num-monk < 5)))
		(up-compare-goal g-desired-num-monk > 0)
		(can-research ri-illumination)
		=>
		(research ri-illumination)
		)

	;---------------
	;	Atonement
	;---------------

		(defrule
		(or
			(goal g-primary-unit monk)
			(goal g-support-unit monk))
		(up-compare-goal g-enemy-monks-count >= 5)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(gold-amount >= 1125))
		(can-research-with-escrow ri-atonement)
		=>
		(release-escrow gold)
		(research ri-atonement)
		)

		(defrule
		(or
			(goal g-primary-unit monk)
			(goal g-support-unit monk))
		(up-compare-goal g-enemy-monks-count >= 5)
		(up-research-status c: ri-atonement == research-available)
		(building-type-count monastery > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-atonement c: 1)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(goal g-primary-unit monk)
		; 	(goal g-support-unit monk))
		; (up-compare-goal g-enemy-monks-count >= 5)
		; (up-research-status c: ri-atonement == research-available)
		; (building-type-count monastery > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Atonement")
		; )

		(defrule
		(up-compare-goal g-desired-num-monks >= 5)
		(up-compare-goal g-enemy-monks-count >= 5)
		(can-research ri-atonement)
		=>
		(research ri-atonement)
		)

		(defrule
		(up-compare-goal g-desired-num-monks > 0)
		(up-compare-goal g-enemy-monks-count >= 5)
		(can-research ri-atonement)
		=>
		(research ri-atonement)
		)

	;----------------------
	;	Aztec Monk Techs
	;----------------------

		#load-if-defined AZTEC-CIV

			(defrule
			(or
			(goal g-primary-unit monk)
			(and
				(goal g-support-unit monk)
				(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-CASTLE-COMPLETE)))
			(research-completed ri-redemption)
			(research-completed ri-sanctity)
			(research-completed ri-fervor)
			(can-research ri-atonement)
			=>
			(research ri-atonement)
			)

			(defrule
			(or
			(goal g-primary-unit monk)
			(and
				(goal g-support-unit monk)
				(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-CASTLE-COMPLETE)))
			(research-completed ri-redemption)
			(research-completed ri-sanctity)
			(research-completed ri-fervor)
			(research-completed ri-atonement)
			(can-research ri-herbal-medicine)
			=>
			(research ri-herbal-medicine)
			)

			(defrule
			(or
			(goal g-primary-unit monk)
			(and
				(goal g-support-unit monk)
				(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-CASTLE-COMPLETE)))
			(research-completed ri-redemption)
			(research-completed ri-sanctity)
			(research-completed ri-fervor)
			(research-completed ri-atonement)
			(research-completed ri-herbal-medicine)
			(can-research ri-heresy)
			=>
			(research ri-heresy)
			)

			(defrule
			(or
			(goal g-primary-unit monk)
			(and
				(goal g-support-unit monk)
				(up-compare-goal g-primary-unit-tech-progress >= SECONDARY-IMPERIAL-COMPLETE)))
			(research-completed ri-redemption)
			(research-completed ri-sanctity)
			(research-completed ri-fervor)
			(research-completed ri-atonement)
			(research-completed ri-herbal-medicine)
			(research-completed ri-heresy)
			(can-research ri-faith)
			=>
			(research ri-faith)
			)

		#end-if

;=========================<>=========================
;				     OTHER TECHS
;=========================<>=========================

	;------------------
	;	Conscription
	;------------------

		(defrule
		(can-research-with-escrow ri-conscription)
		=>
		(release-escrow food)
		(release-escrow gold)
		(research ri-conscription)
		)

	;-----------------
	;	Cartography
	;-----------------

		(defrule
		(current-age >= castle-age)
		(or
			(goal g-first-attack-launched YES)
			(and
				(goal g-position POCKET)
				(up-compare-goal g-eco-tech-progress >= ALL-CASTLE-COMPLETE)))
		(goal g-town-under-attack NO)
		(player-in-game any-ally)
		(can-research ri-cartography)
		=>
		(research ri-cartography)
		)

	;--------------
	;	Caravan
	;--------------

        (defrule
		(or
			(up-compare-goal g-desired-num-trade-cart > 0)
			(up-compare-goal g-desired-num-trade-cog > 0))
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
        (can-research-with-escrow ri-caravan)
        =>
		(release-escrow food)
		(release-escrow gold)
		(research ri-caravan)
        )

		(defrule
		(or
			(up-compare-goal g-desired-num-trade-cart > 0)
			(up-compare-goal g-desired-num-trade-cog > 0))
		(up-research-status c: ri-caravan == research-available)
		(building-type-count market > 0)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-research-cost c: ri-caravan c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (or
		; 	(up-compare-goal g-desired-num-trade-cart > 0)
		; 	(up-compare-goal g-desired-num-trade-cog > 0))
		; (up-research-status c: ri-caravan == research-available)
		; (building-type-count market > 0)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Caravan")
		; )

	;------------
	;	Guilds
	;------------

		(defrule
		(or
			(dropsite-min-distance gold > 50)
			(or
				(unit-type-count villager-gold == 0)
				(up-compare-goal g-current-strategy >= 1301)))	;Late Imperial
		(can-research ri-guilds)
		=>
		(research ri-guilds)
		)

	;------------------
	;	Murder Holes
	;------------------

		(defrule
		(can-research ri-murder-holes)
		(building-type-count castle > 0)
		(or
			(goal g-town-under-attack YES)
			(up-compare-goal g-top-enemy-military-parity < 0))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1200))
		=>
		(research ri-murder-holes)
		)

	;---------------
	;	Hoardings
	;---------------

		(defrule
		(can-research ri-hoardings)
		(building-type-count castle > 0)
		(or
			(goal g-town-under-attack YES)
			(up-compare-goal g-top-enemy-military-parity < 10))
		=>
		(research ri-hoardings)
		)

	;----------------
	;	Town Watch
	;----------------

		(defrule
		(current-age >= castle-age)
		(building-type-count town-center > 1)
		(or
			(and
				(goal g-game-focus DEFENSIVE)
				(goal g-town-under-attack NO))
			(goal g-enemy-strategy FL-GOEMUL))
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1075))
		(can-research ri-town-watch)
		=>
		(research ri-town-watch)
		)

		(defrule
		(building-type-count town-center > 1)
		(up-compare-goal g-eco-tech-progress >= ALL-CASTLE-COMPLETE)
		(population >= SEVENTY-PERCENT-POP)
		(or
			(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
			(food-amount >= 1075))
		(can-research ri-town-watch)
		=>
		(research ri-town-watch)
		)

	;-----------------
	;	Town Patrol
	;-----------------

		(defrule
		(building-type-count town-center > 2)
		(or
			(and
				(goal g-game-focus DEFENSIVE)
				(goal g-town-under-attack NO))
			(goal g-enemy-strategy FL-GOEMUL))
		(up-compare-goal g-eco-tech-progress >= ALL-CASTLE-COMPLETE)
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-town-patrol)
		=>
		(research ri-town-patrol)
		)

		(defrule
		(building-type-count town-center > 2)
		(up-compare-goal g-eco-tech-progress >= ALL-CASTLE-COMPLETE)
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(population >= EIGHTY-PERCENT-POP)
		(can-research ri-town-patrol)
		=>
		(research ri-town-patrol)
		)
		
	;-------------
	;	Masonry
	;-------------

		(defrule
		(current-age == castle-age)
		(up-compare-goal g-eco-tech-progress >= ALL-CASTLE-COMPLETE)
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-masonry)
		=>
		(research ri-masonry)
		)

		(defrule
		(current-age == imperial-age)
		(up-compare-goal g-eco-tech-progress >= ALL-CASTLE-COMPLETE)
		(can-research ri-masonry)
		=>
		(research ri-masonry)
		)
		
	;------------------
	;	Architecture
	;------------------

		(defrule
		(up-compare-goal g-eco-tech-progress >= ALL-CASTLE-COMPLETE)
		(can-research ri-architecture)
		=>
		(research ri-architecture)
		)
		
	;---------------------
	;	Treadmill Crane
	;---------------------

		(defrule
		(current-age == castle-age)
		(up-compare-goal g-eco-tech-progress >= ALL-CASTLE-COMPLETE)
		(up-compare-goal g-age-status != SAVE-FOR-IMPERIAL)
		(can-research ri-treadmill-crane)
		=>
		(research ri-treadmill-crane)
		)

		(defrule
		(current-age == imperial-age)
		(up-compare-goal g-eco-tech-progress >= ALL-CASTLE-COMPLETE)
		(can-research ri-treadmill-crane)
		=>
		(research ri-treadmill-crane)
		)



;=========================<>=========================
;			STORE TECH RES NEEDED AMOUNTS
;=========================<>=========================

	(defrule
	(true)
	=>
	(up-setup-cost-data 1 g-total-techs-food-needed)
	(up-add-cost-data g-max-food-needed c: 1)
	)

;=========================<>=========================
;		    NEEDED RESOURCES FOR BUILDINGS
;=========================<>=========================

	;-------------
	;	Wonders
	;-------------

		(defrule
		(up-object-type-count-total c: wonder g:< g-desired-num-wonder)
		; (not
		; 	(can-afford-building wonder))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: wonder c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		(up-modify-goal g-max-stone-needed g:max g-stone-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-object-type-count-total c: wonder g:< g-desired-num-wonder)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Wonder")
		; )

	;------------------
	;	Town Centers
	;------------------

		(defrule
		(up-object-type-count-total c: town-center g:< g-desired-num-town-center)
		; (not
		; 	(can-afford-building town-center))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: town-center-foundation c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		(up-modify-goal g-max-stone-needed g:max g-stone-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-object-type-count-total c: town-center g:< g-desired-num-town-center)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for TC")
		; )

	;-------------
	;	Castles
	;-------------

		(defrule
		(up-object-type-count-total c: castle g:< g-desired-num-castle)
		; (not
		; 	(can-afford-building castle))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: castle c: 1)
		(up-modify-goal g-max-stone-needed g:max g-stone-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-object-type-count-total c: castle g:< g-desired-num-castle)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for castle")
		; )

	;---------------------
	;	Siege Workshops
	;---------------------

		(defrule
		(up-object-type-count-total c: siege-workshop g:< g-desired-num-siege-workshop)
		; (not
		; 	(can-afford-building siege-workshop))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: siege-workshop c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-object-type-count-total c: siege-workshop g:< g-desired-num-siege-workshop)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Siege Workshop")
		; )

	;----------------
	;	University
	;----------------

		(defrule
		(up-object-type-count-total c: university g:< g-desired-num-university)
		; (not
		; 	(can-afford-building university))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: university c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-object-type-count-total c: university g:< g-desired-num-university)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for University (impossible to ever save enough 11)")
		; )

	;--------------
	;	Barracks
	;--------------

		(defrule
		(up-object-type-count-total c: barracks g:< g-desired-num-barracks)
		(or
			(and
				(goal g-primary-unit-class infantry-class)
				(up-compare-goal g-primary-unit != my-unique-unit))
			(and
				(goal g-support-unit-class infantry-class)
				(up-compare-goal g-support-unit != my-unique-unit)))
		; (not
		; 	(can-afford-building barracks))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: barracks c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-object-type-count-total c: barracks g:< g-desired-num-barracks)
		; (or
		; 	(and
		; 		(goal g-primary-unit-class infantry-class)
		; 		(up-compare-goal g-primary-unit != my-unique-unit))
		; 	(and
		; 		(goal g-support-unit-class infantry-class)
		; 		(up-compare-goal g-support-unit != my-unique-unit)))
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Barracks")
		; )

	;-------------------
	;	Archery Range
	;-------------------

		(defrule
		(up-object-type-count-total c: archery-range g:< g-desired-num-archery-range)
		(or
			(goal g-primary-unit-class archery-class)
			(or
				(goal g-primary-unit-class cavalry-archer-class)
				(goal g-primary-unit hand-cannoneer)))
		(up-compare-goal g-primary-unit != my-unique-unit)
		; (not
		; 	(can-afford-building archery-range))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: archery-range c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-object-type-count-total c: archery-range g:< g-desired-num-archery-range)
		; (or
		; 	(goal g-primary-unit-class archery-class)
		; 	(or
		; 		(goal g-primary-unit-class cavalry-archer-class)
		; 		(goal g-primary-unit hand-cannoneer)))
		; (up-compare-goal g-primary-unit != my-unique-unit)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Archery Range, primary")
		; )

		(defrule
		(up-object-type-count-total c: archery-range g:< g-desired-num-archery-range)
		(or
			(goal g-support-unit-class archery-class)
			(or
				(goal g-support-unit-class cavalry-archer-class)
				(goal g-support-unit hand-cannoneer)))
		(up-compare-goal g-primary-unit != my-unique-unit)
		; (not
		; 	(can-afford-building archery-range))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: archery-range c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-object-type-count-total c: archery-range g:< g-desired-num-archery-range)
		; (or
		; 	(goal g-support-unit-class archery-class)
		; 	(or
		; 		(goal g-support-unit-class cavalry-archer-class)
		; 		(goal g-support-unit hand-cannoneer)))
		; (up-compare-goal g-support-unit != my-unique-unit)
		; ; (not
		; ; 	(can-afford-building archery-range))
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Archery Range, support")
		; )

	;------------
	;	Stable
	;------------

		(defrule
		(up-object-type-count-total c: stable g:< g-desired-num-stable)
		(or
			(and
				(goal g-primary-unit-class cavalry-class)
				(up-compare-goal g-primary-unit != my-unique-unit))
			(and
				(goal g-support-unit-class cavalry-class)
				(up-compare-goal g-support-unit != my-unique-unit)))
		; (not
		; 	(can-afford-building stable))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: stable c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-object-type-count-total c: stable g:< g-desired-num-stable)
		; (or
		; 	(and
		; 		(goal g-primary-unit-class cavalry-class)
		; 		(up-compare-goal g-primary-unit != my-unique-unit))
		; 	(and
		; 		(goal g-support-unit-class cavalry-class)
		; 		(up-compare-goal g-support-unit != my-unique-unit)))
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Stable")
		; )

	;---------------
	;	Monastery
	;---------------

		(defrule
		(up-object-type-count-total c: monastery g:< g-desired-num-monastery)
		(or
			(up-compare-goal g-desired-num-monks > 0)
			(goal g-age-status SAVE-FOR-IMPERIAL))
		; (not
		; 	(can-afford-building monastery))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: monastery c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-object-type-count-total c: monastery g:< g-desired-num-monastery)
		; (or
		; 	(up-compare-goal g-desired-num-monks > 0)
		; 	(goal g-age-status SAVE-FOR-IMPERIAL))
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Monastery")
		; )
		
	;------------
	;	Market
	;------------

		(defrule
		(up-object-type-count-total c: market g:< g-desired-num-market)
		(or
			(goal g-town-under-attack YES)
			(or
				(civilian-population >= 60)
				(or
					(up-compare-goal g-desired-num-trade-cart > 0)
					(current-age <= feudal-age))))	;we need a market as one of our two feudal buildings
		; (not
		; 	(can-afford-building market))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: market c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-object-type-count-total c: market g:< g-desired-num-market)
		; (or
		; 	(goal g-town-under-attack YES)
		; 	(or
		; 		(civilian-population >= 60)
		; 		(or
		; 			(up-compare-goal g-desired-num-trade-cart > 0)
		; 			(current-age <= feudal-age))))	;we need a market as one of our two feudal buildings
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Market")
		; )
		
	;----------
	;	Mill
	;----------

		(defrule
		(up-object-type-count-total c: mill g:< g-desired-num-mill)
		; (not
		; 	(can-afford-building mill))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: mill c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-object-type-count-total c: mill g:< g-desired-num-mill)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Mill")
		; )
		
	;-----------------
	;	Mining Camp
	;-----------------

		(defrule
		(up-object-type-count-total c: mining-camp g:< g-desired-num-mining-camp)
		; (not
		; 	(can-afford-building mining-camp))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: mining-camp c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-object-type-count-total c: mining-camp g:< g-desired-num-mining-camp)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Mining Camp")
		; )

	;-----------------
	;	Lumber Camp
	;-----------------

		(defrule
		(up-object-type-count-total c: lumber-camp g:< g-desired-num-lumber-camp)
		; (not
		; 	(can-afford-building lumber-camp))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: lumber-camp c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-object-type-count-total c: lumber-camp g:< g-desired-num-lumber-camp)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Lumber Camp")
		; )
		
	;----------
	;	Dock
	;----------

		(defrule
		(up-object-type-count-total c: dock g:< g-desired-num-dock)
		; (not
		; 	(can-afford-building dock))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: dock c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		)

		; (defrule
		; (up-object-type-count-total c: dock g:< g-desired-num-dock)
		; (taunt-detected TAUNT-PLAYER 246)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Dock")
		; )
		
	;----------------
	;	Blacksmith
	;----------------

		(defrule
		(up-object-type-count-total c: blacksmith g:< g-desired-num-blacksmith)
		; (not
		; 	(can-afford-building blacksmith))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: blacksmith c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-object-type-count-total c: blacksmith g:< g-desired-num-blacksmith)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Blacksmith")
		; )
		
	;-----------------
	;	Watch Tower
	;-----------------

		(defrule
		(up-compare-goal g-watch-tower-line g:< g-desired-num-watch-tower)
		; (not
		; 	(can-afford-building watch-tower))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: watch-tower c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		(up-modify-goal g-max-stone-needed g:max g-stone-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-compare-goal g-watch-tower-line g:< g-desired-num-watch-tower)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Tower")
		; )
		
	;-------------------
	;	Bombard Tower
	;-------------------

		(defrule
		(up-object-type-count c: bombard-tower g:< g-desired-num-bombard-tower)
		; (not
		; 	(can-afford-building bombard-tower))
		(building-available bombard-tower)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: bombard-tower c: 1)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		(up-modify-goal g-max-stone-needed g:max g-stone-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-object-type-count c: bombard-tower g:< g-desired-num-bombard-tower)
		; (building-available bombard-tower)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Bombard Tower")
		; )
		
	;--------------
	;	Feitoria
	;--------------
		
		#load-if-defined PORTUGUESE-CIV

			(defrule
			(up-object-type-count-total c: feitoria g:< g-desired-num-feitoria)
			; (not
			; 	(can-afford-building feitoria))
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-object-cost c: feitoria c: 1)
			(up-modify-goal g-max-gold-needed g:max g-gold-cost)
			(up-modify-goal g-max-stone-needed g:max g-stone-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (up-object-type-count-total c: feitoria g:< g-desired-num-feitoria)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Feitoria")
			; )

		#end-if

	;-------------
	;	Krepost
	;-------------

		#load-if-defined BULGARIANS-CIV

			(defrule
			(up-object-type-count-total c: krepost g:< g-desired-num-krepost)
			; (not
			; 	(can-afford-building krepost))
			=>
			(up-setup-cost-data 1 g-food-cost)
			(up-add-object-cost c: krepost c: 1)
			(up-modify-goal g-max-stone-needed g:max g-stone-cost)
			)

			; (defrule
			; (taunt-detected TAUNT-PLAYER 246)
			; (up-object-type-count-total c: krepost g:< g-desired-num-krepost)
			; =>
			; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Krepost")
			; )

		#end-if

;=========================<>=========================
;			  NEEDED RESOURCES FOR UNITS
;=========================<>=========================

	;-------------------------
	;	Constant train unit
	;-------------------------

		(defrule
		(true)
		=>
		(up-get-indirect-goal g: g-desired-num-constant-train-unit-goal g-desired-num-constant-train-unit)
		)

		(defrule
		(up-object-type-count-total g: g-constant-train-unit g:< g-desired-num-constant-train-unit)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost g: g-constant-train-unit c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-object-type-count-total g: g-constant-train-unit g:< g-desired-num-constant-train-unit)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for constant train unit")
		; )

	;--------------------
	;	Battering Rams
	;--------------------

		(defrule
		(up-object-type-count-total c: battering-ram-line g:< g-desired-num-battering-ram)
		(military-population g:>= g-min-military-pop)
		(or
			(unit-type-count-total battering-ram-line < 1)
			(and
				(military-population >= 15)
				(unit-type-count-total battering-ram-line < 3)))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: battering-ram c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-object-type-count-total c: battering-ram-line g:< g-desired-num-battering-ram)
		; (military-population g:>= g-min-military-pop)
		; (or
		; 	(unit-type-count-total battering-ram-line < 1)
		; 	(and
		; 		(military-population >= 15)
		; 		(unit-type-count-total battering-ram-line < 3)))
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for ram")
		; )

	;---------------
	;	Mangonels
	;---------------

		(defrule
		(up-compare-goal g-mangonel-line g:< g-desired-num-mangonel)
		(or
			(up-compare-goal g-mangonel-line < 1)
			(and
				(military-population >= 15)
				(up-compare-goal g-mangonel-line < 2)))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: mangonel c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-compare-goal g-mangonel-line g:< g-desired-num-mangonel)
		; (or
		; 	(up-compare-goal g-mangonel-line < 1)
		; 	(and
		; 		(military-population >= 15)
		; 		(up-compare-goal g-mangonel-line < 2)))
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for Mangonel")
		; )

	;---------------
	;	Trebuchet
	;---------------	

		(defrule
		(up-object-type-count-total c: trebuchet-set g:< g-desired-num-trebuchet)
		(military-population g:>= g-min-military-pop)
		(or
			(unit-type-count-total trebuchet-set < 1)
			(and
				(military-population >= 15)
				(unit-type-count-total trebuchet-set < 2)))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: trebuchet c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-object-type-count-total c: trebuchet-set g:< g-desired-num-trebuchet)
		; (military-population g:>= g-min-military-pop)
		; (or
		; 	(unit-type-count-total trebuchet-set < 1)
		; 	(and
		; 		(military-population >= 15)
		; 		(unit-type-count-total trebuchet-set < 2)))
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for treb")
		; )

	;---------------------
	;	Bombard Cannons
	;---------------------

		(defrule
		(up-object-type-count-total c: bombard-cannon g:< g-desired-num-bombard-cannon)
		(military-population g:>= g-min-military-pop)
		(or
			(unit-type-count-total bombard-cannon < 1)
			(and
				(military-population >= 15)
				(unit-type-count-total bombard-cannon < 2)))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: bombard-cannon c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-object-type-count-total c: bombard-cannon g:< g-desired-num-bombard-cannon)
		; (military-population g:>= g-min-military-pop)
		; (or
		; 	(unit-type-count-total bombard-cannon < 1)
		; 	(and
		; 		(military-population >= 15)
		; 		(unit-type-count-total bombard-cannon < 2)))
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for cannon")
		; )

	;---------------
	;	Villagers
	;---------------

		(defrule
		(up-object-type-count-total c: villager g:< g-desired-num-villager)
		(goal g-villager-training TRAIN-WITH-ESCROW)
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: villager c: 1)
		(up-modify-goal g-max-food-needed g:max g-food-cost)
		(up-modify-escrow food g:= g-max-food-needed)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-object-type-count-total c: villager g:< g-desired-num-villager)
		; (goal g-villager-training TRAIN-WITH-ESCROW)
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for villager")
		; )

	;-----------------
	;	Trade Carts
	;-----------------

		(defrule
		(up-object-type-count-total c: trade-cart g:< g-desired-num-trade-cart)
		(military-population g:>= g-min-military-pop)
		(nor
			(goal g-game-focus DEFENSIVE)
			(goal g-game-focus AGGRESSIVE))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: trade-cart c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		(up-modify-escrow wood g:= g-max-wood-needed)
		(up-modify-escrow gold g:= g-max-gold-needed)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-object-type-count-total c: trade-cart g:< g-desired-num-trade-cart)
		; (military-population g:>= g-min-military-pop)
		; (nor
		; 	(goal g-game-focus DEFENSIVE)
		; 	(goal g-game-focus AGGRESSIVE))
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for trade cart")
		; )

	;----------------
	;	Trade Cogs
	;----------------

		(defrule
		(up-object-type-count-total c: trade-cog g:< g-desired-num-trade-cog)
		(military-population g:>= g-min-military-pop)
		(nor
			(goal g-game-focus DEFENSIVE)
			(goal g-game-focus AGGRESSIVE))
		=>
		(up-setup-cost-data 1 g-food-cost)
		(up-add-object-cost c: trade-cog c: 1)
		(up-modify-goal g-max-wood-needed g:max g-wood-cost)
		(up-modify-goal g-max-gold-needed g:max g-gold-cost)
		(up-modify-escrow wood g:= g-max-wood-needed)
		(up-modify-escrow gold g:= g-max-gold-needed)
		)

		; (defrule
		; (taunt-detected TAUNT-PLAYER 246)
		; (up-object-type-count-total c: trade-cog g:< g-desired-num-trade-cog)
		; (military-population g:>= g-min-military-pop)
		; (nor
		; 	(goal g-game-focus DEFENSIVE)
		; 	(goal g-game-focus AGGRESSIVE))
		; =>
		; (chat-to-player THIS-ANY-TAUNT-PLAYER "Saving for trade cog")
		; )

;=========================<>=========================
;	     ACKNOWLEDGE TAUNT 246 - TECH STATUS
;=========================<>=========================
		
	(defrule
	(taunt-detected TAUNT-PLAYER 246)
	=>
	(acknowledge-taunt THIS-ANY-TAUNT-PLAYER 246)
	)


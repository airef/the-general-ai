;Next Items.per

(defrule
(true)
=>
(set-goal g-next-town-center-tech -1)
(set-goal g-next-mill-tech -1)
(set-goal g-next-mining-camp-tech -1)
(set-goal g-next-lumber-camp-tech -1)
(set-goal g-next-dock-tech -1)
(set-goal g-next-blacksmith-tech -1)
(set-goal g-next-market-tech -1)
(set-goal g-next-monastery-tech -1)
(set-goal g-next-university-tech -1)
(set-goal g-next-barracks-tech -1)
(set-goal g-next-archery-range-tech -1)
(set-goal g-next-stable-tech -1)
(set-goal g-next-siege-workshop-tech -1)
(set-goal g-next-castle-tech -1)
)

(defrule
(true)
=>
(set-goal g-next-town-center-unit -1)
(set-goal g-next-dock-unit -1)
(set-goal g-next-market-unit -1)
(set-goal g-next-monastery-unit -1)
(set-goal g-next-barracks-unit -1)
(set-goal g-next-archery-range-unit -1)
(set-goal g-next-stable-unit -1)
(set-goal g-next-siege-workshop-unit -1)
(set-goal g-next-castle-unit -1)
)

(defrule
(true)
=>
(set-goal g-town-center-tech-priority 0)
(set-goal g-mill-tech-priority 0)
(set-goal g-mining-camp-tech-priority 0)
(set-goal g-lumber-camp-tech-priority 0)
(set-goal g-dock-tech-priority 0)
(set-goal g-blacksmith-tech-priority 0)
(set-goal g-market-tech-priority 0)
(set-goal g-monastery-tech-priority 0)
(set-goal g-university-tech-priority 0)
(set-goal g-barracks-tech-priority 0)
(set-goal g-archery-range-tech-priority 0)
(set-goal g-stable-tech-priority 0)
(set-goal g-siege-workshop-tech-priority 0)
(set-goal g-castle-tech-priority 0)
)



;========Town Center

(defrule
(building-type-count town-center > 0)
(up-compare-goal g-town-center-tech-priority < gv-primary)
(up-research-status c: ri-loom == research-available)
(goal g-loom-progress gv-have-enough-vils)	;for when boar is far away
=>
(set-goal g-next-town-center-tech ri-loom)
(set-goal g-town-center-tech-priority gv-primary)
)

; (defrule
; (goal g-next-town-center-tech ri-loom)
; (can-afford-research ri-loom)
; (up-research-status c: ri-loom < research-pending)
; (up-compare-goal g-boar-hunting-conditions-met == gv-far-boar-vils-met)
; (up-compare-goal g-villager-training-time-left >= 10)
; (up-pending-objects c: villager > 0)
; =>
; (up-reset-building 1 c: town-center)
; (chat-local-to-self "emergency cancel vil training for Loom")
; )

(defrule
(building-type-count town-center > 0)
(up-compare-goal g-town-center-tech-priority < gv-primary)
(up-research-status c: ri-loom == research-available)
(or
	(up-object-type-count c: villager g:>= g-desired-num-villager)
	(or
		(goal g-town-under-attack YES)
		(players-military-population any-enemy > 1)))
=>
(set-goal g-next-town-center-tech ri-loom)
(set-goal g-town-center-tech-priority gv-primary)
)

(defrule
(building-type-count town-center > 0)
(up-compare-goal g-town-center-tech-priority < gv-primary)
(up-research-status c: ri-loom == research-available)
(or
	(civ-selected chinese)
	(civ-selected mayan))
=>
(set-goal g-next-town-center-tech ri-loom)
(set-goal g-town-center-tech-priority gv-primary)
)

(defrule
(building-type-count town-center > 0)
(up-compare-goal g-town-center-tech-priority < gv-primary)
(up-research-status c: ri-loom == research-available)
(housing-headroom == 0)
(or
	(building-type-count house > 2)
	(civ-selected hun))
(up-pending-objects c: villager == 0)
(up-research-status c: feudal-age < research-pending)
=>
(set-goal g-next-town-center-tech ri-loom)
(set-goal g-town-center-tech-priority gv-primary)
)

;Feudal Age

(defrule
(building-type-count town-center > 0)
(up-compare-goal g-town-center-tech-priority < gv-secondary)
(up-research-status c: feudal-age == research-available)
(up-object-type-count c: villager g:>= g-desired-num-villager)
=>
(set-goal g-next-town-center-tech feudal-age)
(set-goal g-town-center-tech-priority gv-secondary)
)

(defrule
(building-type-count town-center > 0)
(up-compare-goal g-town-center-tech-priority < gv-secondary)
(up-research-status c: feudal-age == research-available)
(up-object-type-count c: villager g:>= g-required-num-villager)
(or
	(food-amount >= 550)
	(goal g-town-under-attack YES))
=>
(set-goal g-next-town-center-tech feudal-age)
(set-goal g-town-center-tech-priority gv-secondary)
)

;Castle Age

(defrule
(building-type-count town-center > 0)
(up-compare-goal g-town-center-tech-priority < gv-primary)
(up-research-status c: castle-age == research-available)
(or
	(up-object-type-count c: villager g:>= g-required-num-villager)
	(and
		(players-current-age any-enemy >= castle-age)
		(or
			(food-amount >= 900)
			(goal g-town-under-attack YES))))
=>
(set-goal g-next-town-center-tech castle-age)
(set-goal g-town-center-tech-priority gv-primary)
)

;Imperial Age

(defrule
(building-type-count town-center > 0)
(up-compare-goal g-town-center-tech-priority < gv-primary)
(up-research-status c: imperial-age == research-available)
(or
	(up-object-type-count c: villager g:>= g-required-num-villager)
	(and
		(players-current-age any-enemy >= imperial-age)
		(or
			(food-amount >= 1100)
			(goal g-town-under-attack YES))))
=>
(set-goal g-next-town-center-tech imperial-age)
(set-goal g-town-center-tech-priority gv-primary)
)

(defrule
(building-type-count town-center > 0)
(up-compare-goal g-town-center-tech-priority < gv-primary)
(up-research-status c: imperial-age == research-available)
(or
	(up-compare-goal g-military-superiority >= -10)
	(players-current-age any-enemy == imperial-age))
=>
(set-goal g-next-town-center-tech imperial-age)
(set-goal g-town-center-tech-priority gv-primary)
)

(defrule
(building-type-count town-center > 0)
(up-compare-goal g-town-center-tech-priority < gv-secondary)
(up-research-status c: imperial-age == research-available)
(food-amount >= 1200)
(gold-amount >= 1000)
=>
(set-goal g-next-town-center-tech imperial-age)
(set-goal g-town-center-tech-priority gv-secondary)
)

(defrule
(building-type-count town-center > 0)
(up-compare-goal g-town-center-tech-priority < gv-secondary)
(up-research-status c: imperial-age == research-available)
(game-time >= 2400)
(population >= 80)
=>
(set-goal g-next-town-center-tech imperial-age)
(set-goal g-town-center-tech-priority gv-secondary)
)

;Wheelbarrow

(defrule
(building-type-count town-center > 0)
(up-compare-goal g-town-center-tech-priority < gv-primary)
(up-research-status c: ri-wheel-barrow == research-available)
(or
	(unit-type-count-total villager >= 50)
	(up-research-status c: imperial-age >= research-pending))
(goal g-town-under-attack NO)
=>
(set-goal g-next-town-center-tech ri-wheel-barrow)
(set-goal g-town-center-tech-priority gv-primary)
)

(defrule
(building-type-count town-center > 0)
(up-compare-goal g-town-center-tech-priority < gv-secondary)
(up-research-status c: ri-wheel-barrow == research-available)
(unit-type-count-total villager >= 35)
(goal g-town-under-attack NO)
(or
	(unit-type-count-total villager >= 45)
	(or
		(unit-type-count villager-farmer >= 12)
		(building-type-count town-center >= 3)))
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
=>
(set-goal g-next-town-center-tech ri-wheel-barrow)
(set-goal g-town-center-tech-priority gv-secondary)
)

;Hand Cart

(defrule
(building-type-count town-center > 0)
(up-compare-goal g-town-center-tech-priority < gv-low)
(up-research-status c: ri-hand-cart == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(goal g-town-under-attack NO)
(unit-type-count villager >= 80)
(research-completed ri-bow-saw)
=>
(set-goal g-next-town-center-tech ri-hand-cart)
(set-goal g-town-center-tech-priority gv-secondary)
)

(defrule
(building-type-count town-center > 0)
(up-compare-goal g-town-center-tech-priority < gv-low)
(up-research-status c: ri-hand-cart == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(goal g-town-under-attack NO)
(unit-type-count villager-farmer >= 15)
(research-completed ri-bow-saw)
=>
(set-goal g-next-town-center-tech ri-hand-cart)
(set-goal g-town-center-tech-priority gv-low)
)

(defrule
(building-type-count town-center > 0)
(up-compare-goal g-town-center-tech-priority < gv-low)
(up-research-status c: ri-hand-cart == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(goal g-town-under-attack NO)
(current-age >= imperial-age)
(research-completed ri-bow-saw)
=>
(set-goal g-next-town-center-tech ri-hand-cart)
(set-goal g-town-center-tech-priority gv-low)
)

;Town Watch

(defrule
(building-type-count town-center > 0)
(up-compare-goal g-town-center-tech-priority < gv-low)
(up-research-status c: ri-town-watch == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
(or
	(up-building-type-in-town c: watch-tower > 0)
	(or
		(up-unit-type-in-town c: cavalry-class > 0)
		(and
			(building-type-count town-center >= 2)
			(unit-type-count villager >= 30))))
=>
(set-goal g-next-town-center-tech ri-town-watch)
(set-goal g-town-center-tech-priority gv-low)
)

(defrule
(building-type-count town-center >= 2)
(up-compare-goal g-town-center-tech-priority < gv-excess-only)
(up-research-status c: ri-town-watch == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
(or
	(up-object-type-count-total c: villager g:>= g-desired-num-villager)
	(housing-headroom == 0))
(up-research-status c: ri-wheel-barrow >= research-pending)
=>
(set-goal g-next-town-center-tech ri-town-watch)
(set-goal g-town-center-tech-priority gv-excess-only)
)

(defrule
(building-type-count town-center >= 2)
(up-compare-goal g-town-center-tech-priority < gv-high-excess-only)
(up-research-status c: ri-town-watch == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
=>
(set-goal g-next-town-center-tech ri-town-watch)
(set-goal g-town-center-tech-priority gv-high-excess-only)
)

;Town Patrol

(defrule
(building-type-count town-center > 1)
(up-compare-goal g-town-center-tech-priority < gv-excess-only)
(up-research-status c: ri-town-patrol == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(up-object-type-count-total c: villager g:>= g-desired-num-villager)
(population > 125)
(up-research-status c: ri-hand-cart >= research-pending)
=>
(set-goal g-next-town-center-tech ri-town-patrol)
(set-goal g-town-center-tech-priority gv-excess-only)
)

(defrule
(building-type-count town-center > 1)
(up-compare-goal g-town-center-tech-priority < gv-high-excess-only)
(up-research-status c: ri-town-patrol == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(research-completed ri-hand-cart)
=>
(set-goal g-next-town-center-tech ri-town-patrol)
(set-goal g-town-center-tech-priority gv-high-excess-only)
)

;Save for next age

(defrule
(current-age == dark-age)
(up-compare-goal g-age-status < gv-save-for-feudal)
(goal g-next-town-center-tech feudal-age)
=>
(set-goal g-age-status gv-save-for-feudal)
(set-goal g-save-for-next-age YES)
)

(defrule
(current-age == feudal-age)
(up-compare-goal g-age-status < gv-save-for-castle)
(goal g-next-town-center-tech castle-age)
=>
(set-goal g-age-status gv-save-for-castle)
(set-goal g-save-for-next-age YES)
)

(defrule
(current-age == castle-age)
(up-compare-goal g-age-status < gv-save-for-imperial)
(goal g-next-town-center-tech imperial-age)
=>
(set-goal g-age-status gv-save-for-imperial)
(set-goal g-save-for-next-age YES)
)



;========Mill

;Horse Collar

(defrule
(building-type-count mill > 0)
(up-compare-goal g-mill-tech-priority < gv-primary)
(up-research-status c: ri-horse-collar == research-available)
(or
	(goal g-town-under-attack NO)
	(up-compare-goal g-desired-num-farmers >= 12))
(up-compare-goal g-age-status >= gv-advancing-to-castle)
(up-research-status c: ri-double-bit-axe >= research-pending)
=>
(set-goal g-next-mill-tech ri-horse-collar)
(set-goal g-mill-tech-priority gv-primary)
)

;Heavy Plow

(defrule
(building-type-count mill > 0)
(up-compare-goal g-mill-tech-priority < gv-primary)
(up-research-status c: ri-heavy-plow == research-available)
(or
	(unit-type-count villager >= 70)
	(current-age == imperial-age))
(up-research-status c: ri-wheel-barrow >= research-pending)
=>
(set-goal g-next-mill-tech ri-heavy-plow)
(set-goal g-mill-tech-priority gv-primary)
)

(defrule
(building-type-count mill > 0)
(up-compare-goal g-mill-tech-priority < gv-secondary)
(up-research-status c: ri-heavy-plow == research-available)
(or
	(goal g-town-under-attack NO)
	(up-compare-goal g-desired-num-farmers >= 12))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(unit-type-count villager-farmer >= 4)
(up-research-status c: ri-wheel-barrow >= research-pending)
=>
(set-goal g-next-mill-tech ri-heavy-plow)
(set-goal g-mill-tech-priority gv-secondary)
)

;Crop Rotation

(defrule
(building-type-count mill > 0)
(up-compare-goal g-mill-tech-priority < gv-secondary)
(up-research-status c: ri-crop-rotation == research-available)
(unit-type-count villager-farmer > 8)
=>
(set-goal g-next-mill-tech ri-crop-rotation)
(set-goal g-mill-tech-priority gv-secondary)
)



;========Mining Camp

;Gold Mining

(defrule
(building-type-count mining-camp > 0)
(up-compare-goal g-mining-camp-tech-priority < gv-primary)
(up-research-status c: ri-gold-mining == research-available)
(goal g-town-under-attack NO)
(unit-type-count villager-gold >= 2)
(current-age == imperial-age)
(up-gaia-type-count c: gold > 0)
=>
(set-goal g-next-mining-camp-tech ri-gold-mining)
(set-goal g-mining-camp-tech-priority gv-primary)
)

(defrule
(building-type-count mining-camp > 0)
(up-compare-goal g-mining-camp-tech-priority < gv-secondary)
(up-research-status c: ri-gold-mining == research-available)
(goal g-town-under-attack NO)
(unit-type-count villager-gold >= 8)
(up-research-status c: ri-double-bit-axe >= research-pending)
(or
	(up-research-status	c: ri-horse-collar >= research-pending)
	(up-research-status c: castle-age >= research-pending))
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(up-gaia-type-count c: gold > 0)
=>
(set-goal g-next-mining-camp-tech ri-gold-mining)
(set-goal g-mining-camp-tech-priority gv-secondary)
)

;Gold Shaft Mining

(defrule
(building-type-count mining-camp > 0)
(up-compare-goal g-mining-camp-tech-priority < gv-low)
(up-research-status c: ri-gold-shaft-mining == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(goal g-town-under-attack NO)
(up-research-status c: ri-heavy-plow >= research-pending)
(unit-type-count villager-gold >= 5)
(up-gaia-type-count c: gold > 10)
=>
(set-goal g-next-mining-camp-tech ri-gold-shaft-mining)
(set-goal g-mining-camp-tech-priority gv-low)
)

(defrule
(building-type-count mining-camp > 0)
(up-compare-goal g-mining-camp-tech-priority < gv-excess-only)
(up-research-status c: ri-gold-shaft-mining == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(up-research-status c: ri-heavy-plow >= research-pending)
(unit-type-count villager-gold >= 5)
(up-gaia-type-count c: gold > 3)
=>
(set-goal g-next-mining-camp-tech ri-gold-shaft-mining)
(set-goal g-mining-camp-tech-priority gv-excess-only)
)

;Stone Mining

(defrule
(building-type-count mining-camp > 0)
(up-compare-goal g-mining-camp-tech-priority < gv-low)
(up-research-status c: ri-stone-mining == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(unit-type-count villager-stone >= 6)
(up-research-status c: ri-double-bit-axe >= research-pending)
(or
	(up-research-status	c: ri-horse-collar >= research-pending)
	(up-research-status c: castle-age >= research-pending))
(up-compare-goal g-watch-tower-line g:< g-desired-num-watch-tower)
(up-compare-goal g-desired-num-watch-tower >= 4)
(up-gaia-type-count c: stone > 3)
=>
(set-goal g-next-mining-camp-tech ri-stone-mining)
(set-goal g-mining-camp-tech-priority gv-low)
)

(defrule
(building-type-count mining-camp > 0)
(up-compare-goal g-mining-camp-tech-priority < gv-excess-only)
(up-research-status c: ri-stone-mining == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(unit-type-count villager-stone >= 4)
(up-research-status c: castle-age >= research-pending)
(up-research-status c: ri-gold-mining >= research-pending)
(up-object-type-count-total c: castle g:< g-desired-num-castle)
(up-gaia-type-count c: stone > 3)
=>
(set-goal g-next-mining-camp-tech ri-stone-mining)
(set-goal g-mining-camp-tech-priority gv-excess-only)
)

;Stone Shaft Mining

(defrule
(building-type-count mining-camp > 0)
(up-compare-goal g-mining-camp-tech-priority < gv-excess-only)
(up-research-status c: ri-stone-shaft-mining == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(unit-type-count villager-stone > 5)
(up-object-type-count-total c: castle g:< g-desired-num-castle)
(up-gaia-type-count c: stone > 10)
=>
(set-goal g-next-mining-camp-tech ri-stone-shaft-mining)
(set-goal g-mining-camp-tech-priority gv-excess-only)
)

(defrule
(building-type-count mining-camp > 0)
(up-compare-goal g-mining-camp-tech-priority < gv-high-excess-only)
(up-research-status c: ri-stone-shaft-mining == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(unit-type-count villager-stone > 5)
(up-object-type-count-total c: castle g:< g-desired-num-castle)
(up-gaia-type-count c: stone > 3)
=>
(set-goal g-next-mining-camp-tech ri-stone-shaft-mining)
(set-goal g-mining-camp-tech-priority gv-high-excess-only)
)

(defrule
(building-type-count mining-camp > 0)
(up-compare-goal g-mining-camp-tech-priority < gv-high-excess-only)
(up-research-status c: ri-stone-shaft-mining == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(unit-type-count villager-stone > 5)
(or
	(up-compare-goal g-watch-tower-line g:< g-desired-num-watch-tower)
	(up-object-type-count-total c: bombard-tower g:< g-desired-num-bombard-tower))
(or
	(up-compare-goal g-desired-num-watch-tower >= 6)
	(up-compare-goal g-desired-num-bombard-tower >= 4))
(up-gaia-type-count c: stone > 3)
=>
(set-goal g-next-mining-camp-tech ri-stone-shaft-mining)
(set-goal g-mining-camp-tech-priority gv-high-excess-only)
)



;========Lumber Camp

;Double-Bit Axe

(defrule
(building-type-count lumber-camp > 0)
(up-compare-goal g-lumber-camp-tech-priority < gv-primary)
(up-research-status c: ri-double-bit-axe == research-available)
(up-compare-goal g-age-status >= gv-advancing-to-castle)
=>
(set-goal g-next-lumber-camp-tech ri-double-bit-axe)
(set-goal g-lumber-camp-tech-priority gv-primary)
)

;Bow Saw

(defrule
(building-type-count lumber-camp > 0)
(up-compare-goal g-lumber-camp-tech-priority < gv-primary)
(up-research-status c: ri-bow-saw == research-available)
(goal g-town-under-attack NO)
(unit-type-count villager-wood > 7)
=>
(set-goal g-next-lumber-camp-tech ri-bow-saw)
(set-goal g-lumber-camp-tech-priority gv-primary)
)

;Two-Man Saw

(defrule
(building-type-count lumber-camp > 0)
(up-compare-goal g-lumber-camp-tech-priority < gv-tertiary)
(up-research-status c: ri-two-man-saw == research-available)
(goal g-town-under-attack NO)
(unit-type-count villager-wood > 10)
=>
(set-goal g-next-lumber-camp-tech ri-two-man-saw)
(set-goal g-lumber-camp-tech-priority gv-tertiary)
)



;========Blacksmith

;Fletching

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-primary)
(up-research-status c: ri-fletching == research-available)
(up-compare-goal g-desired-num-pierce-attack-units > 10)
(goal g-strategy gv-strongbow)
=>
(set-goal g-next-blacksmith-tech ri-fletching)
(set-goal g-blacksmith-tech-priority gv-primary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-primary)
(up-research-status c: ri-fletching == research-available)
(up-compare-goal g-desired-num-pierce-attack-units > 10)
(or
	(goal g-primary-unit-class gv-archer)
	(goal g-primary-unit-class gv-cavalry-archer))
=>
(set-goal g-next-blacksmith-tech ri-fletching)
(set-goal g-blacksmith-tech-priority gv-primary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-primary)
(up-research-status c: ri-fletching == research-available)
(up-compare-goal g-desired-num-pierce-attack-units > 5)
(or
	(current-age == imperial-age)
	(or
		(unit-type-count archery-class > 10)
		(unit-type-count cavalry-archer-class > 8)))
=>
(set-goal g-next-blacksmith-tech ri-fletching)
(set-goal g-blacksmith-tech-priority gv-primary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-fletching == research-available)
(up-compare-goal g-desired-num-pierce-attack-units > 10)
(or
	(goal g-secondary-unit-class gv-archer)
	(goal g-secondary-unit-class gv-cavalry-archer))
=>
(set-goal g-next-blacksmith-tech ri-fletching)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-fletching == research-available)
(up-compare-goal g-desired-num-pierce-attack-units > 10)
(or
	(goal g-tertiary-unit-class gv-archer)
	(goal g-tertiary-unit-class gv-cavalry-archer))
=>
(set-goal g-next-blacksmith-tech ri-fletching)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-tertiary)
(up-research-status c: ri-fletching == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(up-compare-goal g-desired-num-pierce-attack-units > 10)
=>
(set-goal g-next-blacksmith-tech ri-fletching)
(set-goal g-blacksmith-tech-priority gv-tertiary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-low)
(up-research-status c: ri-fletching == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(up-compare-goal g-desired-num-pierce-attack-units > 5)
=>
(set-goal g-next-blacksmith-tech ri-fletching)
(set-goal g-blacksmith-tech-priority gv-low)
)

;Bodkin Arrow

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-primary)
(up-research-status c: ri-bodkin-arrow == research-available)
(up-compare-goal g-desired-num-pierce-attack-units > 7)
(or
	(goal g-primary-unit-class gv-archer)
	(goal g-primary-unit-class gv-cavalry-archer))
=>
(set-goal g-next-blacksmith-tech ri-bodkin-arrow)
(set-goal g-blacksmith-tech-priority gv-primary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-primary)
(up-research-status c: ri-bodkin-arrow == research-available)
(up-compare-goal g-desired-num-pierce-attack-units > 0)
(or
	(current-age == imperial-age)
	(or
		(unit-type-count archery-class > 15)
		(unit-type-count cavalry-archer-class > 12)))
=>
(set-goal g-next-blacksmith-tech ri-bodkin-arrow)
(set-goal g-blacksmith-tech-priority gv-primary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-bodkin-arrow == research-available)
(up-compare-goal g-desired-num-pierce-attack-units > 7)
(or
	(goal g-secondary-unit-class gv-archer)
	(goal g-secondary-unit-class gv-cavalry-archer))
=>
(set-goal g-next-blacksmith-tech ri-bodkin-arrow)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-bodkin-arrow == research-available)
(up-compare-goal g-desired-num-pierce-attack-units > 7)
(or
	(goal g-tertiary-unit-class gv-archer)
	(goal g-tertiary-unit-class gv-cavalry-archer))
=>
(set-goal g-next-blacksmith-tech ri-bodkin-arrow)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-tertiary)
(up-research-status c: ri-bodkin-arrow == research-available)
(up-compare-goal g-desired-num-pierce-attack-units > 5)
=>
(set-goal g-next-blacksmith-tech ri-bodkin-arrow)
(set-goal g-blacksmith-tech-priority gv-tertiary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-low)
(up-research-status c: ri-bodkin-arrow == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(up-compare-goal g-desired-num-pierce-attack-units > 0)
=>
(set-goal g-next-blacksmith-tech ri-bodkin-arrow)
(set-goal g-blacksmith-tech-priority gv-low)
)

;Scale Barding

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-primary)
(up-research-status c: ri-scale-barding == research-available)
(up-research-status c: castle-age >= research-pending)
(or
	(goal g-initial-strategy gv-krush)
	(goal g-initial-strategy gv-crush))
;(unit-type-count cavalry-class >= 4)
=>
(set-goal g-next-blacksmith-tech ri-scale-barding)
(set-goal g-blacksmith-tech-priority gv-primary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-primary)
(up-research-status c: ri-scale-barding == research-available)
(up-research-status c: castle-age >= research-pending)
(up-compare-goal g-desired-num-cavalry > 4)
(or	
	(goal g-primary-unit knight)
	(goal g-primary-unit camel))
=>
(set-goal g-next-blacksmith-tech ri-scale-barding)
(set-goal g-blacksmith-tech-priority gv-primary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-primary)
(up-research-status c: ri-scale-barding == research-available)
(up-research-status c: castle-age >= research-pending)
(up-compare-goal g-desired-num-cavalry > 0)
(or
	(current-age == imperial-age)
	(unit-type-count cavalry-class > 10))
=>
(set-goal g-next-blacksmith-tech ri-scale-barding)
(set-goal g-blacksmith-tech-priority gv-primary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-scale-barding == research-available)
(up-compare-goal g-desired-num-cavalry > 4)
(or	
	(goal g-primary-unit scout-cavalry)
	(or
		(goal g-primary-unit battle-elephant)
		(and
			(goal g-primary-unit my-unique-unit)
			(or
				(goal g-primary-unit-class gv-cavalry)
				(goal g-primary-unit-class gv-ballista-elephant)))))
(up-compare-goal g-attack-status >= gv-first-attack)
=>
(set-goal g-next-blacksmith-tech ri-scale-barding)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-scale-barding == research-available)
(up-research-status c: castle-age >= research-pending)
(up-compare-goal g-desired-num-cavalry > 4)
(or	
	(goal g-primary-unit scout-cavalry)
	(or
		(goal g-primary-unit battle-elephant)
		(and
			(goal g-primary-unit my-unique-unit)
			(goal g-primary-unit-class gv-cavalry))))
(up-compare-flag g-excess-resources-flag == gv-food)
=>
(set-goal g-next-blacksmith-tech ri-scale-barding)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-scale-barding == research-available)
(up-research-status c: castle-age >= research-pending)
(up-compare-goal g-desired-num-cavalry > 4)
(or
	(goal g-secondary-unit-class gv-cavalry)
	(goal g-secondary-unit-class gv-ballista-elephant))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
=>
(set-goal g-next-blacksmith-tech ri-scale-barding)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-scale-barding == research-available)
(up-research-status c: castle-age >= research-pending)
(up-compare-goal g-desired-num-cavalry > 4)
(or
	(goal g-tertiary-unit-class gv-cavalry)
	(goal g-tertiary-unit-class gv-ballista-elephant))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
=>
(set-goal g-next-blacksmith-tech ri-scale-barding)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-tertiary)
(up-research-status c: ri-scale-barding == research-available)
(up-research-status c: castle-age >= research-pending)
(up-compare-goal g-desired-num-cavalry > 3)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
=>
(set-goal g-next-blacksmith-tech ri-scale-barding)
(set-goal g-blacksmith-tech-priority gv-tertiary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-excess-only)
(up-research-status c: ri-scale-barding == research-available)
(up-research-status c: castle-age >= research-pending)
(up-compare-goal g-desired-num-cavalry > 0)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
=>
(set-goal g-next-blacksmith-tech ri-scale-barding)
(set-goal g-blacksmith-tech-priority gv-excess-only)
)

;Chain Barding

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-primary)
(up-research-status c: ri-chain-barding == research-available)
(or
	(goal g-initial-strategy gv-krush)
	(goal g-initial-strategy gv-crush))
(or	
	(goal g-primary-unit knight)
	(goal g-primary-unit camel))
(unit-type-count cavalry-class >= 6)
=>
(set-goal g-next-blacksmith-tech ri-chain-barding)
(set-goal g-blacksmith-tech-priority gv-primary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-primary)
(up-research-status c: ri-chain-barding == research-available)
(up-compare-goal g-desired-num-cavalry > 4)
(or
	(current-age == imperial-age)
	(unit-type-count cavalry-class > 15))
=>
(set-goal g-next-blacksmith-tech ri-chain-barding)
(set-goal g-blacksmith-tech-priority gv-primary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-chain-barding == research-available)
(up-compare-goal g-desired-num-cavalry > 6)
(or
	(goal g-primary-unit-class gv-cavalry)
	(goal g-primary-unit-class gv-ballista-elephant))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-chain-barding)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-chain-barding == research-available)
(up-compare-goal g-desired-num-cavalry > 6)
(or
	(goal g-secondary-unit-class gv-cavalry)
	(goal g-secondary-unit-class gv-ballista-elephant))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-chain-barding)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-tertiary)
(up-research-status c: ri-chain-barding == research-available)
(up-compare-goal g-desired-num-cavalry > 6)
(or
	(goal g-tertiary-unit-class gv-cavalry)
	(goal g-tertiary-unit-class gv-ballista-elephant))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-chain-barding)
(set-goal g-blacksmith-tech-priority gv-tertiary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-low)
(up-research-status c: ri-chain-barding == research-available)
(up-compare-goal g-desired-num-cavalry > 4)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-chain-barding)
(set-goal g-blacksmith-tech-priority gv-low)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-excess-only)
(up-research-status c: ri-chain-barding == research-available)
(up-compare-goal g-desired-num-cavalry > 0)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-chain-barding)
(set-goal g-blacksmith-tech-priority gv-excess-only)
)

;Scale Mail

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-primary)
(up-research-status c: ri-scale-mail == research-available)
(up-research-status c: castle-age >= research-pending)
(goal g-initial-strategy gv-eagles-revenge)
;(unit-type-count infantry-class >= 6)
=>
(set-goal g-next-blacksmith-tech ri-scale-mail)
(set-goal g-blacksmith-tech-priority gv-primary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-primary)
(up-research-status c: ri-scale-mail == research-available)
(up-research-status c: castle-age >= research-pending)
(up-compare-goal g-desired-num-infantry > 6)
(goal g-primary-unit-class gv-infantry)
=>
(set-goal g-next-blacksmith-tech ri-scale-mail)
(set-goal g-blacksmith-tech-priority gv-primary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-primary)
(up-research-status c: ri-scale-mail == research-available)
(up-research-status c: castle-age >= research-pending)
(up-compare-goal g-desired-num-infantry > 0)
(or
	(current-age == imperial-age)
	(unit-type-count infantry-class >= 12))
=>
(set-goal g-next-blacksmith-tech ri-scale-mail)
(set-goal g-blacksmith-tech-priority gv-primary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-scale-mail == research-available)
(up-research-status c: castle-age >= research-pending)
(up-compare-goal g-desired-num-infantry > 6)
(goal g-secondary-unit-class gv-infantry)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
=>
(set-goal g-next-blacksmith-tech ri-scale-mail)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-scale-mail == research-available)
(up-research-status c: castle-age >= research-pending)
(up-compare-goal g-desired-num-infantry > 6)
(goal g-tertiary-unit-class gv-infantry)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
=>
(set-goal g-next-blacksmith-tech ri-scale-mail)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-tertiary)
(up-research-status c: ri-scale-mail == research-available)
(up-research-status c: castle-age >= research-pending)
(up-compare-goal g-desired-num-infantry > 4)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
=>
(set-goal g-next-blacksmith-tech ri-scale-mail)
(set-goal g-blacksmith-tech-priority gv-tertiary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-excess-only)
(up-research-status c: ri-scale-mail == research-available)
(up-research-status c: castle-age >= research-pending)
(up-compare-goal g-desired-num-infantry > 0)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
=>
(set-goal g-next-blacksmith-tech ri-scale-mail)
(set-goal g-blacksmith-tech-priority gv-excess-only)
)

;Chain Mail

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-primary)
(up-research-status c: ri-chain-mail == research-available)
(goal g-initial-strategy gv-eagles-revenge)
(goal g-primary-unit-class gv-infantry)
(unit-type-count infantry-class >= 8)
=>
(set-goal g-next-blacksmith-tech ri-chain-mail)
(set-goal g-blacksmith-tech-priority gv-primary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-primary)
(up-research-status c: ri-chain-mail == research-available)
(or
	(current-age == imperial-age)
	(unit-type-count infantry-class >= 20))
=>
(set-goal g-next-blacksmith-tech ri-chain-mail)
(set-goal g-blacksmith-tech-priority gv-primary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-chain-mail == research-available)
(up-compare-goal g-desired-num-infantry > 8)
(or
	(goal g-primary-unit-class gv-infantry)
	(goal g-secondary-unit-class gv-infantry))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-chain-mail)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-tertiary)
(up-research-status c: ri-chain-mail == research-available)
(up-compare-goal g-desired-num-infantry > 8)
(goal g-tertiary-unit-class gv-infantry)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-chain-mail)
(set-goal g-blacksmith-tech-priority gv-tertiary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-low)
(up-research-status c: ri-chain-mail == research-available)
(up-compare-goal g-desired-num-infantry > 5)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-chain-mail)
(set-goal g-blacksmith-tech-priority gv-low)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-excess-only)
(up-research-status c: ri-chain-mail == research-available)
(up-compare-goal g-desired-num-infantry > 0)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-chain-mail)
(set-goal g-blacksmith-tech-priority gv-excess-only)
)

;Padded Archer Armor

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-primary)
(up-research-status c: ri-padded-archer-armor == research-available)
(up-compare-goal g-desired-num-archer-armor-units > 0)
(or
	(current-age == imperial-age)
	(or
		(unit-type-count archery-class > 12)
		(unit-type-count cavalry-archer-class > 10)))
=>
(set-goal g-next-blacksmith-tech ri-padded-archer-armor)
(set-goal g-blacksmith-tech-priority gv-primary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-padded-archer-armor == research-available)
(up-compare-goal g-desired-num-archer-armor-units > 6)
(or
	(goal g-primary-unit-class gv-archer)
	(or
		(goal g-primary-unit-class gv-cavalry-archer)
		(or
			(goal g-primary-unit-class gv-janissary)
			(goal g-primary-unit-class gv-conquistador))))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
=>
(set-goal g-next-blacksmith-tech ri-padded-archer-armor)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-padded-archer-armor == research-available)
(up-compare-goal g-desired-num-archer-armor-units > 6)
(or
	(goal g-secondary-unit-class gv-archer)
	(or
		(goal g-secondary-unit-class gv-cavalry-archer)
		(or
			(goal g-secondary-unit-class gv-janissary)
			(goal g-secondary-unit-class gv-conquistador))))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
=>
(set-goal g-next-blacksmith-tech ri-padded-archer-armor)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-padded-archer-armor == research-available)
(up-compare-goal g-desired-num-archer-armor-units > 6)
(or
	(goal g-tertiary-unit-class gv-archer)
	(or
		(goal g-tertiary-unit-class gv-cavalry-archer)
		(or
			(goal g-tertiary-unit-class gv-janissary)
			(goal g-tertiary-unit-class gv-conquistador))))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
=>
(set-goal g-next-blacksmith-tech ri-padded-archer-armor)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-tertiary)
(up-research-status c: ri-padded-archer-armor == research-available)
(up-compare-goal g-desired-num-archer-armor-units > 4)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
=>
(set-goal g-next-blacksmith-tech ri-padded-archer-armor)
(set-goal g-blacksmith-tech-priority gv-tertiary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-excess-only)
(up-research-status c: ri-padded-archer-armor == research-available)
(up-compare-goal g-desired-num-archer-armor-units > 0)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
=>
(set-goal g-next-blacksmith-tech ri-padded-archer-armor)
(set-goal g-blacksmith-tech-priority gv-excess-only)
)

;Leather Archer Armor

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-leather-archer-armor == research-available)
(up-compare-goal g-desired-num-archer-armor-units > 8)
(or
	(goal g-primary-unit-class gv-archer)
	(or
		(goal g-primary-unit-class gv-cavalry-archer)
		(or
			(goal g-primary-unit-class gv-janissary)
			(goal g-primary-unit-class gv-conquistador))))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-leather-archer-armor)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-leather-archer-armor == research-available)
(up-compare-goal g-desired-num-archer-armor-units > 4)
(or
	(current-age == imperial-age)
	(or
		(unit-type-count archery-class > 20)
		(unit-type-count cavalry-archer-class > 15)))
=>
(set-goal g-next-blacksmith-tech ri-leather-archer-armor)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-tertiary)
(up-research-status c: ri-leather-archer-armor == research-available)
(up-compare-goal g-desired-num-archer-armor-units > 8)
(or
	(goal g-secondary-unit-class gv-archer)
	(or
		(goal g-secondary-unit-class gv-cavalry-archer)
		(or
			(goal g-secondary-unit-class gv-janissary)
			(goal g-secondary-unit-class gv-conquistador))))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-leather-archer-armor)
(set-goal g-blacksmith-tech-priority gv-tertiary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-tertiary)
(up-research-status c: ri-leather-archer-armor == research-available)
(up-compare-goal g-desired-num-archer-armor-units > 8)
(or
	(goal g-tertiary-unit-class gv-archer)
	(or
		(goal g-tertiary-unit-class gv-cavalry-archer)
		(or
			(goal g-tertiary-unit-class gv-janissary)
			(goal g-tertiary-unit-class gv-conquistador))))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-leather-archer-armor)
(set-goal g-blacksmith-tech-priority gv-tertiary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-low)
(up-research-status c: ri-leather-archer-armor == research-available)
(up-compare-goal g-desired-num-archer-armor-units > 5)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-leather-archer-armor)
(set-goal g-blacksmith-tech-priority gv-low)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-excess-only)
(up-research-status c: ri-leather-archer-armor == research-available)
(up-compare-goal g-desired-num-archer-armor-units > 0)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-leather-archer-armor)
(set-goal g-blacksmith-tech-priority gv-excess-only)
)

;Forging

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-primary)
(up-research-status c: ri-forging == research-available)
(or
	(current-age == imperial-age)
	(or
		(unit-type-count infantry-class > 12)
		(unit-type-count cavalry-class > 10)))
=>
(set-goal g-next-blacksmith-tech ri-forging)
(set-goal g-blacksmith-tech-priority gv-primary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-forging == research-available)
(or
	(up-compare-goal g-desired-num-infantry > 6)
	(up-compare-goal g-desired-num-cavalry > 6))
(or
	(goal g-primary-unit-class gv-infantry)
	(goal g-primary-unit-class gv-cavalry))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
=>
(set-goal g-next-blacksmith-tech ri-forging)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-forging == research-available)
(or
	(up-compare-goal g-desired-num-infantry > 6)
	(up-compare-goal g-desired-num-cavalry > 6))
(or
	(goal g-secondary-unit-class gv-infantry)
	(goal g-secondary-unit-class gv-cavalry))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
=>
(set-goal g-next-blacksmith-tech ri-forging)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-forging == research-available)
(or
	(up-compare-goal g-desired-num-infantry > 6)
	(up-compare-goal g-desired-num-cavalry > 6))
(or
	(goal g-tertiary-unit-class gv-infantry)
	(goal g-tertiary-unit-class gv-cavalry))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
=>
(set-goal g-next-blacksmith-tech ri-forging)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-tertiary)
(up-research-status c: ri-forging == research-available)
(or
	(up-compare-goal g-desired-num-infantry > 4)
	(up-compare-goal g-desired-num-cavalry > 4))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
=>
(set-goal g-next-blacksmith-tech ri-forging)
(set-goal g-blacksmith-tech-priority gv-tertiary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-excess-only)
(up-research-status c: ri-forging == research-available)
(or
	(up-compare-goal g-desired-num-infantry > 0)
	(up-compare-goal g-desired-num-cavalry > 0))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
=>
(set-goal g-next-blacksmith-tech ri-forging)
(set-goal g-blacksmith-tech-priority gv-excess-only)
)

;Iron Casting

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-primary)
(up-research-status c: ri-iron-casting == research-available)
(or
	(current-age == imperial-age)
	(or
		(unit-type-count infantry-class > 18)
		(unit-type-count cavalry-class > 15)))
=>
(set-goal g-next-blacksmith-tech ri-iron-casting)
(set-goal g-blacksmith-tech-priority gv-primary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-iron-casting == research-available)
(or
	(up-compare-goal g-desired-num-infantry > 8)
	(up-compare-goal g-desired-num-cavalry > 8))
(or
	(goal g-primary-unit-class gv-infantry)
	(goal g-primary-unit-class gv-cavalry))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-iron-casting)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-tertiary)
(up-research-status c: ri-iron-casting == research-available)
(or
	(up-compare-goal g-desired-num-infantry > 8)
	(up-compare-goal g-desired-num-cavalry > 8))
(or
	(goal g-secondary-unit-class gv-infantry)
	(goal g-secondary-unit-class gv-cavalry))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-iron-casting)
(set-goal g-blacksmith-tech-priority gv-tertiary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-tertiary)
(up-research-status c: ri-iron-casting == research-available)
(or
	(up-compare-goal g-desired-num-infantry > 8)
	(up-compare-goal g-desired-num-cavalry > 8))
(or
	(goal g-tertiary-unit-class gv-infantry)
	(goal g-tertiary-unit-class gv-cavalry))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-iron-casting)
(set-goal g-blacksmith-tech-priority gv-tertiary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-low)
(up-research-status c: ri-iron-casting == research-available)
(or
	(up-compare-goal g-desired-num-infantry > 6)
	(up-compare-goal g-desired-num-cavalry > 6))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-iron-casting)
(set-goal g-blacksmith-tech-priority gv-low)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-excess-only)
(up-research-status c: ri-iron-casting == research-available)
(or
	(up-compare-goal g-desired-num-infantry > 0)
	(up-compare-goal g-desired-num-cavalry > 0))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-iron-casting)
(set-goal g-blacksmith-tech-priority gv-excess-only)
)

;Bracer

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-primary)
(up-research-status c: ri-bracer == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(up-compare-goal g-desired-num-pierce-attack-units > 7)
(or
	(goal g-primary-unit-class gv-archer)
	(goal g-primary-unit-class gv-cavalry-archer))
=>
(set-goal g-next-blacksmith-tech ri-bracer)
(set-goal g-blacksmith-tech-priority gv-primary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-bracer == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(up-compare-goal g-desired-num-pierce-attack-units > 7)
(or
	(goal g-secondary-unit-class gv-archer)
	(goal g-secondary-unit-class gv-cavalry-archer))
=>
(set-goal g-next-blacksmith-tech ri-bracer)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-bracer == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(up-compare-goal g-desired-num-pierce-attack-units > 7)
(or
	(goal g-tertiary-unit-class gv-archer)
	(goal g-tertiary-unit-class gv-cavalry-archer))
=>
(set-goal g-next-blacksmith-tech ri-bracer)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-tertiary)
(up-research-status c: ri-bracer == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(up-compare-goal g-desired-num-pierce-attack-units > 5)
=>
(set-goal g-next-blacksmith-tech ri-bracer)
(set-goal g-blacksmith-tech-priority gv-tertiary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-low)
(up-research-status c: ri-bracer == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(up-compare-goal g-desired-num-pierce-attack-units > 0)
=>
(set-goal g-next-blacksmith-tech ri-bracer)
(set-goal g-blacksmith-tech-priority gv-low)
)

;Plate Barding

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-plate-barding == research-available)
(up-compare-goal g-desired-num-cavalry > 6)
(or
	(goal g-primary-unit-class gv-cavalry)
	(goal g-primary-unit-class gv-ballista-elephant))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-plate-barding)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-plate-barding == research-available)
(up-compare-goal g-desired-num-cavalry > 6)
(or
	(goal g-secondary-unit-class gv-cavalry)
	(goal g-secondary-unit-class gv-ballista-elephant))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-plate-barding)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-tertiary)
(up-research-status c: ri-plate-barding == research-available)
(up-compare-goal g-desired-num-cavalry > 6)
(or
	(goal g-tertiary-unit-class gv-cavalry)
	(goal g-tertiary-unit-class gv-ballista-elephant))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-plate-barding)
(set-goal g-blacksmith-tech-priority gv-tertiary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-low)
(up-research-status c: ri-plate-barding == research-available)
(up-compare-goal g-desired-num-cavalry > 4)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-plate-barding)
(set-goal g-blacksmith-tech-priority gv-low)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-excess-only)
(up-research-status c: ri-plate-barding == research-available)
(up-compare-goal g-desired-num-cavalry > 0)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-plate-barding)
(set-goal g-blacksmith-tech-priority gv-excess-only)
)

;Plate Mail

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-plate-mail == research-available)
(up-compare-goal g-desired-num-infantry > 8)
(or
	(goal g-primary-unit-class gv-infantry)
	(goal g-secondary-unit-class gv-infantry))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-plate-mail)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-tertiary)
(up-research-status c: ri-plate-mail == research-available)
(up-compare-goal g-desired-num-infantry > 8)
(goal g-tertiary-unit-class gv-infantry)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-plate-mail)
(set-goal g-blacksmith-tech-priority gv-tertiary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-low)
(up-research-status c: ri-plate-mail == research-available)
(up-compare-goal g-desired-num-infantry > 6)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-plate-mail)
(set-goal g-blacksmith-tech-priority gv-low)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-excess-only)
(up-research-status c: ri-plate-mail == research-available)
(up-compare-goal g-desired-num-infantry > 0)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-plate-mail)
(set-goal g-blacksmith-tech-priority gv-excess-only)
)

;Ring Archer Armor

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-ring-archer-armor == research-available)
(up-compare-goal g-desired-num-archer-armor-units > 8)
(or
	(goal g-primary-unit-class gv-archer)
	(or
		(goal g-primary-unit-class gv-cavalry-archer)
		(or
			(goal g-primary-unit-class gv-janissary)
			(goal g-primary-unit-class gv-conquistador))))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-ring-archer-armor)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-tertiary)
(up-research-status c: ri-ring-archer-armor == research-available)
(up-compare-goal g-desired-num-archer-armor-units > 8)
(or
	(goal g-secondary-unit-class gv-archer)
	(or
		(goal g-secondary-unit-class gv-cavalry-archer)
		(or
			(goal g-secondary-unit-class gv-janissary)
			(goal g-secondary-unit-class gv-conquistador))))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-ring-archer-armor)
(set-goal g-blacksmith-tech-priority gv-tertiary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-tertiary)
(up-research-status c: ri-ring-archer-armor == research-available)
(up-compare-goal g-desired-num-archer-armor-units > 8)
(or
	(goal g-tertiary-unit-class gv-archer)
	(or
		(goal g-tertiary-unit-class gv-cavalry-archer)
		(or
			(goal g-tertiary-unit-class gv-janissary)
			(goal g-tertiary-unit-class gv-conquistador))))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-ring-archer-armor)
(set-goal g-blacksmith-tech-priority gv-tertiary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-low)
(up-research-status c: ri-ring-archer-armor == research-available)
(up-compare-goal g-desired-num-archer-armor-units > 6)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-ring-archer-armor)
(set-goal g-blacksmith-tech-priority gv-low)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-excess-only)
(up-research-status c: ri-ring-archer-armor == research-available)
(up-compare-goal g-desired-num-archer-armor-units > 0)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-ring-archer-armor)
(set-goal g-blacksmith-tech-priority gv-excess-only)
)

;Blast Furnace

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-secondary)
(up-research-status c: ri-blast-furnace == research-available)
(or
	(up-compare-goal g-desired-num-infantry > 8)
	(up-compare-goal g-desired-num-cavalry > 8))
(or
	(goal g-primary-unit-class gv-infantry)
	(goal g-primary-unit-class gv-cavalry))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-blast-furnace)
(set-goal g-blacksmith-tech-priority gv-secondary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-tertiary)
(up-research-status c: ri-blast-furnace == research-available)
(or
	(up-compare-goal g-desired-num-infantry > 8)
	(up-compare-goal g-desired-num-cavalry > 8))
(or
	(goal g-secondary-unit-class gv-infantry)
	(goal g-secondary-unit-class gv-cavalry))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-blast-furnace)
(set-goal g-blacksmith-tech-priority gv-tertiary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-tertiary)
(up-research-status c: ri-blast-furnace == research-available)
(or
	(up-compare-goal g-desired-num-infantry > 8)
	(up-compare-goal g-desired-num-cavalry > 8))
(or
	(goal g-tertiary-unit-class gv-infantry)
	(goal g-tertiary-unit-class gv-cavalry))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-blast-furnace)
(set-goal g-blacksmith-tech-priority gv-tertiary)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-low)
(up-research-status c: ri-blast-furnace == research-available)
(or
	(up-compare-goal g-desired-num-infantry > 6)
	(up-compare-goal g-desired-num-cavalry > 6))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-blast-furnace)
(set-goal g-blacksmith-tech-priority gv-low)
)

(defrule
(building-type-count blacksmith > 0)
(up-compare-goal g-blacksmith-tech-priority < gv-excess-only)
(up-research-status c: ri-blast-furnace == research-available)
(or
	(up-compare-goal g-desired-num-infantry > 0)
	(up-compare-goal g-desired-num-cavalry > 0))
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-blacksmith-tech ri-blast-furnace)
(set-goal g-blacksmith-tech-priority gv-excess-only)
)



;========Market

;Cartography

(defrule
(building-type-count market > 0)
(up-compare-goal g-market-tech-priority < gv-secondary)
(up-research-status c: ri-cartography == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-town-under-attack NO)
(player-in-game any-ally)
(current-age >= castle-age)
=>
(set-goal g-next-market-tech ri-cartography)
(set-goal g-market-tech-priority gv-secondary)
)

;Caravan

(defrule
(building-type-count market > 0)
(up-compare-goal g-market-tech-priority < gv-primary)
(up-research-status c: ri-caravan == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(player-in-game any-ally)
;(population > 150)
(or	
	(up-compare-goal g-desired-num-trade-cart >= 5)
	(unit-type-count trade-cart >= 5))
=>
(set-goal g-next-market-tech ri-caravan)
(set-goal g-market-tech-priority gv-primary)
)

;Guilds

(defrule
(building-type-count market > 0)
(up-compare-goal g-market-tech-priority < gv-tertiary)
(up-research-status c: ri-guilds == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-town-under-attack NO)
(population > 100)
=>
(set-goal g-next-market-tech ri-guilds)
(set-goal g-market-tech-priority gv-tertiary)
)



;========Monastery



;Heresy

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-primary)
(up-research-status c: ri-heresy == research-available)
(players-unit-type-count any-enemy monk > 12)
=>
(set-goal g-next-monastery-tech ri-heresy)
(set-goal g-monastery-tech-priority gv-primary)
)

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-secondary)
(up-research-status c: ri-heresy == research-available)
(players-unit-type-count any-enemy monk > 8)
=>
(set-goal g-next-monastery-tech ri-heresy)
(set-goal g-monastery-tech-priority gv-secondary)
)

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-excess-only)
(up-research-status c: ri-heresy == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(civ-selected aztec)
(up-compare-goal g-desired-num-monks > 10)
=>
(set-goal g-next-monastery-tech ri-heresy)
(set-goal g-monastery-tech-priority gv-excess-only)
)

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-high-excess-only)
(up-research-status c: ri-heresy == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(civ-selected aztec)
(up-compare-goal g-desired-num-monks > 1)
=>
(set-goal g-next-monastery-tech ri-heresy)
(set-goal g-monastery-tech-priority gv-high-excess-only)
)

;Faith

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-tertiary)
(up-research-status c: ri-faith == research-available)
(players-unit-type-count any-enemy monk > 12)
(up-research-status c: ri-heresy != research-available)
=>
(set-goal g-next-monastery-tech ri-faith)
(set-goal g-monastery-tech-priority gv-tertiary)
)

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-low)
(up-research-status c: ri-faith == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(players-unit-type-count any-enemy monk > 8)
(up-research-status c: ri-heresy != research-available)
=>
(set-goal g-next-monastery-tech ri-faith)
(set-goal g-monastery-tech-priority gv-low)
)

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-excess-only)
(up-research-status c: ri-faith == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(civ-selected aztec)
(up-compare-goal g-desired-num-monks > 10)
=>
(set-goal g-next-monastery-tech ri-faith)
(set-goal g-monastery-tech-priority gv-excess-only)
)

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-high-excess-only)
(up-research-status c: ri-faith == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(civ-selected aztec)
(up-compare-goal g-desired-num-monks > 1)
=>
(set-goal g-next-monastery-tech ri-faith)
(set-goal g-monastery-tech-priority gv-high-excess-only)
)

;Block Printing

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-tertiary)
(up-research-status c: ri-block-printing == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(up-compare-goal g-desired-num-monks > 7)
=>
(set-goal g-next-monastery-tech ri-block-printing)
(set-goal g-monastery-tech-priority gv-tertiary)
)

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-low)
(up-research-status c: ri-block-printing == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(up-compare-goal g-desired-num-monks > 3)
=>
(set-goal g-next-monastery-tech ri-block-printing)
(set-goal g-monastery-tech-priority gv-low)
)

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-excess-only)
(up-research-status c: ri-block-printing == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(up-compare-goal g-desired-num-monks > 1)
=>
(set-goal g-next-monastery-tech ri-block-printing)
(set-goal g-monastery-tech-priority gv-excess-only)
)

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-high-excess-only)
(up-research-status c: ri-block-printing == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(up-compare-goal g-desired-num-monks > 1)
=>
(set-goal g-next-monastery-tech ri-block-printing)
(set-goal g-monastery-tech-priority gv-high-excess-only)
)

;Sanctity

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-secondary)
(up-research-status c: ri-sanctity == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(up-compare-goal g-desired-num-monks > 5)
(civ-selected aztec)
=>
(set-goal g-next-monastery-tech ri-sanctity)
(set-goal g-monastery-tech-priority gv-secondary)
)

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-low)
(up-research-status c: ri-sanctity == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(up-compare-goal g-desired-num-monks > 5)
=>
(set-goal g-next-monastery-tech ri-sanctity)
(set-goal g-monastery-tech-priority gv-low)
)

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-excess-only)
(up-research-status c: ri-sanctity == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(up-compare-goal g-desired-num-monks > 1)
=>
(set-goal g-next-monastery-tech ri-sanctity)
(set-goal g-monastery-tech-priority gv-excess-only)
)

;Theocracy

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-tertiary)
(up-research-status c: ri-theocracy == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(up-compare-goal g-desired-num-monks > 7)
=>
(set-goal g-next-monastery-tech ri-theocracy)
(set-goal g-monastery-tech-priority gv-tertiary)
)

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-low)
(up-research-status c: ri-theocracy == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(up-compare-goal g-desired-num-monks > 3)
=>
(set-goal g-next-monastery-tech ri-theocracy)
(set-goal g-monastery-tech-priority gv-low)
)

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-excess-only)
(up-research-status c: ri-theocracy == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(up-compare-goal g-desired-num-monks > 1)
=>
(set-goal g-next-monastery-tech ri-theocracy)
(set-goal g-monastery-tech-priority gv-excess-only)
)

;Illumination

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-low)
(up-research-status c: ri-illumination == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(up-compare-goal g-desired-num-monks > 7)
=>
(set-goal g-next-monastery-tech ri-illumination)
(set-goal g-monastery-tech-priority gv-low)
)

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-excess-only)
(up-research-status c: ri-illumination == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(up-compare-goal g-desired-num-monks > 3)
=>
(set-goal g-next-monastery-tech ri-illumination)
(set-goal g-monastery-tech-priority gv-excess-only)
)

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-high-excess-only)
(up-research-status c: ri-illumination == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(up-compare-goal g-desired-num-monks > 1)
=>
(set-goal g-next-monastery-tech ri-illumination)
(set-goal g-monastery-tech-priority gv-high-excess-only)
)

;Redemption

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-secondary)
(up-research-status c: ri-redemption == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(up-compare-goal g-desired-num-monks > 10)
(civ-selected aztec)
=>
(set-goal g-next-monastery-tech ri-redemption)
(set-goal g-monastery-tech-priority gv-secondary)
)

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-tertiary)
(up-research-status c: ri-redemption == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(up-compare-goal g-desired-num-monks > 10)
=>
(set-goal g-next-monastery-tech ri-redemption)
(set-goal g-monastery-tech-priority gv-tertiary)
)

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-low)
(up-research-status c: ri-redemption == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(up-compare-goal g-desired-num-monks > 5)
=>
(set-goal g-next-monastery-tech ri-redemption)
(set-goal g-monastery-tech-priority gv-low)
)

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-excess-only)
(up-research-status c: ri-redemption == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(up-compare-goal g-desired-num-monks > 3)
=>
(set-goal g-next-monastery-tech ri-redemption)
(set-goal g-monastery-tech-priority gv-excess-only)
)

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-high-excess-only)
(up-research-status c: ri-redemption == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(up-compare-goal g-desired-num-monks > 1)
=>
(set-goal g-next-monastery-tech ri-redemption)
(set-goal g-monastery-tech-priority gv-high-excess-only)
)

;Fervor - don't research if not WK or DE or Aztecs. Tech was bugged in the past.
#load-if-defined UP-GAME-WK

	(defrule
	(building-type-count monastery > 0)
	(up-compare-goal g-monastery-tech-priority < gv-secondary)
	(up-research-status c: ri-fervor == research-available)
	(or
		(up-compare-goal g-attack-status > gv-first-attack)
		(up-compare-flag g-excess-resources-flag == gv-gold))
	(up-compare-goal g-desired-num-monks > 5)
	(civ-selected aztec)
	=>
	(set-goal g-next-monastery-tech ri-fervor)
	(set-goal g-monastery-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count monastery > 0)
	(up-compare-goal g-monastery-tech-priority < gv-low)
	(up-research-status c: ri-fervor == research-available)
	(or
		(up-compare-goal g-attack-status > gv-first-attack)
		(up-compare-flag g-excess-resources-flag == gv-gold))
	(up-compare-goal g-desired-num-monks > 7)
	=>
	(set-goal g-next-monastery-tech ri-fervor)
	(set-goal g-monastery-tech-priority gv-low)
	)

	(defrule
	(building-type-count monastery > 0)
	(up-compare-goal g-monastery-tech-priority < gv-excess-only)
	(up-research-status c: ri-fervor == research-available)
	(or
		(up-compare-goal g-attack-status > gv-first-attack)
		(up-compare-flag g-excess-resources-flag == gv-gold))
	(up-compare-goal g-desired-num-monks > 3)
	=>
	(set-goal g-next-monastery-tech ri-fervor)
	(set-goal g-monastery-tech-priority gv-excess-only)
	)

	(defrule
	(building-type-count monastery > 0)
	(up-compare-goal g-monastery-tech-priority < gv-high-excess-only)
	(up-research-status c: ri-fervor == research-available)
	(or
		(up-compare-goal g-attack-status > gv-first-attack)
		(up-compare-flag g-excess-resources-flag == gv-gold))
	(up-compare-goal g-desired-num-monks > 1)
	=>
	(set-goal g-next-monastery-tech ri-fervor)
	(set-goal g-monastery-tech-priority gv-high-excess-only)
	)

#else

	#load-if-defined AZTEC-CIV

		(defrule
		(building-type-count monastery > 0)
		(up-compare-goal g-monastery-tech-priority < gv-excess-only)
		(up-research-status c: ri-fervor == research-available)
		(or
			(up-compare-goal g-attack-status > gv-first-attack)
			(up-compare-flag g-excess-resources-flag == gv-gold))
		(up-compare-goal g-desired-num-monks > 7)
		=>
		(set-goal g-next-monastery-tech ri-fervor)
		(set-goal g-monastery-tech-priority gv-excess-only)
		)

	#end-if
#end-if

;Atonement

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-tertiary)
(up-research-status c: ri-atonement == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(players-unit-type-count any-enemy monk > 5)
(up-compare-goal g-desired-num-monks > 7)
=>
(set-goal g-next-monastery-tech ri-atonement)
(set-goal g-monastery-tech-priority gv-tertiary)
)

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-low)
(up-research-status c: ri-atonement == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(players-unit-type-count any-enemy monk > 5)
(up-compare-goal g-desired-num-monks > 5)
=>
(set-goal g-next-monastery-tech ri-atonement)
(set-goal g-monastery-tech-priority gv-low)
)

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-excess-only)
(up-research-status c: ri-atonement == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(players-unit-type-count any-enemy monk > 5)
(up-compare-goal g-desired-num-monks > 3)
=>
(set-goal g-next-monastery-tech ri-atonement)
(set-goal g-monastery-tech-priority gv-excess-only)
)

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-excess-only)
(up-research-status c: ri-atonement == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(civ-selected aztec)
(up-compare-goal g-desired-num-monks > 5)
=>
(set-goal g-next-monastery-tech ri-atonement)
(set-goal g-monastery-tech-priority gv-excess-only)
)

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-high-excess-only)
(up-research-status c: ri-atonement == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(players-unit-type-count any-enemy monk > 0)
(up-compare-goal g-desired-num-monks > 1)
=>
(set-goal g-next-monastery-tech ri-atonement)
(set-goal g-monastery-tech-priority gv-high-excess-only)
)

;Herbal Medicine

(defrule
(building-type-count monastery > 0)
(up-compare-goal g-monastery-tech-priority < gv-high-excess-only)
(up-research-status c: ri-herbal-medicine == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-gold))
(civ-selected aztec)
(up-compare-goal g-desired-num-monks > 7)
=>
(set-goal g-next-monastery-tech ri-herbal-medicine)
(set-goal g-monastery-tech-priority gv-high-excess-only)
)



;========University

;Chemistry

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-primary)
(up-research-status c: ri-chemistry == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-hand-cannoneer > 9)
	(or
		(up-compare-goal g-desired-num-bombard-cannon > 2)
		(or
			(up-compare-goal g-desired-num-bombard-tower > 3)
			(up-compare-goal g-desired-num-cannon-galleon > 3))))
=>
(set-goal g-next-university-tech ri-chemistry)
(set-goal g-university-tech-priority gv-primary)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-secondary)
(up-research-status c: ri-chemistry == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-hand-cannoneer > 0)
	(or
		(up-compare-goal g-desired-num-bombard-cannon > 0)
		(or
			(up-compare-goal g-desired-num-bombard-tower > 0)
			(up-compare-goal g-desired-num-cannon-galleon > 0))))
=>
(set-goal g-next-university-tech ri-chemistry)
(set-goal g-university-tech-priority gv-secondary)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-tertiary)
(up-research-status c: ri-chemistry == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(unit-type-count archery-class >= 15)
	(or
		(up-compare-goal g-desired-num-archers >= 25)
		(or
			(unit-type-count cavalry-archer-class >= 12)
			(up-compare-goal g-desired-num-cavalry-archers >= 20))))
=>
(set-goal g-next-university-tech ri-chemistry)
(set-goal g-university-tech-priority gv-tertiary)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-low)
(up-research-status c: ri-chemistry == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(unit-type-count archery-class >= 0)
	(or
		(up-compare-goal g-desired-num-archers >= 0)
		(or
			(unit-type-count cavalry-archer-class >= 0)
			(up-compare-goal g-desired-num-cavalry-archers >= 0))))
=>
(set-goal g-next-university-tech ri-chemistry)
(set-goal g-university-tech-priority gv-low)
)

;Ballistics

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-secondary)
(up-research-status c: ri-ballistics == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-wood-gold))
(or
	(up-compare-goal g-desired-num-pierce-attack-units >= 15)
	(up-compare-goal g-desired-num-galley >= 9))
=>
(set-goal g-next-university-tech ri-ballistics)
(set-goal g-university-tech-priority gv-secondary)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-tertiary)
(up-research-status c: ri-ballistics == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-wood-gold))
(or
	(up-compare-goal g-desired-num-pierce-attack-units >= 10)
	(up-compare-goal g-desired-num-galley >= 6))
=>
(set-goal g-next-university-tech ri-ballistics)
(set-goal g-university-tech-priority gv-tertiary)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-low)
(up-research-status c: ri-ballistics == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-wood-gold))
(or
	(up-compare-goal g-desired-num-pierce-attack-units >= 0)
	(up-compare-goal g-desired-num-galley >= 0))
=>
(set-goal g-next-university-tech ri-ballistics)
(set-goal g-university-tech-priority gv-low)
)

;Siege Engineers

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-secondary)
(up-research-status c: ri-siege-engineers == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(or
	(up-compare-goal g-desired-num-bombard-cannon > 3)
	(or
		(up-compare-goal g-desired-num-mangonel > 3)
		(or
			(unit-type-count-total bombard-cannon > 3)
			(up-compare-goal g-mangonel-line > 3))))
=>
(set-goal g-next-university-tech ri-siege-engineers)
(set-goal g-next-university-tech gv-secondary)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-tertiary)
(up-research-status c: ri-siege-engineers == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(or
	(up-compare-goal g-desired-num-siege > 3)
	(up-compare-goal g-siege-class > 3))
=>
(set-goal g-next-university-tech ri-siege-engineers)
(set-goal g-university-tech-priority gv-tertiary)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-low)
(up-research-status c: ri-siege-engineers == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(or
	(up-compare-goal g-desired-num-siege > 0)
	(up-compare-goal g-siege-class > 0))
=>
(set-goal g-next-university-tech ri-siege-engineers)
(set-goal g-university-tech-priority gv-low)
)

;Bombard Tower

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-secondary)
(up-research-status c: ri-bombard-tower == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(up-compare-goal g-desired-num-bombard-tower > 4)
=>
(set-goal g-next-university-tech ri-bombard-tower)
(set-goal g-university-tech-priority gv-secondary)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-tertiary)
(up-research-status c: ri-bombard-tower == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(up-compare-goal g-desired-num-bombard-tower > 2)
=>
(set-goal g-next-university-tech ri-bombard-tower)
(set-goal g-university-tech-priority gv-tertiary)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-low)
(up-research-status c: ri-bombard-tower == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(up-compare-goal g-desired-num-bombard-tower > 0)
=>
(set-goal g-next-university-tech ri-bombard-tower)
(set-goal g-university-tech-priority gv-low)
)

;Murder Holes

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-tertiary)
(up-research-status c: ri-murder-holes == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-stone))
(building-type-count castle >= 1)
(goal g-town-under-attack YES)
=>
(set-goal g-next-university-tech ri-murder-holes)
(set-goal g-university-tech-priority gv-tertiary)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-low)
(up-research-status c: ri-murder-holes == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-stone))
(or
	(building-type-count-total castle >= 3)
	(or
		(up-compare-goal g-watch-tower-line >= 5)
		(building-type-count bombard-tower >= 5)))
=>
(set-goal g-next-university-tech ri-murder-holes)
(set-goal g-university-tech-priority gv-low)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-excess-only)
(up-research-status c: ri-murder-holes == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-stone))
(or
	(building-type-count-total castle >= 2)
	(or
		(up-compare-goal g-watch-tower-line >= 3)
		(building-type-count bombard-tower >= 3)))
=>
(set-goal g-next-university-tech ri-murder-holes)
(set-goal g-university-tech-priority gv-excess-only)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-high-excess-only)
(up-research-status c: ri-murder-holes == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-stone))
(or
	(building-type-count-total castle >= 1)
	(or
		(up-compare-goal g-watch-tower-line >= 2)
		(building-type-count bombard-tower >= 2)))
=>
(set-goal g-next-university-tech ri-murder-holes)
(set-goal g-university-tech-priority gv-high-excess-only)
)

;Guard Tower

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-low)
(up-research-status c: ri-guard-tower == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(or
	(up-compare-goal g-desired-num-watch-tower > 5)
	(up-compare-goal g-watch-tower-line >= 5))
=>
(set-goal g-next-university-tech ri-guard-tower)
(set-goal g-university-tech-priority gv-low)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-excess-only)
(up-research-status c: ri-guard-tower == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(or
	(up-compare-goal g-desired-num-watch-tower > 3)
	(up-compare-goal g-watch-tower-line >= 3))
=>
(set-goal g-next-university-tech ri-guard-tower)
(set-goal g-university-tech-priority gv-excess-only)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-high-excess-only)
(up-research-status c: ri-guard-tower == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(or
	(up-compare-goal g-desired-num-watch-tower > 0)
	(up-compare-goal g-watch-tower-line >= 1))
=>
(set-goal g-next-university-tech ri-guard-tower)
(set-goal g-university-tech-priority gv-high-excess-only)
)

;Keep

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-low)
(up-research-status c: ri-keep == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(or
	(up-compare-goal g-desired-num-watch-tower > 5)
	(up-compare-goal g-watch-tower-line >= 5))
=>
(set-goal g-next-university-tech ri-keep)
(set-goal g-university-tech-priority gv-low)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-excess-only)
(up-research-status c: ri-keep == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(or
	(up-compare-goal g-desired-num-watch-tower > 3)
	(up-compare-goal g-watch-tower-line >= 3))
=>
(set-goal g-next-university-tech ri-keep)
(set-goal g-university-tech-priority gv-excess-only)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-high-excess-only)
(up-research-status c: ri-keep == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(or
	(up-compare-goal g-desired-num-watch-tower > 0)
	(up-compare-goal g-watch-tower-line >= 1))
=>
(set-goal g-next-university-tech ri-keep)
(set-goal g-university-tech-priority gv-high-excess-only)
)

;Arrowslits

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-tertiary)
(up-research-status c: ri-arrowslits == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(up-compare-goal g-watch-tower-line > 4)
=>
(set-goal g-next-university-tech ri-arrowslits)
(set-goal g-university-tech-priority gv-tertiary)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-low)
(up-research-status c: ri-arrowslits == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(up-compare-goal g-watch-tower-line > 2)
=>
(set-goal g-next-university-tech ri-arrowslits)
(set-goal g-university-tech-priority gv-low)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-excess-only)
(up-research-status c: ri-arrowslits == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(up-compare-goal g-watch-tower-line > 0)
=>
(set-goal g-next-university-tech ri-arrowslits)
(set-goal g-university-tech-priority gv-excess-only)
)

;Masonry

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-low)
(up-research-status c: ri-masonry == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(building-type-count castle >= 3)
=>
(set-goal g-next-university-tech ri-masonry)
(set-goal g-university-tech-priority gv-low)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-excess-only)
(up-research-status c: ri-masonry == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(building-type-count castle >= 1)
=>
(set-goal g-next-university-tech ri-masonry)
(set-goal g-university-tech-priority gv-excess-only)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-high-excess-only)
(up-research-status c: ri-masonry == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
=>
(set-goal g-next-university-tech ri-masonry)
(set-goal g-university-tech-priority gv-high-excess-only)
)

;Architecture

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-low)
(up-research-status c: ri-architecture == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(building-type-count castle >= 3)
=>
(set-goal g-next-university-tech ri-architecture)
(set-goal g-university-tech-priority gv-low)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-excess-only)
(up-research-status c: ri-architecture == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(building-type-count castle >= 1)
=>
(set-goal g-next-university-tech ri-architecture)
(set-goal g-university-tech-priority gv-excess-only)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-high-excess-only)
(up-research-status c: ri-architecture == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
=>
(set-goal g-next-university-tech ri-architecture)
(set-goal g-university-tech-priority gv-high-excess-only)
)

;Treadmill Crane

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-low)
(up-research-status c: ri-treadmill-crane == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(up-compare-goal g-desired-num-castle >= 3)
(up-object-type-count c: castle g:< g-desired-num-castle)
(up-research-status c: ri-hand-cart >= research-pending)
=>
(set-goal g-next-university-tech ri-treadmill-crane)
(set-goal g-university-tech-priority gv-low)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-excess-only)
(up-research-status c: ri-treadmill-crane == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(up-compare-goal g-desired-num-castle >= 2)
(up-object-type-count c: castle g:< g-desired-num-castle)
(up-research-status c: ri-hand-cart >= research-pending)
=>
(set-goal g-next-university-tech ri-treadmill-crane)
(set-goal g-university-tech-priority gv-excess-only)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-high-excess-only)
(up-research-status c: ri-treadmill-crane == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(up-research-status c: ri-hand-cart >= research-pending)
=>
(set-goal g-next-university-tech ri-treadmill-crane)
(set-goal g-university-tech-priority gv-high-excess-only)
)

;Heated Shot

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-tertiary)
(up-research-status c: ri-heated-shot == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(building-type-count-total castle >= 3)
	(or
		(up-compare-goal g-watch-tower-line >= 5)
		(building-type-count-total bombard-tower >= 5)))
(players-unit-type-count any-enemy warship-class > 10)
=>
(set-goal g-next-university-tech ri-heated-shot)
(set-goal g-university-tech-priority gv-tertiary)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-low)
(up-research-status c: ri-heated-shot == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(building-type-count-total castle >= 2)
	(or
		(up-compare-goal g-watch-tower-line >= 3)
		(building-type-count-total bombard-tower >= 3)))
(players-unit-type-count any-enemy warship-class > 5)
=>
(set-goal g-next-university-tech ri-heated-shot)
(set-goal g-university-tech-priority gv-low)
)

(defrule
(building-type-count university > 0)
(up-compare-goal g-university-tech-priority < gv-excess-only)
(up-research-status c: ri-heated-shot == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(building-type-count-total castle >= 1)
	(or
		(up-compare-goal g-watch-tower-line >= 1)
		(building-type-count-total bombard-tower >= 1)))
(players-unit-type-count any-enemy warship-class > 0)
=>
(set-goal g-next-university-tech ri-heated-shot)
(set-goal g-university-tech-priority gv-excess-only)
)

;Fortified Wall (not researched yet)



;========Barracks

;Eagle Warrior

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-primary)
(up-research-status c: ri-eagle-warrior == research-available)
(goal g-strategy gv-eagles-revenge)
(up-compare-goal g-desired-num-eagle-warrior > 0)
=>
(set-goal g-next-barracks-tech ri-eagle-warrior)
(set-goal g-barracks-tech-priority gv-primary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-primary)
(up-research-status c: ri-eagle-warrior == research-available)
(goal g-primary-unit eagle-warrior)
(or
	(up-compare-goal g-desired-num-eagle-warrior > 5)
	(unit-type-count-total eagle-warrior-line >= 8))
=>
(set-goal g-next-barracks-tech ri-eagle-warrior)
(set-goal g-barracks-tech-priority gv-primary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-primary)
(up-research-status c: ri-eagle-warrior == research-available)
(up-compare-goal g-desired-num-eagle-warrior > 0)
(or
	(current-age == imperial-age)
	(up-compare-goal g-eagle-scout-line > 12))
=>
(set-goal g-next-barracks-tech ri-eagle-warrior)
(set-goal g-barracks-tech-priority gv-primary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-secondary)
(up-research-status c: ri-eagle-warrior == research-available)
(or
	(goal g-secondary-unit eagle-warrior)
	(goal g-tertiary-unit eagle-warrior))
(or
	(up-compare-goal g-desired-num-eagle-warrior > 5)
	(unit-type-count-total eagle-warrior-line >= 8))
=>
(set-goal g-next-barracks-tech ri-eagle-warrior)
(set-goal g-barracks-tech-priority gv-secondary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-tertiary)
(up-research-status c: ri-eagle-warrior == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-eagle-warrior > 0)
	(unit-type-count-total eagle-warrior-line >= 4))
=>
(set-goal g-next-barracks-tech ri-eagle-warrior)
(set-goal g-barracks-tech-priority gv-tertiary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-excess-only)
(up-research-status c: ri-eagle-warrior == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(unit-type-count-total eagle-warrior-line > 0)
=>
(set-goal g-next-barracks-tech ri-eagle-warrior)
(set-goal g-barracks-tech-priority gv-excess-only)
)

;Elite Eagle Warrior

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-primary)
(up-research-status c: ri-elite-eagle-warrior == research-available)
(goal g-primary-unit eagle-warrior)
(or
	(up-compare-goal g-desired-num-eagle-warrior > 8)
	(up-compare-goal g-eagle-scout-line >= 12))
=>
(set-goal g-next-barracks-tech ri-elite-eagle-warrior)
(set-goal g-barracks-tech-priority gv-primary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-secondary)
(up-research-status c: ri-elite-eagle-warrior == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-secondary-unit eagle-warrior)
(or
	(up-compare-goal g-desired-num-eagle-warrior > 8)
	(up-compare-goal g-eagle-scout-line >= 12))
=>
(set-goal g-next-barracks-tech ri-elite-eagle-warrior)
(set-goal g-barracks-tech-priority gv-secondary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-tertiary)
(up-research-status c: ri-elite-eagle-warrior == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-tertiary-unit eagle-warrior)
(or
	(up-compare-goal g-desired-num-eagle-warrior > 6)
	(up-compare-goal g-eagle-scout-line >= 9))
=>
(set-goal g-next-barracks-tech ri-elite-eagle-warrior)
(set-goal g-barracks-tech-priority gv-tertiary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-low)
(up-research-status c: ri-elite-eagle-warrior == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-eagle-warrior > 0)
	(up-compare-goal g-eagle-scout-line >= 6))
=>
(set-goal g-next-barracks-tech ri-elite-eagle-warrior)
(set-goal g-barracks-tech-priority gv-low)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-excess-only)
(up-research-status c: ri-elite-eagle-warrior == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(up-compare-goal g-eagle-scout-line > 0)
=>
(set-goal g-next-barracks-tech ri-elite-eagle-warrior)
(set-goal g-barracks-tech-priority gv-excess-only)
)

;Pikeman

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-primary)
(up-research-status c: ri-pikeman == research-available)
(or
	(goal g-primary-unit spearman)
	(goal g-secondary-unit spearman))
(or
	(up-compare-goal g-desired-num-spearman > 5)
	(or
		(unit-type-count-total spearman-line >= 10)
		(and
			(up-compare-goal g-desired-num-spearman > 0)
			(up-compare-goal g-strategy >= gv-low-gold))))
=>
(set-goal g-next-barracks-tech ri-pikeman)
(set-goal g-barracks-tech-priority gv-primary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-primary)
(up-research-status c: ri-pikeman == research-available)
(up-compare-goal g-desired-num-spearman > 0)
(or
	(current-age == imperial-age)
	(unit-type-count spearman-line > 12))
=>
(set-goal g-next-barracks-tech ri-pikeman)
(set-goal g-barracks-tech-priority gv-primary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-primary)
(up-research-status c: ri-pikeman == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-spearman > 5)
	(or
		(unit-type-count-total spearman-line >= 10)
		(and
			(up-compare-goal g-desired-num-spearman > 0)
			(up-compare-goal g-strategy >= gv-low-gold))))
=>
(set-goal g-next-barracks-tech ri-pikeman)
(set-goal g-barracks-tech-priority gv-primary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-secondary)
(up-research-status c: ri-pikeman == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-spearman > 0)
	(or
		(unit-type-count-total spearman-line >= 6)
		(up-compare-goal g-strategy >= gv-low-gold)))
=>
(set-goal g-next-barracks-tech ri-pikeman)
(set-goal g-barracks-tech-priority gv-secondary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-excess-only)
(up-research-status c: ri-pikeman == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(unit-type-count-total spearman-line > 0)
=>
(set-goal g-next-barracks-tech ri-pikeman)
(set-goal g-barracks-tech-priority gv-excess-only)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-high-excess-only)
(up-research-status c: ri-pikeman == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-barracks-tech ri-pikeman)
(set-goal g-barracks-tech-priority gv-high-excess-only)
)

;Halberdier

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-primary)
(up-research-status c: ri-halberdier == research-available)
(goal g-primary-unit spearman)
(or
	(up-compare-goal g-desired-num-spearman > 8)
	(or
		(unit-type-count-total spearman-line >= 12)
		(and
			(up-compare-goal g-desired-num-spearman > 0)
			(up-compare-goal g-strategy >= gv-low-gold))))
=>
(set-goal g-next-barracks-tech ri-halberdier)
(set-goal g-barracks-tech-priority gv-primary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-primary)
(up-research-status c: ri-halberdier == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-secondary-unit spearman)
(or
	(up-compare-goal g-desired-num-spearman > 8)
	(or
		(unit-type-count-total spearman-line >= 12)
		(and
			(up-compare-goal g-desired-num-spearman > 0)
			(up-compare-goal g-strategy >= gv-low-gold))))
=>
(set-goal g-next-barracks-tech ri-halberdier)
(set-goal g-barracks-tech-priority gv-primary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-primary)
(up-research-status c: ri-halberdier == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-tertiary-unit spearman)
(or
	(up-compare-goal g-desired-num-spearman > 8)
	(or
		(unit-type-count-total spearman-line >= 12)
		(and
			(up-compare-goal g-desired-num-spearman > 0)
			(up-compare-goal g-strategy >= gv-low-gold))))
=>
(set-goal g-next-barracks-tech ri-halberdier)
(set-goal g-barracks-tech-priority gv-primary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-primary)
(up-research-status c: ri-halberdier == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-spearman > 0)
	(or
		(unit-type-count-total spearman-line >= 6)
		(up-compare-goal g-strategy >= gv-low-gold)))
=>
(set-goal g-next-barracks-tech ri-halberdier)
(set-goal g-barracks-tech-priority gv-primary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-excess-only)
(up-research-status c: ri-halberdier == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(unit-type-count-total spearman-line > 0)
=>
(set-goal g-next-barracks-tech ri-halberdier)
(set-goal g-barracks-tech-priority gv-excess-only)
)

(defrule
(up-compare-goal g-barracks-tech-priority < gv-high-excess-only)
(up-research-status c: ri-halberdier == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-barracks-tech ri-halberdier)
(set-goal g-barracks-tech-priority gv-high-excess-only)
)

;Man-at-Arms

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-primary)
(up-research-status c: ri-man-at-arms == research-available)
(goal g-primary-unit militiaman)
(up-compare-goal g-desired-num-militia >= 5)
=>
(set-goal g-next-barracks-tech ri-man-at-arms)
(set-goal g-barracks-tech-priority gv-primary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-primary)
(up-research-status c: ri-man-at-arms == research-available)
(up-compare-goal g-desired-num-militia > 0)
(or
	(current-age >= castle-age)
	(unit-type-count militiaman-line > 8))
=>
(set-goal g-next-barracks-tech ri-man-at-arms)
(set-goal g-barracks-tech-priority gv-primary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-secondary)
(up-research-status c: ri-man-at-arms == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(goal g-secondary-unit militiaman)
	(goal g-tertiary-unit militiaman))
(up-compare-goal g-desired-num-militia >= 5)
=>
(set-goal g-next-barracks-tech ri-man-at-arms)
(set-goal g-barracks-tech-priority gv-secondary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-tertiary)
(up-research-status c: ri-man-at-arms == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(up-compare-goal g-desired-num-militia > 0)
=>
(set-goal g-next-barracks-tech ri-man-at-arms)
(set-goal g-barracks-tech-priority gv-tertiary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-excess-only)
(up-research-status c: ri-man-at-arms == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(unit-type-count militiaman-line > 0)
=>
(set-goal g-next-barracks-tech ri-man-at-arms)
(set-goal g-barracks-tech-priority gv-excess-only)
)

;Long Swordsman

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-primary)
(up-research-status c: ri-long-swordsman == research-available)
(goal g-primary-unit militiaman)
(or
	(up-compare-goal g-desired-num-militia > 8)
	(unit-type-count-total militiaman-line >= 12))
=>
(set-goal g-next-barracks-tech ri-long-swordsman)
(set-goal g-barracks-tech-priority gv-primary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-primary)
(up-research-status c: ri-long-swordsman == research-available)
(up-compare-goal g-desired-num-militia > 0)
(or
	(current-age == imperial-age)
	(unit-type-count militiaman-line > 10))
=>
(set-goal g-next-barracks-tech ri-long-swordsman)
(set-goal g-barracks-tech-priority gv-primary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-secondary)
(up-research-status c: ri-long-swordsman == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(goal g-secondary-unit militiaman)
	(goal g-tertiary-unit militiaman))
(or
	(up-compare-goal g-desired-num-militia > 8)
	(unit-type-count-total militiaman-line >= 12))
=>
(set-goal g-next-barracks-tech ri-long-swordsman)
(set-goal g-barracks-tech-priority gv-secondary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-tertiary)
(up-research-status c: ri-long-swordsman == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-militia > 0)
	(unit-type-count-total militiaman-line >= 6))
=>
(set-goal g-next-barracks-tech ri-long-swordsman)
(set-goal g-barracks-tech-priority gv-tertiary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-excess-only)
(up-research-status c: ri-long-swordsman == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(unit-type-count-total militiaman-line > 0)
=>
(set-goal g-next-barracks-tech ri-long-swordsman)
(set-goal g-barracks-tech-priority gv-excess-only)
)

;Two-Handed Swordsman

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-primary)
(up-research-status c: ri-two-handed-swordsman == research-available)
(goal g-primary-unit militiaman)
(or
	(up-compare-goal g-desired-num-militia > 8)
	(unit-type-count-total militiaman-line >= 12))
=>
(set-goal g-next-barracks-tech ri-two-handed-swordsman)
(set-goal g-barracks-tech-priority gv-primary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-secondary)
(up-research-status c: ri-two-handed-swordsman == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(goal g-secondary-unit militiaman)
	(goal g-tertiary-unit militiaman))
(or
	(up-compare-goal g-desired-num-militia > 8)
	(unit-type-count-total militiaman-line >= 12))
=>
(set-goal g-next-barracks-tech ri-two-handed-swordsman)
(set-goal g-barracks-tech-priority gv-secondary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-tertiary)
(up-research-status c: ri-two-handed-swordsman == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-militia > 0)
	(unit-type-count-total militiaman-line >= 6))
=>
(set-goal g-next-barracks-tech ri-two-handed-swordsman)
(set-goal g-barracks-tech-priority gv-tertiary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-excess-only)
(up-research-status c: ri-two-handed-swordsman == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(unit-type-count-total militiaman-line > 0)
=>
(set-goal g-next-barracks-tech ri-two-handed-swordsman)
(set-goal g-barracks-tech-priority gv-excess-only)
)

;Champion

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-primary)
(up-research-status c: ri-champion == research-available)
(goal g-primary-unit militiaman)
(or
	(up-compare-goal g-desired-num-militia > 8)
	(unit-type-count-total militiaman-line >= 12))
=>
(set-goal g-next-barracks-tech ri-champion)
(set-goal g-barracks-tech-priority gv-primary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-secondary)
(up-research-status c: ri-champion == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-secondary-unit militiaman)
(or
	(up-compare-goal g-desired-num-militia > 8)
	(unit-type-count-total militiaman-line >= 12))
=>
(set-goal g-next-barracks-tech ri-champion)
(set-goal g-barracks-tech-priority gv-secondary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-tertiary)
(up-research-status c: ri-champion == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-tertiary-unit militiaman)
(or
	(up-compare-goal g-desired-num-militia > 6)
	(unit-type-count-total militiaman-line >= 9))
=>
(set-goal g-next-barracks-tech ri-champion)
(set-goal g-barracks-tech-priority gv-tertiary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-low)
(up-research-status c: ri-champion == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-militia > 0)
	(unit-type-count-total militiaman-line >= 6))
=>
(set-goal g-next-barracks-tech ri-champion)
(set-goal g-barracks-tech-priority gv-low)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-excess-only)
(up-research-status c: ri-champion == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(unit-type-count-total militiaman-line > 0)
=>
(set-goal g-next-barracks-tech ri-champion)
(set-goal g-barracks-tech-priority gv-excess-only)
)

;Arson

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-secondary)
(up-research-status c: ri-arson == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-initial-strategy gv-eagles-revenge)
(or
	(goal g-town-under-attack NO)
	(up-compare-goal g-enemy-buildings-in-town > 0))
(unit-type-count infantry-class > 10)
=>
(set-goal g-next-barracks-tech ri-arson)
(set-goal g-barracks-tech-priority gv-secondary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-tertiary)
(up-research-status c: ri-arson == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(goal g-town-under-attack NO)
	(up-compare-goal g-enemy-buildings-in-town > 0))
(unit-type-count infantry-class > 15)
=>
(set-goal g-next-barracks-tech ri-arson)
(set-goal g-barracks-tech-priority gv-tertiary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-low)
(up-research-status c: ri-arson == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(unit-type-count infantry-class > 15)
=>
(set-goal g-next-barracks-tech ri-arson)
(set-goal g-barracks-tech-priority gv-low)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-excess-only)
(up-research-status c: ri-arson == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(unit-type-count infantry-class > 0)
=>
(set-goal g-next-barracks-tech ri-arson)
(set-goal g-barracks-tech-priority gv-excess-only)
)

;Squires

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-tertiary)
(up-research-status c: ri-squires == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
(goal g-initial-strategy gv-eagles-revenge)
(goal g-town-under-attack NO)
(unit-type-count infantry-class > 12)
=>
(set-goal g-next-barracks-tech ri-squires)
(set-goal g-barracks-tech-priority gv-tertiary)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-low)
(up-research-status c: ri-squires == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
(goal g-town-under-attack NO)
(unit-type-count infantry-class > 20)
=>
(set-goal g-next-barracks-tech ri-squires)
(set-goal g-barracks-tech-priority gv-low)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-excess-only)
(up-research-status c: ri-squires == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
(unit-type-count infantry-class > 10)
=>
(set-goal g-next-barracks-tech ri-squires)
(set-goal g-barracks-tech-priority gv-excess-only)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-high-excess-only)
(up-research-status c: ri-squires == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
(unit-type-count infantry-class > 0)
=>
(set-goal g-next-barracks-tech ri-squires)
(set-goal g-barracks-tech-priority gv-high-excess-only)
)

;Tracking

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-excess-only)
(up-research-status c: ri-tracking == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
(current-age >= castle-age)
(unit-type-count infantry-class > 15)
(food-amount > 500)
(up-research-status c: ri-forging >= research-pending)
(up-research-status c: ri-scale-mail >= research-pending)
=>
(set-goal g-next-barracks-tech ri-tracking)
(set-goal g-barracks-tech-priority gv-excess-only)
)

(defrule
(building-type-count barracks > 0)
(up-compare-goal g-barracks-tech-priority < gv-high-excess-only)
(up-research-status c: ri-tracking == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
(current-age >= castle-age)
(unit-type-count infantry-class > 10)
(up-compare-goal g-attack-status > gv-first-attack)
(up-research-status c: ri-forging >= research-pending)
(up-research-status c: ri-scale-mail >= research-pending)
=>
(set-goal g-next-barracks-tech ri-tracking)
(set-goal g-barracks-tech-priority gv-high-excess-only)
)



;========Archery Range

;Crossbowman

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-primary)
(up-research-status c: ri-crossbow == research-available)
(goal g-strategy gv-strongbow)
=>
(set-goal g-next-archery-range-tech ri-crossbow)
(set-goal g-archery-range-tech-priority gv-primary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-primary)
(up-research-status c: ri-crossbow == research-available)
(or
	(goal g-primary-unit archer)
	(goal g-secondary-unit archer))
(or
	(up-compare-goal g-desired-num-archer > 5)
	(unit-type-count-total archer-line >= 10))
=>
(set-goal g-next-archery-range-tech ri-crossbow)
(set-goal g-archery-range-tech-priority gv-primary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-primary)
(up-research-status c: ri-crossbow == research-available)
(or
	(current-age >= imperial-age)
	(unit-type-count archer-line > 8))
=>
(set-goal g-next-archery-range-tech ri-crossbow)
(set-goal g-archery-range-tech-priority gv-primary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-secondary)
(up-research-status c: ri-crossbow == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-tertiary-unit archer)
(or
	(up-compare-goal g-desired-num-archer > 5)
	(unit-type-count-total archer-line >= 10))
=>
(set-goal g-next-archery-range-tech ri-crossbow)
(set-goal g-archery-range-tech-priority gv-secondary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-tertiary)
(up-research-status c: ri-crossbow == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-archer > 0)
	(unit-type-count-total archer-line >= 6))
=>
(set-goal g-next-archery-range-tech ri-crossbow)
(set-goal g-archery-range-tech-priority gv-tertiary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-excess-only)
(up-research-status c: ri-crossbow == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(unit-type-count-total archer-line > 0)
=>
(set-goal g-next-archery-range-tech ri-crossbow)
(set-goal g-archery-range-tech-priority gv-excess-only)
)

;Arbalest

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-primary)
(up-research-status c: ri-arbalest == research-available)
(goal g-primary-unit archer)
(or
	(up-compare-goal g-desired-num-archer > 8)
	(unit-type-count-total archer-line >= 12))
=>
(set-goal g-next-archery-range-tech ri-arbalest)
(set-goal g-archery-range-tech-priority gv-primary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-secondary)
(up-research-status c: ri-arbalest == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(goal g-secondary-unit archer)
	(goal g-tertiary-unit archer))
(or
	(up-compare-goal g-desired-num-archer > 8)
	(unit-type-count-total archer-line >= 12))
=>
(set-goal g-next-archery-range-tech ri-arbalest)
(set-goal g-archery-range-tech-priority gv-secondary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-tertiary)
(up-research-status c: ri-arbalest == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-archer > 0)
	(unit-type-count-total archer-line >= 6))
=>
(set-goal g-next-archery-range-tech ri-arbalest)
(set-goal g-archery-range-tech-priority gv-tertiary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-excess-only)
(up-research-status c: ri-arbalest == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(unit-type-count-total archer-line > 0)
=>
(set-goal g-next-archery-range-tech ri-arbalest)
(set-goal g-archery-range-tech-priority gv-excess-only)
)

;Elite Skirmisher

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-primary)
(up-research-status c: ri-elite-skirmisher == research-available)
(or
	(goal g-primary-unit skirmisher)
	(goal g-secondary-unit skirmisher))
(or
	(up-compare-goal g-desired-num-skirmisher > 5)
	(up-compare-goal g-skirmisher-line >= 8))
=>
(set-goal g-next-archery-range-tech ri-elite-skirmisher)
(set-goal g-archery-range-tech-priority gv-primary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-primary)
(up-research-status c: ri-elite-skirmisher == research-available)
(or
	(current-age == imperial-age)
	(up-compare-goal g-skirmisher-line > 10))
=>
(set-goal g-next-archery-range-tech ri-elite-skirmisher)
(set-goal g-archery-range-tech-priority gv-primary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-secondary)
(up-research-status c: ri-elite-skirmisher == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-wood-gold))
(or
	(up-compare-goal g-desired-num-skirmisher > 5)
	(up-compare-goal g-skirmisher-line >= 8))
=>
(set-goal g-next-archery-range-tech ri-elite-skirmisher)
(set-goal g-archery-range-tech-priority gv-secondary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-tertiary)
(up-research-status c: ri-elite-skirmisher == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-wood-gold))
(or
	(up-compare-goal g-desired-num-skirmisher > 0)
	(up-compare-goal g-skirmisher-line >= 5))
=>
(set-goal g-next-archery-range-tech ri-elite-skirmisher)
(set-goal g-archery-range-tech-priority gv-tertiary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-excess-only)
(up-research-status c: ri-elite-skirmisher == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-wood-gold))
(up-compare-goal g-skirmisher-line > 0)
=>
(set-goal g-next-archery-range-tech ri-elite-skirmisher)
(set-goal g-archery-range-tech-priority gv-excess-only)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-high-excess-only)
(up-research-status c: ri-elite-skirmisher == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-wood-gold))
=>
(set-goal g-next-archery-range-tech ri-elite-skirmisher)
(set-goal g-archery-range-tech-priority gv-high-excess-only)
)

;Imperial Skirmisher

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-primary)
(up-research-status c: ri-imperial-skirmisher == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-primary-unit skirmisher)
(or
	(up-compare-goal g-desired-num-skirmisher > 5)
	(up-compare-goal g-skirmisher-line >= 8))
=>
(set-goal g-next-archery-range-tech ri-imperial-skirmisher)
(set-goal g-archery-range-tech-priority gv-primary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-secondary)
(up-research-status c: ri-imperial-skirmisher == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-secondary-unit skirmisher)
(or
	(up-compare-goal g-desired-num-skirmisher > 5)
	(up-compare-goal g-skirmisher-line >= 8))
=>
(set-goal g-next-archery-range-tech ri-imperial-skirmisher)
(set-goal g-archery-range-tech-priority gv-secondary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-tertiary)
(up-research-status c: ri-imperial-skirmisher == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-tertiary-unit skirmisher)
(or
	(up-compare-goal g-desired-num-skirmisher > 5)
	(up-compare-goal g-skirmisher-line >= 8))
=>
(set-goal g-next-archery-range-tech ri-imperial-skirmisher)
(set-goal g-archery-range-tech-priority gv-tertiary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-low)
(up-research-status c: ri-imperial-skirmisher == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-skirmisher > 0)
	(up-compare-goal g-skirmisher-line >= 5))
=>
(set-goal g-next-archery-range-tech ri-imperial-skirmisher)
(set-goal g-archery-range-tech-priority gv-low)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-excess-only)
(up-research-status c: ri-imperial-skirmisher == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(up-compare-goal g-skirmisher-line > 0)
=>
(set-goal g-next-archery-range-tech ri-imperial-skirmisher)
(set-goal g-archery-range-tech-priority gv-excess-only)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-high-excess-only)
(up-research-status c: ri-imperial-skirmisher == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-archery-range-tech ri-imperial-skirmisher)
(set-goal g-archery-range-tech-priority gv-high-excess-only)
)

;Heavy Cavalry Archer

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-primary)
(up-research-status c: ri-heavy-cavalry-archer == research-available)
(goal g-primary-unit cavalry-archer)
(or
	(up-compare-goal g-desired-num-cavalry-archer > 10)
	(unit-type-count-total cavalry-archer-line >= 15))
=>
(set-goal g-next-archery-range-tech ri-heavy-cavalry-archer)
(set-goal g-archery-range-tech-priority gv-primary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-secondary)
(up-research-status c: ri-heavy-cavalry-archer == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-secondary-unit cavalry-archer)
(or
	(up-compare-goal g-desired-num-cavalry-archer > 10)
	(unit-type-count-total cavalry-archer-line >= 15))
=>
(set-goal g-next-archery-range-tech ri-heavy-cavalry-archer)
(set-goal g-archery-range-tech-priority gv-secondary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-tertiary)
(up-research-status c: ri-heavy-cavalry-archer == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-tertiary-unit cavalry-archer)
(or
	(up-compare-goal g-desired-num-cavalry-archer > 7)
	(unit-type-count-total cavalry-archer-line >= 12))
=>
(set-goal g-next-archery-range-tech ri-heavy-cavalry-archer)
(set-goal g-archery-range-tech-priority gv-tertiary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-low)
(up-research-status c: ri-heavy-cavalry-archer == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-cavalry-archer > 0)
	(unit-type-count-total cavalry-archer-line >= 8))
=>
(set-goal g-next-archery-range-tech ri-heavy-cavalry-archer)
(set-goal g-archery-range-tech-priority gv-low)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-excess-only)
(up-research-status c: ri-heavy-cavalry-archer == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(unit-type-count-total cavalry-archer-line > 0)
=>
(set-goal g-next-archery-range-tech ri-heavy-cavalry-archer)
(set-goal g-archery-range-tech-priority gv-excess-only)
)

;Elite Genitour

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-primary)
(up-research-status c: ri-elite-genitour == research-available)
(goal g-primary-unit genitour)
(or
	(up-compare-goal g-desired-num-genitour > 8)
	(up-compare-goal g-genitour-line >= 12))
=>
(set-goal g-next-archery-range-tech ri-elite-genitour)
(set-goal g-archery-range-tech-priority gv-primary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-secondary)
(up-research-status c: ri-elite-genitour == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(or
	(goal g-secondary-unit genitour)
	(goal g-tertiary-unit genitour))
(or
	(up-compare-goal g-desired-num-genitour > 8)
	(up-compare-goal g-genitour-line >= 12))
=>
(set-goal g-next-archery-range-tech ri-elite-genitour)
(set-goal g-archery-range-tech-priority gv-secondary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-low)
(up-research-status c: ri-elite-genitour == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(or
	(up-compare-goal g-desired-num-genitour > 0)
	(up-compare-goal g-genitour-line >= 6))
=>
(set-goal g-next-archery-range-tech ri-elite-genitour)
(set-goal g-archery-range-tech-priority gv-low)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-excess-only)
(up-research-status c: ri-elite-genitour == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(up-compare-goal g-genitour-line > 0)
=>
(set-goal g-next-archery-range-tech ri-elite-genitour)
(set-goal g-archery-range-tech-priority gv-excess-only)
)

;Thumb Ring

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-primary)
(up-research-status c: ri-thumb-ring == research-available)
(goal g-primary-unit-class gv-cavalry-archer)
(or
	(up-compare-goal g-desired-num-cavalry-archers >= 6)
	(unit-type-count cavalry-archer-line >= 10))
		
=>
(set-goal g-next-archery-range-tech ri-thumb-ring)
(set-goal g-archery-range-tech-priority gv-primary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-secondary)
(up-research-status c: ri-thumb-ring == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(or
	(up-compare-goal g-desired-num-archer >= 8)
	(and
		(up-compare-goal g-desired-num-unique-unit >= 8)
		(goal g-unique-unit-class gv-archer)))
=>
(set-goal g-next-archery-range-tech ri-thumb-ring)
(set-goal g-archery-range-tech-priority gv-secondary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-secondary)
(up-research-status c: ri-thumb-ring == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(or
	(up-compare-goal g-desired-num-cavalry-archer >= 6)
	(and
		(up-compare-goal g-desired-num-unique-unit >= 6)
		(goal g-unique-unit-class gv-cavalry-archer)))
=>
(set-goal g-next-archery-range-tech ri-thumb-ring)
(set-goal g-archery-range-tech-priority gv-secondary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-secondary)
(up-research-status c: ri-thumb-ring == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(or
	(unit-type-count archer-line >= 12)
	(and
		(up-compare-goal g-unique-unit-line >= 12)
		(goal g-unique-unit-class gv-archer)))
=>
(set-goal g-next-archery-range-tech ri-thumb-ring)
(set-goal g-archery-range-tech-priority gv-secondary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-secondary)
(up-research-status c: ri-thumb-ring == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(or
	(unit-type-count cavalry-archer-line >= 10)
	(and
		(up-compare-goal g-unique-unit-line >= 10)
		(goal g-unique-unit-class gv-cavalry-archer)))
=>
(set-goal g-next-archery-range-tech ri-thumb-ring)
(set-goal g-archery-range-tech-priority gv-secondary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-low)
(up-research-status c: ri-thumb-ring == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(or
	(unit-type-count archer-line > 0)
	(and
		(up-compare-goal g-unique-unit-line > 0)
		(goal g-unique-unit-class gv-archer)))
=>
(set-goal g-next-archery-range-tech ri-thumb-ring)
(set-goal g-archery-range-tech-priority gv-low)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-low)
(up-research-status c: ri-thumb-ring == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(or
	(unit-type-count cavalry-archer-line > 0)
	(and
		(up-compare-goal g-unique-unit-line > 0)
		(goal g-unique-unit-class gv-cavalry-archer)))
=>
(set-goal g-next-archery-range-tech ri-thumb-ring)
(set-goal g-archery-range-tech-priority gv-low)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-excess-only)
(up-research-status c: ri-thumb-ring == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(or
	(up-compare-goal g-skirmisher-line > 0)
	(or
		(up-compare-goal g-genitour-line > 0)
		(unit-type-count-total slinger > 0)))
=>
(set-goal g-next-archery-range-tech ri-thumb-ring)
(set-goal g-archery-range-tech-priority gv-excess-only)
)

;Parthian Tactics

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-secondary)
(up-research-status c: ri-parthian-tactics == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-primary-unit-class gv-cavalry-archer)
(up-compare-goal g-primary-unit != genitour)
(or
	(up-compare-goal g-desired-num-cavalry-archer >= 8)
	(and
		(up-compare-goal g-desired-num-unique-unit >= 8)
		(goal g-unique-unit-class gv-cavalry-archer)))
=>
(set-goal g-next-archery-range-tech ri-parthian-tactics)
(set-goal g-archery-range-tech-priority gv-secondary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-secondary)
(up-research-status c: ri-parthian-tactics == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-secondary-unit-class gv-cavalry-archer)
(up-compare-goal g-secondary-unit != genitour)
(or
	(up-compare-goal g-desired-num-cavalry-archer >= 8)
	(and
		(up-compare-goal g-desired-num-unique-unit >= 8)
		(goal g-unique-unit-class gv-cavalry-archer)))
=>
(set-goal g-next-archery-range-tech ri-parthian-tactics)
(set-goal g-archery-range-tech-priority gv-secondary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-tertiary)
(up-research-status c: ri-parthian-tactics == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-cavalry-archer >= 6)
	(and
		(up-compare-goal g-desired-num-unique-unit >= 6)
		(goal g-unique-unit-class gv-cavalry-archer)))
=>
(set-goal g-next-archery-range-tech ri-parthian-tactics)
(set-goal g-archery-range-tech-priority gv-tertiary)
)

(defrule
(building-type-count archery-range > 0)
(up-compare-goal g-archery-range-tech-priority < gv-excess-only)
(up-research-status c: ri-parthian-tactics == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(unit-type-count cavalry-archer-line > 0)
	(and
		(up-compare-goal g-unique-unit-line > 0)
		(goal g-unique-unit-class gv-cavalry-archer)))
=>
(set-goal g-next-archery-range-tech ri-parthian-tactics)
(set-goal g-archery-range-tech-priority gv-excess-only)
)



;========Stable

;Cavalier

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-primary)
(up-research-status c: ri-cavalier == research-available)
(goal g-primary-unit knight)
(or
	(up-compare-goal g-desired-num-knight > 8)
	(unit-type-count-total knight-line >= 10))
=>
(set-goal g-next-stable-tech ri-cavalier)
(set-goal g-stable-tech-priority gv-primary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-secondary)
(up-research-status c: ri-cavalier == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(goal g-secondary-unit knight)
	(goal g-tertiary-unit knight))
(or
	(up-compare-goal g-desired-num-knight > 8)
	(unit-type-count-total knight-line >= 10))
=>
(set-goal g-next-stable-tech ri-cavalier)
(set-goal g-stable-tech-priority gv-secondary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-secondary)
(up-research-status c: ri-cavalier == research-available)
(unit-type-count-total knight-line >= 14)
=>
(set-goal g-next-stable-tech ri-cavalier)
(set-goal g-stable-tech-priority gv-secondary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-tertiary)
(up-research-status c: ri-cavalier == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-knight > 0)
	(unit-type-count-total knight-line >= 5))
=>
(set-goal g-next-stable-tech ri-cavalier)
(set-goal g-stable-tech-priority gv-tertiary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-excess-only)
(up-research-status c: ri-cavalier == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(unit-type-count-total knight-line > 0)
=>
(set-goal g-next-stable-tech ri-cavalier)
(set-goal g-stable-tech-priority gv-excess-only)
)

;Paladin

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-primary)
(up-research-status c: ri-paladin == research-available)
(goal g-primary-unit knight)
(or
	(up-compare-goal g-desired-num-knight > 10)
	(unit-type-count-total knight-line >= 15))
=>
(set-goal g-next-stable-tech ri-paladin)
(set-goal g-stable-tech-priority gv-primary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-secondary)
(up-research-status c: ri-paladin == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-secondary-unit knight)
(or
	(up-compare-goal g-desired-num-knight > 10)
	(unit-type-count-total knight-line >= 15))
=>
(set-goal g-next-stable-tech ri-paladin)
(set-goal g-stable-tech-priority gv-secondary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-tertiary)
(up-research-status c: ri-paladin == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-tertiary-unit knight)
(or
	(up-compare-goal g-desired-num-knight > 7)
	(unit-type-count-total knight-line >= 12))
=>
(set-goal g-next-stable-tech ri-paladin)
(set-goal g-stable-tech-priority gv-tertiary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-low)
(up-research-status c: ri-paladin == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-knight > 0)
	(unit-type-count-total knight-line >= 8))
=>
(set-goal g-next-stable-tech ri-paladin)
(set-goal g-stable-tech-priority gv-low)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-excess-only)
(up-research-status c: ri-paladin == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(unit-type-count-total knight-line > 0)
=>
(set-goal g-next-stable-tech ri-paladin)
(set-goal g-stable-tech-priority gv-excess-only)
)

;Light Cavalry

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-primary)
(up-research-status c: ri-light-cavalry == research-available)
(or
	(goal g-primary-unit scout-cavalry)
	(goal g-secondary-unit scout-cavalry))
(or
	(up-compare-goal g-desired-num-scout-cavalry > 7)
	(or
		(unit-type-count-total scout-cavalry-line >= 10)
		(and
			(up-compare-goal g-desired-num-scout-cavalry > 0)
			(up-compare-goal g-strategy >= gv-low-gold))))
=>
(set-goal g-next-stable-tech ri-light-cavalry)
(set-goal g-stable-tech-priority gv-primary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-primary)
(up-research-status c: ri-light-cavalry == research-available)
(or
	(current-age == imperial-age)
	(unit-type-count scout-cavalry-line > 8))
=>
(set-goal g-next-stable-tech ri-light-cavalry)
(set-goal g-stable-tech-priority gv-primary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-secondary)
(up-research-status c: ri-light-cavalry == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-scout-cavalry > 0)
	(or
		(unit-type-count-total scout-cavalry-line >= 5)
		(up-compare-goal g-strategy >= gv-low-gold)))
=>
(set-goal g-next-stable-tech ri-light-cavalry)
(set-goal g-stable-tech-priority gv-secondary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-excess-only)
(up-research-status c: ri-light-cavalry == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(unit-type-count-total scout-cavalry-line > 0)
=>
(set-goal g-next-stable-tech ri-light-cavalry)
(set-goal g-stable-tech-priority gv-excess-only)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-high-excess-only)
(up-research-status c: ri-light-cavalry == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-stable-tech ri-light-cavalry)
(set-goal g-stable-tech-priority gv-high-excess-only)
)

;Elite Battle Elephant

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-primary)
(up-research-status c: ri-elite-battle-elephant == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-primary-unit battle-elephant)
(or
	(up-compare-goal g-desired-num-battle-elephant > 8)
	(unit-type-count-total battle-elephant >= 12))
=>
(set-goal g-next-stable-tech ri-elite-battle-elephant)
(set-goal g-stable-tech-priority gv-primary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-secondary)
(up-research-status c: ri-elite-battle-elephant == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-secondary-unit battle-elephant)
(or
	(up-compare-goal g-desired-num-battle-elephant > 8)
	(unit-type-count-total battle-elephant >= 12))
=>
(set-goal g-next-stable-tech ri-elite-battle-elephant)
(set-goal g-stable-tech-priority gv-secondary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-tertiary)
(up-research-status c: ri-elite-battle-elephant == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-tertiary-unit battle-elephant)
(or
	(up-compare-goal g-desired-num-battle-elephant > 6)
	(unit-type-count-total battle-elephant >= 9))
=>
(set-goal g-next-stable-tech ri-elite-battle-elephant)
(set-goal g-stable-tech-priority gv-tertiary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-low)
(up-research-status c: ri-elite-battle-elephant == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-battle-elephant > 0)
	(unit-type-count-total battle-elephant >= 6))
=>
(set-goal g-next-stable-tech ri-elite-battle-elephant)
(set-goal g-stable-tech-priority gv-low)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-high-excess-only)
(up-research-status c: ri-elite-battle-elephant == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(unit-type-count-total battle-elephant > 0)
=>
(set-goal g-next-stable-tech ri-elite-battle-elephant)
(set-goal g-stable-tech-priority gv-high-excess-only)
)

;Hussar

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-primary)
(up-research-status c: ri-hussar == research-available)
(goal g-primary-unit scout-cavalry)
(or
	(up-compare-goal g-desired-num-scout-cavalry > 8)
	(or
		(unit-type-count-total scout-cavalry-line >= 12)
		(and
			(up-compare-goal g-desired-num-scout-cavalry > 0)
			(up-compare-goal g-strategy >= gv-low-gold))))
=>
(set-goal g-next-stable-tech ri-hussar)
(set-goal g-stable-tech-priority gv-primary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-secondary)
(up-research-status c: ri-hussar == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-secondary-unit scout-cavalry)
(or
	(up-compare-goal g-desired-num-scout-cavalry > 8)
	(or
		(unit-type-count-total scout-cavalry-line >= 12)
		(and
			(up-compare-goal g-desired-num-scout-cavalry > 0)
			(up-compare-goal g-strategy >= gv-low-gold))))
=>
(set-goal g-next-stable-tech ri-hussar)
(set-goal g-stable-tech-priority gv-secondary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-secondary)
(up-research-status c: ri-hussar == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-tertiary-unit scout-cavalry)
(or
	(up-compare-goal g-desired-num-scout-cavalry > 8)
	(or
		(unit-type-count-total scout-cavalry-line >= 12)
		(and
			(up-compare-goal g-desired-num-scout-cavalry > 0)
			(up-compare-goal g-strategy >= gv-low-gold))))
=>
(set-goal g-next-stable-tech ri-hussar)
(set-goal g-stable-tech-priority gv-secondary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-tertiary)
(up-research-status c: ri-hussar == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-scout-cavalry > 0)
	(or
		(unit-type-count-total scout-cavalry-line >= 6)
		(up-compare-goal g-strategy >= gv-low-gold)))
=>
(set-goal g-next-stable-tech ri-hussar)
(set-goal g-stable-tech-priority gv-tertiary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-excess-only)
(up-research-status c: ri-hussar == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(unit-type-count-total scout-cavalry-line > 0)
=>
(set-goal g-next-stable-tech ri-hussar)
(set-goal g-stable-tech-priority gv-excess-only)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-high-excess-only)
(up-research-status c: ri-hussar == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
=>
(set-goal g-next-stable-tech ri-hussar)
(set-goal g-stable-tech-priority gv-high-excess-only)
)

;Heavy Camel

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-primary)
(up-research-status c: ri-heavy-camel == research-available)
(goal g-primary-unit camel)
(or
	(up-compare-goal g-desired-num-camel > 8)
	(up-compare-goal g-camel-line >= 12))
=>
(set-goal g-next-stable-tech ri-heavy-camel)
(set-goal g-stable-tech-priority gv-primary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-secondary)
(up-research-status c: ri-heavy-camel == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(goal g-secondary-unit camel)
	(goal g-tertiary-unit camel))
(or
	(up-compare-goal g-desired-num-camel > 8)
	(up-compare-goal g-camel-line >= 12))
=>
(set-goal g-next-stable-tech ri-heavy-camel)
(set-goal g-stable-tech-priority gv-secondary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-tertiary)
(up-research-status c: ri-heavy-camel == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-camel > 0)
	(up-compare-goal g-camel-line >= 6))
=>
(set-goal g-next-stable-tech ri-heavy-camel)
(set-goal g-stable-tech-priority gv-tertiary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-excess-only)
(up-research-status c: ri-heavy-camel == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(up-compare-goal g-camel-line > 0)
=>
(set-goal g-next-stable-tech ri-heavy-camel)
(set-goal g-stable-tech-priority gv-excess-only)
)

#load-if-defined INDIAN-CIV

	;Imperial Camel

	(defrule
	(building-type-count stable > 0)
	(up-compare-goal g-stable-tech-priority < gv-primary)
	(up-research-status c: ri-imperial-camel == research-available)
	(goal g-primary-unit camel)
	(or
		(up-compare-goal g-desired-num-camel > 8)
		(up-compare-goal g-camel-line >= 12))
	=>
	(set-goal g-next-stable-tech ri-imperial-camel)
	(set-goal g-stable-tech-priority gv-primary)
	)

	(defrule
	(building-type-count stable > 0)
	(up-compare-goal g-stable-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-camel == research-available)
	(or
		(up-compare-goal g-attack-status >= gv-first-attack)
		(up-compare-flag g-excess-resources-flag == gv-food-gold))
	(goal g-secondary-unit camel)
	(or
		(up-compare-goal g-desired-num-camel > 8)
		(up-compare-goal g-camel-line >= 12))
	=>
	(set-goal g-next-stable-tech ri-imperial-camel)
	(set-goal g-stable-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count stable > 0)
	(up-compare-goal g-stable-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-camel == research-available)
	(or
		(up-compare-goal g-attack-status >= gv-first-attack)
		(up-compare-flag g-excess-resources-flag == gv-food-gold))
	(goal g-tertiary-unit camel)
	(or
		(up-compare-goal g-desired-num-camel > 6)
		(up-compare-goal g-camel-line >= 9))
	=>
	(set-goal g-next-stable-tech ri-imperial-camel)
	(set-goal g-stable-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count stable > 0)
	(up-compare-goal g-stable-tech-priority < gv-low)
	(up-research-status c: ri-imperial-camel == research-available)
	(or
		(up-compare-goal g-attack-status >= gv-first-attack)
		(up-compare-flag g-excess-resources-flag == gv-food-gold))
	(or
		(up-compare-goal g-desired-num-camel > 0)
		(up-compare-goal g-camel-line >= 6))
	=>
	(set-goal g-next-stable-tech ri-imperial-camel)
	(set-goal g-stable-tech-priority gv-low)
	)

	(defrule
	(building-type-count stable > 0)
	(up-compare-goal g-stable-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-camel == research-available)
	(or
		(up-compare-goal g-attack-status >= gv-first-attack)
		(up-compare-flag g-excess-resources-flag == gv-food-gold))
	(up-compare-goal g-camel-line > 0)
	=>
	(set-goal g-next-stable-tech ri-imperial-camel)
	(set-goal g-stable-tech-priority gv-excess-only)
	)
	
#end-if

;Bloodlines

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-primary)
(up-research-status c: ri-bloodlines == research-available)
(or
	(current-age == imperial-age)
	(unit-type-count cavalry-class >= 15))
=>
(set-goal g-next-stable-tech ri-bloodlines)
(set-goal g-stable-tech-priority gv-primary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-secondary)
(up-research-status c: ri-bloodlines == research-available)
(or
	(up-compare-goal g-desired-num-cavalry >= 4)
	(unit-type-count cavalry-class >= 4))
(up-compare-goal g-attack-status >= gv-first-attack)
(or
	(goal g-initial-strategy gv-krush)
	(goal g-initial-strategy gv-crush))
=>
(set-goal g-next-stable-tech ri-bloodlines)
(set-goal g-stable-tech-priority gv-secondary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-secondary)
(up-research-status c: ri-bloodlines == research-available)
(up-compare-goal g-attack-status >= gv-first-attack)
(or
	(up-compare-goal g-desired-num-cavalry >= 4)
	(up-compare-goal g-desired-num-cavalry-archers >= 4))
(or
	(goal g-primary-unit-class gv-cavalry)
	(or
		(goal g-primary-unit-class gv-cavalry-archer)
		(or
			(goal g-primary-unit-class gv-conquistador)
			(goal g-primary-unit-class gv-ballista-elephant))))
=>
(set-goal g-next-stable-tech ri-bloodlines)
(set-goal g-stable-tech-priority gv-secondary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-secondary)
(up-research-status c: ri-bloodlines == research-available)
(up-compare-flag g-excess-resources-flag == gv-food-gold)
(or
	(up-compare-goal g-desired-num-cavalry >= 4)
	(up-compare-goal g-desired-num-cavalry-archers >= 4))
(or
	(goal g-primary-unit-class gv-cavalry)
	(or
		(goal g-primary-unit-class gv-cavalry-archer)
		(or
			(goal g-primary-unit-class gv-conquistador)
			(goal g-primary-unit-class gv-ballista-elephant))))
=>
(set-goal g-next-stable-tech ri-bloodlines)
(set-goal g-stable-tech-priority gv-secondary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-tertiary)
(up-research-status c: ri-bloodlines == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-cavalry >= 4)
	(up-compare-goal g-desired-num-cavalry-archers >= 4))
=>
(set-goal g-next-stable-tech ri-bloodlines)
(set-goal g-stable-tech-priority gv-tertiary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-tertiary)
(up-research-status c: ri-bloodlines == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(unit-type-count cavalry-class >= 8)
	(or
		(unit-type-count cavalry-archer-class >= 6)
		(unit-type-count cavalry-cannon-class >= 6)))
=>
(set-goal g-next-stable-tech ri-bloodlines)
(set-goal g-stable-tech-priority gv-tertiary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-low)
(up-research-status c: ri-bloodlines == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-cavalry > 0)
	(up-compare-goal g-desired-num-cavalry-archers > 0))
=>
(set-goal g-next-stable-tech ri-bloodlines)
(set-goal g-stable-tech-priority gv-low)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-low)
(up-research-status c: ri-bloodlines == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(unit-type-count cavalry-class > 0)
	(or
		(unit-type-count cavalry-archer-class > 0)
		(unit-type-count cavalry-cannon-class > 0)))
=>
(set-goal g-next-stable-tech ri-bloodlines)
(set-goal g-stable-tech-priority gv-low)
)

;Husbandry

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-secondary)
(up-research-status c: ri-husbandry == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
(goal g-town-under-attack NO)
(or
	(unit-type-count-total cavalry-class > 15)
	(or
		(unit-type-count-total cavalry-archer-class > 8)
		(unit-type-count-total cavalry-cannon-class > 8)))
(up-research-status c: ri-bloodlines != research-available)
=>
(set-goal g-next-stable-tech ri-husbandry)
(set-goal g-stable-tech-priority gv-secondary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-tertiary)
(up-research-status c: ri-husbandry == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
(goal g-town-under-attack NO)
(or
	(unit-type-count-total cavalry-class > 8)
	(or
		(unit-type-count-total cavalry-archer-class > 5)
		(unit-type-count-total cavalry-cannon-class > 5)))
(up-research-status c: ri-bloodlines != research-available)
=>
(set-goal g-next-stable-tech ri-husbandry)
(set-goal g-stable-tech-priority gv-tertiary)
)

(defrule
(building-type-count stable > 0)
(up-compare-goal g-stable-tech-priority < gv-low)
(up-research-status c: ri-husbandry == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
(goal g-town-under-attack NO)
(or
	(unit-type-count-total cavalry-class > 0)
	(or
		(unit-type-count-total cavalry-archer-class > 0)
		(unit-type-count-total cavalry-cannon-class > 0)))
(up-research-status c: ri-bloodlines != research-available)
=>
(set-goal g-next-stable-tech ri-husbandry)
(set-goal g-stable-tech-priority gv-low)
)



;========Siege Workshop

;Onager

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-primary)
(up-research-status c: ri-onager == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-primary-unit mangonel)
(or
	(up-compare-goal g-desired-num-mangonel > 2)
	(up-compare-goal g-mangonel-line >= 4))
=>
(set-goal g-next-siege-workshop-tech ri-onager)
(set-goal g-siege-workshop-tech-priority gv-primary)
)

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-secondary)
(up-research-status c: ri-onager == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-secondary-unit mangonel)
(or
	(up-compare-goal g-desired-num-mangonel > 2)
	(up-compare-goal g-mangonel-line >= 4))
=>
(set-goal g-next-siege-workshop-tech ri-onager)
(set-goal g-siege-workshop-tech-priority gv-secondary)
)

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-tertiary)
(up-research-status c: ri-onager == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-tertiary-unit mangonel)
(or
	(up-compare-goal g-desired-num-mangonel > 1)
	(up-compare-goal g-mangonel-line >= 3))
=>
(set-goal g-next-siege-workshop-tech ri-onager)
(set-goal g-siege-workshop-tech-priority gv-tertiary)
)

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-low)
(up-research-status c: ri-onager == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-mangonel > 0)
	(up-compare-goal g-mangonel-line >= 2))
=>
(set-goal g-next-siege-workshop-tech ri-onager)
(set-goal g-siege-workshop-tech-priority gv-low)
)

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-excess-only)
(up-research-status c: ri-onager == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(up-compare-goal g-mangonel-line > 0)
=>
(set-goal g-next-siege-workshop-tech ri-onager)
(set-goal g-siege-workshop-tech-priority gv-excess-only)
)

;Siege Onager

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-primary)
(up-research-status c: ri-siege-onager == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-primary-unit mangonel)
(or
	(up-compare-goal g-desired-num-mangonel > 2)
	(up-compare-goal g-mangonel-line >= 4))
=>
(set-goal g-next-siege-workshop-tech ri-siege-onager)
(set-goal g-siege-workshop-tech-priority gv-primary)
)

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-secondary)
(up-research-status c: ri-siege-onager == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-secondary-unit mangonel)
(or
	(up-compare-goal g-desired-num-mangonel > 2)
	(up-compare-goal g-mangonel-line >= 4))
=>
(set-goal g-next-siege-workshop-tech ri-siege-onager)
(set-goal g-siege-workshop-tech-priority gv-secondary)
)

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-tertiary)
(up-research-status c: ri-siege-onager == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(goal g-tertiary-unit mangonel)
(or
	(up-compare-goal g-desired-num-mangonel > 1)
	(up-compare-goal g-mangonel-line >= 3))
=>
(set-goal g-next-siege-workshop-tech ri-siege-onager)
(set-goal g-siege-workshop-tech-priority gv-tertiary)
)

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-low)
(up-research-status c: ri-siege-onager == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-mangonel > 0)
	(up-compare-goal g-mangonel-line >= 2))
=>
(set-goal g-next-siege-workshop-tech ri-siege-onager)
(set-goal g-siege-workshop-tech-priority gv-low)
)

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-excess-only)
(up-research-status c: ri-siege-onager == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(up-compare-goal g-mangonel-line > 0)
=>
(set-goal g-next-siege-workshop-tech ri-siege-onager)
(set-goal g-siege-workshop-tech-priority gv-excess-only)
)

;Capped Ram

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-primary)
(up-research-status c: ri-capped-ram == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
(or
	(goal g-primary-unit battering-ram)
	(goal g-secondary-unit battering-ram))
(or
	(up-compare-goal g-desired-num-battering-ram > 3)
	(unit-type-count-total battering-ram-line >= 5))
=>
(set-goal g-next-siege-workshop-tech ri-capped-ram)
(set-goal g-siege-workshop-tech-priority gv-primary)
)

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-secondary)
(up-research-status c: ri-capped-ram == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
(or
	(up-compare-goal g-desired-num-battering-ram > 3)
	(unit-type-count-total battering-ram-line >= 5))
=>
(set-goal g-next-siege-workshop-tech ri-capped-ram)
(set-goal g-siege-workshop-tech-priority gv-secondary)
)

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-tertiary)
(up-research-status c: ri-capped-ram == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
(or
	(up-compare-goal g-desired-num-battering-ram > 0)
	(unit-type-count-total battering-ram-line >= 3))
=>
(set-goal g-next-siege-workshop-tech ri-capped-ram)
(set-goal g-siege-workshop-tech-priority gv-tertiary)
)

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-excess-only)
(up-research-status c: ri-capped-ram == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
(unit-type-count-total battering-ram-line > 0)
=>
(set-goal g-next-siege-workshop-tech ri-capped-ram)
(set-goal g-siege-workshop-tech-priority gv-excess-only)
)

;Siege Ram

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-primary)
(up-research-status c: ri-siege-ram == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
(goal g-primary-unit battering-ram)
(or
	(up-compare-goal g-desired-num-battering-ram > 3)
	(unit-type-count-total battering-ram-line >= 5))
=>
(set-goal g-next-siege-workshop-tech ri-siege-ram)
(set-goal g-siege-workshop-tech-priority gv-primary)
)

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-secondary)
(up-research-status c: ri-siege-ram == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
(goal g-secondary-unit battering-ram)
(or
	(up-compare-goal g-desired-num-battering-ram > 3)
	(unit-type-count-total battering-ram-line >= 5))
=>
(set-goal g-next-siege-workshop-tech ri-siege-ram)
(set-goal g-siege-workshop-tech-priority gv-secondary)
)

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-tertiary)
(up-research-status c: ri-siege-ram == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
(or
	(up-compare-goal g-desired-num-battering-ram > 2)
	(unit-type-count-total battering-ram-line >= 4))
=>
(set-goal g-next-siege-workshop-tech ri-siege-ram)
(set-goal g-siege-workshop-tech-priority gv-tertiary)
)

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-low)
(up-research-status c: ri-siege-ram == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
(or
	(up-compare-goal g-desired-num-battering-ram > 0)
	(unit-type-count-total battering-ram-line >= 3))
=>
(set-goal g-next-siege-workshop-tech ri-siege-ram)
(set-goal g-siege-workshop-tech-priority gv-low)
)

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-excess-only)
(up-research-status c: ri-siege-ram == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food))
(unit-type-count-total battering-ram-line > 0)
=>
(set-goal g-next-siege-workshop-tech ri-siege-ram)
(set-goal g-siege-workshop-tech-priority gv-excess-only)
)

;Heavy Scorpion

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-primary)
(up-research-status c: ri-heavy-scorpion == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(goal g-primary-unit scorpion)
(or
	(up-compare-goal g-desired-num-scorpion > 3)
	(unit-type-count-total scorpion-line >= 5))
=>
(set-goal g-next-siege-workshop-tech ri-heavy-scorpion)
(set-goal g-siege-workshop-tech-priority gv-primary)
)

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-secondary)
(up-research-status c: ri-heavy-scorpion == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(goal g-secondary-unit scorpion)
(or
	(up-compare-goal g-desired-num-scorpion > 3)
	(unit-type-count-total scorpion-line >= 5))
=>
(set-goal g-next-siege-workshop-tech ri-heavy-scorpion)
(set-goal g-siege-workshop-tech-priority gv-secondary)
)

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-tertiary)
(up-research-status c: ri-heavy-scorpion == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(goal g-tertiary-unit scorpion)
(or
	(up-compare-goal g-desired-num-scorpion > 2)
	(unit-type-count-total scorpion-line >= 4))
=>
(set-goal g-next-siege-workshop-tech ri-heavy-scorpion)
(set-goal g-siege-workshop-tech-priority gv-tertiary)
)

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-low)
(up-research-status c: ri-heavy-scorpion == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(or
	(up-compare-goal g-desired-num-scorpion > 0)
	(unit-type-count-total scorpion-line >= 3))
=>
(set-goal g-next-siege-workshop-tech ri-heavy-scorpion)
(set-goal g-siege-workshop-tech-priority gv-low)
)

(defrule
(building-type-count siege-workshop > 0)
(up-compare-goal g-siege-workshop-tech-priority < gv-excess-only)
(up-research-status c: ri-heavy-scorpion == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-wood))
(unit-type-count-total scorpion-line > 0)
=>
(set-goal g-next-siege-workshop-tech ri-heavy-scorpion)
(set-goal g-siege-workshop-tech-priority gv-excess-only)
)



;========Castle

;Conscription

(defrule
(building-type-count castle > 0)
(up-research-status c: ri-conscription == research-available)
=>
(up-get-fact military-population 0 g-temp)
(up-modify-goal g-temp g:- g-desired-military-pop)
(up-modify-goal g-temp c:* -1)
)

(defrule
(building-type-count castle > 0)
(up-compare-goal g-castle-tech-priority < gv-primary)
(up-research-status c: ri-conscription == research-available)
(up-compare-goal g-temp > 20)	;difference between desired military pop and current military pop
=>
(set-goal g-next-castle-tech ri-conscription)
(set-goal g-castle-tech-priority gv-primary)
)

(defrule
(building-type-count castle > 0)
(up-compare-goal g-castle-tech-priority < gv-secondary)
(up-research-status c: ri-conscription == research-available)
(or
	(up-compare-goal g-attack-status >= gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(up-compare-goal g-temp > 0)	;difference between desired military pop and current military pop
=>
(set-goal g-next-castle-tech ri-conscription)
(set-goal g-castle-tech-priority gv-secondary)
)

;Elite Unique Unit

(defrule
(building-type-count castle > 0)
(up-compare-goal g-castle-tech-priority < gv-primary)
(up-research-status c: my-unique-unit-upgrade == research-available)
(goal g-primary-unit my-unique-unit)
(or
	(up-compare-goal g-desired-num-unique-unit > 6)
	(up-compare-goal g-unique-unit-line >= 9))
=>
(set-goal g-next-castle-tech my-unique-unit-upgrade)
(set-goal g-castle-tech-priority gv-primary)
)

#load-if-not-defined BERBERS-CIV
	#load-if-not-defined MAYAN-CIV

		(defrule
		(building-type-count castle > 0)
		(up-compare-goal g-castle-tech-priority < gv-secondary)
		(up-research-status c: my-unique-unit-upgrade == research-available)
		(or
			(up-compare-goal g-attack-status >= gv-first-attack)
			(up-compare-flag g-excess-resources-flag == gv-food-gold))
		(goal g-secondary-unit my-unique-unit)
		(or
			(up-compare-goal g-desired-num-unique-unit > 6)
			(up-compare-goal g-unique-unit-line >= 9))
		=>
		(set-goal g-next-castle-tech my-unique-unit-upgrade)
		(set-goal g-castle-tech-priority gv-secondary)
		)

		(defrule
		(building-type-count castle > 0)
		(up-compare-goal g-castle-tech-priority < gv-tertiary)
		(up-research-status c: my-unique-unit-upgrade == research-available)
		(or
			(up-compare-goal g-attack-status >= gv-first-attack)
			(up-compare-flag g-excess-resources-flag == gv-food-gold))
		(goal g-tertiary-unit my-unique-unit)
		(or
			(up-compare-goal g-desired-num-unique-unit > 5)
			(up-compare-goal g-unique-unit-line >= 7))
		=>
		(set-goal g-next-castle-tech my-unique-unit-upgrade)
		(set-goal g-castle-tech-priority gv-tertiary)
		)

		(defrule
		(building-type-count castle > 0)
		(up-compare-goal g-castle-tech-priority < gv-low)
		(up-research-status c: my-unique-unit-upgrade == research-available)
		(or
			(up-compare-goal g-attack-status >= gv-first-attack)
			(up-compare-flag g-excess-resources-flag == gv-food-gold))
		(or
			(up-compare-goal g-desired-num-unique-unit > 0)
			(up-compare-goal g-unique-unit-line >= 5))
		=>
		(set-goal g-next-castle-tech my-unique-unit-upgrade)
		(set-goal g-castle-tech-priority gv-low)
		)

		(defrule
		(building-type-count castle > 0)
		(up-compare-goal g-castle-tech-priority < gv-excess-only)
		(up-research-status c: my-unique-unit-upgrade == research-available)
		(or
			(up-compare-goal g-attack-status >= gv-first-attack)
			(up-compare-flag g-excess-resources-flag == gv-food-gold))
		(up-compare-goal g-unique-unit-line > 0)
		=>
		(set-goal g-next-castle-tech my-unique-unit-upgrade)
		(set-goal g-castle-tech-priority gv-excess-only)
		)
		
	#end-if
#end-if

#load-if-defined BERBERS-CIV

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: my-unique-unit-upgrade == research-available)
	(or
		(up-compare-goal g-attack-status >= gv-first-attack)
		(up-compare-flag g-excess-resources-flag == gv-wood-gold))
	(goal g-secondary-unit my-unique-unit)
	(or
		(up-compare-goal g-desired-num-unique-unit > 6)
		(up-compare-goal g-unique-unit-line >= 9))
	=>
	(set-goal g-next-castle-tech my-unique-unit-upgrade)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: my-unique-unit-upgrade == research-available)
	(or
		(up-compare-goal g-attack-status >= gv-first-attack)
		(up-compare-flag g-excess-resources-flag == gv-wood-gold))
	(goal g-tertiary-unit my-unique-unit)
	(or
		(up-compare-goal g-desired-num-unique-unit > 5)
		(up-compare-goal g-unique-unit-line >= 7))
	=>
	(set-goal g-next-castle-tech my-unique-unit-upgrade)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: my-unique-unit-upgrade == research-available)
	(or
		(up-compare-goal g-attack-status >= gv-first-attack)
		(up-compare-flag g-excess-resources-flag == gv-wood-gold))
	(or
		(up-compare-goal g-desired-num-unique-unit > 0)
		(up-compare-goal g-unique-unit-line >= 5))
	=>
	(set-goal g-next-castle-tech my-unique-unit-upgrade)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: my-unique-unit-upgrade == research-available)
	(or
		(up-compare-goal g-attack-status >= gv-first-attack)
		(up-compare-flag g-excess-resources-flag == gv-wood-gold))
	(up-compare-goal g-unique-unit-line > 0)
	=>
	(set-goal g-next-castle-tech my-unique-unit-upgrade)
	(set-goal g-castle-tech-priority gv-excess-only)
	)
	
#end-if

#load-if-defined MAYAN-CIV

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: my-unique-unit-upgrade == research-available)
	(or
		(up-compare-goal g-attack-status >= gv-first-attack)
		(up-compare-flag g-excess-resources-flag == gv-food-wood))
	(goal g-secondary-unit my-unique-unit)
	(or
		(up-compare-goal g-desired-num-unique-unit > 6)
		(up-compare-goal g-unique-unit-line >= 9))
	=>
	(set-goal g-next-castle-tech my-unique-unit-upgrade)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: my-unique-unit-upgrade == research-available)
	(or
		(up-compare-goal g-attack-status >= gv-first-attack)
		(up-compare-flag g-excess-resources-flag == gv-food-wood))
	(goal g-tertiary-unit my-unique-unit)
	(or
		(up-compare-goal g-desired-num-unique-unit > 5)
		(up-compare-goal g-unique-unit-line >= 7))
	=>
	(set-goal g-next-castle-tech my-unique-unit-upgrade)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: my-unique-unit-upgrade == research-available)
	(or
		(up-compare-goal g-attack-status >= gv-first-attack)
		(up-compare-flag g-excess-resources-flag == gv-food-wood))
	(or
		(up-compare-goal g-desired-num-unique-unit > 0)
		(up-compare-goal g-unique-unit-line >= 5))
	=>
	(set-goal g-next-castle-tech my-unique-unit-upgrade)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: my-unique-unit-upgrade == research-available)
	(or
		(up-compare-goal g-attack-status >= gv-first-attack)
		(up-compare-flag g-excess-resources-flag == gv-food-wood))
	(up-compare-goal g-unique-unit-line > 0)
	=>
	(set-goal g-next-castle-tech my-unique-unit-upgrade)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

#end-if

;Unique Techs

#load-if-defined AZTEC-CIV

	;Garland Wars - infantry attack

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-primary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-primary-unit-class gv-infantry)
	(or
		(up-compare-goal g-desired-num-infantry > 10)
		(unit-type-count infantry-class >= 15))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-primary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-infantry > 10)
		(unit-type-count infantry-class >= 15))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-infantry > 0)
		(unit-type-count infantry-class >= 10))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(unit-type-count infantry-class > 0)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Atlatl - skirmisher range and attack

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-research-status c: ri-fletching != research-available)
	(up-research-status c: ri-bodkin-arrow != research-available)
	(up-research-status c: ri-bracer != research-available)
	(goal g-primary-unit skirmisher)
	(or
		(up-compare-goal g-desired-num-skirmisher > 5)
		(up-compare-goal g-skirmisher-line >= 8))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-research-status c: ri-fletching != research-available)
	(up-research-status c: ri-bodkin-arrow != research-available)
	(up-research-status c: ri-bracer != research-available)
	(or
		(goal g-secondary-unit skirmisher)
		(goal g-tertiary-unit skirmisher))
	(or
		(up-compare-goal g-desired-num-skirmisher > 5)
		(up-compare-goal g-skirmisher-line >= 5))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-research-status c: ri-fletching != research-available)
	(up-research-status c: ri-bodkin-arrow != research-available)
	(up-research-status c: ri-bracer != research-available)
	(or
		(up-compare-goal g-desired-num-skirmisher > 0)
		(up-compare-goal g-skirmisher-line > 0))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-research-status c: ri-fletching != research-available)
	(up-research-status c: ri-bodkin-arrow != research-available)
	(up-research-status c: ri-bracer != research-available)
	(goal g-primary-unit genitour)
	(or
		(up-compare-goal g-desired-num-genitour > 5)
		(up-compare-goal g-genitour-line >= 8))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-research-status c: ri-fletching != research-available)
	(up-research-status c: ri-bodkin-arrow != research-available)
	(up-research-status c: ri-bracer != research-available)
	(or
		(goal g-secondary-unit genitour)
		(goal g-tertiary-unit genitour))
	(or
		(up-compare-goal g-desired-num-genitour > 5)
		(up-compare-goal g-genitour-line >= 5))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-research-status c: ri-fletching != research-available)
	(up-research-status c: ri-bodkin-arrow != research-available)
	(up-research-status c: ri-bracer != research-available)
	(or
		(up-compare-goal g-desired-num-genitour > 0)
		(up-compare-goal g-genitour-line > 0))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

#end-if

#load-if-defined BERBERS-CIV

	;Maghrabi Camels - camel units regenerate

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(goal g-primary-unit camel)
		(goal g-secondary-unit camel))
	(or
		(up-compare-goal g-desired-num-camel > 12)
		(up-compare-goal g-camel-line >= 15))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(goal g-primary-unit my-unique-unit)
		(goal g-secondary-unit my-unique-unit))
	(or
		(up-compare-goal g-desired-num-unique-unit > 7)
		(up-compare-goal g-unique-unit-line >= 9))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-camel > 0)
		(or
			(up-compare-goal g-camel-line >= 5)
			(or
				(up-compare-goal g-desired-num-unique-unit > 0)
				(up-compare-goal g-unique-unit-line >= 5))))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Kasbah - team castle work rate

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(goal g-primary-unit my-unique-unit)
	(unit-type-count castle >= 2)
	(up-compare-goal g-desired-num-unique-unit > 5)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(goal g-secondary-unit my-unique-unit)
	(unit-type-count castle >= 2)
	(up-compare-goal g-desired-num-unique-unit > 5)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(and
			(unit-type-count castle >= 2)
			(up-compare-goal g-desired-num-unique-unit > 5))
		(players-building-type-count any-ally castle >= 2))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

#end-if

#load-if-defined BRITON-CIV

	;Warwolf - trebuchets have blast radius and 100% accuracy

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-trebuchet > 3)
		(unit-type-count-total trebuchet-set > 4))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-trebuchet > 0)
		(unit-type-count-total trebuchet-set > 0))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Yeomen - foot archer range and tower attack

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-archer > 10)
		(or
			(up-compare-goal g-desired-num-unique-unit > 10)
			(or
				(unit-type-count archer-line > 15)
				(unit-type-count my-unique-unit-line > 12))))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-archer > 0)
		(up-compare-goal g-desired-num-unique-unit > 0))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-watch-tower > 4)
		(up-compare-goal g-watch-tower-line > 7))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-high-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-watch-tower > 0)
		(up-compare-goal g-watch-tower-line > 0))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-high-excess-only)
	)

#end-if

#load-if-defined BURMESE-CIV

	;Manipur Cavalry - cavalry and arambai attack vs. buildings

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(goal g-primary-unit-class gv-cavalry)
		(or
			(goal g-primary-unit my-unique-unit)
			(or
				(goal g-secondary-unit-class gv-cavalry)
				(goal g-secondary-unit my-unique-unit))))
	(or
		(up-compare-goal g-desired-num-cavalry > 15)
		(up-compare-goal g-desired-num-unique-unit > 9))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-cavalry > 15)
		(or
			(unit-type-count cavalry-class >= 20)
			(or
				(up-compare-goal g-desired-num-unique-unit > 9)
				(up-compare-goal g-unique-unit-line >= 13))))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-cavalry > 0)
		(or
			(unit-type-count cavalry-class > 0)
			(or
				(up-compare-goal g-desired-num-unique-unit > 0)
				(up-compare-goal g-unique-unit-line > 0))))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Howdah - battle elephant armor

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(goal g-primary-unit battle-elephant)
	(up-research-status c: ri-scale-barding != research-available)
	(up-research-status c: ri-chain-barding != research-available)
	(up-research-status c: ri-plate-barding != research-available)
	(or
		(up-compare-goal g-desired-num-battle-elephant > 8)
		(up-compare-goal g-battle-elephant-line >= 12))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(goal g-secondary-unit battle-elephant)
		(goal g-tertiary-unit battle-elephant))
	(up-research-status c: ri-scale-barding != research-available)
	(up-research-status c: ri-chain-barding != research-available)
	(up-research-status c: ri-plate-barding != research-available)
	(or
		(up-compare-goal g-desired-num-battle-elephant > 6)
		(up-compare-goal g-battle-elephant-line >= 9))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-research-status c: ri-scale-barding != research-available)
	(up-research-status c: ri-chain-barding != research-available)
	(up-research-status c: ri-plate-barding != research-available)
	(or
		(up-compare-goal g-desired-num-battle-elephant > 0)
		(up-compare-goal g-battle-elephant-line > 6))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-research-status c: ri-scale-barding != research-available)
	(up-research-status c: ri-chain-barding != research-available)
	(up-research-status c: ri-plate-barding != research-available)
	(up-compare-goal g-battle-elephant-line > 0)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

#end-if

#load-if-defined BYZANTINE-CIV

	;Logistica - cataphract trample damage

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-primary-unit my-unique-unit)
	(up-research-status c: my-unique-unit-upgrade >= research-pending)
	(or
		(up-compare-goal g-desired-num-unique-unit > 9)
		(up-compare-goal g-unique-unit-line >= 12))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(goal g-secondary-unit my-unique-unit)
		(goal g-tertiary-unit my-unique-unit))
	(up-research-status c: my-unique-unit-upgrade >= research-pending)
	(or
		(up-compare-goal g-desired-num-unique-unit > 7)
		(up-compare-goal g-unique-unit-line >= 9))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(up-research-status c: my-unique-unit-upgrade >= research-pending)
	(or
		(up-compare-goal g-desired-num-unique-unit > 0)
		(up-compare-goal g-unique-unit-line >= 6))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(up-research-status c: my-unique-unit-upgrade >= research-pending)
	(up-compare-goal g-unique-unit-line > 0)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Greek Fire - fire ship range

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-fire-ship > 6)
		(up-compare-goal g-fire-galley-line >= 9))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-fire-ship > 3)
		(up-compare-goal g-fire-galley-line >= 5))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-fire-ship > 0)
		(up-compare-goal g-fire-galley-line >= 5))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-compare-goal g-fire-galley-line > 0)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

#end-if

#load-if-defined CELTIC-CIV

	;Furor Celtica - siege weapon HP
	
	;Determine desired counts and existing counts for siege workshop siege only
	(defrule
	(building-type-count castle > 0)
	=>
	(up-modify-goal g-temp g:= g-desired-num-siege)
	(up-modify-goal g-temp g:- g-desired-num-trebuchet)
	(up-modify-goal g-temp g:- g-desired-num-petard)
	(up-get-fact unit-type-count petard-class g-temp-2)
	(up-modify-goal g-temp-2 c:* -1)	;alternate way of subtracting petards without using extra temp goal
	(up-modify-goal g-temp-2 g:+ g-siege-class)
	(up-modify-goal g-temp-2 c:- trebuchet-set)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(goal g-primary-unit-class gv-siege)
		(goal g-secondary-unit-class gv-siege))
	(or
		(up-compare-goal g-temp > 3)		;desired num siege weapons from siege workshop
		(up-compare-goal g-temp-2 > 4))		;num siege workshop units AI currently has
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-temp > 2)		;desired num siege weapons from siege workshop
		(up-compare-goal g-temp-2 > 3))		;num siege workshop units AI currently has
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-temp > 0)		;desired num siege weapons from siege workshop
		(up-compare-goal g-temp-2 > 2))		;num siege workshop units AI currently has
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(up-compare-goal g-temp-2 > 0)		;num siege workshop units AI currently has
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Stronghold - castle and tower fire rate

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(unit-type-count castle > 1)
		(up-compare-goal g-watch-tower-line >= 5))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

#end-if

#load-if-defined CHINESE-CIV

	;Rocketry - chu ko nu and scorpion attack

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-primary-unit my-unique-unit)
	(or
		(up-compare-goal g-desired-num-unique-unit > 16)
		(up-compare-goal g-unique-unit-line >= 22))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(goal g-primary-unit scorpion)
		(goal g-secondary-unit scorpion))
	(or
		(up-compare-goal g-desired-num-scorpion > 6)
		(unit-type-count scorpion-line >= 9))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-scorpion > 0)
		(unit-type-count scorpion-line > 0))
	(or
		(up-compare-goal g-desired-num-unique-unit > 0)
		(up-compare-goal g-unique-unit-line > 0))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Great Wall - Tower/walls HP

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-watch-tower-line >= 6)
		(unit-type-count bombard-tower > 3))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-high-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-watch-tower-line > 0)
		(unit-type-count bombard-tower > 0))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-high-excess-only)
	)

#end-if

#load-if-defined ETHIOPIAN-CIV

	;Torsion Engines - siege workshop unit blast radius
	
	;Determine desired counts and existing counts for siege workshop siege only
	(defrule
	(building-type-count castle > 0)
	=>
	(up-modify-goal g-temp g:= g-desired-num-siege)
	(up-modify-goal g-temp g:- g-desired-num-trebuchet)
	(up-modify-goal g-temp g:- g-desired-num-petard)
	(up-get-fact unit-type-count petard-class g-temp-2)
	(up-modify-goal g-temp-2 c:* -1)	;alternate way of subtracting petards without using extra temp goal
	(up-modify-goal g-temp-2 g:+ g-siege-class)
	(up-modify-goal g-temp-2 c:- trebuchet-set)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-primary-unit-class gv-siege)
	(or
		(up-compare-goal g-temp > 3)		;desired num siege weapons from siege workshop
		(up-compare-goal g-temp-2 > 4))		;num siege workshop units AI currently has
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(goal g-secondary-unit-class gv-siege)
		(goal g-tertiary-unit-class gv-siege))
	(or
		(up-compare-goal g-temp > 2)		;desired num siege weapons from siege workshop
		(up-compare-goal g-temp-2 > 3))		;num siege workshop units AI currently has
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-temp > 1)		;desired num siege weapons from siege workshop
		(up-compare-goal g-temp-2 > 2))		;num siege workshop units AI currently has
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-temp > 0)		;desired num siege weapons from siege workshop
		(up-compare-goal g-temp-2 > 0))		;num siege workshop units AI currently has
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Royal Heirs - Shotel warrior training time

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-primary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(goal g-primary-unit my-unique-unit)
	(up-compare-goal g-desired-num-unique-unit > 12)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-primary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(goal g-secondary-unit my-unique-unit)
	(up-compare-goal g-desired-num-unique-unit > 12)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(goal g-tertiary-unit my-unique-unit)
	(up-compare-goal g-desired-num-unique-unit > 9)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-compare-goal g-desired-num-unique-unit > 6)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-compare-goal g-desired-num-unique-unit > 0)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

#end-if

#load-if-defined FRANKISH-CIV

	;Bearded Axe - throwing axemen range

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-primary-unit my-unique-unit)
	(or
		(up-compare-goal g-desired-num-unique-unit > 9)
		(up-compare-goal g-unique-unit-line > 15))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(goal g-secondary-unit my-unique-unit)
		(goal g-tertiary-unit my-unique-unit))
	(or
		(up-compare-goal g-desired-num-unique-unit > 8)
		(up-compare-goal g-unique-unit-line > 13))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-unique-unit > 7)
		(up-compare-goal g-unique-unit-line > 10))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-unique-unit > 0)
		(up-compare-goal g-unique-unit-line > 0))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Chivalry - stable work rate

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-primary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(goal g-primary-unit-class gv-cavalry)
	(or
		(up-compare-goal g-desired-num-scout-cavalry > 15)
		(up-compare-goal g-desired-num-knight > 15))
	(civilian-population > 75)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-primary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(goal g-secondary-unit-class gv-cavalry)
	(or
		(up-compare-goal g-desired-num-scout-cavalry > 15)
		(up-compare-goal g-desired-num-knight > 15))
	(civilian-population > 75)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(goal g-tertiary-unit-class gv-cavalry)
	(or
		(up-compare-goal g-desired-num-scout-cavalry > 12)
		(up-compare-goal g-desired-num-knight > 12))
	(civilian-population > 75)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-scout-cavalry > 8)
		(up-compare-goal g-desired-num-knight > 8))
	(civilian-population > 75)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-scout-cavalry > 0)
		(up-compare-goal g-desired-num-knight > 0))
	(civilian-population > 75)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

#end-if

#load-if-defined GOTHIC-CIV

	;Perfusion - barracks work faster

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-primary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-primary-unit-class gv-infantry)
	(or
		(up-compare-goal g-primary-unit != my-unique-unit)
		(up-research-status c: ri-castle-unique-tech >= research-pending))
	(up-compare-goal g-desired-num-infantry > 15)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-primary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-secondary-unit-class gv-infantry)
	(or
		(up-compare-goal g-secondary-unit != my-unique-unit)
		(up-research-status c: ri-castle-unique-tech >= research-pending))
	(up-compare-goal g-desired-num-infantry > 15)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-tertiary-unit-class gv-infantry)
	(or
		(up-compare-goal g-tertiary-unit != my-unique-unit)
		(up-research-status c: ri-castle-unique-tech >= research-pending))
	(up-compare-goal g-desired-num-infantry > 12)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(up-compare-goal g-desired-num-infantry > 8)
	(or
		(up-compare-goal g-desired-num-unique-unit <= 8)
		(up-research-status c: ri-castle-unique-tech >= research-pending))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(up-compare-goal g-desired-num-infantry > 0)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Anarchy - huskarls train at barracks

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(goal g-primary-unit my-unique-unit)
		(goal g-secondary-unit my-unique-unit))
	(up-compare-goal g-desired-num-unique-unit > 12)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(goal g-tertiary-unit my-unique-unit)
	(up-compare-goal g-desired-num-unique-unit > 9)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-compare-goal g-desired-num-unique-unit > 6)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-compare-goal g-desired-num-unique-unit > 0)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

#end-if

#load-if-defined HUN-CIV
	#load-if-defined VICTORY-STANDARD

		;Atheism - relic wonder victories longer, spies/treason cheaper

		(defrule
		(building-type-count castle > 0)
		(up-compare-goal g-castle-tech-priority < gv-tertiary)
		(up-research-status c: ri-imperial-unique-tech == research-available)
		(or
			(players-building-type-count any-enemy wonder > 0)
			(enemy-captured-relics))
		=>
		(set-goal g-next-castle-tech ri-imperial-unique-tech)
		(set-goal g-castle-tech-priority gv-tertiary)
		)

		(defrule
		(building-type-count castle > 0)
		(up-compare-goal g-castle-tech-priority < gv-high-excess-only)
		(up-research-status c: ri-imperial-unique-tech == research-available)
		=>
		(set-goal g-next-castle-tech ri-imperial-unique-tech)
		(set-goal g-castle-tech-priority gv-high-excess-only)
		)
		
	#end-if

	;Marauders - tarkans train at stable

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(goal g-primary-unit my-unique-unit)
		(goal g-secondary-unit my-unique-unit))
	(up-compare-goal g-desired-num-unique-unit > 12)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(goal g-tertiary-unit my-unique-unit)
	(up-compare-goal g-desired-num-unique-unit > 9)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-compare-goal g-desired-num-unique-unit > 6)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-compare-goal g-desired-num-unique-unit > 0)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

#end-if

#load-if-defined INCAN-CIV

	;Couriers - kamayuks, slingers, eagle warriors extra armor

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(goal g-primary-unit my-unique-unit)
		(goal g-secondary-unit my-unique-unit))
	(or
		(up-compare-goal g-desired-num-unique-unit > 10)
		(up-compare-goal g-unique-unit-line > 12))
	(up-research-status c: ri-scale-mail != research-available)
	(up-research-status c: ri-chain-mail != research-available)
	(up-research-status c: ri-plate-mail != research-available)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-tertiary-unit my-unique-unit)
	(or
		(up-compare-goal g-desired-num-unique-unit > 7)
		(up-compare-goal g-unique-unit-line > 9))
	(up-research-status c: ri-scale-mail != research-available)
	(up-research-status c: ri-chain-mail != research-available)
	(up-research-status c: ri-plate-mail != research-available)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-unique-unit > 0)
		(up-compare-goal g-unique-unit-line > 6))
	(up-research-status c: ri-scale-mail != research-available)
	(up-research-status c: ri-chain-mail != research-available)
	(up-research-status c: ri-plate-mail != research-available)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(up-compare-goal g-unique-unit-line > 0)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(goal g-primary-unit eagle-warrior)
		(goal g-secondary-unit eagle-warrior))
	(or
		(up-compare-goal g-desired-num-eagle-warrior > 10)
		(up-compare-goal g-eagle-scout-line > 12))
	(up-research-status c: ri-scale-mail != research-available)
	(up-research-status c: ri-chain-mail != research-available)
	(up-research-status c: ri-plate-mail != research-available)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-tertiary-unit eagle-warrior)
	(or
		(up-compare-goal g-desired-num-eagle-warrior > 7)
		(up-compare-goal g-eagle-scout-line > 9))
	(up-research-status c: ri-scale-mail != research-available)
	(up-research-status c: ri-chain-mail != research-available)
	(up-research-status c: ri-plate-mail != research-available)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-eagle-warrior > 0)
		(up-compare-goal g-eagle-scout-line > 6))
	(up-research-status c: ri-scale-mail != research-available)
	(up-research-status c: ri-chain-mail != research-available)
	(up-research-status c: ri-plate-mail != research-available)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(up-compare-goal g-eagle-scout-line > 0)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(goal g-primary-unit slinger)
		(goal g-secondary-unit slinger))
	(or
		(up-compare-goal g-desired-num-slinger > 10)
		(unit-type-count-total slinger > 12))
	(up-research-status c: ri-padded-archer-armor != research-available)
	(up-research-status c: ri-leather-archer-armor != research-available)
	(up-research-status c: ri-ring-archer-armor != research-available)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-tertiary-unit slinger)
	(or
		(up-compare-goal g-desired-num-slinger > 7)
		(unit-type-count-total slinger > 9))
	(up-research-status c: ri-padded-archer-armor != research-available)
	(up-research-status c: ri-leather-archer-armor != research-available)
	(up-research-status c: ri-ring-archer-armor != research-available)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-slinger > 0)
		(unit-type-count-total slinger > 6))
	(up-research-status c: ri-padded-archer-armor != research-available)
	(up-research-status c: ri-leather-archer-armor != research-available)
	(up-research-status c: ri-ring-archer-armor != research-available)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(unit-type-count-total slinger > 0)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Andean Sling - no min range for skirmishers, slingers, or genitours

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(goal g-primary-unit skirmisher)
		(goal g-secondary-unit skirmisher))
	(or
		(up-compare-goal g-desired-num-skirmisher > 9)
		(up-compare-goal g-skirmisher-line >= 12))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-skirmisher > 6)
		(up-compare-goal g-skirmisher-line >= 9))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-skirmisher > 0)
		(up-compare-goal g-skirmisher-line > 0))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(goal g-primary-unit slinger)
		(goal g-secondary-unit slinger))
	(or
		(up-compare-goal g-desired-num-slinger > 9)
		(unit-type-count-total slinger >= 12))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-slinger > 6)
		(unit-type-count-total slinger >= 9))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-slinger > 0)
		(unit-type-count-total slinger > 0))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(goal g-primary-unit genitour)
		(goal g-secondary-unit genitour))
	(or
		(up-compare-goal g-desired-num-genitour > 9)
		(up-compare-goal g-genitour-line >= 12))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-genitour > 6)
		(up-compare-goal g-genitour-line >= 9))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-genitour > 0)
		(up-compare-goal g-genitour-line > 0))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

#end-if

#load-if-defined INDIAN-CIV

	;Shatagni - hand cannoneers more range

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-primary-unit hand-cannoneer)
	(or
		(up-compare-goal g-desired-num-hand-cannoneer > 12)
		(unit-type-count hand-cannoneer >= 15))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-secondary-unit hand-cannoneer)
	(or
		(up-compare-goal g-desired-num-hand-cannoneer > 9)
		(unit-type-count hand-cannoneer >= 12))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-hand-cannoneer > 5)
		(unit-type-count hand-cannoneer >= 8))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-hand-cannoneer > 0)
		(unit-type-count hand-cannoneer > 0))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Sultans - all gold sources gather faster

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(goal g-town-under-attack NO)
	(or
		(unit-type-count villager-gold > 5)
		(or
			(unit-type-count trade-cart > 10)
			(up-compare-goal g-num-relics-gathered >= 2)))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(goal g-town-under-attack NO)
	(unit-type-count villager-gold > 5)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

#end-if

#load-if-defined ITALIAN-CIV

	;Silk Road - trade carts/cogs cost less

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-trade-cart > 0)
		(up-compare-goal g-desired-num-trade-cog > 0))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	;Pavise - increases foot archer armor

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(goal g-primary-unit archer)
	(or
		(up-compare-goal g-desired-num-archer > 10)
		(unit-type-count archer-line >= 15))
	(up-research-status c: ri-padded-archer-armor != research-available)
	(up-research-status c: ri-leather-archer-armor != research-available)
	(up-research-status c: ri-ring-archer-armor != research-available)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(goal g-secondary-unit archer)
		(goal g-tertiary-unit archer))
	(or
		(up-compare-goal g-desired-num-archer > 7)
		(unit-type-count archer-line >= 12))
	(up-research-status c: ri-padded-archer-armor != research-available)
	(up-research-status c: ri-leather-archer-armor != research-available)
	(up-research-status c: ri-ring-archer-armor != research-available)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-archer > 0)
		(unit-type-count archer-line >= 8))
	(up-research-status c: ri-padded-archer-armor != research-available)
	(up-research-status c: ri-leather-archer-armor != research-available)
	(up-research-status c: ri-ring-archer-armor != research-available)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-unique-unit-line > 0)
		(unit-type-count archer-line > 0))
	(up-research-status c: ri-padded-archer-armor != research-available)
	(up-research-status c: ri-leather-archer-armor != research-available)
	(up-research-status c: ri-ring-archer-armor != research-available)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(goal g-primary-unit my-unique-unit)
	(or
		(up-compare-goal g-desired-num-unique-unit > 10)
		(up-compare-goal g-unique-unit-line >= 15))
	(up-research-status c: ri-padded-archer-armor != research-available)
	(up-research-status c: ri-leather-archer-armor != research-available)
	(up-research-status c: ri-ring-archer-armor != research-available)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(goal g-secondary-unit my-unique-unit)
		(goal g-tertiary-unit my-unique-unit))
	(or
		(up-compare-goal g-desired-num-unique-unit > 7)
		(up-compare-goal g-unique-unit-line >= 12))
	(up-research-status c: ri-padded-archer-armor != research-available)
	(up-research-status c: ri-leather-archer-armor != research-available)
	(up-research-status c: ri-ring-archer-armor != research-available)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-unique-unit > 0)
		(up-compare-goal g-unique-unit-line >= 8))
	(up-research-status c: ri-padded-archer-armor != research-available)
	(up-research-status c: ri-leather-archer-armor != research-available)
	(up-research-status c: ri-ring-archer-armor != research-available)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

#end-if

#load-if-defined JAPANESE-CIV

	;Kataparuto - trebuchets fire/unpack faster

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-trebuchet > 3)
		(unit-type-count-total trebuchet-set >= 5))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-trebuchet > 1)
		(unit-type-count-total trebuchet-set >= 3))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-trebuchet > 0)
		(unit-type-count-total trebuchet-set > 0))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Yasama - towers fire extra arrows

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-watch-tower > 4)
		(up-compare-goal g-watch-tower-line >= 6))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-watch-tower > 2)
		(up-compare-goal g-watch-tower-line >= 3))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-watch-tower > 0)
		(up-compare-goal g-watch-tower-line > 0))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

#end-if

#load-if-defined KHMER-CIV

	;Double Crossbow - ballista elephants, scorpions fire 2 arrows

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(goal g-primary-unit my-unique-unit)
		(goal g-secondary-unit my-unique-unit))
	(or
		(up-compare-goal g-desired-num-unique-unit > 9)
		(up-compare-goal g-unique-unit-line >= 15))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-tertiary-unit my-unique-unit)
	(or
		(up-compare-goal g-desired-num-unique-unit > 7)
		(up-compare-goal g-unique-unit-line >= 12))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-unique-unit > 0)
		(up-compare-goal g-unique-unit-line >= 8))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(up-compare-goal g-unique-unit-line > 0)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(goal g-primary-unit scorpion)
		(goal g-secondary-unit scorpion))
	(or
		(up-compare-goal g-desired-num-scorpion > 6)
		(unit-type-count-total scorpion-line >= 8))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-tertiary-unit scorpion)
	(or
		(up-compare-goal g-desired-num-scorpion > 4)
		(unit-type-count-total scorpion-line >= 6))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-scorpion > 0)
		(unit-type-count-total scorpion-line >= 4))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(unit-type-count-total scorpion-line > 0)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Tusk Swords - battle elephant attack

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-primary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(goal g-primary-unit battle-elephant)
	(or
		(up-compare-goal g-desired-num-battle-elephant > 8)
		(up-compare-goal g-battle-elephant-line >= 12))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-primary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(goal g-secondary-unit battle-elephant)
	(or
		(up-compare-goal g-desired-num-battle-elephant > 8)
		(up-compare-goal g-battle-elephant-line >= 12))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(goal g-tertiary-unit battle-elephant)
	(or
		(up-compare-goal g-desired-num-battle-elephant > 6)
		(up-compare-goal g-battle-elephant-line >= 9))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-battle-elephant > 0)
		(up-compare-goal g-battle-elephant-line >= 6))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-compare-goal g-battle-elephant-line > 0)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

#end-if

#load-if-defined KOREAN-CIV

	;Shinkichon - mangonel less minimum range (more range in 1.0c)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(goal g-primary-unit mangonel)
		(or
			(goal g-secondary-unit mangonel)
			(goal g-tertiary-unit mangonel)))
	(or
		(up-compare-goal g-desired-num-mangonel >= 4)
		(unit-type-count mangonel-line >= 6))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-mangonel > 0)
		(unit-type-count mangonel-line >= 4))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(unit-type-count mangonel-line > 0)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Panokseon - turtle ship speed

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-unique-ship >= 5)
		(unit-type-count turtle-ship-line >= 6))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-unique-ship >= 2)
		(unit-type-count turtle-ship-line >= 4))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-unique-ship > 0)
		(unit-type-count turtle-ship-line > 0))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

#end-if

#load-if-defined MAGYAR-CIV

	;Recurve Bow - cavalry archer range and attack

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-primary-unit cavalry-archer)
	(or
		(up-compare-goal g-desired-num-cavalry-archer > 8)
		(unit-type-count cavalry-archer-line >= 12))
	(up-research-status c: ri-fletching != research-available)
	(up-research-status c: ri-bodkin-arrow != research-available)
	(up-research-status c: ri-bracer != research-available)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(goal g-secondary-unit cavalry-archer)
		(goal g-tertiary-unit cavalry-archer))
	(or
		(up-compare-goal g-desired-num-cavalry-archer > 6)
		(unit-type-count cavalry-archer-line >= 9))
	(up-research-status c: ri-fletching != research-available)
	(up-research-status c: ri-bodkin-arrow != research-available)
	(up-research-status c: ri-bracer != research-available)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-cavalry-archer > 0)
		(unit-type-count cavalry-archer-line >= 6))
	(up-research-status c: ri-fletching != research-available)
	(up-research-status c: ri-bodkin-arrow != research-available)
	(up-research-status c: ri-bracer != research-available)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(unit-type-count cavalry-archer-line > 0)
	(up-research-status c: ri-fletching != research-available)
	(up-research-status c: ri-bodkin-arrow != research-available)
	(up-research-status c: ri-bracer != research-available)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Mercenaries - Magyar huszar don't cost gold

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(goal g-primary-unit my-unique-unit)
		(goal g-secondary-unit my-unique-unit))
	(or
		(up-compare-goal g-desired-num-unique-unit > 8)
		(up-compare-goal g-unique-unit-line >= 12))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(goal g-tertiary-unit my-unique-unit)
	(or
		(up-compare-goal g-desired-num-unique-unit > 6)
		(up-compare-goal g-unique-unit-line >= 9))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-unique-unit > 0)
		(up-compare-goal g-unique-unit-line >= 6))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-compare-goal g-unique-unit-line > 0)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

#end-if

#load-if-defined MALAY-CIV

	;Forced Levy - militia line don't cost gold

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(goal g-primary-unit militiaman)
		(goal g-secondary-unit militiaman))
	(up-compare-goal g-desired-num-militia > 12)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-tertiary-unit militiaman)
	(up-compare-goal g-desired-num-militia > 9)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(up-compare-goal g-desired-num-militia > 0)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	;Thalassocracy - docks fire arrows

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-dock > 2)
		(building-type-count dock >= 4))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-dock > 1)
		(building-type-count dock >= 2))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(building-type-count dock > 0)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

#end-if

#load-if-defined MALIAN-CIV

	;Farimba - cavalry attack

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-primary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-primary-unit-class gv-cavalry)
	(or
		(up-compare-goal g-desired-num-cavalry > 10)
		(unit-type-count cavalry-class >= 15))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-primary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-secondary-unit-class gv-cavalry)
	(or
		(up-compare-goal g-desired-num-cavalry > 10)
		(unit-type-count cavalry-class >= 15))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-tertiary-unit-class gv-cavalry)
	(or
		(up-compare-goal g-desired-num-cavalry > 7)
		(unit-type-count cavalry-class >= 12))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-cavalry > 0)
		(unit-type-count cavalry-class >= 8))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(unit-type-count cavalry-class > 0)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Tigui - TCs fire arrows

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-town-center > 3)
		(building-type-count town-center >= 4))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-town-center > 2)
		(building-type-count town-center >= 3))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-high-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(building-type-count town-center > 0)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-high-excess-only)
	)

#end-if

#load-if-defined MAYAN-CIV

	;El Dorado - eagle warrior HP

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-primary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-primary-unit eagle-warrior)
	(or
		(up-compare-goal g-desired-num-eagle-warrior >= 10)
		(up-compare-goal g-eagle-scout-line >= 15))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-primary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-secondary-unit eagle-warrior)
	(or
		(up-compare-goal g-desired-num-eagle-warrior >= 10)
		(up-compare-goal g-eagle-scout-line >= 15))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-tertiary-unit eagle-warrior)
	(or
		(up-compare-goal g-desired-num-eagle-warrior >= 7)
		(up-compare-goal g-eagle-scout-line >= 12))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-eagle-warrior > 0)
		(up-compare-goal g-eagle-scout-line >= 8))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(up-compare-goal g-eagle-scout-line > 0)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Obsidian Arrows - archer attack vs. buildings

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(goal g-primary-unit archer)
		(goal g-secondary-unit archer))
	(or
		(up-compare-goal g-desired-num-archer >= 8)
		(unit-type-count archer-line >= 12))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(goal g-tertiary-unit archer)
	(or
		(up-compare-goal g-desired-num-archer >= 8)
		(unit-type-count archer-line >= 12))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-archer > 0)
		(unit-type-count archer-line >= 6))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(unit-type-count archer-line > 0)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

#end-if

#load-if-defined MONGOL-CIV

	;Drill - siege workshop units move faster
	
	;Determine desired counts and existing counts for siege workshop siege only
	(defrule
	(building-type-count castle > 0)
	=>
	(up-modify-goal g-temp g:= g-desired-num-siege)
	(up-modify-goal g-temp g:- g-desired-num-trebuchet)
	(up-modify-goal g-temp g:- g-desired-num-petard)
	(up-get-fact unit-type-count petard-class g-temp-2)
	(up-modify-goal g-temp-2 c:* -1)	;alternate way of subtracting petards without using extra temp goal
	(up-modify-goal g-temp-2 g:+ g-siege-class)
	(up-modify-goal g-temp-2 c:- trebuchet-set)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-temp > 3)		;desired num siege weapons from siege workshop
		(up-compare-goal g-temp-2 > 4))		;num siege workshop units
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-temp > 2)		;desired num siege weapons from siege workshop
		(up-compare-goal g-temp-2 > 2))		;num siege workshop units
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-temp > 0)		;desired num siege weapons from siege workshop
		(up-compare-goal g-temp-2 > 0))		;num siege workshop units
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Nomads - destroyed houses still support pop

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(goal g-town-under-attack YES)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

#end-if

#load-if-defined PERSIAN-CIV

	;Mahouts - war elephant speed

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-primary-unit my-unique-unit)
	(or
		(up-compare-goal g-desired-num-unique-unit >= 8)
		(up-compare-goal g-unique-unit-line >= 12))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-secondary-unit my-unique-unit)
	(or
		(up-compare-goal g-desired-num-unique-unit >= 6)
		(up-compare-goal g-unique-unit-line >= 9))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-unique-unit > 0)
		(up-compare-goal g-unique-unit-line >= 6))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(up-compare-goal g-unique-unit-line > 0)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)
	
	#load-if-not-defined DE-AVAILABLE

		;Boiling Oil - castles do more damage to rams

		(defrule
		(building-type-count castle > 0)
		(up-compare-goal g-castle-tech-priority < gv-excess-only)
		(up-research-status c: ri-castle-unique-tech == research-available)
		(building-type-count castle >= 2)
		(players-unit-type-count any-enemy battering-ram-line >= 5)
		=>
		(set-goal g-next-castle-tech ri-castle-unique-tech)
		(set-goal g-castle-tech-priority gv-excess-only)
		)

		(defrule
		(building-type-count castle > 0)
		(up-compare-goal g-castle-tech-priority < gv-high-excess-only)
		(up-research-status c: ri-castle-unique-tech == research-available)
		(building-type-count castle >= 2)
		=>
		(set-goal g-next-castle-tech ri-castle-unique-tech)
		(set-goal g-castle-tech-priority gv-high-excess-only)
		)
		
	#end-if
	
	#load-if-defined DE-AVAILABLE
	
		;Kamandaran - Archer line costs 50W

		(defrule
		(building-type-count castle > 0)
		(up-compare-goal g-castle-tech-priority < gv-primary)
		(up-research-status c: ri-castle-unique-tech == research-available)
		(goal g-primary-unit archer)
		(or
			(up-compare-goal g-desired-num-archer >= 6)
			(unit-type-count archer-line >= 8))
		=>
		(set-goal g-next-castle-tech ri-castle-unique-tech)
		(set-goal g-castle-tech-priority gv-primary)
		)

		(defrule
		(building-type-count castle > 0)
		(up-compare-goal g-castle-tech-priority < gv-secondary)
		(up-research-status c: ri-castle-unique-tech == research-available)
		(goal g-secondary-unit archer)
		(or
			(up-compare-goal g-desired-num-archer >= 6)
			(unit-type-count archer-line >= 8))
		=>
		(set-goal g-next-castle-tech ri-castle-unique-tech)
		(set-goal g-castle-tech-priority gv-secondary)
		)

		(defrule
		(building-type-count castle > 0)
		(up-compare-goal g-castle-tech-priority < gv-tertiary)
		(up-research-status c: ri-castle-unique-tech == research-available)
		(goal g-tertiary-unit archer)
		(or
			(up-compare-goal g-desired-num-archer >= 5)
			(unit-type-count archer-line >= 6))
		=>
		(set-goal g-next-castle-tech ri-castle-unique-tech)
		(set-goal g-castle-tech-priority gv-tertiary)
		)

		(defrule
		(building-type-count castle > 0)
		(up-compare-goal g-castle-tech-priority < gv-low)
		(up-research-status c: ri-castle-unique-tech == research-available)
		(or
			(up-compare-goal g-desired-num-archer > 0)
			(unit-type-count archer-line >= 4))
		=>
		(set-goal g-next-castle-tech ri-castle-unique-tech)
		(set-goal g-castle-tech-priority gv-low)
		)

		(defrule
		(building-type-count castle > 0)
		(up-compare-goal g-castle-tech-priority < gv-excess-only)
		(up-research-status c: ri-castle-unique-tech == research-available)
		(unit-type-count archer-line > 0)
		=>
		(set-goal g-next-castle-tech ri-castle-unique-tech)
		(set-goal g-castle-tech-priority gv-excess-only)
		)
		
	#end-if
#end-if

#load-if-defined PORTUGUESE-CIV

	;Arquebus - gunpowder unit ballistics

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-primary-unit my-unique-unit)
	(or
		(up-compare-goal g-desired-num-unique-unit > 7)
		(up-compare-goal g-unique-unit-line >= 10))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(goal g-secondary-unit my-unique-unit)
		(goal g-tertiary-unit my-unique-unit))
	(or
		(up-compare-goal g-desired-num-unique-unit > 5)
		(up-compare-goal g-unique-unit-line >= 8))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-unique-unit > 0)
		(up-compare-goal g-unique-unit-line >= 5))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(up-compare-goal g-unique-unit-line > 0)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-primary-unit bombard-cannon)
	(or
		(up-compare-goal g-desired-num-bombard-cannon > 3)
		(unit-type-count-total bombard-cannon >= 5))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(goal g-secondary-unit bombard-cannon)
		(goal g-tertiary-unit bombard-cannon))
	(or
		(up-compare-goal g-desired-num-bombard-cannon > 3)
		(unit-type-count-total bombard-cannon >= 5))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-bombard-cannon > 4)
		(unit-type-count-total bombard-cannon >= 6))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-bombard-cannon > 0)
		(unit-type-count-total bombard-cannon >= 3))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(unit-type-count-total bombard-cannon > 0)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-cannon-galleon > 5)
		(unit-type-count-total cannon-galleon-line >= 8))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-cannon-galleon > 3)
		(unit-type-count-total cannon-galleon-line >= 5))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-cannon-galleon > 0)
		(unit-type-count-total cannon-galleon-line > 0))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-primary-unit hand-cannoneer)
	(or
		(up-compare-goal g-desired-num-hand-cannoneer > 10)
		(unit-type-count-total hand-cannoneer >= 15))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(goal g-secondary-unit hand-cannoneer)
		(goal g-tertiary-unit hand-cannoneer))
	(or
		(up-compare-goal g-desired-num-hand-cannoneer > 7)
		(unit-type-count-total hand-cannoneer >= 12))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-hand-cannoneer > 0)
		(unit-type-count-total hand-cannoneer >= 8))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(unit-type-count-total hand-cannoneer > 0)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Carrack - ship armor

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-warships >= 10)
		(unit-type-count warship-class >= 15))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-warships > 0)
		(unit-type-count warship-class > 0))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

#end-if

#load-if-defined SARACEN-CIV

	;Zealotry - camel, mamaluke HP

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-primary-unit camel)
	(or
		(up-compare-goal g-desired-num-camel > 10)
		(up-compare-goal g-camel-line >= 15))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(goal g-secondary-unit camel)
		(goal g-tertiary-unit camel))
	(or
		(up-compare-goal g-desired-num-camel > 7)
		(up-compare-goal g-camel-line >= 12))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-camel > 0)
		(up-compare-goal g-camel-line >= 8))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(up-compare-goal g-camel-line > 0)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(goal g-primary-unit my-unique-unit)
		(goal g-secondary-unit my-unique-unit))
	(or
		(up-compare-goal g-desired-num-unique-unit > 9)
		(up-compare-goal g-unique-unit-line >= 15))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-tertiary-unit my-unique-unit)
	(or
		(up-compare-goal g-desired-num-unique-unit > 7)
		(up-compare-goal g-unique-unit-line >= 12))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-unique-unit > 0)
		(up-compare-goal g-unique-unit-line >= 8))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(up-compare-goal g-unique-unit-line > 0)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Masrasah - dead monks return some gold

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-compare-goal g-desired-num-monks >= 7)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-compare-goal g-desired-num-monks >= 5)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-compare-goal g-desired-num-monks >= 4)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-compare-goal g-desired-num-monks > 1)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

#end-if

#load-if-defined SLAVIC-CIV

	;Druzhina - infantry blast radius

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(goal g-primary-unit-class gv-infantry)
		(goal g-secondary-unit-class gv-infantry))
	(or
		(up-compare-goal g-desired-num-infantry >= 15)
		(unit-type-count infantry-class >= 20))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(goal g-tertiary-unit-class gv-infantry)
	(or
		(up-compare-goal g-desired-num-infantry >= 10)
		(unit-type-count infantry-class >= 15))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-infantry > 0)
		(unit-type-count infantry-class > 10))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(unit-type-count infantry-class > 0)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Orthodoxy - monk armor

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-monks >= 5)
		(unit-type-count monastery-class >= 7))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-monks > 1)
		(unit-type-count monastery-class >= 4))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(unit-type-count monastery-class > 1)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

#end-if

#load-if-defined SPANISH-CIV

	;Surpremacy - villager combat skills

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-primary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(up-compare-sn sn-number-civilian-militia >= 12)
	(goal g-attacking YES)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-primary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(unit-type-count villager >= 90)
		(up-compare-sn sn-number-civilian-militia >= 12))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(unit-type-count villager >= 75)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Inquisition - monk/missionary convert speed

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-monks >= 8)
		(unit-type-count monastery-class >= 12))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-monks >= 5)
		(unit-type-count monastery-class >= 7))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-monks > 1)
		(unit-type-count monastery-class >= 4))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(unit-type-count monastery-class > 1)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

#end-if

#load-if-defined TEUTONIC-CIV

	;Crenellations - castle HP, garrisoned infantry fire arrows

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-castle >= 3)
		(unit-type-count castle >= 3))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-castle >= 2)
		(unit-type-count castle >= 2))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-high-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-castle > 0)
		(unit-type-count castle > 0))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-high-excess-only)
	)

	;Ironclad - siege melee armor

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-siege >= 5)
		(up-compare-goal g-siege-class >= 7))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-siege >= 3)
		(up-compare-goal g-siege-class >= 5))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-high-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-siege > 0)
		(up-compare-goal g-siege-class > 0))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-high-excess-only)
	)

#end-if

#load-if-defined TURKISH-CIV

	;Artillery - bombard tower, bombard cannon, cannon galleon range

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-bombard-cannon > 4)
		(unit-type-count bombard-cannon >= 7))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-bombard-cannon > 2)
		(unit-type-count bombard-cannon >= 5))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-bombard-cannon > 0)
		(unit-type-count bombard-cannon >= 3))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(unit-type-count bombard-cannon > 0)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-bombard-tower > 3)
		(building-type-count bombard-tower >= 5))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-bombard-tower > 1)
		(building-type-count bombard-tower >= 3))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-bombard-tower > 0)
		(building-type-count bombard-tower > 0))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-cannon-galleon > 3)
		(unit-type-count-total cannon-galleon-line >= 5))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-cannon-galleon > 1)
		(unit-type-count-total cannon-galleon-line >= 3))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-high-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-cannon-galleon > 0)
		(unit-type-count-total cannon-galleon-line > 0))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-high-excess-only)
	)

	;Sipahi - cav archer HP

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-research-status c: ri-bloodlines != research-available)
	(or
		(goal g-primary-unit cavalry-archer)
		(goal g-primary-unit genitour))
	(or
		(up-compare-goal g-desired-num-cavalry-archer >= 8)
		(or
			(unit-type-count cavalry-archer-line >= 12)
			(or
				(up-compare-goal g-desired-num-genitour >= 8)
				(up-compare-goal g-genitour-line >= 12))))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-research-status c: ri-bloodlines != research-available)
	(or
		(up-compare-goal g-desired-num-cavalry-archer >= 6)
		(or
			(unit-type-count cavalry-archer-line >= 9)
			(or
				(up-compare-goal g-desired-num-genitour >= 6)
				(up-compare-goal g-genitour-line >= 9))))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-research-status c: ri-bloodlines != research-available)
	(or
		(up-compare-goal g-desired-num-cavalry-archer > 0)
		(or
			(unit-type-count cavalry-archer-line >= 6)
			(or
				(up-compare-goal g-desired-num-genitour > 0)
				(up-compare-goal g-genitour-line >= 6))))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-research-status c: ri-bloodlines != research-available)
	(or
		(up-compare-goal g-desired-num-cavalry-archer > 0)
		(up-compare-goal g-desired-num-genitour > 0))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

#end-if

#load-if-defined VIETNAMESE-CIV

	;Paper Money - team receives gold

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(player-in-game any-ally)
	(or
		(up-allied-resource-amount any-ally gold < 100)
		(up-compare-goal g-strategy >= gv-low-gold))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(player-in-game any-ally)
	(game-time >= 3600)
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(unit-type-count villager-gold == 0)
		(up-compare-goal g-strategy >= gv-low-gold))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	;Chatras - Battle elephant HP

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(goal g-primary-unit battle-elephant)
		(goal g-secondary-unit battle-elephant))
	(or
		(up-compare-goal g-desired-num-battle-elephant >= 8)
		(up-compare-goal g-battle-elephant-line >= 12))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-low)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-battle-elephant > 0)
		(up-compare-goal g-battle-elephant-line >= 6))
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-low)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(up-compare-goal g-battle-elephant-line > 0)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

#end-if

#load-if-defined VIKING-CIV

	;Berserkergang - berserk regeneration

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-unique-unit >= 12)
		(up-compare-goal g-unique-unit-line >= 16))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-unique-unit >= 6)
		(up-compare-goal g-unique-unit-line >= 8))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-high-excess-only)
	(up-research-status c: ri-imperial-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-unique-unit > 0)
		(up-compare-goal g-unique-unit-line > 0))
	=>
	(set-goal g-next-castle-tech ri-imperial-unique-tech)
	(set-goal g-castle-tech-priority gv-high-excess-only)
	)

	;Chieftains - infantry bonus attack vs. cavalry

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-secondary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-infantry >= 15)
		(unit-type-count infantry-class >= 20))
	(players-unit-type-count any-enemy cavalry-class > 10)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-secondary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-tertiary)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-infantry >= 8)
		(unit-type-count infantry-class >= 12))
	(players-unit-type-count any-enemy cavalry-class > 5)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-tertiary)
	)

	(defrule
	(building-type-count castle > 0)
	(up-compare-goal g-castle-tech-priority < gv-excess-only)
	(up-research-status c: ri-castle-unique-tech == research-available)
	(or
		(up-compare-goal g-desired-num-infantry > 0)
		(unit-type-count infantry-class > 0))
	(players-unit-type-count any-enemy cavalry-class > 0)
	=>
	(set-goal g-next-castle-tech ri-castle-unique-tech)
	(set-goal g-castle-tech-priority gv-excess-only)
	)

#end-if

;Hoardings

(defrule
(building-type-count castle > 0)
(up-compare-goal g-castle-tech-priority < gv-low)
(up-research-status c: ri-hoardings == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-castle > 3)
	(unit-type-count castle > 2))
=>
(set-goal g-next-castle-tech ri-hoardings)
(set-goal g-castle-tech-priority gv-low)
)

(defrule
(building-type-count castle > 0)
(up-compare-goal g-castle-tech-priority < gv-excess-only)
(up-research-status c: ri-hoardings == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-castle > 1)
	(unit-type-count castle > 1))
=>
(set-goal g-next-castle-tech ri-hoardings)
(set-goal g-castle-tech-priority gv-excess-only)
)

(defrule
(building-type-count castle > 0)
(up-compare-goal g-castle-tech-priority < gv-high-excess-only)
(up-research-status c: ri-hoardings == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(or
	(up-compare-goal g-desired-num-castle > 0)
	(unit-type-count castle > 0))
=>
(set-goal g-next-castle-tech ri-hoardings)
(set-goal g-castle-tech-priority gv-high-excess-only)
)

;Sappers

(defrule
(building-type-count castle > 0)
(up-compare-goal g-castle-tech-priority < gv-secondary)
(up-research-status c: ri-sappers == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(up-compare-sn sn-allow-civilian-offense == 1)
(up-compare-sn sn-number-civilian-militia >= 12)
(civ-selected spanish)
(research-completed ri-imperial-unique-tech)
(goal g-attacking YES)
=>
(set-goal g-next-castle-tech ri-sappers)
(set-goal g-castle-tech-priority gv-secondary)
)

(defrule
(building-type-count castle > 0)
(up-compare-goal g-castle-tech-priority < gv-low)
(up-research-status c: ri-sappers == research-available)
(or
	(up-compare-goal g-attack-status > gv-first-attack)
	(up-compare-flag g-excess-resources-flag == gv-food-gold))
(up-compare-sn sn-allow-civilian-offense == 1)
(up-compare-sn sn-number-civilian-militia >= 12)
=>
(set-goal g-next-castle-tech ri-sappers)
(set-goal g-castle-tech-priority gv-low)
)

;====GOAL: g-highest-tech-priority

(defrule
(true)
=>
(set-goal g-highest-tech-priority 0)
(up-modify-goal g-highest-tech-priority g:max g-town-center-tech-priority)
(up-modify-goal g-highest-tech-priority g:max g-mill-tech-priority)
(up-modify-goal g-highest-tech-priority g:max g-mining-camp-tech-priority)
(up-modify-goal g-highest-tech-priority g:max g-lumber-camp-tech-priority)
(up-modify-goal g-highest-tech-priority g:max g-dock-tech-priority)
(up-modify-goal g-highest-tech-priority g:max g-blacksmith-tech-priority)
(up-modify-goal g-highest-tech-priority g:max g-market-tech-priority)
(up-modify-goal g-highest-tech-priority g:max g-monastery-tech-priority)
(up-modify-goal g-highest-tech-priority g:max g-university-tech-priority)
(up-modify-goal g-highest-tech-priority g:max g-barracks-tech-priority)
(up-modify-goal g-highest-tech-priority g:max g-archery-range-tech-priority)
(up-modify-goal g-highest-tech-priority g:max g-stable-tech-priority)
(up-modify-goal g-highest-tech-priority g:max g-siege-workshop-tech-priority)
(up-modify-goal g-highest-tech-priority g:max g-castle-tech-priority)
)